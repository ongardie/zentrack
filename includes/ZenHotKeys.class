<? if( !ZT_DEFINED ) { die("Illegal Access"); }

class ZenHotKeys {
  
  function ZenHotKeys( &$zen ) {
    $this->_zen =& $zen;
    $this->_keys = array();
    $this->_fxns = array();
    $this->_idx = array();
    $this->_tabs = array();
    $this->_keysRendered = array();
    $this->_lh = '';
    $this->_alternate = $zen->getSetting('hotkeys_alternate_hints');
    $this->_alreadyLoaded = array();
    
    //todo load registered hot keys from database for the 'all' section
    //todo and assign them here
    $this->assign('ALT+1', 'Projects',    "KeyEvent.createLoadUrl('{rootUrl}/projects.php')", '', true);
    $this->assign('ALT+2', 'Tickets',     "KeyEvent.createLoadUrl('{rootUrl}/index.php')", '', true);
    $this->assign('ALT+3', 'Contacts',    "KeyEvent.createLoadUrl('{rootUrl}/contacts.php')", '', true);
    $this->assign('ALT+4', 'Options',     "KeyEvent.createLoadUrl('{rootUrl}/options.php')", '', true);  
    $this->assign('ALT+5', 'Help',        "KeyEvent.createLoadUrl('{rootUrl}/help/index.php')", '', true);  
    $this->assign('ALT+6', 'Admin',       "KeyEvent.createLoadUrl('{rootUrl}/admin/index.php')", '', true);  
    $this->assign('ALT+P', 'New Project', "KeyEvent.createLoadUrl('{rootUrl}/newProject.php')", '', true);  
    $this->assign('ALT+T', 'New Ticket',  "KeyEvent.createLoadUrl('{rootUrl}/newTicket.php')", '', true);  
    $this->assign('ALT+C', 'New Contact', "KeyEvent.createLoadUrl('{rootUrl}/newContact.php')", '', true);
    
    $this->newFxn('quickFocus', 'window.document.quickIdForm.idText.focus(); quickHighlight("window.document.quickIdForm.idText","searchHelpBox");', '', true);
    $this->assign('ALT+S', 'Search',   "quickFocus()", 'Enter a ticket id or summary', true);
    $this->assign('ALT+V', 'Advanced Search', "KeyEvent.createLoadUrl('{rootUrl}/search.php')", "Advanced ticket search", true);
  }
  
  /** Prepares hot keys for a given section of the app */
  function loadSection( $sect ) {
    $sect = strtolower($sect);
    if( in_array($sect, $this->_alreadyLoaded) ) {
      $this->_zen->addDebug('loadSection', "$sect already loaded", 3);
      return;
    }
    $this->_alreadyLoaded[] = $section;
    
    //todo load registered hot keys from database and assign here
    $this->_zen->addDebug('loadSection', "Attempting to load section: $sect", 3);
    
    //this is a quick hack for the time being
    if( $sect == 'admin' ) {
      $this->assign('ALT+N',  'New User',        "KeyEvent.createLoadUrl('{rootUrl}/admin/addUser.php')");
      $this->assign('ALT+U',  'Edit Users',      "KeyEvent.createLoadUrl('{rootUrl}/admin/listUsers.php')");
      $this->assign('ALT+E',  'Edit Tickets',    "KeyEvent.createLoadUrl('{rootUrl}/admin/editTicket.php')");
      $this->assign('ALT+F',  'Edit Field Map',  "KeyEvent.createLoadUrl('{rootUrl}/admin/fieldMap.php')");
      $this->assign('ALT+B',  'Bins',            "KeyEvent.createLoadUrl('{rootUrl}/admin/bins.php')");
      $this->assign('ALT+R',  'Priorities',      "KeyEvent.createLoadUrl('{rootUrl}/admin/priorities.php')");
      $this->assign('ALT+S',  'Systems',         "KeyEvent.createLoadUrl('{rootUrl}/admin/systems.php')");
      $this->assign('ALT+A',  'Tasks',           "KeyEvent.createLoadUrl('{rootUrl}/admin/tasks.php')");
      $this->assign('ALT+Y',  'Types',           "KeyEvent.createLoadUrl('{rootUrl}/admin/types.php')");
      $this->assign('ALT+G',  'Data Groups',     "KeyEvent.createLoadUrl('{rootUrl}/admin/groups.php')");
      $this->assign('ALT+H',  'Behaviors',       "KeyEvent.createLoadUrl('{rootUrl}/admin/behaviors.php')");
      $this->assign('ALT+O',  'Configuration',   "KeyEvent.createLoadUrl('{rootUrl}/admin/config.php')");
    }
    else if( $sect == 'actionbar' ) {
      $actions = $this->_zen->getActions();
      foreach($actions as $k=>$v) {
        if( $v['button'] && $v['key'] ) {
          if( $k == 'print' ) {
            $this->assign($v['key'], "Action: {$v['label']}", "printWindow");
            continue;
          }
          $this->assign($v['key'], "Action: {$v['label']}", 
            "KeyEvent.createLoadUrl('{rootUrl}/actions/$k.php?id={id}')", $v['label']);
        }
      }
    }
    else if( $sect == 'action_approve' ) {
      $f = "window.document.forms['approveForm']";
      $this->assign('ALT+O', "Comments", "{$f}.elements['comments'].select()");
      $this->assign('ALT+A', "Approve", "{$f}.submit()");
    }
    else if( $sect == 'action_assign' ) {
      $f = "window.document.forms['assignForm']";
      $this->assign('ALT+R', "Recipient", "{$f}.elements['user_id'].focus()");
      $this->assign('ALT+O', "Comments or Instructions", "{$f}.elements['comments'].select()");
      $this->assign('ALT+A', "Assign", "{$f}.submit()");
    }
    else if( $sect == 'action_close' ) {
      $this->assign('ALT+H', 'Field: hours', "window.document.forms['ticketTabForm'].elements['hours'].select()", "Hours");
      $this->assign('ALT+O', 'Field: comments', "window.document.forms['ticketTabForm'].elements['comments'].select()", "Comments");
      $this->assign('ALT+L', 'Close', "window.document.forms['ticketTabForm'].submit()");
    }
    else if( $sect == 'action_contacts' ) {
      $this->assign('ALT+N', 'Create New Contact', "window.document.forms['newContactForm'].submit()");
      $this->assign('ALT+A', 'Add Contact', "window.document.forms['ContactsAddForm'].submit()");
      $this->assign('ALT+D', 'Drop Contacts', "window.document.forms['dropContactsForm'].submit()");
      $this->assign('ALT+Y', 'Field: company_id', "window.document.forms['ContactsAddForm'].elements['company_id'].focus()", "Company");
      $this->assign('ALT+E', 'Field: person_id', "window.document.forms['ContactsAddForm'].elements['person_id'].focus()", "Person");
    }
    else if( $sect == 'action_notify' ) {
      $f = "window.document.forms['notifyAddForm']";
      $this->assign('ALT+R', "Enter Registered Users", "{$f}.elements['user_accts'].select()");
      $this->assign('ALT+U', "Add an Unregistered User", "{$f}.elements['unreg_name'].select()");
      $this->assign('ALT+O', "Add a Contact", "{$f}.elements['company_id'].focus()");
      $this->assign('ALT+A', "Add Recipients", "{$f}.submit()");
    }
    else if( $sect == 'action_email' ) {
      $f = "window.document.forms['emailForm']";
      $this->newFxn('emailFormToggle', "var obj = {$f}.elements['method']; var newVal = arguments[0]; for(var i=0; i < obj.length; i++) { if( obj[i].value == newVal ) { obj[i].checked = true; break; } }");
      $this->assign('ALT+U', 'Select a User', "{$f}.elements['users_to_email[]'].focus();",
        "Select one or more users, use CTRL or SHIFT key for multiples");
      $this->assign('ALT+M', 'Manually Enter Addresses', "{$f}.elements['custom_email_addresses'].select();",
        "Manually enter an email address, use commas to separate multiple addresses");
      $this->assign('ALT+O', 'Comments or Instructions', "{$f}.elements['comments'].select()");
      $this->assign('ALT+E', 'Send Email', "{$f}.submit()");
      $this->assign('ALT+L', 'send option: link',  "emailFormToggle(1)");
      $this->assign('ALT+Y', 'send option: summary', "emailFormToggle(2)");
      $this->assign('ALT+G', 'send option: log',  "emailFormToggle(3)");
    }
    else if( $sect == 'action_log' ) {
      $f = "window.document.forms['logForm']";
      $this->assign('ALT+Y', 'Select an Activity', "{$f}.elements['log_action'].focus()");
      $this->assign('ALT+H', 'Enter Hours Worked', "{$f}.elements['hours'].select()");
      $this->assign('ALT+O', 'Log Entry / Comments', "{$f}.elements['comments'].select()");
      $this->assign('ALT+A', 'Save Log', "{$f}.submit()");
    }
    else if( $sect == 'action_move' ) {
      $f = "window.document.forms['moveForm']";
      $this->assign('ALT+B',  'New Bin', "{$f}.elements['newBin'].focus()");
      $this->assign('ALT+O',  'Comments', "{$f}.elements['comments'].select()");
      $this->assign('ALT+M',  'Move',  "{$f}.submit()");
    }
    else if( $sect == 'action_reject' ) {
      $f = "window.document.forms['rejectForm']";
      $this->assign('ALT+O', 'Reason', "{$f}.elements['comments'].select()");
      $this->assign('ALT+R', 'Reject', "{$f}.submit()");
    }
    else if( $sect == 'action_relate' ) {
      $f = "window.document.forms['relateTicketForm']";
      $this->assign('ALT+I', 'Enter Ticket IDs', "{$f}.elements['relations'].select()");
      $this->assign('ALT+O', 'Comments', "{$f}.elements['comments'].select()");
      $this->assign('ALT+R', 'Relate', "{$f}.submit()");
    }
    else if( $sect == 'action_reopen' ) {
      $f = "window.document.forms['reopenForm']";
      $this->assign('ALT+O', 'Comments or Instructions', "{$f}.elements['comments'].select()");
      $this->assign('ALT+R', 'Reopen', "{$f}.submit()");
    }
    else if( $sect == 'action_test' ) {
      $f = "window.document.forms['testForm']";
      $this->assign('ALT+H', 'Hours Worked', "{$f}.elements['hours'].select()");
      $this->assign('ALT+O', 'Comments or Instructions', "{$f}.elements['comments'].select()");
      $this->assign('ALT+E', 'Testing Complete', "{$f}.submit()");
    }
    else if( $sect == 'action_upload' ) {
      $f = "window.document.forms['addAttachmentForm']";
      $this->assign('ALT+U', 'Select a File to Upload', "{$f}.elements['userfile'].focus()");
      $this->assign('ALT+E', 'Description of Attachment', "{$f}.elements['comments'].select()");
      $this->assign('ALT+A', 'Add Attachment', "{$f}.submit()");
    }
    else if( $sect == 'action_yank' ) {
      $this->assign('ALT+O', 'Reason', "window.document.forms['pullForm'].elements['comments'].select()");
      $this->assign('ALT+U', 'Pull', "window.document.forms['pullForm'].submit()");
    }
    else if( $sect == 'agreement_view' ) {
      $this->assign('ALT+E', 'Edit', "window.document.forms['editAgreementForm'].submit()");
      $msg = Zen::fixJsHtml(tr("Are you sure you want to archive this agreement?"),"'");
      $this->assign('ALT+A', 'Archive', "confirmSubmit(window.document.forms['archiveAgreementForm'],$msg)");
      $msg = Zen::fixJsHtml(tr("Are you sure you want to delete this agreement?"),"'");
      $this->assign('ALT+D', 'Delete', "confirmSubmit(window.document.forms['deleteAgreementForm'],$msg)");
    }
    else if( $sect == 'agreement_form' ) {
      $f = "window.document.forms['agreementForm']";
      $this->assign('ALT+A', "Add Item",     "rerouteAgreementForm('addItems')");
      $this->assign('ALT+O', "Drop Items",   "rerouteAgreementForm('removeItems')");
      $this->assign('ALT+R', "Create",       "{$f}.submit()");
      $this->assign('ALT+M', "Agreement ID", "{$f}.elements['contractnr'].select()");
      $this->assign('ALT+E', "Description",  "{$f}.elements['description'].select()");
    }
    else if( $sect == 'contacts' ) {
      $this->assign('ALT+N',  'Find',           "KeyEvent.createLoadUrl('{rootUrl}/searchContacts.php')");
      $this->assign('ALT+B',  'Browse',         "KeyEvent.createLoadUrl('{rootUrl}/agreements.php')");
      $this->assign('ALT+G',  'New Agreement',  "KeyEvent.createLoadUrl('{rootUrl}/newAgreement.php')");
    }
    else if( $sect == 'contacts_new_menu' ) {
      $this->assign('ALT+Y',  'New Company',    "KeyEvent.createLoadUrl('{rootUrl}/newContact.php?mode2=1')");
      $this->assign('ALT+N',  'New Person',     "KeyEvent.createLoadUrl('{rootUrl}/newContact.php?mode2=2')");
    }
    else if( $sect == 'contacts_view' ) {
      $this->assign('ALT+D',  'Edit',    "KeyEvent.createLoadUrl('{rootUrl}/actions/contact_edit.php?cid={id}')");
      $this->assign('ALT+L',  'Delete',  "KeyEvent.createLoadUrl('{rootUrl}/actions/contact_delete.php?cid={id}')");
      $this->assign('ALT+E',  'Add Employee',  "KeyEvent.createLoadUrl('{rootUrl}/actions/contact_employee.php?cid={id}')");
      $this->assign('ALT+A',  'Add Agreement',  "KeyEvent.createLoadUrl('{rootUrl}/actions/contact_agreement.php?cid={id}')");
      $this->assign('ALT+I',  'View Tickets', "KeyEvent.createLoadUrl('{rootUrl}/contact.php?overview=tickets&cid={id}')");
      $this->assign('ALT+Y',  'View Employees',  "KeyEvent.createLoadUrl('{rootUrl}/contact.php?cid={id}&overview=contact')");
      $this->assign('ALT+M',  'View Agreements',  "KeyEvent.createLoadUrl('{rootUrl}/contact.php?cid={id}&overview=agreement')");
    }
    else if( $sect == 'contacts_view_employee' ) {
      $this->assign('ALT+E',  'Edit',         "window.document.forms['edit_form'].submit()");
      $msg = Zen::fixJsVal(tr("Are you sure you want to delete this contact?"));
      $this->assign('ALT+D',  'Delete',       "confirmSubmit(window.document.forms['delete_form'],$msg)");
      $this->assign('ALT+I',  'View Tickets', "window.document.forms['view_form'].submit()");
    }
    else if( $sect == 'contacts_list' ) {
      $tabs = array('all',"abc","def","ghi","jkl","mno","pqrs","tuv","wxyz","!19");
      foreach($tabs as $t) {
        $c = 0;
        $k = false;
        while(!$k || (array_key_exists($k,$this->_keys) && $c < strlen($t))) {
          $k = strtoupper(substr($t,$c,1));
          if( $k == '!' ) { $k = false; }
          $c++;
        }
        $this->assign($k, $t, "updateUrl('setmode','$t')");
      }
      $this->assign('ALT+O', "Company",  "updateUrl('overview', 'company')"  );
      $this->assign('ALT+E', "External", "updateUrl('overview', 'external')" );
      $this->assign('ALT+I', "Internal", "updateUrl('overview', 'internal')" );
    }
    else if( $sect == 'log' ) {
      $this->assign('ALT+L',  'Show All Logs',  "window.document.getElementById('systemLogFilterCheckbox').click()");
    }
    else if( $sect == 'login' ) {
      $f = "window.document.forms['loginForm']";
      $this->newFxn("loginAutoCheck", "{$f}.elements['save_my_password'].checked = !window.document.forms['loginForm'].elements['save_my_password'].checked;");
      $this->assign('ALT+L',   'Log On',         "{$f}.submit()");
      $this->assign('ALT+A',   "In the future, log me in automatically (using a cookie)", "loginAutoCheck()");
      $this->assign('ALT+N',   'Login Name',     "{$f}.elements['username'].select()");
      $this->assign('ALT+W',   'Password',       "{$f}.elements['passphrase'].select()");
    }
    else if( $sect == 'options' ) {
      $this->assign('ALT+L',  'Log Off',        "KeyEvent.createLoadUrl('{rootUrl}/index.php?logoff=1')", "Log out of ".$this->_zen->getSetting('system_name'));
    }
    else if( $sect == 'paging' ) {
      $this->assign('ALT+E',  "Prev",           "window.location = window.document.getElementById('pagingPrevLink').href");
      $this->assign('ALT+X',  "Next",           "window.location = window.document.getElementById('pagingNextLink').href");
    }
    else if( $sect == 'project_tasks' ) {
      $this->assign('ALT+A', "Add Ticket to Project", "window.document.forms['newTicketHotkey'].submit()");
      $this->assign('ALT+R', "Create Sub-Project", "window.document.forms['newProjectHotkey'].submit()");
    }
    else if( $sect == 'search_form' ) {
      $f = "window.document.forms['searchForm']";
      $this->assign('ALT+E', "Search",  "{$f}.submit()");
      $this->assign('ALT+O', "Containing", "{$f}.elements['search_text'].select()");
      $this->assign('ALT+U', "Summary", "{$f}.elements['search_fields[title]'].click()");
      $this->assign('ALT+D', "Description", "{$f}.elements['search_fields[description]'].click()");
    }
    else if( $sect == 'tab_attachments' ) {
      $this->assign('ALT+D', 'Delete Attachments', "window.document.forms['deleteAttachmentForm'].submit()");
      $this->assign('ALT+A', 'Add Attachment', "window.document.forms['addAttachmentForm'].submit()");
    }
    else if( $sect == 'tab_contacts' ) {
      $this->assign('ALT+N', 'Create New Contact', "window.document.forms['newContactForm'].submit()");
      $this->assign('ALT+A', 'Add Contact', "window.document.forms['ContactsAddForm'].submit()");
      $this->assign('ALT+D', 'Drop Contacts', "window.document.forms['dropContactsForm'].submit()");
      $this->assign('ALT+Y', 'Field: company_id', "window.document.forms['ContactsAddForm'].elements['company_id'].focus()", "Company");
      $this->assign('ALT+E', 'Field: person_id', "window.document.forms['ContactsAddForm'].elements['person_id'].focus()", "Person");
    }
    else if( $sect == 'tab_notify' ) {
      $this->assign('ALT+D', "Drop Recipients", "window.document.forms['dropNotifyForm'].submit()");
      $this->assign('ALT+A', "Add Recipients", "window.document.forms['notifyAddForm'].submit()");
    }    
    else if( $sect == 'ticket_fields_editable' ) {
      $this->assign('ALT+A', 'Save', "window.document.forms['ticketTabForm'].submit()");
    }
    else if( $sect == 'ticket_view' || $sect == 'project_view' ) {
      $map = $GLOBALS['zt_map'];
      preg_match('@(ticket|project)@', $sect, $matches);
      $t = $matches[1];
      for($i=1; $i<=8; $i++) {
        $view = "{$t}_tab_{$i}";
        if( $map->getViewProp($view, 'visible') ) {
          $label = $map->getViewProp($view,'label');
          $this->assign($i, $label, "KeyEvent.createLoadUrl('{rootUrl}/ticket.php?id={id}&setmode=$view')");
        }
      }
    }
  }
  
  function newFxn( $name, $code ) {
    if( array_key_exists($name, $this->_fxns) ) {
      $this->_zen->addDebug('ZenHotKeys->newFxn', "The fxn '$name' already exists", 1);
      return;
    }
    $this->_zen->addDebug('ZenHotKeys->assign', "Added fxn '$name'", 3);
    $this->_fxns["$name"] = $code;
  }
  
  function getFxnName($key) {
    return str_replace('KeyEvent.createLoadUrl', 'KeyEvent.loadUrl', $this->_keys[$key]['fxn']);
  }

  /** 
   * Adds a hot key to the list.  The fxn param accepts the following special
   * placeholders:
   * <ul>
   *  <li>{rootUrl} - replaced with the value of $rootUrl in www/header.php
   *  <li>{id} - replaced with the current ticket/project/contact/agreement id (if any)
   * </ul>
   *
   * @param String $key a hot key such as 'ALT+SHIFT+Y'
   * @param String $label name of the hot key
   * @param String $fxn name of function to call when hot key is pressed
   * @param String $description tooltip text (defaults to label)
   */
  function assign( $key, $label, $fxn, $description = '', $global = false ) {
    global $id; global $rootUrl;
    
    $key = strtoupper($key);
    if( array_key_exists($key, $this->_keys) ) {
      $this->_zen->addDebug('ZenHotKeys->assign', "The key '$key' already exists", 1);
      return;
    }

    if( array_key_exists($label, $this->_idx) ) {
      $this->_zen->addDebug('ZenHotKeys->assign', "The label '$label' already exists for key '".$this->_idx["$label"]."', this hotkey cannot be looked up by label accurately", 2);
    }
    else {
      $this->_idx["$label"] = $key;
    }
    
    if( !$description ) { $description = $label; }
    $fxn = str_replace("{rootUrl}", $rootUrl, $fxn);
    $fxn = str_replace("{id}", $id, $fxn);
    
    $this->_zen->addDebug('ZenHotKeys->assign', "Added key '$key' for label '$label' and fxn '$fxn'", 3);
    $this->_keys["$key"] = array('label'=>$label, 'fxn'=>$fxn, 'description'=>$description, 'global'=>$global);
  }
  
  function disableAction( $key ) {
    $this->_keys["$key"]["fxn"] = 'doNothing';
  }
  
  /**
   * Return the hot key for a given label (the section must be loaded unless
   * this label appears in 'all')
   *
   * @param String $label
   * @return String the key for this label
   */
  function find( $label ) {
    if( !array_key_exists("$label", $this->_idx) ) { return false; }
    return $this->_idx["$label"];
  }
  
  
  /** Returns a tooltip for a given label */
  function tt( $label ) {
    $key = $this->find($label);
    if( !$key ) {
      $this->_zen->addDebug('ZenHotKeys->tt', "Invalid label '$label'", 1);
      return $label;
    }
    return $this->tooltip($key, $override_text = '');
  }
  
  /** Returns a parsed/translated label for a given label */
  function ll( $label, $override_text = '', $supress_key = false ) {
    $key = $this->find($label);
    if( !$key ) {
      $this->_zen->addDebug('ZenHotKeys->ll', "Invalid label '$label'", 1);
      return $override_text? $override_text : $label;
    }
    return $this->label($key, $override_text, $supress_key);
  }
  
  /** 
   * Return a tooltip message for a given key, this will be translated and
   * the hot key will be appended
   */
  function tooltip( $key ) {
    $key = strtoupper($key);
    return $this->_zen->ffv(tr($this->_keys["$key"]["description"])." ($key)");
  }
  
  /**
   * Return description for a given key, translated and escaped
   *
   * If the description is the same as the label, it will be skipped.
   */
  function description( $key ) {
    $key = strtoupper($key);
    $x = $this->_keys["$key"];
    if( $x["description"] == $x["label"] ) { return "&nbsp;"; }
    return $this->_zen->ffv(tr($x["description"]));
  }
  
  /** 
   * Return a label for a given key, this will be translated
   * and the hot key will be underlined if possible
   */
  function label( $key, $override_text = '' ) {
    $key = strtoupper($key);
    $char = $this->_getChar($key);
    $lchar = strtolower($char);
    $label = $override_text? tr($override_text) : tr($this->_keys["$key"]["label"]);
    $label = preg_replace('@^(Action|Field): @', '', $label);
    $label = str_replace('_', ' ', $label);
    $pos = strpos($label, $char);
    if( $pos === false ) { $pos = strpos($label, $lchar); $char = $lchar; }
    $len = strlen($label);
    if( $pos === 0 ) {
      // matched at beginning of string
      $txt = "<u>{$char}</u>".substr($label,1);
    }
    else if( $pos > 0 && $pos == $len-1 ) {
      // matched at end of string
      $txt = substr($label,0,$len-1)."<u>{$char}</u>";
    }
    else if( $pos > 0 ) {
      // matched inside the string
      $txt = substr($label,0,$pos)."<u>{$char}</u>".substr($label,$pos+1);
    }
    else {
      // no match, just return the label
      //return $label."<sub class='note'>$char</sub>";
      $txt = $label;
    }
    //if( !$supress_key ) { $txt .= $this->renderAccessKey($key); }
    //$txt .= $this->addZenTab($key);
    return $txt;
  }
  
  /**
   * Renders any custom functions defined here.
   */
  function renderFunctions() {
    if( !count($this->_fxns) ) { return; }
    foreach( $this->_fxns as $k=>$v ) {
      print "function $k() {\n";
      print $v;
      print "}\n\n";
    }
     
  }
  
  /** 
   * Create javascript code needed for
   * hot keys to function.  Depends on the keyevents.js file
   *
   * This is meant to be used inside of the onload fxn for the page.   */
  function renderKeys() {
    if( !count($this->_keys) ) { return; }
    foreach( $this->_keys as $k=>$v ) {
      if( $this->_getAccessKey($k) || array_key_exists($k,$this->_keysRendered) ) { continue; }
      $this->_keysRendered[$k] = 1;
      $f = $v['fxn'];
      if( strpos($f,'KeyEvent.createLoadUrl')===false ) { $f = Zen::fixJsVal($f); }
      print "\tKeyEvent.register($f, '$k');\n";
    }
    foreach( $this->_tabs as $t=>$k ) {
      print "\tZenTabs.singleton.register('keySub_$t');\n";
    }
  }
  
  /**
   * create javascript code needed for
   * accesskey functions
   */
  function renderAccessKeys() {
    $keys = array();
    foreach($this->_keys as $k=>$v) {
      print $this->renderAccessKey($k);
    }
  }
  
  /**
   * Render a single access key, done this way so that they will focus near
   * the appropriate field, when possible
   */
  function renderAccessKey( $k ) {
    $v = $this->_keys[$k];
    if( array_key_exists($k,$this->_keysRendered) ) { return; }
    if( $key = $this->_getAccessKey($k) ) {
      $this->_keysRendered[$k] = 1;
      $fxn_parsed = Zen::fixJsHtml($v['fxn']);
      $fxn_parsed = str_replace('KeyEvent.createLoadUrl', 'KeyEvent.loadUrl', $fxn_parsed);
      return "<input type='button' name='accessKeyButton{$key}' value='' accesskey='{$key}' class='accesskeys' onclick=$fxn_parsed>";
    }
    return null;
  }
  
  /** Returns letter used to access this key if it is an accesskey */
  function _getAccessKey( $key ) {
    preg_match('@^ALT[+](\w)$@', $key, $matches);
    return count($matches)>1? $matches[1] : false;
  }
  
  /** Splits a key and returns the letter to be used */
  function _getChar( $key ) {
    return preg_replace('@^.*[+]@', '', $key);
  }
  
  function getChar( $key ) {
    return $this->_getChar($key);
  }
  
  /** Creates html output to display help info */
  function renderHelp() {
    print "<table width='300' border='0' cellspacing='1' cellpadding='2'><tr><td class='titleCell'>Hot Key</td><td class='titleCell'>Function</td></tr>";
    $keys = $this->_keys;
    uasort($keys, 'sortHotKeyTable');
    foreach( $keys as $k=>$v ) {
      print "<tr><td class='hotKeyCell'>$k</td><td class='hotKeyCell'>"
      .$this->label($k)."</td></tr>";
    }
    print "</table>\n";
  }
  
  /** Store a key that will be used to display subtext on tabs */
  function addZenTab( $key ) {
    $count = 1;
    $id = $key.$count++;
    while( array_key_exists($id, $this->_tabs) ) {
      $id = $key.$count++;
    }
    $this->_tabs[$id] = $key;
    $this->_lh = $this->_alternate? $this->_lh == 'High'? 'Low' : 'High' : "High";
    return "<div id='keySub_$id' class='keySub{$this->_lh}'>$key</div>";
  }
  
  function addZenTabByLabel($label) {
    $this->addZenTab($this->find($label));
  }
  
  var $_alternate;
  var $_lh;
  var $_fxns;
  var $_zen;
  var $_keys;
  var $_idx;
  var $_alreadyLoaded;
  var $_tabs;
  var $_keysRendered;
}

/** Must be declared outside of class to work with php */
function sortHotKeyTable( $a, $b ) {
  $a['label'] = preg_replace('@^(Action|Field): @', '', $a['label']);
  $b['label'] = preg_replace('@^(Action|Field): @', '', $b['label']);
  return strnatcmp($a['label'], $b['label']);
}

?>