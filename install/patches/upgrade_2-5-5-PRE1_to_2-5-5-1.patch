diff -Naur zentrack_2-5-5-PRE1/includes/ZenFieldMap.class zentrack_2-5-5-1/includes/ZenFieldMap.class
--- zentrack_2-5-5-PRE1/includes/ZenFieldMap.class	2005-03-11 07:37:36.000000000 -0800
+++ zentrack_2-5-5-1/includes/ZenFieldMap.class	2005-05-08 07:41:02.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 // define some constants for field types
 define("ZTFIELD_HIDDEN",0);
@@ -140,10 +142,10 @@
 $ztf = array(
   "fields" => array(//       searchable,  types                 , data_type,  admin_view, multiple, always_required, default
     "id"              => array(   true,   array(1)              , 'int'    ,      null, false,  true,  false),
-    "title"           => array(   true,   array(1,2)            , 'string' ,      null, false,  true,   true),
+    "title"           => array(   true,   array(1,2)            , 'text' ,        null, false,  true,   true),
     "priority"        => array(   true,   array(1,3,4,6)        , 'int'    ,      null, false,  true,   true),
     "status"          => array(   true,   array(1,3,4,6)        , 'string' ,      null, false,  true,  false),
-    "description"     => array(   true,   array(1,2)            , 'string' ,      null, false,  false,  true),
+    "description"     => array(   true,   array(1,2)            , 'text' ,        null, false,  false,  true),
     "otime"           => array(   true,   array(1)              , 'date'   ,  array(7), false,  true,  false),
     "ctime"           => array(   true,   array(1)              , 'date'   ,  array(7), false,  false,  false),
     "bin_id"          => array(   true,   array(1,3,4,6)        , 'int'    ,      null, false,  true,   true),
@@ -154,17 +156,19 @@
     "tested"          => array(  false,   array(1,3,5,6)        , 'int'    ,      null, false,  false,  true),
     "approved"        => array(  false,   array(1,3,5,6)        , 'int'    ,      null, false,  false,  true),
     "relations"       => array(  false,   array(1,4)            , 'string' ,  array(2), true ,  false,  true),
-    "project_id"      => array(  false,   array(1,4)            , 'int'    ,  array(2), false,  false,  true),
-    "est_hours"       => array(  false,   array(1,2)            , 'float'  ,     null, false,  false,  true),
+    "project_id"      => array(  false,   array(1,3,4)          , 'int'    ,  array(2), false,  false,  true),
+    "est_hours"       => array(  false,   array(1,2)            , 'float'  ,      null, false,  false,  true),
     "deadline"        => array(  false,   array(1,7)            , 'date'   ,      null, false,  false,  true),
     "start_date"      => array(  false,   array(1,7)            , 'date'   ,      null, false,  false,  true),
     "wkd_hours"       => array(  false,   array(1,2)            , 'float'  ,      null, false,  false,  true),
-    "custom_string"   => array(   true,   array(1,2)            , 'string' ,      null, false,  false,  true),
+    "custom_string"   => array(   true,   array(1,2)            , 'text' ,        null, false,  false,  true),
     "custom_number"   => array(   true,   array(1,2)            , 'int'    ,      null, false,  false,  true),
     "custom_boolean"  => array(   true,   array(1,3,5,6)        , 'boolean',      null, false,  false,  true),
     "custom_date"     => array(   true,   array(1,7)            , 'date'   ,      null, false,  false,  true),
     "custom_menu"     => array(   true,   array(1,3,6)          , 'string' ,      null, false,  false,  true),
-    "custom_text"     => array(  false,   array(1,2)            , 'string' ,      null, false,  false,  true)
+    "custom_text"     => array(  false,   array(1,2)            , 'text'   ,      null, false,  false,  true),
+    "hours"           => array(  false,   array(2)              , 'int'    ,      null, false,  false,  true),
+    "comments"        => array(  false,   array(2)              , 'text'   ,      null, false,  false,  true)
   ),
   
   "views" => array(//           disabled, view_only, has_behaviors, admin_view, multiple, sections
@@ -250,10 +254,16 @@
   /**
    * Returns the label specified for the field in question
    */
+/*old Function (wrong):
   function getLabel( $view, $field_name ) {
     $field = $this->getFieldFromMap($view,$field_name);
     return $field['field_label']? $field['field_label'] : $field['field_name'];
   }
+  new Function: */
+  function getLabel( $view, $field_name) {
+    $field = $this->getFieldFromMap($view,is_array($field_name)?$field_name['field_name']:$field_name);
+    return $field['field_label']? $field['field_label'] : $field['field_name'];
+  }
   
   /**
    * Consults the field map and returns a string of suitable text to show
@@ -280,7 +290,7 @@
           if( isset($vals["$value"]) ) { return $this->_zen->ffv(tr($vals["$value"])); }
           else {
             $this->_zen->addDebug("getTextValue", "Unable to find choices for {$view}->{$field_name}", 1);
-            return $this->_zen->ffv($value); 
+            return $this->_zen->ffv($value, $field['num_cols']); 
           }
         case "user_id":
         case "creator_id":
@@ -304,6 +314,10 @@
         case "custom_boolean":
           $val = $value == 1? tr('Yes') : tr('No');
           return $this->_zen->ffv($val,$field['num_cols']);
+        case "details":
+        case "title":
+        case "custom_text":
+          return $this->_zen->ffvText($value);
         default:
           $val = $this->_zen->ffv($value, $field['num_cols']);
           $this->_zen->addDebug("getTextValue", "rendering default: $val", 3);
@@ -325,7 +339,7 @@
    * @return string containing html to render
    */
   function renderTicketField( $view, $form_name, $field_name, $value = null, $override_name = null ) {
-    //$this->_zen->addDebug("renderTicketField", "rendering $view, $form_name, $field_name, $value, $override_name", 1);//debug
+//    $this->_zen->addDebug("renderTicketField", "rendering $view, $form_name, $field_name, $value, $override_name", 1);//debug
     global $templateDir;
     global $rootUrl;
     
@@ -357,8 +371,15 @@
     $vals['date_format'] = $this->_zen->popupDateFormat();
     $vals["field_name"] = $this->_zen->ffv(strlen($override_name)>0? $override_name : $field_name);
     
-    if( !isset($value) && ($view=="ticket_create" || $view=="project_create")) {
+    if( !isset($value) && ($view=="ticket_create" || $view=="project_create"
+         || $view == 'search_form' )) {
+      // if there is no value and this is a create page or search page then we will
+      // retrieve a default value to use instead
       $vals["field_value"] = $this->getDefaultValue($view,$field_name);
+    } else if( $typeint == ZTFIELD_DATE && !preg_match('/[^0-9]/', $value) ) {
+      // if it is a date and we have a numeric value, then we will parse it to
+      // a date right here
+      
     } else {
       $vals["field_value"] = $this->_zen->ffv($value);
     }
@@ -659,9 +680,8 @@
     $this->_zen->addDebug('_getChoices', "Generated ".count($vals)." choices for {$view}->{$field_name}", 3);
     
     if( $view == 'search_form' && $field['num_rows'] == 1 ) {
-      $vals = array_merge( array(''=>'-any-'), $vals );
+      $vals = array(''=>'-any-') + $vals ;
     }
-    
     if( !isset($this->_fieldVals[$view]) ) { $this->_fieldVals[$view] = array(); }
     $this->_fieldVals[$view][$field_name] = $vals;
     return $vals;
diff -Naur zentrack_2-5-5-PRE1/includes/ZenSessionManager.class zentrack_2-5-5-1/includes/ZenSessionManager.class
--- zentrack_2-5-5-PRE1/includes/ZenSessionManager.class	2005-02-28 12:02:28.000000000 -0800
+++ zentrack_2-5-5-1/includes/ZenSessionManager.class	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 /**
  * Manages session information for ZT
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-csvlib.inc.php zentrack_2-5-5-1/includes/adodb/adodb-csvlib.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-csvlib.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-csvlib.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -7,7 +7,8 @@
 $ADODB_INCLUDED_CSV = 1;
 
 /* 
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. See License.txt. 
@@ -66,10 +67,15 @@
 			$o =& $rs->FetchField($i);
 			$flds[] = $o;
 		}
-		
-		$rs =& new ADORecordSet_array();
-		$rs->InitArrayFields($rows,$flds);
-		return $line.serialize($rs);
+	
+		$savefetch = isset($rs->adodbFetchMode) ? $rs->adodbFetchMode : $rs->fetchMode;
+		$class = $rs->connection->arrayClass;
+		$rs2 =& new $class();
+		$rs2->sql = $rs->sql;
+		$rs2->oldProvider = $rs->dataProvider; 
+		$rs2->InitArrayFields($rows,$flds);
+		$rs2->fetchMode = $savefetch;
+		return $line.serialize($rs2);
 	}
 
 	
@@ -84,7 +90,7 @@
 *			error occurred in sql INSERT/UPDATE/DELETE, 
 *			empty recordset is returned
 */
-	function &csv2rs($url,&$err,$timeout=0)
+	function &csv2rs($url,&$err,$timeout=0, $rsclass='ADORecordSet_array')
 	{
 		$err = false;
 		$fp = @fopen($url,'rb');
@@ -121,11 +127,12 @@
 						$err = " Illegal Timeout $timeout ";
 						return false;
 					}
+					
+					$rs =& new $rsclass($val=true);
 					$rs->fields = array();
 					$rs->timeCreated = $meta[1];
-					$rs =& new ADORecordSet($val=true);
 					$rs->EOF = true;
-					$rs->_numOfFields=0;
+					$rs->_numOfFields = 0;
 					$rs->sql = urldecode($meta[2]);
 					$rs->affectedrows = (integer)$meta[3];
 					$rs->insertid = $meta[4];	
@@ -244,7 +251,7 @@
 			if (get_magic_quotes_runtime()) $err .= ". Magic Quotes Runtime should be disabled!";
 			return false;
 		}
-		$rs =& new ADORecordSet_array();
+		$rs =& new $rsclass();
 		$rs->timeCreated = $ttl;
 		$rs->InitArrayFields($arr,$flds);
 		return $rs;
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-datadict.inc.php zentrack_2-5-5-1/includes/adodb/adodb-datadict.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-datadict.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-datadict.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -22,7 +22,7 @@
 
 function Lens_ParseTest()
 {
-$str = "`zcol ACOL` NUMBER(32,2) DEFAULT 'The \"cow\" (and Jim''s dog) jumps over the moon' PRIMARY, INTI INT AUTO DEFAULT 0";
+$str = "`zcol ACOL` NUMBER(32,2) DEFAULT 'The \"cow\" (and Jim''s dog) jumps over the moon' PRIMARY, INTI INT AUTO DEFAULT 0, zcol2\"afs ds";
 print "<p>$str</p>";
 $a= Lens_ParseArgs($str);
 print "<pre>";
@@ -30,6 +30,7 @@
 print "</pre>";
 }
 
+
 if (!function_exists('ctype_alnum')) {
 	function ctype_alnum($text) {
 		return preg_match('/^[a-z0-9]*$/i', $text);
@@ -153,6 +154,7 @@
 		}
 		$pos += 1;
 	}
+	if ($intoken) $tokens[$stmtno][] = implode('',$tokarr);
 	
 	return $tokens;
 }
@@ -162,15 +164,18 @@
 	var $connection;
 	var $debug = false;
 	var $dropTable = 'DROP TABLE %s';
+	var $renameTable = 'RENAME TABLE %s TO %s'; 
 	var $dropIndex = 'DROP INDEX %s';
 	var $addCol = ' ADD';
 	var $alterCol = ' ALTER COLUMN';
 	var $dropCol = ' DROP COLUMN';
+	var $renameColumn = 'ALTER TABLE %s RENAME COLUMN %s TO %s';	// table, old-column, new-column, column-definitions (not used by default)
 	var $nameRegex = '\w';
 	var $schema = false;
 	var $serverInfo = array();
 	var $autoIncrement = false;
 	var $dataProvider;
+	var $invalidResizeTypes4 = array('CLOB','BLOB','TEXT','DATE','TIME'); // for changetablesql
 	var $blobSize = 100; 	/// any varchar/char field this size or greater is treated as a blob
 							/// in other words, we use a text area for editting.
 	
@@ -186,21 +191,25 @@
 	
 	function &MetaTables()
 	{
+		if (!$this->connection->IsConnected()) return array();
 		return $this->connection->MetaTables();
 	}
 	
 	function &MetaColumns($tab, $upper=true, $schema=false)
 	{
+		if (!$this->connection->IsConnected()) return array();
 		return $this->connection->MetaColumns($this->TableName($tab), $upper, $schema);
 	}
 	
 	function &MetaPrimaryKeys($tab,$owner=false,$intkey=false)
 	{
+		if (!$this->connection->IsConnected()) return array();
 		return $this->connection->MetaPrimaryKeys($this->TableName($tab), $owner, $intkey);
 	}
 	
 	function &MetaIndexes($table, $primary = false, $owner = false)
 	{
+		if (!$this->connection->IsConnected()) return array();
 		return $this->connection->MetaIndexes($this->TableName($table), $primary, $owner);
 	}
 	
@@ -338,7 +347,18 @@
 		return $sql;
 	}
 	
-	function AlterColumnSQL($tabname, $flds)
+	/**
+	 * Change the definition of one column
+	 *
+	 * As some DBM's can't do that on there own, you need to supply the complete defintion of the new table,
+	 * to allow, recreating the table and copying the content over to the new table
+	 * @param string $tabname table-name
+	 * @param string $flds column-name and type for the changed column
+	 * @param string $tableflds='' complete defintion of the new table, eg. for postgres, default ''
+	 * @param array/string $tableoptions='' options for the new table see CreateTableSQL, default ''
+	 * @return array with SQL strings
+	 */
+	function AlterColumnSQL($tabname, $flds, $tableflds='',$tableoptions='')
 	{
 		$tabname = $this->TableName ($tabname);
 		$sql = array();
@@ -350,7 +370,39 @@
 		return $sql;
 	}
 	
-	function DropColumnSQL($tabname, $flds)
+	/**
+	 * Rename one column
+	 *
+	 * Some DBM's can only do this together with changeing the type of the column (even if that stays the same, eg. mysql)
+	 * @param string $tabname table-name
+	 * @param string $oldcolumn column-name to be renamed
+	 * @param string $newcolumn new column-name
+	 * @param string $flds='' complete column-defintion-string like for AddColumnSQL, only used by mysql atm., default=''
+	 * @return array with SQL strings
+	 */
+	function RenameColumnSQL($tabname,$oldcolumn,$newcolumn,$flds='')
+	{
+		$tabname = $this->TableName ($tabname);
+		if ($flds) {
+			list($lines,$pkey) = $this->_GenFields($flds);
+			list(,$first) = each($lines);
+			list(,$column_def) = split("[\t ]+",$first,2);
+		}
+		return array(sprintf($this->renameColumn,$tabname,$this->NameQuote($oldcolumn),$this->NameQuote($newcolumn),$column_def));
+	}
+		
+	/**
+	 * Drop one column
+	 *
+	 * Some DBM's can't do that on there own, you need to supply the complete defintion of the new table,
+	 * to allow, recreating the table and copying the content over to the new table
+	 * @param string $tabname table-name
+	 * @param string $flds column-name and type for the changed column
+	 * @param string $tableflds='' complete defintion of the new table, eg. for postgres, default ''
+	 * @param array/string $tableoptions='' options for the new table see CreateTableSQL, default ''
+	 * @return array with SQL strings
+	 */
+	function DropColumnSQL($tabname, $flds, $tableflds='',$tableoptions='')
 	{
 		$tabname = $this->TableName ($tabname);
 		if (!is_array($flds)) $flds = explode(',',$flds);
@@ -367,6 +419,11 @@
 		return array (sprintf($this->dropTable, $this->TableName($tabname)));
 	}
 	
+	function RenameTableSQL($tabname,$newname)
+	{
+		return array (sprintf($this->renameTable, $this->TableName($tabname),$this->TableName($newname)));
+	}	
+	
 	/*
 	 Generate the SQL to create table. Returns an array of sql strings.
 	*/
@@ -374,7 +431,7 @@
 	{
 		if (!$tableoptions) $tableoptions = array();
 		
-		list($lines,$pkey) = $this->_GenFields($flds);
+		list($lines,$pkey) = $this->_GenFields($flds, true);
 		
 		$taboptions = $this->_Options($tableoptions);
 		$tabname = $this->TableName ($tabname);
@@ -386,7 +443,7 @@
 		return $sql;
 	}
 	
-	function _GenFields($flds)
+	function _GenFields($flds,$widespacing=false)
 	{
 		if (is_string($flds)) {
 			$padding = '     ';
@@ -517,7 +574,7 @@
 						$fdefault = $this->connection->qstr($fdefault);
 			$suffix = $this->_CreateSuffix($fname,$ftype,$fnotnull,$fdefault,$fautoinc,$fconstraint,$funsigned);
 			
-			$fname = str_pad($fname,16);
+			if ($widespacing) $fname = str_pad($fname,24);
 			$lines[$fid] = $fname.' '.$ftype.$suffix;
 			
 			if ($fautoinc) $this->autoIncrement = true;
@@ -642,26 +699,69 @@
 	}
 	
 	/*
-	"Florian Buzin [ easywe ]" <florian.buzin@easywe.de>
+	"Florian Buzin [ easywe ]" <florian.buzin#easywe.de>
 	
 	This function changes/adds new fields to your table. You don't
 	have to know if the col is new or not. It will check on its own.
 	*/
 	function ChangeTableSQL($tablename, $flds, $tableoptions = false)
 	{
+	global $ADODB_FETCH_MODE;
+	
+		$save = $ADODB_FETCH_MODE;
+		$ADODB_FETCH_MODE = ADODB_FETCH_ASSOC;
+		if ($this->connection->fetchMode !== false) $savem = $this->connection->SetFetchMode(false);
+		
 		// check table exists
+		$save_handler = $this->connection->raiseErrorFn;
+		$this->connection->raiseErrorFn = '';
 		$cols = &$this->MetaColumns($tablename);
+		$this->connection->raiseErrorFn = $save_handler;
+		
+		if (isset($savem)) $this->connection->SetFetchMode($savem);
+		$ADODB_FETCH_MODE = $save;
+		
 		if ( empty($cols)) { 
 			return $this->CreateTableSQL($tablename, $flds, $tableoptions);
 		}
 		
+		if (is_array($flds)) {
+		// Cycle through the update fields, comparing
+		// existing fields to fields to update.
+		// if the Metatype and size is exactly the
+		// same, ignore - by Mark Newham
+			$holdflds = array();
+			foreach($flds as $k=>$v) {
+				if ( isset($cols[$k]) && is_object($cols[$k]) ) {
+					$c = $cols[$k];
+					$ml = $c->max_length;
+					$mt = &$this->MetaType($c->type,$ml);
+					if ($ml == -1) $ml = '';
+					if ($mt == 'X') $ml = $v['SIZE'];
+					if (($mt != $v['TYPE']) ||  $ml != $v['SIZE']) {
+						$holdflds[$k] = $v;
+					}
+				} else {
+					$holdflds[$k] = $v;
+				}		
+			}
+			$flds = $holdflds;
+		}
+	
+
 		// already exists, alter table instead
 		list($lines,$pkey) = $this->_GenFields($flds);
 		$alter = 'ALTER TABLE ' . $this->TableName($tablename);
 		$sql = array();
-		
+
 		foreach ( $lines as $id => $v ) {
 			if ( isset($cols[$id]) && is_object($cols[$id]) ) {
+			
+				$flds = Lens_ParseArgs($v,',');
+				
+				//  We are trying to change the size of the field, if not allowed, simply ignore the request.
+				if ($flds && in_array(strtoupper(substr($flds[0][1],0,4)),$this->invalidResizeTypes4)) continue;	 
+	 		
 				$sql[] = $alter . $this->alterCol . ' ' . $v;
 			} else {
 				$sql[] = $alter . $this->addCol . ' ' . $v;
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-error.inc.php zentrack_2-5-5-1/includes/adodb/adodb-error.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-error.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-error.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /** 
- * @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license. 
  * Whenever there is any discrepancy between the two licenses, 
  * the BSD license will take precedence. 
@@ -249,7 +249,8 @@
            1136 => DB_ERROR_VALUE_COUNT_ON_ROW,
            1146 => DB_ERROR_NOSUCHTABLE,
            1048 => DB_ERROR_CONSTRAINT,
-		    2002 => DB_ERROR_CONNECT_FAILED
+		    2002 => DB_ERROR_CONNECT_FAILED,
+			2005 => DB_ERROR_CONNECT_FAILED
        );
 	   
 	return $MAP;
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-errorhandler.inc.php zentrack_2-5-5-1/includes/adodb/adodb-errorhandler.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-errorhandler.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-errorhandler.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /**
- * @version V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license.
  * Whenever there is any discrepancy between the two licenses,
  * the BSD license will take precedence.
@@ -15,7 +15,7 @@
 // added Claudio Bustos  clbustos#entelchile.net
 if (!defined('ADODB_ERROR_HANDLER_TYPE')) define('ADODB_ERROR_HANDLER_TYPE',E_USER_ERROR); 
 
-define('ADODB_ERROR_HANDLER','ADODB_Error_Handler');
+if (!defined('ADODB_ERROR_HANDLER')) define('ADODB_ERROR_HANDLER','ADODB_Error_Handler');
 
 /**
 * Default Error Handler. This will be called with the following params
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-errorpear.inc.php zentrack_2-5-5-1/includes/adodb/adodb-errorpear.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-errorpear.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-errorpear.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /** 
- * @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -12,7 +12,7 @@
 */
 include_once('PEAR.php');
 
-define('ADODB_ERROR_HANDLER','ADODB_Error_PEAR');
+if (!defined('ADODB_ERROR_HANDLER')) define('ADODB_ERROR_HANDLER','ADODB_Error_PEAR');
 
 /*
 * Enabled the following if you want to terminate scripts when an error occurs
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-exceptions.inc.php zentrack_2-5-5-1/includes/adodb/adodb-exceptions.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-exceptions.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-exceptions.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
- * @version V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license.
  * Whenever there is any discrepancy between the two licenses,
  * the BSD license will take precedence.
@@ -69,7 +69,8 @@
 function adodb_throw($dbms, $fn, $errno, $errmsg, $p1, $p2, $thisConnection)
 {
 global $ADODB_EXCEPTION;
-
+	
+	if (error_reporting() == 0) return; // obey @ protocol
 	if (is_string($ADODB_EXCEPTION)) $errfn = $ADODB_EXCEPTION;
 	else $errfn = 'ADODB_EXCEPTION';
 	throw new $errfn($dbms, $fn, $errno, $errmsg, $p1, $p2, $thisConnection);
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-iterator.inc.php zentrack_2-5-5-1/includes/adodb/adodb-iterator.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-iterator.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-iterator.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /*
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -73,6 +73,7 @@
         return new ADODB_Iterator($this);
     }
 	
+	/* this is experimental - i don't really know what to return... */
 	function __toString()
 	{
 		include_once(ADODB_DIR.'/toexport.inc.php');
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-lib.inc.php zentrack_2-5-5-1/includes/adodb/adodb-lib.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-lib.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-lib.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -7,7 +7,7 @@
 $ADODB_INCLUDED_LIB = 1;
 
 /* 
- @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim\@natsoft.com.my). All rights reserved.
+ @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim\@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. See License.txt. 
@@ -22,6 +22,7 @@
 function _array_change_key_case($an_array)
 {
 	if (is_array($an_array)) {
+		$new_array = array();
 		foreach($an_array as $key=>$value)
 			$new_array[strtoupper($key)] = $value;
 
@@ -114,12 +115,12 @@
 
 	if ($multiple or is_array($defstr)) {
 		if ($size==0) $size=5;
-		$attr = " multiple size=$size";
+		$attr = ' multiple size="'.$size.'"';
 		if (!strpos($name,'[]')) $name .= '[]';
-	} else if ($size) $attr = " size=$size";
+	} else if ($size) $attr = ' size="'.$size.'"';
 	else $attr ='';
-
-	$s = "<select name=\"$name\"$attr $selectAttr>";
+	
+	$s = '<select name="'.$name.'"'.$attr.' '.$selectAttr.'>';
 	if ($blank1stItem) 
 		if (is_string($blank1stItem))  {
 			$barr = explode(':',$blank1stItem);
@@ -183,7 +184,12 @@
 		if ($zthis->dataProvider == 'oci8') {
 			
 			$rewritesql = preg_replace('/(\sORDER\s+BY\s.*)/is','',$sql);
-			$rewritesql = "SELECT COUNT(*) FROM ($rewritesql)"; 
+			
+			// Allow Oracle hints to be used for query optimization, Chris Wrye
+			if (preg_match('#/\\*+.*?\\*\\/#', $sql, $hint)) {
+				$rewritesql = "SELECT ".$hint[0]." COUNT(*) FROM (".$rewritesql.")"; 
+			} else
+				$rewritesql = "SELECT COUNT(*) FROM (".$rewritesql.")"; 
 			
 		} else if ( $zthis->databaseType == 'postgres' || $zthis->databaseType == 'postgres7')  {
 			
@@ -416,9 +422,9 @@
                 // is_null requires php 4.0.4
                 //********************************************************//
                 if (is_null($arrFields[$upperfname])
+					|| (empty($arrFields[$upperfname]) && strlen($arrFields[$upperfname]) == 0)
                     || $arrFields[$upperfname] === 'null'
-                    || $arrFields[$upperfname] === ''
-                    || empty($arrFields[$upperfname]))
+                    )
                 {
                     switch ($force) {
 
@@ -462,7 +468,8 @@
 		// If there were any modified fields then build the rest of the update query.
 		if ($fieldUpdatedCount > 0 || $forceUpdate) {
 					// Get the table name from the existing query.
-			preg_match("/FROM\s+".ADODB_TABLE_REGEX."/is", $rs->sql, $tableName);
+			if (!empty($rs->tableName)) $tableName = $rs->tableName;
+			else preg_match("/FROM\s+".ADODB_TABLE_REGEX."/is", $rs->sql, $tableName);
 	
 			// Get the full where clause excluding the word "WHERE" from
 			// the existing query.
@@ -472,7 +479,8 @@
 			// not a good hack, improvements?
 			if ($whereClause) {
 				if (preg_match('/\s(ORDER\s.*)/is', $whereClause[1], $discard));
-				else preg_match('/\s(LIMIT\s.*)/is', $whereClause[1], $discard);
+				else if (preg_match('/\s(LIMIT\s.*)/is', $whereClause[1], $discard));
+				else preg_match('/\s(FOR UPDATE.*)/is', $whereClause[1], $discard);
 			} else
 				$whereClause = array(false,false);
 				
@@ -512,6 +520,10 @@
  */
 function _adodb_getinsertsql(&$zthis,&$rs,$arrFields,$magicq=false,$force=2)
 {
+static $cacheRS = false;
+static $cacheSig = 0;
+static $cacheCols;
+
 	$tableName = '';
 	$values = '';
 	$fields = '';
@@ -530,11 +542,24 @@
 		$rsclass = $zthis->rsPrefix.$zthis->databaseType;
 		$recordSet =& new $rsclass(-1,$zthis->fetchMode);
 		$recordSet->connection = &$zthis;
-	
-		$columns = $zthis->MetaColumns( $tableName );
+		
+		if (is_string($cacheRS) && $cacheRS == $rs) {
+			$columns =& $cacheCols;
+		} else {
+			$columns = $zthis->MetaColumns( $tableName );
+			$cacheRS = $tableName;
+			$cacheCols = $columns;
+		}
 	} else if (is_subclass_of($rs, 'adorecordset')) {
-		for ($i=0, $max=$rs->FieldCount(); $i < $max; $i++) 
-			$columns[] = $rs->FetchField($i);
+		if (isset($rs->insertSig) && is_integer($cacheRS) && $cacheRS == $rs->insertSig) {
+			$columns =& $cacheCols;
+		} else {
+			for ($i=0, $max=$rs->FieldCount(); $i < $max; $i++) 
+				$columns[] = $rs->FetchField($i);
+			$cacheRS = $cacheSig;
+			$cacheCols = $columns;
+			$rs->insertSig = $cacheSig++;
+		}
 		$recordSet =& $rs;
 	
 	} else {
@@ -556,9 +581,9 @@
 			
             /********************************************************/
             if (is_null($arrFields[$upperfname])
+                || (empty($arrFields[$upperfname]) && strlen($arrFields[$upperfname]) == 0)
                 || $arrFields[$upperfname] === 'null'
-                || $arrFields[$upperfname] === ''
-                || empty($arrFields[$upperfname]))
+				)
                {
                     switch ($force) {
 
@@ -613,7 +638,8 @@
 	
 	// Get the table name from the existing query.
 	if (!$tableName) {
-		if (preg_match("/FROM\s+".ADODB_TABLE_REGEX."/is", $rs->sql, $tableName))
+		if (!empty($rs->tableName)) $tableName = $rs->tableName;
+		else if (preg_match("/FROM\s+".ADODB_TABLE_REGEX."/is", $rs->sql, $tableName))
 			$tableName = $tableName[1];
 		else 
 			return false;
@@ -724,57 +750,39 @@
 			
 		}
 	}
-	
-	$sql = '';
 		
 	switch($type) {
 		case "C":
 		case "X":
 		case 'B':
-			if ($action == 'I') {
-				$sql = $zthis->qstr($arrFields[$fname],$magicq) . ", ";
-			} else {
-				$sql .= $fnameq . "=" . $zthis->qstr($arrFields[$fname],$magicq) . ", ";
-			}
-		  break;
+			$val = $zthis->qstr($arrFields[$fname],$magicq);
+			break;
 
 		case "D":
-			if ($action == 'I') {
-				$sql = $zthis->DBDate($arrFields[$fname]) . ", ";
-			} else {
-				$sql .= $fnameq . "=" . $zthis->DBDate($arrFields[$fname]) . ", ";
-			}
+			$val = $zthis->DBDate($arrFields[$fname]);
 			break;
 
 		case "T":
-			if ($action == 'I') {
-				$sql = $zthis->DBTimeStamp($arrFields[$fname]) . ", ";
-			} else {
-				$sql .= $fnameq . "=" . $zthis->DBTimeStamp($arrFields[$fname]) . ", ";
-			}
+			$val = $zthis->DBTimeStamp($arrFields[$fname]);
 			break;
 
 		default:
 			$val = $arrFields[$fname];
 			if (empty($val)) $val = '0';
-
-
-			if ($action == 'I') {
-				$sql .= $val . ", ";
-			} else {
-				$sql .= $fnameq . "=" . $val  . ", ";
-			}
 			break;
 	}
 
-	return $sql;
+	if ($action == 'I') return $val . ", ";
+	
+	
+	return $fnameq . "=" . $val  . ", ";
+	
 }
 
 
 
 function _adodb_debug_execute(&$zthis, $sql, $inputarr)
 {
-global $HTTP_SERVER_VARS;
 
 	$ss = '';
 	if ($inputarr) {
@@ -787,18 +795,20 @@
 	$sqlTxt = str_replace(',',', ',is_array($sql) ? $sql[0] : $sql);
 
 	// check if running from browser or command-line
-	$inBrowser = isset($HTTP_SERVER_VARS['HTTP_USER_AGENT']);
+	$inBrowser = isset($_SERVER['HTTP_USER_AGENT']);
 	
+	$dbt = $zthis->databaseType;
+	if (isset($zthis->dsnType)) $dbt .= '-'.$zthis->dsnType;
 	if ($inBrowser) {
 		$ss = htmlspecialchars($ss);
 		if ($zthis->debug === -1)
-			ADOConnection::outp( "<br>\n($zthis->databaseType): ".htmlspecialchars($sqlTxt)." &nbsp; <code>$ss</code>\n<br>\n",false);
+			ADOConnection::outp( "<br>\n($dbt): ".htmlspecialchars($sqlTxt)." &nbsp; <code>$ss</code>\n<br>\n",false);
 		else 
-			ADOConnection::outp( "<hr>\n($zthis->databaseType): ".htmlspecialchars($sqlTxt)." &nbsp; <code>$ss</code>\n<hr>\n",false);
+			ADOConnection::outp( "<hr>\n($dbt): ".htmlspecialchars($sqlTxt)." &nbsp; <code>$ss</code>\n<hr>\n",false);
 	} else {
-		ADOConnection::outp("-----\n($zthis->databaseType): ".$sqlTxt."\n-----\n",false);
+		ADOConnection::outp("-----\n($dbt): ".$sqlTxt."\n-----\n",false);
 	}
-	
+
 	$qID = $zthis->_query($sql,$inputarr);
 	
 	/* 
@@ -825,7 +835,7 @@
 	$html =  (isset($_SERVER['HTTP_USER_AGENT']));
 	$fmt =  ($html) ? "</font><font color=#808080 size=-1> %% line %4d, file: <a href=\"file:/%s\">%s</a></font>" : "%% line %4d, file: %s";
 
-	$MAXSTRLEN = 64;
+	$MAXSTRLEN = 128;
 
 	$s = ($html) ? '<pre align=left>' : '';
 	
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-pager.inc.php zentrack_2-5-5-1/includes/adodb/adodb-pager.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-pager.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-pager.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /*
-	V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+	V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
 	  Released under both BSD license and Lesser GPL library license. 
 	  Whenever there is any discrepancy between the two licenses, 
 	  the BSD license will take precedence. 
@@ -57,10 +57,10 @@
 	//
 	function ADODB_Pager(&$db,$sql,$id = 'adodb', $showPageLinks = false)
 	{
-	global $HTTP_SERVER_VARS,$PHP_SELF,$HTTP_SESSION_VARS,$HTTP_GET_VARS;
+	global $PHP_SELF;
 	
 		$curr_page = $id.'_curr_page';
-		if (empty($PHP_SELF)) $PHP_SELF = $HTTP_SERVER_VARS['PHP_SELF'];
+		if (empty($PHP_SELF)) $PHP_SELF = $_SERVER['PHP_SELF'];
 		
 		$this->sql = $sql;
 		$this->id = $id;
@@ -69,12 +69,12 @@
 		
 		$next_page = $id.'_next_page';	
 		
-		if (isset($HTTP_GET_VARS[$next_page])) {
-			$HTTP_SESSION_VARS[$curr_page] = $HTTP_GET_VARS[$next_page];
+		if (isset($_GET[$next_page])) {
+			$_SESSION[$curr_page] = $_GET[$next_page];
 		}
-		if (empty($HTTP_SESSION_VARS[$curr_page])) $HTTP_SESSION_VARS[$curr_page] = 1; ## at first page
+		if (empty($_SESSION[$curr_page])) $_SESSION[$curr_page] = 1; ## at first page
 		
-		$this->curr_page = $HTTP_SESSION_VARS[$curr_page];
+		$this->curr_page = $_SESSION[$curr_page];
 		
 	}
 	
@@ -242,6 +242,8 @@
 	
 		$this->rows = $rows;
 		
+		if ($this->db->dataProvider == 'informix') $this->db->cursorType = IFX_SCROLL;
+		
 		$savec = $ADODB_COUNTRECS;
 		if ($this->db->pageExecuteCountRows) $ADODB_COUNTRECS = true;
 		if ($this->cache)
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-pear.inc.php zentrack_2-5-5-1/includes/adodb/adodb-pear.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-pear.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-pear.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /** 
- * @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license. 
  * Whenever there is any discrepancy between the two licenses, 
  * the BSD license will take precedence. 
@@ -51,6 +51,11 @@
 if (!defined('DB_OK')) {
 define("DB_OK",	1);
 define("DB_ERROR",-1);
+
+// autoExecute constants
+define('DB_AUTOQUERY_INSERT', 1);
+define('DB_AUTOQUERY_UPDATE', 2);
+
 /**
  * This is a special constant that tells DB the user hasn't specified
  * any particular get mode, so the default should be used.
@@ -160,6 +165,7 @@
 		if (is_array($options)) {
 			foreach($options as $k => $v) {
 				switch(strtolower($k)) {
+				case 'persist':
 				case 'persistent': 	$persist = $v; break;
 				#ibase
 				case 'dialect': 	$obj->dialect = $v; break;
@@ -204,9 +210,10 @@
 	 */
 	function isError($value)
 	{
-		return (is_object($value) &&
-				(get_class($value) == 'db_error' ||
-				 is_subclass_of($value, 'db_error')));
+		if (!is_object($value)) return false;
+		$class = get_class($value);
+		return $class == 'pear_error' || is_subclass_of($value, 'pear_error') || 
+				$class == 'db_error' || is_subclass_of($value, 'db_error');
 	}
 
 
@@ -221,9 +228,11 @@
 	 */
 	function isWarning($value)
 	{
+		return false;
+		/*
 		return is_object($value) &&
 			(get_class( $value ) == "db_warning" ||
-			 is_subclass_of($value, "db_warning"));
+			 is_subclass_of($value, "db_warning"));*/
 	}
 
 	/**
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-perf.inc.php zentrack_2-5-5-1/includes/adodb/adodb-perf.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-perf.inc.php	2004-09-08 17:31:45.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-perf.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. See License.txt. 
@@ -37,7 +37,6 @@
 /* sql code timing */
 function& adodb_log_sql(&$conn,$sql,$inputarr)
 {
-global $HTTP_SERVER_VARS;
 	
     $perf_table = adodb_perf::table();
 	$conn->fnExecute = false;
@@ -73,20 +72,26 @@
 			$conn->lastInsID = @$conn->Insert_ID();
 			$conn->debug = $dbg;
 		}
-		if (isset($HTTP_SERVER_VARS['HTTP_HOST'])) {
-			$tracer .= '<br>'.$HTTP_SERVER_VARS['HTTP_HOST'];
-			if (isset($HTTP_SERVER_VARS['PHP_SELF'])) $tracer .= $HTTP_SERVER_VARS['PHP_SELF'];
+		if (isset($_SERVER['HTTP_HOST'])) {
+			$tracer .= '<br>'.$_SERVER['HTTP_HOST'];
+			if (isset($_SERVER['PHP_SELF'])) $tracer .= $_SERVER['PHP_SELF'];
 		} else 
-			if (isset($HTTP_SERVER_VARS['PHP_SELF'])) $tracer .= '<br>'.$HTTP_SERVER_VARS['PHP_SELF'];
+			if (isset($_SERVER['PHP_SELF'])) $tracer .= '<br>'.$_SERVER['PHP_SELF'];
 		//$tracer .= (string) adodb_backtrace(false);
 		
-		$tracer = substr($tracer,0,500);
+		$tracer = (string) substr($tracer,0,500);
 		
 		if (is_array($inputarr)) {
 			if (is_array(reset($inputarr))) $params = 'Array sizeof='.sizeof($inputarr);
 			else {
-				$params = '';
-				$params = implode(', ',$inputarr);
+				// Quote string parameters so we can see them in the
+				// performance stats. This helps spot disabled indexes.
+				$xar_params = $inputarr;
+				foreach ($xar_params as $xar_param_key => $xar_param) {
+					if (gettype($xar_param) == 'string')
+					$xar_params[$xar_param_key] = '"' . $xar_param . '"';
+				}
+				$params = implode(', ', $xar_params);
 				if (strlen($params) >= 3000) $params = substr($params, 0, 3000);
 			}
 		} else {
@@ -100,8 +105,10 @@
 		$saved = $conn->debug;
 		$conn->debug = 0;
 		
+		$d = $conn->sysTimeStamp;
+		if (empty($d)) $d = date("'Y-m-d H:i:s'");
 		if ($conn->dataProvider == 'oci8' && $dbT != 'oci8po') {
-			$isql = "insert into $perf_table values($conn->sysTimeStamp,:b,:c,:d,:e,:f)";
+			$isql = "insert into $perf_table values($d,:b,:c,:d,:e,:f)";
 		} else if ($dbT == 'odbc_mssql' || $dbT == 'informix') {
 			$timer = $arr['f'];
 			if ($dbT == 'informix') $sql2 = substr($sql2,0,230);
@@ -111,12 +118,13 @@
 			$params = $conn->qstr($arr['d']);
 			$tracer = $conn->qstr($arr['e']);
 			
-			$isql = "insert into $perf_table (created,sql0,sql1,params,tracer,timer) values($conn->sysTimeStamp,$sql1,$sql2,$params,$tracer,$timer)";
+			$isql = "insert into $perf_table (created,sql0,sql1,params,tracer,timer) values($d,$sql1,$sql2,$params,$tracer,$timer)";
 			if ($dbT == 'informix') $isql = str_replace(chr(10),' ',$isql);
 			$arr = false;
 		} else {
-			$isql = "insert into $perf_table (created,sql0,sql1,params,tracer,timer) values( $conn->sysTimeStamp,?,?,?,?,?)";
+			$isql = "insert into $perf_table (created,sql0,sql1,params,tracer,timer) values( $d,?,?,?,?,?)";
 		}
+
 		$ok = $conn->Execute($isql,$arr);
 		$conn->debug = $saved;
 		
@@ -138,7 +146,7 @@
 				timer decimal(16,6))");
 			}
 			if (!$ok) {
-				ADOConnection::outp( "<b>LOGSQL Insert Failed</b>: $isql<br>$err2</br>");
+				ADOConnection::outp( "<p><b>LOGSQL Insert Failed</b>: $isql<br>$err2</p>");
 				$conn->_logsql = false;
 			}
 		}
@@ -208,6 +216,12 @@
 		// Algorithm is taken from
 		// http://msdn.microsoft.com/library/default.asp?url=/library/en-us/wmisdk/wmi/example__obtaining_raw_performance_data.asp
 		if (strncmp(PHP_OS,'WIN',3)==0) {
+			if (PHP_VERSION == '5.0.0') return false;
+			if (PHP_VERSION == '5.0.1') return false;
+			if (PHP_VERSION == '5.0.2') return false;
+			if (PHP_VERSION == '5.0.3') return false;
+			if (PHP_VERSION == '4.3.10') return false; # see http://bugs.php.net/bug.php?id=31737
+			
 			@$c = new COM("WinMgmts:{impersonationLevel=impersonate}!Win32_PerfRawData_PerfOS_Processor.Name='_Total'");
 			if (!$c) return false;
 			
@@ -340,9 +354,8 @@
 	
 	function InvalidSQL($numsql = 10)
 	{
-	global $HTTP_GET_VARS;
 	
-		if (isset($HTTP_GET_VARS['sql'])) return;
+		if (isset($_GET['sql'])) return;
 		$s = '<h3>Invalid SQL</h3>';
 		$saveE = $this->conn->fnExecute;
 		$this->conn->fnExecute = false;
@@ -363,22 +376,23 @@
 	*/	
 	function _SuspiciousSQL($numsql = 10)
 	{
-		global $ADODB_FETCH_MODE,$HTTP_GET_VARS;
+		global $ADODB_FETCH_MODE;
 		
             $perf_table = adodb_perf::table();
 			$saveE = $this->conn->fnExecute;
 			$this->conn->fnExecute = false;
 			
-			if (isset($HTTP_GET_VARS['exps']) && isset($HTTP_GET_VARS['sql'])) {
-				$partial = !empty($HTTP_GET_VARS['part']);
-				echo "<a name=explain></a>".$this->Explain($HTTP_GET_VARS['sql'],$partial)."\n";
+			if (isset($_GET['exps']) && isset($_GET['sql'])) {
+				$partial = !empty($_GET['part']);
+				echo "<a name=explain></a>".$this->Explain($_GET['sql'],$partial)."\n";
 			}
 			
-			if (isset($HTTP_GET_VARS['sql'])) return;
+			if (isset($_GET['sql'])) return;
 			$sql1 = $this->sql1;
 			
 			$save = $ADODB_FETCH_MODE;
 			$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+			if ($this->conn->fetchMode !== false) $savem = $this->conn->SetFetchMode(false);
 			//$this->conn->debug=1;
 			$rs =& $this->conn->SelectLimit(
 			"select avg(timer) as avg_timer,$sql1,count(*),max(timer) as max_timer,min(timer) as min_timer
@@ -387,6 +401,7 @@
 				and (tracer is null or tracer not like 'ERROR:%')
 				group by sql1
 				order by 1 desc",$numsql);
+			if (isset($savem)) $this->conn->SetFetchMode($savem);
 			$ADODB_FETCH_MODE = $save;
 			$this->conn->fnExecute = $saveE;
 			
@@ -440,22 +455,24 @@
 	*/
 	function _ExpensiveSQL($numsql = 10)
 	{
-		global $HTTP_GET_VARS,$ADODB_FETCH_MODE;
+		global $ADODB_FETCH_MODE;
 		
             $perf_table = adodb_perf::table();
 			$saveE = $this->conn->fnExecute;
 			$this->conn->fnExecute = false;
 			
-			if (isset($HTTP_GET_VARS['expe']) && isset($HTTP_GET_VARS['sql'])) {
-				$partial = !empty($HTTP_GET_VARS['part']);
-				echo "<a name=explain></a>".$this->Explain($HTTP_GET_VARS['sql'],$partial)."\n";
+			if (isset($_GET['expe']) && isset($_GET['sql'])) {
+				$partial = !empty($_GET['part']);
+				echo "<a name=explain></a>".$this->Explain($_GET['sql'],$partial)."\n";
 			}
 			
-			if (isset($HTTP_GET_VARS['sql'])) return;
+			if (isset($_GET['sql'])) return;
 			
 			$sql1 = $this->sql1;
 			$save = $ADODB_FETCH_MODE;
 			$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+			if ($this->conn->fetchMode !== false) $savem = $this->conn->SetFetchMode(false);
+			
 			$rs =& $this->conn->SelectLimit(
 			"select sum(timer) as total,$sql1,count(*),max(timer) as max_timer,min(timer) as min_timer
 				from $perf_table
@@ -463,7 +480,7 @@
 				and (tracer is null or tracer not like 'ERROR:%')
 				group by sql1
 				order by 1 desc",$numsql);
-			
+			if (isset($savem)) $this->conn->SetFetchMode($savem);
 			$this->conn->fnExecute = $saveE;
 			$ADODB_FETCH_MODE = $save;
 			if (!$rs) return "<p>$this->helpurl. ".$this->conn->ErrorMsg()."</p>";
@@ -577,7 +594,6 @@
 	
 	function UI($pollsecs=5)
 	{
-	global $HTTP_GET_VARS,$HTTP_SERVER_VARS,$HTTP_POST_VARS;
 	
     $perf_table = adodb_perf::table();
 	$conn = $this->conn;
@@ -589,15 +605,15 @@
 	if ($app) $app .= ', ';
 	$savelog = $this->conn->LogSQL(false);	
 	$info = $conn->ServerInfo();
-	if (isset($HTTP_GET_VARS['clearsql'])) {
+	if (isset($_GET['clearsql'])) {
 		$this->conn->Execute("delete from $perf_table");
 	}
 	$this->conn->LogSQL($savelog);
 	
 	// magic quotes
 	
-	if (isset($HTTP_GET_VARS['sql']) && get_magic_quotes_gpc()) {
-		$_GET['sql'] = $HTTP_GET_VARS['sql'] = str_replace(array("\\'",'\"'),array("'",'"'),$HTTP_GET_VARS['sql']);
+	if (isset($_GET['sql']) && get_magic_quotes_gpc()) {
+		$_GET['sql'] = $_GET['sql'] = str_replace(array("\\'",'\"'),array("'",'"'),$_GET['sql']);
 	}
 	
 	if (!isset($_SESSION['ADODB_PERF_SQL'])) $nsql = $_SESSION['ADODB_PERF_SQL'] = 10;
@@ -606,13 +622,13 @@
 	$app .= $info['description'];
 	
 	
-	if (isset($HTTP_GET_VARS['do'])) $do = $HTTP_GET_VARS['do'];
-	else if (isset($HTTP_POST_VARS['do'])) $do = $HTTP_POST_VARS['do'];
-	 else if (isset($HTTP_GET_VARS['sql'])) $do = 'viewsql';
+	if (isset($_GET['do'])) $do = $_GET['do'];
+	else if (isset($_POST['do'])) $do = $_POST['do'];
+	 else if (isset($_GET['sql'])) $do = 'viewsql';
 	 else $do = 'stats';
 	 
-	if (isset($HTTP_GET_VARS['nsql'])) {
-		if ($HTTP_GET_VARS['nsql'] > 0) $nsql = $_SESSION['ADODB_PERF_SQL'] = (integer) $HTTP_GET_VARS['nsql'];
+	if (isset($_GET['nsql'])) {
+		if ($_GET['nsql'] > 0) $nsql = $_SESSION['ADODB_PERF_SQL'] = (integer) $_GET['nsql'];
 	}
 	echo "<title>ADOdb Performance Monitor on $app</title><body bgcolor=white>";
 	if ($do == 'viewsql') $form = "<td><form># SQL:<input type=hidden value=viewsql name=do> <input type=text size=4 name=nsql value=$nsql><input type=submit value=Go></td></form>";
@@ -620,7 +636,7 @@
 	
 	$allowsql = !defined('ADODB_PERF_NO_RUN_SQL');
 	
-	if  (empty($HTTP_GET_VARS['hidem']))
+	if  (empty($_GET['hidem']))
 	echo "<table border=1 width=100% bgcolor=lightyellow><tr><td colspan=2>
 	<b><a href=http://adodb.sourceforge.net/?perf=1>ADOdb</a> Performance Monitor</b> <font size=1>for $app</font></tr><tr><td>
 	<a href=?do=stats><b>Performance Stats</b></a> &nbsp; <a href=?do=viewsql><b>View SQL</b></a>
@@ -639,7 +655,7 @@
 			break;
 		case 'poll':
 			echo "<iframe width=720 height=80% 
-				src=\"{$HTTP_SERVER_VARS['PHP_SELF']}?do=poll2&hidem=1\"></iframe>";
+				src=\"{$_SERVER['PHP_SELF']}?do=poll2&hidem=1\"></iframe>";
 			break;
 		case 'poll2':
 			echo "<pre>";
@@ -652,7 +668,7 @@
 			$this->DoSQLForm();
 			break;
 		case 'viewsql':
-			if (empty($HTTP_GET_VARS['hidem']))
+			if (empty($_GET['hidem']))
 				echo "&nbsp; <a href=\"?do=viewsql&clearsql=1\">Clear SQL Log</a><br>";
 			echo($this->SuspiciousSQL($nsql));
 			echo($this->ExpensiveSQL($nsql));
@@ -679,6 +695,7 @@
 		set_time_limit(0);
 		sleep($secs);
 		while (1) {
+
 			$arr =& $this->PollParameters();
 			
 			$hits   = sprintf('%2.2f',$arr[0]);
@@ -699,6 +716,8 @@
 			echo date('H:i:s').'  '.$osval."$hits  $sess $reads $writes\n";
 			flush();
 			
+			if (connection_aborted()) return;
+			
 			sleep($secs);
 			$arro = $arr;
 		}
@@ -809,24 +828,22 @@
 	
 	function DoSQLForm()
 	{
-	global $HTTP_SERVER_VARS,$HTTP_GET_VARS,$HTTP_POST_VARS,$HTTP_SESSION_VARS;
 	
-		$HTTP_VARS = array_merge($HTTP_GET_VARS,$HTTP_POST_VARS);
 		
-		$PHP_SELF = $HTTP_SERVER_VARS['PHP_SELF'];
-		$sql = isset($HTTP_VARS['sql']) ? $HTTP_VARS['sql'] : '';
+		$PHP_SELF = $_SERVER['PHP_SELF'];
+		$sql = isset($_REQUEST['sql']) ? $_REQUEST['sql'] : '';
 
-		if (isset($HTTP_SESSION_VARS['phplens_sqlrows'])) $rows = $HTTP_SESSION_VARS['phplens_sqlrows'];
+		if (isset($_SESSION['phplens_sqlrows'])) $rows = $_SESSION['phplens_sqlrows'];
 		else $rows = 3;
 		
-		if (isset($HTTP_VARS['SMALLER'])) {
+		if (isset($_REQUEST['SMALLER'])) {
 			$rows /= 2;
 			if ($rows < 3) $rows = 3;
-			$HTTP_SESSION_VARS['phplens_sqlrows'] = $rows;
+			$_SESSION['phplens_sqlrows'] = $rows;
 		}
-		if (isset($HTTP_VARS['BIGGER'])) {
+		if (isset($_REQUEST['BIGGER'])) {
 			$rows *= 2;
-			$HTTP_SESSION_VARS['phplens_sqlrows'] = $rows;
+			$_SESSION['phplens_sqlrows'] = $rows;
 		}
 		
 ?>
@@ -846,7 +863,7 @@
 </form>
 
 <?php
-		if (!isset($HTTP_VARS['sql'])) return;
+		if (!isset($_REQUEST['sql'])) return;
 		
 		$sql = $this->undomq(trim($sql));
 		if (substr($sql,strlen($sql)-1) === ';') {
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-php4.inc.php zentrack_2-5-5-1/includes/adodb/adodb-php4.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-php4.inc.php	2004-09-08 17:31:45.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-php4.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /*
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-time.inc.php zentrack_2-5-5-1/includes/adodb/adodb-time.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-time.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-time.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -24,6 +24,8 @@
 	gmdate()   with  adodb_gmdate()
 	mktime()   with  adodb_mktime()
 	gmmktime() with  adodb_gmmktime()
+	strftime() with  adodb_strftime()
+	strftime() with  adodb_gmstrftime()
 </pre>
 	
 The parameters are identical, except that adodb_date() accepts a subset
@@ -55,8 +57,8 @@
 
 COPYRIGHT
 
-(c) 2003 John Lim and released under BSD-style license except for code by jackbbs,
-which includes adodb_mktime, adodb_get_gmt_diff, adodb_is_leap_year
+(c) 2003-2005 John Lim and released under BSD-style license except for code by 
+jackbbs, which includes adodb_mktime, adodb_get_gmt_diff, adodb_is_leap_year
 and originally found at http://www.php.net/manual/en/function.mktime.php
 
 =============================================================================
@@ -72,13 +74,14 @@
 FUNCTION DESCRIPTIONS
 
 
-FUNCTION adodb_getdate($date=false)
+** FUNCTION adodb_getdate($date=false)
 
 Returns an array containing date information, as getdate(), but supports
-dates greater than 1901 to 2038.
-
-
-FUNCTION adodb_date($fmt, $timestamp = false)
+dates greater than 1901 to 2038. The local date/time format is derived from a 
+heuristic the first time adodb_getdate is called. 
+	 
+	 
+** FUNCTION adodb_date($fmt, $timestamp = false)
 
 Convert a timestamp to a formatted local date. If $timestamp is not defined, the
 current timestamp is used. Unlike the function date(), it supports dates
@@ -87,72 +90,139 @@
 The format fields that adodb_date supports:
 
 <pre>
-a - "am" or "pm" 
-A - "AM" or "PM" 
-d - day of the month, 2 digits with leading zeros; i.e. "01" to "31" 
-D - day of the week, textual, 3 letters; e.g. "Fri" 
-F - month, textual, long; e.g. "January" 
-g - hour, 12-hour format without leading zeros; i.e. "1" to "12" 
-G - hour, 24-hour format without leading zeros; i.e. "0" to "23" 
-h - hour, 12-hour format; i.e. "01" to "12" 
-H - hour, 24-hour format; i.e. "00" to "23" 
-i - minutes; i.e. "00" to "59" 
-j - day of the month without leading zeros; i.e. "1" to "31" 
-l (lowercase 'L') - day of the week, textual, long; e.g. "Friday"  
-L - boolean for whether it is a leap year; i.e. "0" or "1" 
-m - month; i.e. "01" to "12" 
-M - month, textual, 3 letters; e.g. "Jan" 
-n - month without leading zeros; i.e. "1" to "12" 
-O - Difference to Greenwich time in hours; e.g. "+0200" 
-Q - Quarter, as in 1, 2, 3, 4 
-r - RFC 822 formatted date; e.g. "Thu, 21 Dec 2000 16:01:07 +0200" 
-s - seconds; i.e. "00" to "59" 
-S - English ordinal suffix for the day of the month, 2 characters; 
-   			i.e. "st", "nd", "rd" or "th" 
-t - number of days in the given month; i.e. "28" to "31"
-T - Timezone setting of this machine; e.g. "EST" or "MDT" 
-U - seconds since the Unix Epoch (January 1 1970 00:00:00 GMT)  
-w - day of the week, numeric, i.e. "0" (Sunday) to "6" (Saturday) 
-Y - year, 4 digits; e.g. "1999" 
-y - year, 2 digits; e.g. "99" 
-z - day of the year; i.e. "0" to "365" 
-Z - timezone offset in seconds (i.e. "-43200" to "43200"). 
-   			The offset for timezones west of UTC is always negative, 
-			and for those east of UTC is always positive. 
+	a - "am" or "pm" 
+	A - "AM" or "PM" 
+	d - day of the month, 2 digits with leading zeros; i.e. "01" to "31" 
+	D - day of the week, textual, 3 letters; e.g. "Fri" 
+	F - month, textual, long; e.g. "January" 
+	g - hour, 12-hour format without leading zeros; i.e. "1" to "12" 
+	G - hour, 24-hour format without leading zeros; i.e. "0" to "23" 
+	h - hour, 12-hour format; i.e. "01" to "12" 
+	H - hour, 24-hour format; i.e. "00" to "23" 
+	i - minutes; i.e. "00" to "59" 
+	j - day of the month without leading zeros; i.e. "1" to "31" 
+	l (lowercase 'L') - day of the week, textual, long; e.g. "Friday"  
+	L - boolean for whether it is a leap year; i.e. "0" or "1" 
+	m - month; i.e. "01" to "12" 
+	M - month, textual, 3 letters; e.g. "Jan" 
+	n - month without leading zeros; i.e. "1" to "12" 
+	O - Difference to Greenwich time in hours; e.g. "+0200" 
+	Q - Quarter, as in 1, 2, 3, 4 
+	r - RFC 822 formatted date; e.g. "Thu, 21 Dec 2000 16:01:07 +0200" 
+	s - seconds; i.e. "00" to "59" 
+	S - English ordinal suffix for the day of the month, 2 characters; 
+	   			i.e. "st", "nd", "rd" or "th" 
+	t - number of days in the given month; i.e. "28" to "31"
+	T - Timezone setting of this machine; e.g. "EST" or "MDT" 
+	U - seconds since the Unix Epoch (January 1 1970 00:00:00 GMT)  
+	w - day of the week, numeric, i.e. "0" (Sunday) to "6" (Saturday) 
+	Y - year, 4 digits; e.g. "1999" 
+	y - year, 2 digits; e.g. "99" 
+	z - day of the year; i.e. "0" to "365" 
+	Z - timezone offset in seconds (i.e. "-43200" to "43200"). 
+	   			The offset for timezones west of UTC is always negative, 
+				and for those east of UTC is always positive. 
 </pre>
 
 Unsupported:
 <pre>
-B - Swatch Internet time 
-I (capital i) - "1" if Daylight Savings Time, "0" otherwise.
-W - ISO-8601 week number of year, weeks starting on Monday 
+	B - Swatch Internet time 
+	I (capital i) - "1" if Daylight Savings Time, "0" otherwise.
+	W - ISO-8601 week number of year, weeks starting on Monday 
 
 </pre>
 
-FUNCTION adodb_date2($fmt, $isoDateString = false)
+
+** FUNCTION adodb_date2($fmt, $isoDateString = false)
 Same as adodb_date, but 2nd parameter accepts iso date, eg.
 
   adodb_date2('d-M-Y H:i','2003-12-25 13:01:34');
 
-FUNCTION adodb_gmdate($fmt, $timestamp = false)
+  
+** FUNCTION adodb_gmdate($fmt, $timestamp = false)
 
 Convert a timestamp to a formatted GMT date. If $timestamp is not defined, the
 current timestamp is used. Unlike the function date(), it supports dates
 outside the 1901 to 2038 range.
 
 
-FUNCTION adodb_mktime($hr, $min, $sec [, $month, $day, $year])
+** FUNCTION adodb_mktime($hr, $min, $sec[, $month, $day, $year])
 
 Converts a local date to a unix timestamp.  Unlike the function mktime(), it supports
-dates outside the 1901 to 2038 range. Differs from mktime() in that all parameters
-are currently compulsory.
+dates outside the 1901 to 2038 range. All parameters are optional.
+
 
-FUNCTION adodb_gmmktime($hr, $min, $sec [, $month, $day, $year])
+** FUNCTION adodb_gmmktime($hr, $min, $sec [, $month, $day, $year])
 
 Converts a gmt date to a unix timestamp.  Unlike the function gmmktime(), it supports
 dates outside the 1901 to 2038 range. Differs from gmmktime() in that all parameters
 are currently compulsory.
 
+** FUNCTION adodb_gmstrftime($fmt, $timestamp = false)
+Convert a timestamp to a formatted GMT date.
+
+** FUNCTION adodb_strftime($fmt, $timestamp = false)
+
+Convert a timestamp to a formatted local date. Internally converts $fmt into 
+adodb_date format, then echo result.
+
+For best results, you can define the local date format yourself. Define a global
+variable $ADODB_DATE_LOCALE which is an array, 1st element is date format using
+adodb_date syntax, and 2nd element is the time format, also in adodb_date syntax.
+
+    eg. $ADODB_DATE_LOCALE = array('d/m/Y','H:i:s');
+	
+	Supported format codes:
+
+<pre>
+	%a - abbreviated weekday name according to the current locale 
+	%A - full weekday name according to the current locale 
+	%b - abbreviated month name according to the current locale 
+	%B - full month name according to the current locale 
+	%c - preferred date and time representation for the current locale 
+	%d - day of the month as a decimal number (range 01 to 31) 
+	%D - same as %m/%d/%y 
+	%e - day of the month as a decimal number, a single digit is preceded by a space (range ' 1' to '31') 
+	%h - same as %b
+	%H - hour as a decimal number using a 24-hour clock (range 00 to 23) 
+	%I - hour as a decimal number using a 12-hour clock (range 01 to 12) 
+	%m - month as a decimal number (range 01 to 12) 
+	%M - minute as a decimal number 
+	%n - newline character 
+	%p - either `am' or `pm' according to the given time value, or the corresponding strings for the current locale 
+	%r - time in a.m. and p.m. notation 
+	%R - time in 24 hour notation 
+	%S - second as a decimal number 
+	%t - tab character 
+	%T - current time, equal to %H:%M:%S 
+	%x - preferred date representation for the current locale without the time 
+	%X - preferred time representation for the current locale without the date 
+	%y - year as a decimal number without a century (range 00 to 99) 
+	%Y - year as a decimal number including the century 
+	%Z - time zone or name or abbreviation 
+	%% - a literal `%' character 
+</pre>	
+
+	Unsupported codes:
+<pre>
+	%C - century number (the year divided by 100 and truncated to an integer, range 00 to 99) 
+	%g - like %G, but without the century. 
+	%G - The 4-digit year corresponding to the ISO week number (see %V). 
+	     This has the same format and value as %Y, except that if the ISO week number belongs 
+		 to the previous or next year, that year is used instead. 
+	%j - day of the year as a decimal number (range 001 to 366) 
+	%u - weekday as a decimal number [1,7], with 1 representing Monday 
+	%U - week number of the current year as a decimal number, starting 
+	    with the first Sunday as the first day of the first week 
+	%V - The ISO 8601:1988 week number of the current year as a decimal number, 
+	     range 01 to 53, where week 1 is the first week that has at least 4 days in the 
+		 current year, and with Monday as the first day of the week. (Use %G or %g for 
+		 the year component that corresponds to the week number for the specified timestamp.) 
+	%w - day of the week as a decimal, Sunday being 0 
+	%W - week number of the current year as a decimal number, starting with the 
+	     first Monday as the first day of the first week 
+</pre>
+
 =============================================================================
 
 NOTES
@@ -166,17 +236,27 @@
 (page 428, xttotm.c _Ttotm() function). Plauger's algorithm will not 
 work outside 32-bit signed range, so i decided not to implement it.
 
-b. Iterate over a block of years (say 12) when searching for the 
-correct year.
-
-c. Implement daylight savings, which looks awfully complicated, see
+b. Implement daylight savings, which looks awfully complicated, see
 	http://webexhibits.org/daylightsaving/
 
 
 CHANGELOG
+
+- 24 Feb 2005 0.20
+Added limited strftime/gmstrftime support. x10 improvement in performance of adodb_date().
+
+- 21 Dec 2004 0.17
+In adodb_getdate(), the timestamp was accidentally converted to gmt when $is_gmt is false. 
+Also adodb_mktime(0,0,0) did not work properly. Both fixed thx Mauro.
+
+- 17 Nov 2004 0.16
+Removed intval typecast in adodb_mktime() for secs, allowing:
+	 adodb_mktime(0,0,0 + 2236672153,1,1,1934);
+Suggested by Ryan.
+
 - 18 July 2004 0.15
-All params in adodb_mktime were formerly compulsory. Now only the hour, min, secs is compulsory. This
-brings it more in line with mktime (still not identical).
+All params in adodb_mktime were formerly compulsory. Now only the hour, min, secs is compulsory. 
+This brings it more in line with mktime (still not identical).
 
 - 23 June 2004 0.14
 
@@ -275,7 +355,7 @@
 /*
 	Version Number
 */
-define('ADODB_DATE_VERSION',0.15);
+define('ADODB_DATE_VERSION',0.17);
 
 /*
 	We check for Windows as only +ve ints are accepted as dates on Windows.
@@ -293,16 +373,28 @@
 
 if (!defined('ADODB_ALLOW_NEGATIVE_TS')) define('ADODB_NO_NEGATIVE_TS',1);
 
-function adodb_date_test_date($y1,$m)
+function adodb_date_test_date($y1,$m,$d=13)
 {
-	//print " $y1/$m ";
-	$t = adodb_mktime(0,0,0,$m,13,$y1);
-	if ("$y1-$m-13 00:00:00" != adodb_date('Y-n-d H:i:s',$t)) {
-		print "<b>$y1 error</b><br>";
+	$t = adodb_mktime(0,0,0,$m,$d,$y1);
+	$rez = adodb_date('Y-n-j H:i:s',$t);
+	if ("$y1-$m-$d 00:00:00" != $rez) {
+		print "<b>$y1 error, expected=$y1-$m-$d 00:00:00, adodb=$rez</b><br>";
 		return false;
 	}
 	return true;
 }
+
+function adodb_date_test_strftime($fmt)
+{
+	$s1 = strftime($fmt);
+	$s2 = adodb_strftime($fmt);
+	
+	if ($s1 == $s2) return true;
+	
+	echo "error for $fmt,  strftime=$s1, $adodb=$s2<br>";
+	return false;
+}
+
 /**
 	 Test Suite
 */
@@ -317,6 +409,10 @@
 	// This flag disables calling of PHP native functions, so we can properly test the code
 	if (!defined('ADODB_TEST_DATES')) define('ADODB_TEST_DATES',1);
 	
+	adodb_date_test_strftime('%Y %m %x %X');
+	adodb_date_test_strftime("%A %d %B %Y");
+	adodb_date_test_strftime("%H %M S");
+	
 	$t = adodb_mktime(0,0,0);
 	if (!(adodb_date('Y-m-d') == date('Y-m-d'))) print 'Error in '.adodb_mktime(0,0,0).'<br>';
 	
@@ -485,13 +581,13 @@
 	    $year--;
 	}
 	
-	$day =  ( floor((13 * $month - 1) / 5) +
+	$day =  floor((13 * $month - 1) / 5) +
 	        $day + ($year % 100) +
 	        floor(($year % 100) / 4) +
 	        floor(($year / 100) / 4) - 2 *
-	        floor($year / 100) + 77);
+	        floor($year / 100) + 77 + $greg_correction;
 	
-	return (($day - 7 * floor($day / 7))) + $greg_correction;
+	return $day - 7 * floor($day / 7);
 }
 
 
@@ -575,6 +671,26 @@
 	return _adodb_getdate($d);
 }
 
+/*
+// generate $YRS table for _adodb_getdate()
+function adodb_date_gentable($out=true)
+{
+
+	for ($i=1970; $i >= 1600; $i-=10) {
+		$s = adodb_gmmktime(0,0,0,1,1,$i);
+		echo "$i => $s,<br>";	
+	}
+}
+adodb_date_gentable();
+
+for ($i=1970; $i > 1500; $i--) {
+
+echo "<hr>$i ";
+	adodb_date_test_date($i,1,1);
+}
+
+*/
+
 /**
 	Low-level function that returns the getdate() array. We have a special
 	$fast flag, which if set to true, will return fewer array values,
@@ -582,6 +698,8 @@
 */
 function _adodb_getdate($origd=false,$fast=false,$is_gmt=false)
 {
+static $YRS;
+
 	$d =  $origd - ($is_gmt ? 0 : adodb_get_gmt_diff());
 	
 	$_day_power = 86400;
@@ -597,9 +715,57 @@
 	$d365 = $_day_power * 365;
 	
 	if ($d < 0) {
-		$origd = $d;
+		
+		if (empty($YRS)) $YRS = array(
+			1970 => 0,
+			1960 => -315619200,
+			1950 => -631152000,
+			1940 => -946771200,
+			1930 => -1262304000,
+			1920 => -1577923200,
+			1910 => -1893456000,
+			1900 => -2208988800,
+			1890 => -2524521600,
+			1880 => -2840140800,
+			1870 => -3155673600,
+			1860 => -3471292800,
+			1850 => -3786825600,
+			1840 => -4102444800,
+			1830 => -4417977600,
+			1820 => -4733596800,
+			1810 => -5049129600,
+			1800 => -5364662400,
+			1790 => -5680195200,
+			1780 => -5995814400,
+			1770 => -6311347200,
+			1760 => -6626966400,
+			1750 => -6942499200,
+			1740 => -7258118400,
+			1730 => -7573651200,
+			1720 => -7889270400,
+			1710 => -8204803200,
+			1700 => -8520336000,
+			1690 => -8835868800,
+			1680 => -9151488000,
+			1670 => -9467020800,
+			1660 => -9782640000,
+			1650 => -10098172800,
+			1640 => -10413792000,
+			1630 => -10729324800,
+			1620 => -11044944000,
+			1610 => -11360476800,
+			1600 => -11676096000);
+
+		if ($is_gmt) $origd = $d;
 		// The valid range of a 32bit signed timestamp is typically from 
 		// Fri, 13 Dec 1901 20:45:54 GMT to Tue, 19 Jan 2038 03:14:07 GMT
+		//
+		
+		# old algorithm iterates through all years. new algorithm does it in
+		# 10 year blocks
+		
+		/*
+		# old algo
 		for ($a = 1970 ; --$a >= 0;) {
 			$lastd = $d;
 			
@@ -611,6 +777,36 @@
 				break;
 			}
 		}
+		*/
+		
+		$lastsecs = 0;
+		$lastyear = 1970;
+		foreach($YRS as $year => $secs) {
+			if ($d >= $secs) {
+				$a = $lastyear;
+				break;
+			}
+			$lastsecs = $secs;
+			$lastyear = $year;
+		}
+		
+		$d -= $lastsecs;
+		if (!isset($a)) $a = $lastyear;
+		
+		//echo ' yr=',$a,' ', $d,'.';
+		
+		for (; --$a >= 0;) {
+			$lastd = $d;
+			
+			if ($leaf = _adodb_is_leap_year($a)) $d += $d366;
+			else $d += $d365;
+			
+			if ($d >= 0) {
+				$year = $a;
+				break;
+			}
+		}
+		/**/
 		
 		$secsInYear = 86400 * ($leaf ? 366 : 365) + $lastd;
 		
@@ -738,6 +934,7 @@
 	$_day_power = 86400;
 	
 	$arr = _adodb_getdate($d,true,$is_gmt);
+	
 	if (!isset($daylight)) $daylight = function_exists('adodb_daylight_sv');
 	if ($daylight) adodb_daylight_sv($arr, $is_gmt);
 	
@@ -877,22 +1074,31 @@
 function adodb_mktime($hr,$min,$sec,$mon=false,$day=false,$year=false,$is_dst=false,$is_gmt=false) 
 {
 	if (!defined('ADODB_TEST_DATES')) {
+
+		if ($mon === false) {
+			return $is_gmt? @gmmktime($hr,$min,$sec): @mktime($hr,$min,$sec);
+		}
+		
 		// for windows, we don't check 1970 because with timezone differences, 
 		// 1 Jan 1970 could generate negative timestamp, which is illegal
 		if (1971 < $year && $year < 2038
-			|| $mon === false
 			|| !defined('ADODB_NO_NEGATIVE_TS') && (1901 < $year && $year < 2038)
-			)
-				return $is_gmt?
+			) {
+				return $is_gmt ?
 					@gmmktime($hr,$min,$sec,$mon,$day,$year):
 					@mktime($hr,$min,$sec,$mon,$day,$year);
+			}
 	}
 	
 	$gmt_different = ($is_gmt) ? 0 : adodb_get_gmt_diff();
-	
+
+	/*
+	# disabled because some people place large values in $sec.
+	# however we need it for $mon because we use an array...
 	$hr = intval($hr);
 	$min = intval($min);
 	$sec = intval($sec);
+	*/
 	$mon = intval($mon);
 	$day = intval($day);
 	$year = intval($year);
@@ -964,4 +1170,108 @@
 	return $ret;
 }
 
+function adodb_gmstrftime($fmt, $ts=false)
+{
+	return adodb_strftime($fmt,$ts,true);
+}
+
+// hack - convert to adodb_date
+function adodb_strftime($fmt, $ts=false,$is_gmt=false)
+{
+global $ADODB_DATE_LOCALE;
+
+	if (!defined('ADODB_TEST_DATES')) {
+		if ((abs($ts) <= 0x7FFFFFFF)) { // check if number in 32-bit signed range
+			if (!defined('ADODB_NO_NEGATIVE_TS') || $ts >= 0) // if windows, must be +ve integer
+				return ($is_gmt)? @gmstrftime($fmt,$ts): @strftime($fmt,$ts);
+
+		}
+	}
+	
+	if (empty($ADODB_DATE_LOCALE)) {
+		$tstr = strtoupper(gmstrftime('%c',31366800)); // 30 Dec 1970, 1 am
+		$sep = substr($tstr,2,1);
+		$hasAM = strrpos($tstr,'M') !== false;
+		
+		$ADODB_DATE_LOCALE = array();
+		$ADODB_DATE_LOCALE[] =  strncmp($tstr,'30',2) == 0 ? 'd'.$sep.'m'.$sep.'y' : 'm'.$sep.'d'.$sep.'y';	
+		$ADODB_DATE_LOCALE[]  = ($hasAM) ? 'h:i:s a' : 'H:i:s';
+			
+	}
+	$inpct = false;
+	$fmtdate = '';
+	for ($i=0,$max = strlen($fmt); $i < $max; $i++) {
+		$ch = $fmt[$i];
+		if ($ch == '%') {
+			if ($inpct) {
+				$fmtdate .= '%';
+				$inpct = false;
+			} else
+				$inpct = true;
+		} else if ($inpct) {
+		
+			$inpct = false;
+			switch($ch) {
+			case '0':
+			case '1':
+			case '2':
+			case '3':
+			case '4':
+			case '5':
+			case '6':
+			case '7':
+			case '8':
+			case '9':
+			case 'E':
+			case 'O':
+				/* ignore format modifiers */
+				$inpct = true; 
+				break;
+				
+			case 'a': $fmtdate .= 'D'; break;
+			case 'A': $fmtdate .= 'l'; break;
+			case 'h':
+			case 'b': $fmtdate .= 'M'; break;
+			case 'B': $fmtdate .= 'F'; break;
+			case 'c': $fmtdate .= $ADODB_DATE_LOCALE[0].$ADODB_DATE_LOCALE[1]; break;
+			case 'C': $fmtdate .= '\C?'; break; // century
+			case 'd': $fmtdate .= 'd'; break;
+			case 'D': $fmtdate .= 'm/d/y'; break;
+			case 'e': $fmtdate .= 'j'; break;
+			case 'g': $fmtdate .= '\g?'; break; //?
+			case 'G': $fmtdate .= '\G?'; break; //?
+			case 'H': $fmtdate .= 'H'; break;
+			case 'I': $fmtdate .= 'h'; break;
+			case 'j': $fmtdate .= '?z'; $parsej = true; break; // wrong as j=1-based, z=0-basd
+			case 'm': $fmtdate .= 'm'; break;
+			case 'M': $fmtdate .= 'i'; break;
+			case 'n': $fmtdate .= "\n"; break;
+			case 'p': $fmtdate .= 'a'; break;
+			case 'r': $fmtdate .= 'h:i:s a'; break;
+			case 'R': $fmtdate .= 'H:i:s'; break;
+			case 'S': $fmtdate .= 's'; break;
+			case 't': $fmtdate .= "\t"; break;
+			case 'T': $fmtdate .= 'H:i:s'; break;
+			case 'u': $fmtdate .= '?u'; $parseu = true; break; // wrong strftime=1-based, date=0-basde
+			case 'U': $fmtdate .= '?U'; $parseU = true; break;// wrong strftime=1-based, date=0-based
+			case 'x': $fmtdate .= $ADODB_DATE_LOCALE[0]; break;
+			case 'X': $fmtdate .= $ADODB_DATE_LOCALE[1]; break;
+			case 'w': $fmtdate .= '?w'; $parseu = true; break; // wrong strftime=1-based, date=0-basde
+			case 'W': $fmtdate .= '?W'; $parseU = true; break;// wrong strftime=1-based, date=0-based
+			case 'y': $fmtdate .= 'y'; break;
+			case 'Y': $fmtdate .= 'Y'; break;
+			case 'Z': $fmtdate .= 'T'; break;
+			}
+		} else if (('A' <= ($ch) && ($ch) <= 'Z' ) || ('a' <= ($ch) && ($ch) <= 'z' ))
+			$fmtdate .= "\\".$ch;
+		else
+			$fmtdate .= $ch;
+	}
+	//echo "fmt=",$fmtdate,"<br>";
+	if ($ts === false) $ts = time();
+	$ret = adodb_date($fmtdate, $ts, $is_gmt);
+	return $ret;
+}
+
+
 ?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb-xmlschema.inc.php zentrack_2-5-5-1/includes/adodb/adodb-xmlschema.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb-xmlschema.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb-xmlschema.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -12,7 +12,7 @@
  *
  * Last Editor: $Author: phpzen $
  * @author Richard Tango-Lowy & Dan Cech
- * @version $Revision: 1.2 $
+ * @version $Revision: 1.2 $
  *
  * @package axmls
  * @tutorial getting_started.pkg
@@ -1194,7 +1194,7 @@
 * @tutorial getting_started.pkg
 *
 * @author Richard Tango-Lowy & Dan Cech
-* @version $Revision: 1.2 $
+* @version $Revision: 1.2 $
 *
 * @package axmls
 */
@@ -1917,7 +1917,7 @@
 				$schema .= '	<table name="' . $table . '">' . "\n";
 				
 				// grab details from database
-				$rs = $this->db->Execute( 'SELECT * FROM ' . $table . ' WHERE -1' );
+				$rs = $this->db->Execute( 'SELECT * FROM ' . $table . ' WHERE 1=1' );
 				$fields = $this->db->MetaColumns( $table );
 				$indexes = $this->db->MetaIndexes( $table );
 				
@@ -1983,7 +1983,7 @@
 						
 						while( $row = $rs->FetchRow() ) {
 							foreach( $row as $key => $val ) {
-								$row[$key] = htmlentities($row);
+								$row[$key] = htmlentities($val);
 							}
 							
 							$schema .= '			<row><f>' . implode( '</f><f>', $row ) . '</f></row>' . "\n";
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/adodb.inc.php zentrack_2-5-5-1/includes/adodb/adodb.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/adodb.inc.php	2004-09-08 01:22:39.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/adodb.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -14,7 +14,7 @@
 /**
 	\mainpage 	
 	
-	 @version V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim\@natsoft.com.my). All rights reserved.
+	 @version V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim#natsoft.com.my). All rights reserved.
 
 	Released under both BSD license and Lesser GPL library license. You can choose which license
 	you prefer.
@@ -26,8 +26,8 @@
 	We currently support MySQL, Oracle, Microsoft SQL Server, Sybase, Sybase SQL Anywhere, DB2,
 	Informix, PostgreSQL, FrontBase, Interbase (Firebird and Borland variants), Foxpro, Access,
 	ADO, SAP DB, SQLite and ODBC. We have had successful reports of connecting to Progress and
-	other databases via ODBC. 
-	 
+	other databases via ODBC.
+
 	Latest Download at http://php.weblogs.com/adodb<br>
 	Manual is at http://php.weblogs.com/adodb_manual
 	  
@@ -87,7 +87,7 @@
 		define('ADODB_BAD_RS','<p>Bad $rs in %s. Connection or SQL invalid. Try using $connection->debug=true;</p>');
 	
 	// allow [ ] @ ` " and . in table names
-		define('ADODB_TABLE_REGEX','([]0-9a-z_\"\`\.\@\[-]*)');
+		define('ADODB_TABLE_REGEX','([]0-9a-z_\:\"\`\.\@\[-]*)');
 	
 	// prefetching used by oracle
 		if (!defined('ADODB_PREFETCH_ROWS')) define('ADODB_PREFETCH_ROWS',10);
@@ -172,7 +172,7 @@
 		/**
 		 * ADODB version as a string.
 		 */
-		$ADODB_vers = 'V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim#natsoft.com.my). All rights reserved. Released BSD & LGPL.';
+		$ADODB_vers = 'V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim#natsoft.com.my). All rights reserved. Released BSD & LGPL.';
 	
 		/**
 		 * Determines whether recordset->RecordCount() is used. 
@@ -199,7 +199,7 @@
 		var $name = '';
 		var $max_length=0;
 		var $type="";
-
+/*
 		// additional fields by dannym... (danny_milo@yahoo.com)
 		var $not_null = false; 
 		// actually, this has already been built-in in the postgres, fbsql AND mysql module? ^-^
@@ -208,6 +208,7 @@
 		var $has_default = false; // this one I have done only in mysql and postgres for now ... 
 			// others to come (dannym)
 		var $default_value; // default, if any, and supported. Check has_default first.
+*/
 	}
 	
 
@@ -240,10 +241,10 @@
 	var $user = ''; 			/// The username which is used to connect to the database server. 
 	var $password = ''; 		/// Password for the username. For security, we no longer store it.
 	var $debug = false; 		/// if set to true will output sql statements
-	var $maxblobsize = 256000; 	/// maximum size of blobs or large text fields -- some databases die otherwise like foxpro
+	var $maxblobsize = 262144; 	/// maximum size of blobs or large text fields (262144 = 256K)-- some db's die otherwise like foxpro
 	var $concat_operator = '+'; /// default concat operator -- change to || for Oracle/Interbase	
 	var $substr = 'substr';		/// substring operator
-	var $length = 'length';		/// string length operator
+	var $length = 'length';		/// string length ofperator
 	var $random = 'rand()';		/// random function
 	var $upperCase = 'upper';		/// uppercase function
 	var $fmtDate = "'Y-m-d'";	/// used by DBDate() as the default date format used by the database
@@ -252,7 +253,7 @@
 	var $false = '0'; 			/// string that represents FALSE for a database
 	var $replaceQuote = "\\'"; 	/// string to use to replace quotes
 	var $nameQuote = '"';		/// string to use to quote identifiers and names
-	var $charSet=false; 		/// character set to use - only for interbase
+	var $charSet=false; 		/// character set to use - only for interbase, postgres and oci8
 	var $metaDatabasesSQL = '';
 	var $metaTablesSQL = '';
 	var $uniqueOrderBy = false; /// All order by columns have to be unique
@@ -343,6 +344,11 @@
 		return array('description' => '', 'version' => '');
 	}
 	
+	function IsConnected()
+	{
+    	return !empty($this->_connectionID);
+	}
+	
 	function _findvers($str)
 	{
 		if (preg_match('/([0-9]+\.([0-9\.])+)/',$str, $arr)) return $arr[1];
@@ -355,7 +361,7 @@
 	*/
 	function outp($msg,$newline=true)
 	{
-	global $HTTP_SERVER_VARS,$ADODB_FLUSH,$ADODB_OUTP;
+	global $ADODB_FLUSH,$ADODB_OUTP;
 	
 		if (defined('ADODB_OUTP')) {
 			$fn = ADODB_OUTP;
@@ -369,7 +375,7 @@
 		
 		if ($newline) $msg .= "<br>\n";
 		
-		if (isset($HTTP_SERVER_VARS['HTTP_USER_AGENT']) || !$newline) echo $msg;
+		if (isset($_SERVER['HTTP_USER_AGENT']) || !$newline) echo $msg;
 		else echo strip_tags($msg);
 	
 		
@@ -405,17 +411,25 @@
 		
 		$this->_isPersistentConnection = false;	
 		if ($forceNew) {
-			if ($this->_nconnect($this->host, $this->user, $this->password, $this->database)) return true;
+			if ($rez=$this->_nconnect($this->host, $this->user, $this->password, $this->database)) return true;
+		} else {
+			 if ($rez=$this->_connect($this->host, $this->user, $this->password, $this->database)) return true;
+		}
+		if (isset($rez)) {
+			$err = $this->ErrorMsg();
+			if (empty($err)) $err = "Connection error to server '$argHostname' with user '$argUsername'";
+			$ret = false;
 		} else {
-			 if ($this->_connect($this->host, $this->user, $this->password, $this->database)) return true;
+			$err = "Missing extension for ".$this->dataProvider;
+			$ret = 0;
 		}
-		$err = $this->ErrorMsg();
-		if (empty($err)) $err = "Connection error to server '$argHostname' with user '$argUsername'";
 		if ($fn = $this->raiseErrorFn) 
 			$fn($this->databaseType,'CONNECT',$this->ErrorNo(),$err,$this->host,$this->database,$this);
 		
+		
+		$this->_connectionID = false;
 		if ($this->debug) ADOConnection::outp( $this->host.': '.$err);
-		return false;
+		return $ret;
 	}	
 	
 	function _nconnect($argHostname, $argUsername, $argPassword, $argDatabaseName)
@@ -460,17 +474,22 @@
 		if ($argDatabaseName != "") $this->database = $argDatabaseName;		
 			
 		$this->_isPersistentConnection = true;	
-		if ($this->_pconnect($this->host, $this->user, $this->password, $this->database)) return true;
-		$err = $this->ErrorMsg();
-		if (empty($err)) {
-			$err = "Connection error to server '$argHostname' with user '$argUsername'";
-		}	
+		if ($rez = $this->_pconnect($this->host, $this->user, $this->password, $this->database)) return true;
+		if (isset($rez)) {
+			$err = $this->ErrorMsg();
+			if (empty($err)) $err = "Connection error to server '$argHostname' with user '$argUsername'";
+			$ret = false;
+		} else {
+			$err = "Missing extension for ".$this->dataProvider;
+			$ret = 0;
+		}
 		if ($fn = $this->raiseErrorFn) {
 			$fn($this->databaseType,'PCONNECT',$this->ErrorNo(),$err,$this->host,$this->database,$this);
 		}
 		
+		$this->_connectionID = false;
 		if ($this->debug) ADOConnection::outp( $this->host.': '.$err);
-		return false;
+		return $ret;
 	}
 
 	// Format date column in sql string given an input format that understands Y M D
@@ -499,7 +518,7 @@
 	{
 		return $sql;
 	}
-
+	
 	/**
 	 * Some databases, eg. mssql require a different function for preparing
 	 * stored procedures. So we cannot use Prepare().
@@ -792,20 +811,26 @@
 					$sql = ''; $i = 0;
 					foreach($arr as $v) {
 						$sql .= $sqlarr[$i];
-						// from Ron Baldwin <ron.baldwin@sourceprose.com>
+						// from Ron Baldwin <ron.baldwin#sourceprose.com>
 						// Only quote string types	
-						if (gettype($v) == 'string')
+						$typ = gettype($v);
+						if ($typ == 'string')
 							$sql .= $this->qstr($v);
+						else if ($typ == 'double')
+							$sql .= str_replace(',','.',$v); // locales fix so 1.1 does not get converted to 1,1
+						else if ($typ == 'boolean')
+							$sql = $v ? $this->true : $this->false;
 						else if ($v === null)
 							$sql .= 'NULL';
 						else
 							$sql .= $v;
 						$i += 1;
 					}
-					$sql .= $sqlarr[$i];
-					
-					if ($i+1 != sizeof($sqlarr))	
-						ADOConnection::outp( "Input Array does not match ?: ".htmlspecialchars($sql));
+					if (isset($sqlarr[$i])) {
+						$sql .= $sqlarr[$i];
+						if ($i+1 != sizeof($sqlarr)) ADOConnection::outp( "Input Array does not match ?: ".htmlspecialchars($sql));
+					} else if ($i != sizeof($sqlarr))	
+						ADOConnection::outp( "Input array does not match ?: ".htmlspecialchars($sql));
 		
 					$ret =& $this->_Execute($sql);
 					if (!$ret) return $ret;
@@ -829,7 +854,7 @@
 	}
 	
 	
-	function& _Execute($sql,$inputarr=false)
+	function &_Execute($sql,$inputarr=false)
 	{
 
 		if ($this->debug) {
@@ -850,8 +875,8 @@
 			if ($fn) {
 				$fn($this->databaseType,'EXECUTE',$this->ErrorNo(),$this->ErrorMsg(),$sql,$inputarr,$this);
 			} 
-				
-			return false;
+			$false = false;
+			return $false;
 		} 
 		
 		if ($this->_queryID === true) { // return simplified recordset for inserts/updates/deletes with lower overhead
@@ -885,7 +910,7 @@
 		return $this->Execute(sprintf($this->_genSeqSQL,$seqname,$startID));
 	}
 
-	function DropSequence($seqname)
+	function DropSequence($seqname='adodbseq')
 	{
 		if (empty($this->_dropSeqSQL)) return false;
 		return $this->Execute(sprintf($this->_dropSeqSQL,$seqname));
@@ -908,7 +933,12 @@
 		$getnext = sprintf($this->_genIDSQL,$seqname);
 		
 		$holdtransOK = $this->_transOK;
-		$rs = @$this->Execute($getnext);
+		
+		$save_handler = $this->connection->raiseErrorFn;
+		$this->connection->raiseErrorFn = '';
+		@($rs = $this->Execute($getnext));
+		$this->connection->raiseErrorFn = $save_handler;
+		
 		if (!$rs) {
 			$this->_transOK = $holdtransOK; //if the status was ok before reset
 			$createseq = $this->Execute(sprintf($this->_genSeqSQL,$seqname,$startID));
@@ -923,12 +953,14 @@
 	}	
 
 	/**
+	 * @param $table string name of the table, not needed by all databases (eg. mysql), default ''
+	 * @param $column string name of the column, not needed by all databases (eg. mysql), default ''
 	 * @return  the last inserted ID. Not all databases support this.
 	 */ 
-	function Insert_ID()
+	function Insert_ID($table='',$column='')
 	{
 		if ($this->_logsql && $this->lastInsID) return $this->lastInsID;
-		if ($this->hasInsertID) return $this->_insertid();
+		if ($this->hasInsertID) return $this->_insertid($table,$column);
 		if ($this->debug) {
 			ADOConnection::outp( '<p>Insert_ID error</p>');
 			adodb_backtrace();
@@ -938,7 +970,7 @@
 
 
 	/**
-	 * Portable Insert ID. Pablo Roca <pabloroca@mvps.org>
+	 * Portable Insert ID. Pablo Roca <pabloroca#mvps.org>
 	 *
 	 * @return  the last inserted ID. All databases support this. But aware possible
 	 * problems in multiuser environments. Heavy test this before deploying.
@@ -946,7 +978,7 @@
 	function PO_Insert_ID($table="", $id="") 
 	{
 	   if ($this->hasInsertID){
-		   return $this->Insert_ID();
+		   return $this->Insert_ID($table,$id);
 	   } else {
 		   return $this->GetOne("SELECT MAX($id) FROM $table");
 	   }
@@ -1145,8 +1177,10 @@
 	*/
 	function &_rs2rs(&$rs,$nrows=-1,$offset=-1,$close=true)
 	{
-		if (! $rs) return false;
-		
+		if (! $rs) {
+			$false = false;
+			return $false;
+		}
 		$dbtype = $rs->databaseType;
 		if (!$dbtype) {
 			$rs = &$rs;  // required to prevent crashing in 4.2.1, but does not happen in 4.3.1 -- why ?
@@ -1173,6 +1207,7 @@
 		$rs2->sql = $rs->sql;
 		$rs2->dataProvider = $this->dataProvider;
 		$rs2->InitArrayFields($arr,$flds);
+		$rs2->fetchMode = isset($rs->adodbFetchMode) ? $rs->adodbFetchMode : $rs->fetchMode;
 		return $rs2;
 	}
 	
@@ -1188,8 +1223,10 @@
 	function &GetAssoc($sql, $inputarr=false,$force_array = false, $first2cols = false)
 	{
 		$rs =& $this->Execute($sql, $inputarr);
-		if (!$rs) return false;
-		
+		if (!$rs) {
+			$false = false;
+			return $false;
+		}
 		$arr =& $rs->GetAssoc($force_array,$first2cols);
 		return $arr;
 	}
@@ -1201,8 +1238,10 @@
 			$force_array = $inputarr;
 		}
 		$rs =& $this->CacheExecute($secs2cache, $sql, $inputarr);
-		if (!$rs) return false;
-		
+		if (!$rs) {
+			$false = false;
+			return $false;
+		}
 		$arr =& $rs->GetAssoc($force_array,$first2cols);
 		return $arr;
 	}
@@ -1222,7 +1261,7 @@
 		
 		$ret = false;
 		$rs = &$this->Execute($sql,$inputarr);
-		if ($rs) {		
+		if ($rs) {	
 			if (!$rs->EOF) $ret = reset($rs->fields);
 			$rs->Close();
 		}
@@ -1314,7 +1353,10 @@
 		$ADODB_COUNTRECS = $savec;
 		if (!$rs) 
 			if (defined('ADODB_PEAR')) return ADODB_PEAR_Error();
-			else return false;
+			else {
+				$false = false;
+				return $false;
+			}
 		$arr =& $rs->GetArray();
 		$rs->Close();
 		return $arr;
@@ -1336,8 +1378,10 @@
 		
 		if (!$rs) 
 			if (defined('ADODB_PEAR')) return ADODB_PEAR_Error();
-			else return false;
-		
+			else {
+				$false = false;
+				return $false;
+			}
 		$arr =& $rs->GetArray();
 		$rs->Close();
 		return $arr;
@@ -1367,7 +1411,8 @@
 			return $arr;
 		}
 		
-		return false;
+		$false = false;
+		return $false;
 	}
 	
 	function &CacheGetRow($secs2cache,$sql=false,$inputarr=false)
@@ -1379,7 +1424,8 @@
 			$rs->Close();
 			return $arr;
 		}
-		return false;
+		$false = false;
+		return $false;
 	}
 	
 	/**
@@ -1455,7 +1501,8 @@
 			if (strncmp(PHP_OS,'WIN',3) === 0) {
 				$cmd = 'del /s '.str_replace('/','\\',$ADODB_CACHE_DIR).'\adodb_*.cache';
 			} else {
-				$cmd = 'rm -rf '.$ADODB_CACHE_DIR.'/??/adodb_*.cache'; 
+				//$cmd = 'find "'.$ADODB_CACHE_DIR.'" -type f -maxdepth 1 -print0 | xargs -0 rm -f';
+				$cmd = 'rm -rf '.$ADODB_CACHE_DIR.'/[0-9a-f][0-9a-f]/'; 
 				// old version 'rm -f `find '.$ADODB_CACHE_DIR.' -name adodb_*.cache`';
 			}
 			if ($this->debug) {
@@ -1541,7 +1588,7 @@
 		$err = '';
 		
 		if ($secs2cache > 0){
-			$rs = &csv2rs($md5file,$err,$secs2cache);
+			$rs = &csv2rs($md5file,$err,$secs2cache,$this->arrayClass);
 			$this->numCacheHits += 1;
 		} else {
 			$err='Timeout 1';
@@ -1556,7 +1603,9 @@
 				}
 				if ($this->debug !== -1) ADOConnection::outp( " $md5file cache failure: $err (see sql below)");
 			}
+			
 			$rs = &$this->Execute($sql,$inputarr);
+
 			if ($rs) {
 				$eof = $rs->EOF;
 				$rs = &$this->_rs2rs($rs); // read entire recordset into memory immediately
@@ -1587,9 +1636,8 @@
 		// ok, set cached object found
 			$rs->connection = &$this; // Pablo suggestion
 			if ($this->debug){ 
-			global $HTTP_SERVER_VARS;
 					
-				$inBrowser = isset($HTTP_SERVER_VARS['HTTP_USER_AGENT']);
+				$inBrowser = isset($_SERVER['HTTP_USER_AGENT']);
 				$ttl = $rs->timeCreated + $secs2cache - time();
 				$s = is_array($sql) ? $sql[0] : $sql;
 				if ($inBrowser) $s = '<i>'.htmlspecialchars($s).'</i>';
@@ -1601,6 +1649,46 @@
 	}
 	
 	
+	/* 
+		Similar to PEAR DB's autoExecute(), except that 
+		$mode can be 'INSERT' or 'UPDATE' or DB_AUTOQUERY_INSERT or DB_AUTOQUERY_UPDATE
+		If $mode == 'UPDATE', then $where is compulsory as a safety measure.
+		
+		$forceUpdate means that even if the data has not changed, perform update.
+	 */
+	function& AutoExecute($table, $fields_values, $mode = 'INSERT', $where = FALSE, $forceUpdate=true, $magicq=false) 
+	{
+		//$flds = array_keys($fields_values);
+		//$fldstr = implode(', ',$flds);
+		$sql = 'SELECT * FROM '.$table;  
+		if ($where!==FALSE) $sql .= ' WHERE '.$where;
+		else if ($mode == 'UPDATE') {
+			ADOConnection::outp('AutoExecute: Illegal mode=UPDATE with empty WHERE clause');
+			return false;
+		}
+
+		$rs =& $this->SelectLimit($sql,1);
+		if (!$rs) return false; // table does not exist
+		
+		switch((string) $mode) {
+		case 'UPDATE':
+		case '2':
+			$sql = $this->GetUpdateSQL($rs, $fields_values, $forceUpdate, $magicq);
+			break;
+		case 'INSERT':
+		case '1':
+			$sql = $this->GetInsertSQL($rs, $fields_values, $magicq);
+			break;
+		default:
+			ADOConnection::outp("AutoExecute: Unknown mode=$mode");
+			return false;
+		}
+		$ret = false;
+		if ($sql) $ret = $this->Execute($sql);
+		return $ret;
+	}
+	
+	
 	/**
 	 * Generates an Update Query based on an existing recordset.
 	 * $arrFields is an associative array of fields with the value
@@ -1629,6 +1717,8 @@
 		return _adodb_getupdatesql($this,$rs,$arrFields,$forceUpdate,$magicq,$force);
 	}
 
+	
+	
 
 	/**
 	 * Generates an Insert Query based on an existing recordset.
@@ -1753,22 +1843,32 @@
 		$this->locale = $locale;
 		switch ($locale)
 		{
-			default:
 			case 'En':
-				$this->fmtDate="Y-m-d";
-				$this->fmtTimeStamp = "Y-m-d H:i:s";
+				$this->fmtDate="'Y-m-d'";
+				$this->fmtTimeStamp = "'Y-m-d H:i:s'";
 				break;
-	
+				
+			case 'Us':
+				$this->fmtDate = "'m-d-Y'";
+				$this->fmtTimeStamp = "'m-d-Y H:i:s'";
+				break;
+				
+			case 'Nl':
 			case 'Fr':
 			case 'Ro':
 			case 'It':
-				$this->fmtDate="d-m-Y";
-				$this->fmtTimeStamp = "d-m-Y H:i:s";
+				$this->fmtDate="'d-m-Y'";
+				$this->fmtTimeStamp = "'d-m-Y H:i:s'";
 				break;
 				
 			case 'Ge':
-				$this->fmtDate="d.m.Y";
-				$this->fmtTimeStamp = "d.m.Y H:i:s";
+				$this->fmtDate="'d.m.Y'";
+				$this->fmtTimeStamp = "'d.m.Y H:i:s'";
+				break;
+				
+			default:
+				$this->fmtDate="'Y-m-d'";
+				$this->fmtTimeStamp = "'Y-m-d H:i:s'";
 				break;
 		}
 	}
@@ -1777,14 +1877,11 @@
 	/**
 	 * Close Connection
 	 */
-	function Close() 
+	function Close()
 	{
-		return $this->_close();
-		
-		// "Simon Lee" <simon@mediaroad.com> reports that persistent connections need 
-		// to be closed too!
-		//if ($this->_isPersistentConnection != true) return $this->_close();
-		//else return true;	
+		$rez = $this->_close();
+		$this->_connectionID = false;
+		return $rez;
 	}
 	
 	/**
@@ -1855,10 +1952,12 @@
 	{
 	global $ADODB_FETCH_MODE;
 	
-		if ($mask) return false;
 		
+		$false = false;
+		if ($mask) {
+			return $false;
+		}
 		if ($this->metaTablesSQL) {
-			// complicated state saving by the need for backward compat
 			$save = $ADODB_FETCH_MODE; 
 			$ADODB_FETCH_MODE = ADODB_FETCH_NUM; 
 			
@@ -1868,7 +1967,7 @@
 			if (isset($savem)) $this->SetFetchMode($savem);
 			$ADODB_FETCH_MODE = $save; 
 			
-			if ($rs === false) return false;
+			if ($rs === false) return $false;
 			$arr =& $rs->GetArray();
 			$arr2 = array();
 			
@@ -1889,7 +1988,7 @@
 			$rs->Close();
 			return $arr2;
 		}
-		return false;
+		return $false;
 	}
 	
 	
@@ -1915,6 +2014,8 @@
 	{
 	global $ADODB_FETCH_MODE;
 		
+		$false = false;
+		
 		if (!empty($this->metaColumnsSQL)) {
 		
 			$schema = false;
@@ -1926,7 +2027,7 @@
 			$rs = $this->Execute(sprintf($this->metaColumnsSQL,($upper)?strtoupper($table):$table));
 			if (isset($savem)) $this->SetFetchMode($savem);
 			$ADODB_FETCH_MODE = $save;
-			if ($rs === false) return false;
+			if ($rs === false || $rs->EOF) return $false;
 
 			$retarr = array();
 			while (!$rs->EOF) { //print_r($rs->fields);
@@ -1947,19 +2048,31 @@
 			$rs->Close();
 			return $retarr;	
 		}
-		return false;
+		return $false;
 	}
 	
     /**
       * List indexes on a table as an array.
-      * @param table        table name to query
-      * @param primary include primary keys.
+      * @param table  table name to query
+      * @param primary true to only show primary keys. Not actually used for most databases
 	  *
-      * @return array of indexes on current table.
+      * @return array of indexes on current table. Each element represents an index, and is itself an associative array.
+	  
+		 Array (
+		    [name_of_index] => Array
+		      (
+	          [unique] => true or false
+	          [columns] => Array
+	          (
+	          	[0] => firstname
+		      	[1] => lastname
+	          )
+		)		
       */
      function &MetaIndexes($table, $primary = false, $owner = false)
      {
-             return FALSE;
+	 		$false = false;
+            return false;
      }
 
 	/**
@@ -1971,8 +2084,10 @@
 	function &MetaColumnNames($table, $numIndexes=false) 
 	{
 		$objarr =& $this->MetaColumns($table);
-		if (!is_array($objarr)) return false;
-		
+		if (!is_array($objarr)) {
+			$false = false;
+			return $false;
+		}
 		$arr = array();
 		if ($numIndexes) {
 			$i = 0;
@@ -2051,6 +2166,12 @@
 	 */
 	function UnixDate($v)
 	{
+		if (is_object($v)) {
+		// odbtp support
+		//( [year] => 2004 [month] => 9 [day] => 4 [hour] => 12 [minute] => 44 [second] => 8 [fraction] => 0 )
+			return adodb_mktime($v->hour,$v->minute,$v->second,$v->month,$v->day, $v->year);
+		}
+	
 		if (is_numeric($v) && strlen($v) !== 8) return $v;
 		if (!preg_match( "|^([0-9]{4})[-/\.]?([0-9]{1,2})[-/\.]?([0-9]{1,2})|", 
 			($v), $rr)) return false;
@@ -2069,6 +2190,12 @@
 	 */
 	function UnixTimeStamp($v)
 	{
+		if (is_object($v)) {
+		// odbtp support
+		//( [year] => 2004 [month] => 9 [day] => 4 [hour] => 12 [minute] => 44 [second] => 8 [fraction] => 0 )
+			return adodb_mktime($v->hour,$v->minute,$v->second,$v->month,$v->day, $v->year);
+		}
+		
 		if (!preg_match( 
 			"|^([0-9]{4})[-/\.]?([0-9]{1,2})[-/\.]?([0-9]{1,2})[ ,-]*(([0-9]{1,2}):?([0-9]{1,2}):?([0-9\.]{1,4}))?|", 
 			($v), $rr)) return false;
@@ -2123,6 +2250,11 @@
 		return ($gmt) ? adodb_gmdate($fmt,$tt) : adodb_date($fmt,$tt);
 	}
 	
+	function escape($s,$magic_quotes=false)
+	{
+		return $this->addq($s,$magic_quotes);
+	}
+	
 	/**
 	* Quotes a string, without prefixing nor appending quotes. 
 	*/
@@ -2508,7 +2640,8 @@
 	
 		$cols = $this->_numOfFields;
 		if ($cols < 2) {
-			return false;
+			$false = false;
+			return $false;
 		}
 		$numIndex = isset($this->fields[0]);
 		$results = array();
@@ -2622,14 +2755,7 @@
 	 */
 	function UnixDate($v)
 	{
-		if (is_numeric($v) && strlen($v) !== 8) return $v;
-		if (!preg_match( "|^([0-9]{4})[-/\.]?([0-9]{1,2})[-/\.]?([0-9]{1,2})|", 
-			($v), $rr)) return false;
-			
-		if ($rr[1] <= TIMESTAMP_FIRST_YEAR || $rr[1] > 10000) return 0;
-		
-		// h-m-s-MM-DD-YY
-		return @adodb_mktime(0,0,0,$rr[2],$rr[3],$rr[1]);
+		return ADOConnection::UnixDate($v);
 	}
 	
 
@@ -2640,15 +2766,7 @@
 	 */
 	function UnixTimeStamp($v)
 	{
-		
-		if (!preg_match( 
-			"|^([0-9]{4})[-/\.]?([0-9]{1,2})[-/\.]?([0-9]{1,2})[ ,-]*(([0-9]{1,2}):?([0-9]{1,2}):?([0-9\.]{1,4}))?|", 
-			($v), $rr)) return false;
-		if ($rr[1] <= TIMESTAMP_FIRST_YEAR && $rr[2]<= 1) return 0;
-	
-		// h-m-s-MM-DD-YY
-		if (!isset($rr[5])) return  adodb_mktime(0,0,0,$rr[2],$rr[3],$rr[1]);
-		return  @adodb_mktime($rr[5],$rr[6],$rr[7],$rr[2],$rr[3],$rr[1]);
+		return ADOConnection::UnixTimeStamp($v);
 	}
 	
 	
@@ -2686,7 +2804,10 @@
 	*/
 	function &FetchRow()
 	{
-		if ($this->EOF) return false;
+		if ($this->EOF) {
+			$false = false;
+			return $false;
+		}
 		$arr = $this->fields;
 		$this->_currentRow++;
 		if (!$this->_fetch()) $this->EOF = true;
@@ -3000,7 +3121,9 @@
 			}
 		}
 		$i = 0;
-		$o = &$this->_obj;
+		if (PHP_VERSION >= 5) $o = clone($this->_obj);
+		else $o = $this->_obj;
+	
 		for ($i=0; $i <$this->_numOfFields; $i++) {
 			$name = $this->_names[$i];
 			if ($isupper) $n = strtoupper($name);
@@ -3022,7 +3145,7 @@
 	*/
 	function &FetchNextObj()
 	{
-		$o = $this->FetchNextObject(false);
+		$o =& $this->FetchNextObject(false);
 		return $o;
 	}
 	
@@ -3132,6 +3255,9 @@
 		'INT IDENTITY' => 'R',
 		##
 		'INT' => 'I',
+		'INT2' => 'I',
+		'INT4' => 'I',
+		'INT8' => 'I',
 		'INTEGER' => 'I',
 		'INTEGER UNSIGNED' => 'I',
 		'SHORT' => 'I',
@@ -3172,7 +3298,7 @@
 		
 		$tmap = false;
 		$t = strtoupper($t);
-		$tmap = @$typeMap[$t];
+		$tmap = (isset($typeMap[$t])) ? $typeMap[$t] : 'N';
 		switch ($tmap) {
 		case 'C':
 		
@@ -3347,7 +3473,9 @@
 		/* Use associative array to get fields array */
 		function Fields($colname)
 		{
-			if ($this->fetchMode & ADODB_FETCH_ASSOC) {
+			$mode = isset($this->adodbFetchMode) ? $this->adodbFetchMode : $this->fetchMode;
+	
+			if ($mode & ADODB_FETCH_ASSOC) {
 				if (!isset($this->fields[$colname])) $colname = strtolower($colname);
 				return $this->fields[$colname];
 			}
@@ -3449,19 +3577,26 @@
 		if (!$dbType) return false;
 		$db = strtolower($dbType);
 		switch ($db) {
+			case 'ado': 
+				if (PHP_VERSION >= 5) $db = 'ado5';
+				$class = 'ado'; 
+				break;
 			case 'ifx':
-			case 'maxsql': $db = 'mysqlt'; break;
+			case 'maxsql': $class = $db = 'mysqlt'; break;
 			case 'postgres':
-			case 'pgsql': $db = 'postgres7'; break;
+			case 'postgres8':
+			case 'pgsql': $class = $db = 'postgres7'; break;
+			default:
+				$class = $db; break;
 		}
-		@include_once(ADODB_DIR."/drivers/adodb-".$db.".inc.php");
-		$ADODB_LASTDB = $db;
-		
-		$ok = class_exists("ADODB_" . $db);
-		if ($ok) return $db;
 		
-		print_r(get_declared_classes());
 		$file = ADODB_DIR."/drivers/adodb-".$db.".inc.php";
+		@include_once($file);
+		$ADODB_LASTDB = $class;
+		
+		if (class_exists("ADODB_" . $db)) return $class;
+		
+		//ADOConnection::outp(adodb_pr(get_declared_classes(),true));
 		if (!file_exists($file)) ADOConnection::outp("Missing file: $file");
 		else ADOConnection::outp("Syntax error in file: $file");
 		return false;
@@ -3490,7 +3625,7 @@
 		
 		if (!defined('ADODB_ASSOC_CASE')) define('ADODB_ASSOC_CASE',2);
 		$errorfn = (defined('ADODB_ERROR_HANDLER')) ? ADODB_ERROR_HANDLER : false;
-		
+		$false = false;
 		if (strpos($db,'://')) {
 			$origdsn = $db;
 			$dsna = @parse_url($db);
@@ -3498,15 +3633,15 @@
 				// special handling of oracle, which might not have host
 				$db = str_replace('@/','@adodb-fakehost/',$db);
 				$dsna = parse_url($db);
-				if (!$dsna) return false;
+				if (!$dsna) return $false;
 				$dsna['host'] = '';
 			}
 			$db = @$dsna['scheme'];
-			if (!$db) return false;
+			if (!$db) return $false;
 			$dsna['host'] = isset($dsna['host']) ? rawurldecode($dsna['host']) : '';
 			$dsna['user'] = isset($dsna['user']) ? rawurldecode($dsna['user']) : '';
 			$dsna['pass'] = isset($dsna['pass']) ? rawurldecode($dsna['pass']) : '';
-			$dsna['path'] = isset($dsna['path']) ? rawurldecode(substr($dsna['path'],1)) : '';
+			$dsna['path'] = isset($dsna['path']) ? rawurldecode(substr($dsna['path'],1)) : ''; # strip off initial /
 			
 			if (isset($dsna['query'])) {
 				$opt1 = explode('&',$dsna['query']);
@@ -3547,13 +3682,13 @@
 				} else
 					 ADOConnection::outp( "<p>ADONewConnection: Unable to load database driver '$db'</p>",false);
 					
-				return false;
+				return $false;
 			}
 			
 			$cls = 'ADODB_'.$db;
 			if (!class_exists($cls)) {
 				adodb_backtrace();
-				return false;
+				return $false;
 			}
 			
 			$obj =& new $cls();
@@ -3570,6 +3705,7 @@
 					case 'persistent': 	$persist = $v; break;
 					case 'debug':		$obj->debug = (integer) $v; break;
 					#ibase
+					case 'role':		$obj->role = $v; break;
 					case 'dialect': 	$obj->dialect = (integer) $v; break;
 					case 'charset':		$obj->charset = $v; break;
 					case 'buffers':		$obj->buffers = $v; break;
@@ -3581,6 +3717,8 @@
 					#mysqli
 					case 'port': $obj->port = $v; break;
 					case 'socket': $obj->socket = $v; break;
+					#oci8
+					case 'nls_date_format': $obj->NLS_DATE_FORMAT = $v; break;
 					}
 				}
 				if (empty($persist))
@@ -3588,7 +3726,7 @@
 				else
 					$ok = $obj->PConnect($dsna['host'], $dsna['user'], $dsna['pass'], $dsna['path']);
 					
-				if (!$ok) return false;
+				if (!$ok) return $false;
 			}
 		}
 		return $obj;
@@ -3599,53 +3737,53 @@
 	// $perf == true means called by NewPerfMonitor()
 	function _adodb_getdriver($provider,$drivername,$perf=false)
 	{
-		if ($provider !== 'native' && $provider != 'odbc' && $provider != 'ado') 
-			$drivername = $provider;
-		else {
-			if (substr($drivername,0,5) == 'odbc_') $drivername = substr($drivername,5);
-			else if (substr($drivername,0,4) == 'ado_') $drivername = substr($drivername,4);
-			else 
-			switch($drivername) {
-			case 'oracle': $drivername = 'oci8';break;
-			//case 'sybase': $drivername = 'mssql';break;
-			case 'access': 
-						if ($perf) $drivername = '';
-						break;
-			case 'db2':	
-						break;
-			default:
-				$drivername = 'generic';
-				break;
-			}
+		switch ($provider) {
+		case 'odbtp':   if (strncmp('odbtp_',$drivername,6)==0) return substr($drivername,6); 
+		case 'odbc' :   if (strncmp('odbc_',$drivername,5)==0) return substr($drivername,5); 
+		case 'ado'  :   if (strncmp('ado_',$drivername,4)==0) return substr($drivername,4);
+		case 'native':  break;
+		default:
+			return $provider;
+		}
+		
+		switch($drivername) {
+		case 'oracle': $drivername = 'oci8'; break;
+		case 'access': if ($perf) $drivername = ''; break;
+		case 'db2'   : break;
+		case 'sapdb' : break;
+		default:
+			$drivername = 'generic';
+			break;
 		}
-		
 		return $drivername;
 	}
 	
 	function &NewPerfMonitor(&$conn)
 	{
+		$false = false;
 		$drivername = _adodb_getdriver($conn->dataProvider,$conn->databaseType,true);
-		if (!$drivername || $drivername == 'generic') return false;
+		if (!$drivername || $drivername == 'generic') return $false;
 		include_once(ADODB_DIR.'/adodb-perf.inc.php');
 		@include_once(ADODB_DIR."/perf/perf-$drivername.inc.php");
 		$class = "Perf_$drivername";
-		if (!class_exists($class)) return false;
+		if (!class_exists($class)) return $false;
 		$perf =& new $class($conn);
 		
 		return $perf;
 	}
 	
-	function &NewDataDictionary(&$conn)
+	function &NewDataDictionary(&$conn,$drivername=false)
 	{
-		$drivername = _adodb_getdriver($conn->dataProvider,$conn->databaseType);
-		
+		$false = false;
+		if (!$drivername) $drivername = _adodb_getdriver($conn->dataProvider,$conn->databaseType);
+
 		include_once(ADODB_DIR.'/adodb-lib.inc.php');
 		include_once(ADODB_DIR.'/adodb-datadict.inc.php');
 		$path = ADODB_DIR."/datadict/datadict-$drivername.inc.php";
 
 		if (!file_exists($path)) {
 			ADOConnection::outp("Database driver '$path' not available");
-			return false;
+			return $false;
 		}
 		include_once($path);
 		$class = "ADODB2_$drivername";
@@ -3665,12 +3803,20 @@
 	/*
 		Perform a print_r, with pre tags for better formatting.
 	*/
-	function adodb_pr($var)
+	function adodb_pr($var,$as_string=false)
 	{
+		if ($as_string) ob_start();
+		
 		if (isset($_SERVER['HTTP_USER_AGENT'])) { 
 			echo " <pre>\n";print_r($var);echo "</pre>\n";
 		} else
 			print_r($var);
+			
+		if ($as_string) {
+			$s = ob_get_contents();
+			ob_end_clean();
+			return $s;
+		}
 	}
 	
 	/*
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-access.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-access.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-access.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-access.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-db2.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-db2.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-db2.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-db2.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -16,29 +16,29 @@
 	
 	var $databaseType = 'db2';
 	var $seqField = false;
- 	
+	
  	function ActualType($meta)
 	{
 		switch($meta) {
 		case 'C': return 'VARCHAR';
 		case 'XL': return 'CLOB';
 		case 'X': return 'VARCHAR(3600)'; 
-		
+
 		case 'C2': return 'VARCHAR'; // up to 32K
 		case 'X2': return 'VARCHAR(3600)'; // up to 32000, but default page size too small
-		
+
 		case 'B': return 'BLOB';
-			
+
 		case 'D': return 'DATE';
 		case 'T': return 'TIMESTAMP';
-		
+
 		case 'L': return 'SMALLINT';
 		case 'I': return 'INTEGER';
 		case 'I1': return 'SMALLINT';
 		case 'I2': return 'SMALLINT';
 		case 'I4': return 'INTEGER';
 		case 'I8': return 'BIGINT';
-		
+
 		case 'F': return 'DOUBLE';
 		case 'N': return 'DECIMAL';
 		default:
@@ -70,6 +70,73 @@
 		return array();
 	}
 	
+	
+	function xChangeTableSQL($tablename, $flds, $tableoptions = false)
+	{
+		
+		/**
+		  Allow basic table changes to DB2 databases
+		  DB2 will fatally reject changes to non character columns 
+
+		*/
+		
+		$validTypes = array("CHAR","VARC");
+		$invalidTypes = array("BIGI","BLOB","CLOB","DATE", "DECI","DOUB", "INTE", "REAL","SMAL", "TIME");
+		// check table exists
+		$cols = &$this->MetaColumns($tablename);
+		if ( empty($cols)) { 
+			return $this->CreateTableSQL($tablename, $flds, $tableoptions);
+		}
+		
+		// already exists, alter table instead
+		list($lines,$pkey) = $this->_GenFields($flds);
+		$alter = 'ALTER TABLE ' . $this->TableName($tablename);
+		$sql = array();
+		
+		foreach ( $lines as $id => $v ) {
+			if ( isset($cols[$id]) && is_object($cols[$id]) ) {
+				/**
+				  If the first field of $v is the fieldname, and
+				  the second is the field type/size, we assume its an
+				  attempt to modify the column size, so check that it is allowed
+				  $v can have an indeterminate number of blanks between the
+				  fields, so account for that too
+				 */
+				$vargs = explode(' ' , $v);
+				// assume that $vargs[0] is the field name.
+				$i=0;
+				// Find the next non-blank value;
+				for ($i=1;$i<sizeof($vargs);$i++)
+					if ($vargs[$i] != '')
+						break;
+				
+				// if $vargs[$i] is one of the following, we are trying to change the
+				// size of the field, if not allowed, simply ignore the request.
+				if (in_array(substr($vargs[$i],0,4),$invalidTypes)) 
+					continue;
+				// insert the appropriate DB2 syntax
+				if (in_array(substr($vargs[$i],0,4),$validTypes)) {
+					array_splice($vargs,$i,0,array('SET','DATA','TYPE'));
+				}
+
+				// Now Look for the NOT NULL statement as this is not allowed in
+				// the ALTER table statement. If it is in there, remove it
+				if (in_array('NOT',$vargs) && in_array('NULL',$vargs)) {
+					for ($i=1;$i<sizeof($vargs);$i++)
+					if ($vargs[$i] == 'NOT')
+						break;
+					array_splice($vargs,$i,2,'');
+				}
+				$v = implode(' ',$vargs);	
+				$sql[] = $alter . $this->alterCol . ' ' . $v;
+			} else {
+				$sql[] = $alter . $this->addCol . ' ' . $v;
+			}
+		}
+		
+		return $sql;
+	}
+	
 }
 
 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-firebird.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-firebird.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-firebird.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-firebird.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -21,7 +21,7 @@
 	{
 		switch($meta) {
 		case 'C': return 'VARCHAR';
-		case 'XL':
+		case 'XL': return 'VARCHAR(32000)'; 
 		case 'X': return 'VARCHAR(4000)'; 
 		
 		case 'C2': return 'VARCHAR'; // up to 32K
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-generic.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-generic.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-generic.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-generic.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-ibase.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-ibase.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-ibase.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-ibase.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-informix.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-informix.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-informix.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-informix.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-mssql.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-mssql.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-mssql.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-mssql.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -15,8 +15,10 @@
 
 class ADODB2_mssql extends ADODB_DataDict {
 	var $databaseType = 'mssql';
-	
 	var $dropIndex = 'DROP INDEX %2$s.%1$s';
+	var $renameTable = "EXEC sp_rename '%s','%s'";
+	var $renameColumn = "EXEC sp_rename '%s.%s','%s'";
+	//var $alterCol = ' ALTER COLUMN ';
 	
 	function MetaType($t,$len=-1,$fieldobj=false)
 	{
@@ -28,7 +30,7 @@
 		
 		$len = -1; // mysql max_length is not accurate
 		switch (strtoupper($t)) {
-
+		case 'R':
 		case 'INT': 
 		case 'INTEGER': return  'I';
 		case 'BIT':
@@ -45,10 +47,10 @@
 	function ActualType($meta)
 	{
 		switch(strtoupper($meta)) {
+
 		case 'C': return 'VARCHAR';
-		case 'XL':
-		case 'X': return 'TEXT';
-		
+		case 'XL': return 'TEXT';
+		case 'X': return 'VARCHAR(4000)'; ## could be varchar(8000), but we want compat with oracle
 		case 'C2': return 'NVARCHAR';
 		case 'X2': return 'NTEXT';
 		
@@ -58,6 +60,7 @@
 		case 'T': return 'DATETIME';
 		case 'L': return 'BIT';
 		
+		case 'R':		
 		case 'I': return 'INT'; 
 		case 'I1': return 'TINYINT';
 		case 'I2': return 'SMALLINT';
@@ -81,7 +84,7 @@
 		foreach($lines as $v) {
 			$f[] = "\n $v";
 		}
-		$s .= implode(',',$f);
+		$s .= implode(', ',$f);
 		$sql[] = $s;
 		return $sql;
 	}
@@ -108,9 +111,9 @@
 		$f = array();
 		$s = 'ALTER TABLE ' . $tabname;
 		foreach($flds as $v) {
-			$f[] = "\n$this->dropCol $v";
+			$f[] = "\n$this->dropCol ".$this->NameQuote($v);
 		}
-		$s .= implode(',',$f);
+		$s .= implode(', ',$f);
 		$sql[] = $s;
 		return $sql;
 	}
@@ -239,12 +242,9 @@
 		case 'BIGINT':
 			return $ftype;
 		}
-		if (strlen($fsize) && $ty != 'X' && $ty != 'B' && strpos($ftype,'(') === false) {
-			$ftype .= "(".$fsize;
-			if (strlen($fprec)) $ftype .= ",".$fprec;
-			$ftype .= ')';
-		}
-		return $ftype;
+    	if ($ty == 'T') return $ftype;
+    	return parent::_GetSize($ftype, $ty, $fsize, $fprec);    
+
 	}
 }
 ?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-mysql.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-mysql.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-mysql.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-mysql.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -20,6 +20,7 @@
 	var $dropTable = 'DROP TABLE IF EXISTS %s'; // requires mysql 3.22 or later
 	
 	var $dropIndex = 'DROP INDEX %s ON %s';
+	var $renameColumn = 'ALTER TABLE %s CHANGE COLUMN %s %s %s';	// needs column-definition!
 	
 	function MetaType($t,$len=-1,$fieldobj=false)
 	{
@@ -28,6 +29,7 @@
 			$t = $fieldobj->type;
 			$len = $fieldobj->max_length;
 		}
+		$is_serial = is_object($fieldobj) && $fieldobj->primary_key && $fieldobj->auto_increment;
 		
 		$len = -1; // mysql max_length is not accurate
 		switch (strtoupper($t)) {
@@ -65,11 +67,11 @@
 			return 'F';
 			
 		case 'INT': 
-		case 'INTEGER': return (!empty($fieldobj->primary_key)) ? 'R' : 'I';
-		case 'TINYINT': return (!empty($fieldobj->primary_key)) ? 'R' : 'I1';
-		case 'SMALLINT': return (!empty($fieldobj->primary_key)) ? 'R' : 'I2';
-		case 'MEDIUMINT': return (!empty($fieldobj->primary_key)) ? 'R' : 'I4';
-		case 'BIGINT':  return (!empty($fieldobj->primary_key)) ? 'R' : 'I8';
+		case 'INTEGER': return $is_serial ? 'R' : 'I';
+		case 'TINYINT': return $is_serial ? 'R' : 'I1';
+		case 'SMALLINT': return $is_serial ? 'R' : 'I2';
+		case 'MEDIUMINT': return $is_serial ? 'R' : 'I4';
+		case 'BIGINT':  return $is_serial ? 'R' : 'I8';
 		default: return 'N';
 		}
 	}
@@ -78,8 +80,8 @@
 	{
 		switch(strtoupper($meta)) {
 		case 'C': return 'VARCHAR';
-		case 'XL':
-		case 'X': return 'LONGTEXT';
+		case 'XL':return 'LONGTEXT';
+		case 'X': return 'TEXT';
 		
 		case 'C2': return 'VARCHAR';
 		case 'X2': return 'LONGTEXT';
@@ -91,10 +93,10 @@
 		case 'L': return 'TINYINT';
 		
 		case 'R':
+		case 'I4':
 		case 'I': return 'INTEGER';
 		case 'I1': return 'TINYINT';
 		case 'I2': return 'SMALLINT';
-		case 'I4': return 'MEDIUMINT';
 		case 'I8': return 'BIGINT';
 		
 		case 'F': return 'DOUBLE';
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-oci8.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-oci8.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-oci8.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-oci8.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -20,6 +20,7 @@
 	var $seqPrefix = 'SEQ_';
 	var $dropTable = "DROP TABLE %s CASCADE CONSTRAINTS";
 	var $trigPrefix = 'TRIG_';
+	var $alterCol = ' MODIFY ';
 	
 	function MetaType($t,$len=-1)
 	{
@@ -113,7 +114,7 @@
 			$f[] = "\n $v";
 		}
 		
-		$s .= implode(',',$f).')';
+		$s .= implode(', ',$f).')';
 		$sql[] = $s;
 		return $sql;
 	}
@@ -126,7 +127,7 @@
 		foreach($lines as $v) {
 			$f[] = "\n $v";
 		}
-		$s .= implode(',',$f).')';
+		$s .= implode(', ',$f).')';
 		$sql[] = $s;
 		return $sql;
 	}
@@ -134,9 +135,11 @@
 	function DropColumnSQL($tabname, $flds)
 	{
 		if (!is_array($flds)) $flds = explode(',',$flds);
+		foreach ($flds as $k => $v) $flds[$k] = $this->NameQuote($v);
+		
 		$sql = array();
 		$s = "ALTER TABLE $tabname DROP(";
-		$s .= implode(',',$flds).') CASCADE COSTRAINTS';
+		$s .= implode(', ',$flds).') CASCADE CONSTRAINTS';
 		$sql[] = $s;
 		return $sql;
 	}
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-postgres.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-postgres.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-postgres.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-postgres.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -20,6 +20,7 @@
 	var $seqPrefix = 'SEQ_';
 	var $addCol = ' ADD COLUMN';
 	var $quote = '"';
+	var $renameTable = 'ALTER TABLE %s RENAME TO %s'; // at least since 7.1
 	
 	function MetaType($t,$len=-1,$fieldobj=false)
 	{
@@ -28,6 +29,9 @@
 			$t = $fieldobj->type;
 			$len = $fieldobj->max_length;
 		}
+		$is_serial = is_object($fieldobj) && $fieldobj->primary_key && $fieldobj->unique && 
+			$fieldobj->has_default && substr($fieldobj->default_value,0,8) == 'nextval(';
+		
 		switch (strtoupper($t)) {
 			case 'INTERVAL':
 			case 'CHAR':
@@ -60,12 +64,12 @@
 			case 'TIMESTAMPTZ':
 				return 'T';
 			
-			case 'INTEGER': return (empty($fieldobj->primary_key) && empty($fieldobj->unique))? 'I' : 'R';
+			case 'INTEGER': return !$is_serial ? 'I' : 'R';
 			case 'SMALLINT': 
-			case 'INT2': return (empty($fieldobj->primary_key) && empty($fieldobj->unique))? 'I2' : 'R';
-			case 'INT4': return (empty($fieldobj->primary_key) && empty($fieldobj->unique))? 'I4' : 'R';
+			case 'INT2': return !$is_serial ? 'I2' : 'R';
+			case 'INT4': return !$is_serial ? 'I4' : 'R';
 			case 'BIGINT': 
-			case 'INT8': return (empty($fieldobj->primary_key) && empty($fieldobj->unique))? 'I8' : 'R';
+			case 'INT8': return !$is_serial ? 'I8' : 'R';
 				
 			case 'OID':
 			case 'SERIAL':
@@ -111,23 +115,150 @@
 		}
 	}
 	
-	/* The following does not work in Pg 6.0 - does anyone want to contribute code? 
+	/**
+	 * Adding a new Column 
+	 *
+	 * reimplementation of the default function as postgres does NOT allow to set the default in the same statement
+	 *
+	 * @param string $tabname table-name
+	 * @param string $flds column-names and types for the changed columns
+	 * @return array with SQL strings
+	 */
+	function AddColumnSQL($tabname, $flds)
+	{
+		$tabname = $this->TableName ($tabname);
+		$sql = array();
+		list($lines,$pkey) = $this->_GenFields($flds);
+		$alter = 'ALTER TABLE ' . $tabname . $this->addCol . ' ';
+		foreach($lines as $v) {
+			if (($not_null = preg_match('/NOT NULL/i',$v))) {
+				$v = preg_replace('/NOT NULL/i','',$v);
+			}
+			if (preg_match('/^([^ ]+) .*(DEFAULT [^ ]+)/',$v,$matches)) {
+				list(,$colname,$default) = $matches;
+				$sql[] = $alter . str_replace($default,'',$v);
+				$sql[] = 'ALTER TABLE '.$tabname.' ALTER COLUMN '.$colname.' SET ' . $default;
+			} else {				
+				$sql[] = $alter . $v;
+			}
+			if ($not_null) {
+				list($colname) = explode(' ',$v);
+				$sql[] = 'ALTER TABLE '.$tabname.' ALTER COLUMN '.$colname.' SET NOT NULL';
+			}
+		}
+		return $sql;
+	}
+	
+	/**
+	 * Change the definition of one column
+	 *
+	 * Postgres can't do that on it's own, you need to supply the complete defintion of the new table,
+	 * to allow, recreating the table and copying the content over to the new table
+	 * @param string $tabname table-name
+	 * @param string $flds column-name and type for the changed column
+	 * @param string $tableflds complete defintion of the new table, eg. for postgres, default ''
+	 * @param array/ $tableoptions options for the new table see CreateTableSQL, default ''
+	 * @return array with SQL strings
+	 */
+	function AlterColumnSQL($tabname, $flds, $tableflds='',$tableoptions='')
+	{
+		if (!$tableflds) {
+			if ($this->debug) ADOConnection::outp("AlterColumnSQL needs a complete table-definiton for PostgreSQL");
+			return array();
+		}
+		return $this->_recreate_copy_table($tabname,False,$tableflds,$tableoptions);
+	}
 	
-	//"ALTER TABLE table ALTER COLUMN column SET DEFAULT mydef" and
-	//"ALTER TABLE table ALTER COLUMN column DROP DEFAULT mydef"
-	//"ALTER TABLE table ALTER COLUMN column SET NOT NULL" and
-	//"ALTER TABLE table ALTER COLUMN column DROP NOT NULL"*/
-	function AlterColumnSQL($tabname, $flds)
+	/**
+	 * Drop one column
+	 *
+	 * Postgres < 7.3 can't do that on it's own, you need to supply the complete defintion of the new table,
+	 * to allow, recreating the table and copying the content over to the new table
+	 * @param string $tabname table-name
+	 * @param string $flds column-name and type for the changed column
+	 * @param string $tableflds complete defintion of the new table, eg. for postgres, default ''
+	 * @param array/ $tableoptions options for the new table see CreateTableSQL, default ''
+	 * @return array with SQL strings
+	 */
+	function DropColumnSQL($tabname, $flds, $tableflds='',$tableoptions='')
 	{
-		if ($this->debug) ADOConnection::outp("AlterColumnSQL not supported for PostgreSQL");
+		$has_drop_column = 7.3 <= (float) @$this->serverInfo['version'];
+		if (!$has_drop_column && !$tableflds) {
+			if ($this->debug) ADOConnection::outp("DropColumnSQL needs complete table-definiton for PostgreSQL < 7.3");
 		return array();
 	}
+		if ($has_drop_column) {
+			return ADODB_DataDict::DropColumnSQL($tabname, $flds);
+		}
+		return $this->_recreate_copy_table($tabname,$flds,$tableflds,$tableoptions);
+	}
 	
+	/**
+	 * Save the content into a temp. table, drop and recreate the original table and copy the content back in
+	 *
+	 * We also take care to set the values of the sequenz and recreate the indexes.
+	 * All this is done in a transaction, to not loose the content of the table, if something went wrong!
+	 * @internal
+	 * @param string $tabname table-name
+	 * @param string $dropflds column-names to drop
+	 * @param string $tableflds complete defintion of the new table, eg. for postgres
+	 * @param array/string $tableoptions options for the new table see CreateTableSQL, default ''
+	 * @return array with SQL strings
+	 */
+	function _recreate_copy_table($tabname,$dropflds,$tableflds,$tableoptions='')
+	{
+		if ($dropflds && !is_array($dropflds)) $dropflds = explode(',',$dropflds);
+		$copyflds = array();
+		foreach($this->MetaColumns($tabname) as $fld) {
+			if (!$dropflds || !in_array($fld->name,$dropflds)) {
+				// we need to explicit convert varchar to a number to be able to do an AlterColumn of a char column to a nummeric one
+				if (preg_match('/'.$fld->name.' (I|I2|I4|I8|N|F)/i',$tableflds,$matches) && 
+					in_array($fld->type,array('varchar','char','text','bytea'))) {
+					$copyflds[] = "to_number($fld->name,'S99D99')";
+				} else {
+					$copyflds[] = $fld->name;
+				}
+				// identify the sequence name and the fld its on
+				if ($fld->primary_key && $fld->has_default && 
+					preg_match("/nextval\('([^']+)'::text\)/",$fld->default_value,$matches)) {
+					$seq_name = $matches[1];
+					$seq_fld = $fld->name;
+				}
+			}
+		}
+		$copyflds = implode(', ',$copyflds);
+		
+		$tempname = $tabname.'_tmp';
+		$aSql[] = 'BEGIN';		// we use a transaction, to make sure not to loose the content of the table
+		$aSql[] = "SELECT * INTO TEMPORARY TABLE $tempname FROM $tabname";
+		$aSql = array_merge($aSql,$this->DropTableSQL($tabname));
+		$aSql = array_merge($aSql,$this->CreateTableSQL($tabname,$tableflds,$tableoptions));
+		$aSql[] = "INSERT INTO $tabname SELECT $copyflds FROM $tempname";
+		if ($seq_name && $seq_fld) {	// if we have a sequence we need to set it again
+			$seq_name = $tabname.'_'.$seq_fld.'_seq';	// has to be the name of the new implicit sequence
+			$aSql[] = "SELECT setval('$seq_name',MAX($seq_fld)) FROM $tabname";
+		}
+		$aSql[] = "DROP TABLE $tempname";
+		// recreate the indexes, if they not contain one of the droped columns
+		foreach($this->MetaIndexes($tabname) as $idx_name => $idx_data)
+		{
+			if (substr($idx_name,-5) != '_pkey' && (!$dropflds || !count(array_intersect($dropflds,$idx_data['columns'])))) {
+				$aSql = array_merge($aSql,$this->CreateIndexSQL($idx_name,$tabname,$idx_data['columns'],
+					$idx_data['unique'] ? array('UNIQUE') : False));
+			}
+		}
+		$aSql[] = 'COMMIT';
+		return $aSql;
+	}
 	
-	function DropColumnSQL($tabname, $flds)
+	function DropTableSQL($tabname)
 	{
-		if ($this->debug) ADOConnection::outp("DropColumnSQL only works with PostgreSQL 7.3+");
-		return ADODB_DataDict::DropColumnSQL($tabname, $flds)."/* only works for PostgreSQL 7.3+ */";
+		$sql = ADODB_DataDict::DropTableSQL($tabname);
+		
+		$drop_seq = $this->_DropAutoIncrement($tabname);
+		if ($drop_seq) $sql[] = $drop_seq;
+		
+		return $sql;
 	}
 
 	// return string must begin with space
@@ -144,9 +275,20 @@
 		return $suffix;
 	}
 	
-	function _DropAutoIncrement($t)
+	// search for a sequece for the given table (asumes the seqence-name contains the table-name!)
+	// if yes return sql to drop it
+	// this is still necessary if postgres < 7.3 or the SERIAL was created on an earlier version!!!
+	function _DropAutoIncrement($tabname)
 	{
-		return "drop sequence ".$t."_m_id_seq";
+		$tabname = $this->connection->quote('%'.$tabname.'%');
+
+		$seq = $this->connection->GetOne("SELECT relname FROM pg_class WHERE NOT relname ~ 'pg_.*' AND relname LIKE $tabname AND relkind='S'");
+
+		// check if a tables depends on the sequenz and it therefor cant and dont need to be droped separatly
+		if (!$seq || $this->connection->GetOne("SELECT relname FROM pg_class JOIN pg_depend ON pg_class.relfilenode=pg_depend.objid WHERE relname='$seq' AND relkind='S' AND deptype='i'")) {
+			return False;
+		}
+		return "DROP SEQUENCE ".$seq;
 	}
 	
 	/*
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-sapdb.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-sapdb.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-sapdb.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-sapdb.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -0,0 +1,121 @@
+<?php
+
+/**
+  V4.50 6 July 2004  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
+  Released under both BSD license and Lesser GPL library license. 
+  Whenever there is any discrepancy between the two licenses, 
+  the BSD license will take precedence.
+	
+  Set tabs to 4 for best viewing.
+  
+  Modified from datadict-generic.inc.php for sapdb by RalfBecker-AT-outdoor-training.de
+*/
+
+// security - hide paths
+if (!defined('ADODB_DIR')) die();
+
+class ADODB2_sapdb extends ADODB_DataDict {
+	
+	var $databaseType = 'sapdb';
+	var $seqField = false;	
+	var $renameColumn = 'RENAME COLUMN %s.%s TO %s';
+ 	
+ 	function ActualType($meta)
+	{
+		switch($meta) {
+		case 'C': return 'VARCHAR';
+		case 'XL':
+		case 'X': return 'LONG';
+		
+		case 'C2': return 'VARCHAR UNICODE';
+		case 'X2': return 'LONG UNICODE';
+		
+		case 'B': return 'LONG';
+			
+		case 'D': return 'DATE';
+		case 'T': return 'TIMESTAMP';
+		
+		case 'L': return 'BOOLEAN';
+		case 'I': return 'INTEGER';
+		case 'I1': return 'FIXED(3)';
+		case 'I2': return 'SMALLINT';
+		case 'I4': return 'INTEGER';
+		case 'I8': return 'FIXED(20)';
+		
+		case 'F': return 'FLOAT(38)';
+		case 'N': return 'FIXED';
+		default:
+			return $meta;
+		}
+	}
+	
+	function MetaType($t,$len=-1,$fieldobj=false)
+	{
+		if (is_object($t)) {
+			$fieldobj = $t;
+			$t = $fieldobj->type;
+			$len = $fieldobj->max_length;
+		}
+		static $maxdb_type2adodb = array(
+			'VARCHAR'	=> 'C',
+			'CHARACTER'	=> 'C',
+			'LONG'		=> 'X',		// no way to differ between 'X' and 'B' :-(
+			'DATE'		=> 'D',
+			'TIMESTAMP'	=> 'T',
+			'BOOLEAN'	=> 'L',
+			'INTEGER'	=> 'I4',
+			'SMALLINT'	=> 'I2',
+			'FLOAT'		=> 'F',
+			'FIXED'		=> 'N',
+		);
+		$type = isset($maxdb_type2adodb[$t]) ? $maxdb_type2adodb[$t] : 'C';
+
+		// convert integer-types simulated with fixed back to integer
+		if ($t == 'FIXED' && !$fieldobj->scale && ($len == 20 || $len == 3)) {
+			$type = $len == 20 ? 'I8' : 'I1';
+		}
+		if ($fieldobj->auto_increment) $type = 'R';
+
+		return $type;
+	}
+	
+	// return string must begin with space
+	function _CreateSuffix($fname,$ftype,$fnotnull,$fdefault,$fautoinc,$fconstraint,$funsigned)
+	{	
+		$suffix = '';
+		if ($funsigned) $suffix .= ' UNSIGNED';
+		if ($fnotnull) $suffix .= ' NOT NULL';
+		if ($fautoinc) $suffix .= ' DEFAULT SERIAL';
+		elseif (strlen($fdefault)) $suffix .= " DEFAULT $fdefault";
+		if ($fconstraint) $suffix .= ' '.$fconstraint;
+		return $suffix;
+	}
+
+	function AddColumnSQL($tabname, $flds)
+	{
+		$tabname = $this->TableName ($tabname);
+		$sql = array();
+		list($lines,$pkey) = $this->_GenFields($flds);
+		return array( 'ALTER TABLE ' . $tabname . ' ADD (' . implode(', ',$lines) . ')' );
+	}
+	
+	function AlterColumnSQL($tabname, $flds)
+	{
+		$tabname = $this->TableName ($tabname);
+		$sql = array();
+		list($lines,$pkey) = $this->_GenFields($flds);
+		return array( 'ALTER TABLE ' . $tabname . ' MODIFY (' . implode(', ',$lines) . ')' );
+	}
+
+	function DropColumnSQL($tabname, $flds)
+	{
+		$tabname = $this->TableName ($tabname);
+		if (!is_array($flds)) $flds = explode(',',$flds);
+		foreach($flds as $k => $v) {
+			$flds[$k] = $this->NameQuote($v);
+		}
+		return array( 'ALTER TABLE ' . $tabname . ' DROP (' . implode(', ',$flds) . ')' );
+	}	
+}
+
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-sybase.inc.php zentrack_2-5-5-1/includes/adodb/datadict/datadict-sybase.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/datadict/datadict-sybase.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/datadict/datadict-sybase.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /**
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -81,7 +81,7 @@
 		foreach($lines as $v) {
 			$f[] = "\n $v";
 		}
-		$s .= implode(',',$f);
+		$s .= implode(', ',$f);
 		$sql[] = $s;
 		return $sql;
 	}
@@ -100,14 +100,14 @@
 	
 	function DropColumnSQL($tabname, $flds)
 	{
-		$tabname = $this->TableName ($tabname);
+		$tabname = $this->TableName($tabname);
 		if (!is_array($flds)) $flds = explode(',',$flds);
 		$f = array();
 		$s = "ALTER TABLE $tabname";
 		foreach($flds as $v) {
-			$f[] = "\n$this->dropCol $v";
+			$f[] = "\n$this->dropCol ".$this->NameQuote($v);
 		}
-		$s .= implode(',',$f);
+		$s .= implode(', ',$f);
 		$sql[] = $s;
 		return $sql;
 	}
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-access.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-access.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-access.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-access.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. See License.txt. 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ado.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-ado.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ado.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-ado.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -172,7 +172,7 @@
 	function &MetaColumns($table)
 	{
 		$table = strtoupper($table);
-		$arr= array();
+		$arr = array();
 		$dbc = $this->_connectionID;
 		
 		$adors=@$dbc->OpenSchema(4);//tables
@@ -196,8 +196,8 @@
 			}
 			$adors->Close();
 		}
-		
-		return $arr;
+		$false = false;
+		return empty($arr) ? $false : $arr;
 	}
 	
 
@@ -208,6 +208,7 @@
 	{
 		
 		$dbc = $this->_connectionID;
+		$false = false;
 		
 	//	return rs	
 		if ($inputarr) {
@@ -230,21 +231,19 @@
 			$p = false;
 			$rs = $oCmd->Execute();
 			$e = $dbc->Errors;
-			if ($dbc->Errors->Count > 0) return false;
+			if ($dbc->Errors->Count > 0) return $false;
 			return $rs;
 		}
 		
 		$rs = @$dbc->Execute($sql,$this->_affectedRows, $this->_execute_option);
-		/*
-			$rs =  new COM('ADODB.Recordset');
-			if ($rs) {
-				$rs->Open ($sql, $dbc, $this->_cursor_type,$this->_lock_type, $this->_execute_option);							
-			}
-		*/
-		if ($dbc->Errors->Count > 0) return false;
-		if (! $rs) return false;
+
+		if ($dbc->Errors->Count > 0) return $false;
+		if (! $rs) return $false;
 		
-		if ($rs->State == 0) return true; // 0 = adStateClosed means no records returned
+		if ($rs->State == 0) {
+			$true = true;
+			return $true; // 0 = adStateClosed means no records returned
+		}
 		return $rs;
 	}
 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ado5.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-ado5.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ado5.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-ado5.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -0,0 +1,636 @@
+<?php
+/* 
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
+  Released under both BSD license and Lesser GPL library license. 
+  Whenever there is any discrepancy between the two licenses, 
+  the BSD license will take precedence. 
+Set tabs to 4 for best viewing.
+  
+  Latest version is available at http://adodb.sourceforge.net
+  
+	Microsoft ADO data driver. Requires ADO. Works only on MS Windows. PHP5 compat version.
+*/
+
+// security - hide paths
+if (!defined('ADODB_DIR')) die();
+	
+define("_ADODB_ADO_LAYER", 1 );
+/*--------------------------------------------------------------------------------------
+--------------------------------------------------------------------------------------*/
+
+	
+class ADODB_ado extends ADOConnection {
+	var $databaseType = "ado";	
+	var $_bindInputArray = false;
+	var $fmtDate = "'Y-m-d'";
+	var $fmtTimeStamp = "'Y-m-d, h:i:sA'";
+	var $replaceQuote = "''"; // string to use to replace quotes
+	var $dataProvider = "ado";	
+	var $hasAffectedRows = true;
+	var $adoParameterType = 201; // 201 = long varchar, 203=long wide varchar, 205 = long varbinary
+	var $_affectedRows = false;
+	var $_thisTransactions;
+	var $_cursor_type = 3; // 3=adOpenStatic,0=adOpenForwardOnly,1=adOpenKeyset,2=adOpenDynamic
+	var $_cursor_location = 3; // 2=adUseServer, 3 = adUseClient;
+	var $_lock_type = -1;
+	var $_execute_option = -1;
+	var $poorAffectedRows = true; 
+	var $charPage;
+		
+	function ADODB_ado() 
+	{ 	
+		$this->_affectedRows = new VARIANT;
+	}
+
+	function ServerInfo()
+	{
+		if (!empty($this->_connectionID)) $desc = $this->_connectionID->provider;
+		return array('description' => $desc, 'version' => '');
+	}
+	
+	function _affectedrows()
+	{
+		if (PHP_VERSION >= 5) return $this->_affectedRows;
+		
+		return $this->_affectedRows->value;
+	}
+	
+	// you can also pass a connection string like this:
+	//
+	// $DB->Connect('USER ID=sa;PASSWORD=pwd;SERVER=mangrove;DATABASE=ai',false,false,'SQLOLEDB');
+	function _connect($argHostname, $argUsername, $argPassword, $argProvider= 'MSDASQL')
+	{
+		try {
+		$u = 'UID';
+		$p = 'PWD';
+	
+		if (!empty($this->charPage))
+			$dbc = new COM('ADODB.Connection',null,$this->charPage);
+		else
+			$dbc = new COM('ADODB.Connection');
+			
+		if (! $dbc) return false;
+
+		/* special support if provider is mssql or access */
+		if ($argProvider=='mssql') {
+			$u = 'User Id';  //User parameter name for OLEDB
+			$p = 'Password'; 
+			$argProvider = "SQLOLEDB"; // SQL Server Provider
+			
+			// not yet
+			//if ($argDatabasename) $argHostname .= ";Initial Catalog=$argDatabasename";
+			
+			//use trusted conection for SQL if username not specified
+			if (!$argUsername) $argHostname .= ";Trusted_Connection=Yes";
+		} else if ($argProvider=='access')
+			$argProvider = "Microsoft.Jet.OLEDB.4.0"; // Microsoft Jet Provider
+		
+		if ($argProvider) $dbc->Provider = $argProvider;	
+		
+		if ($argUsername) $argHostname .= ";$u=$argUsername";
+		if ($argPassword)$argHostname .= ";$p=$argPassword";
+		
+		if ($this->debug) ADOConnection::outp( "Host=".$argHostname."<BR>\n version=$dbc->version");
+		// @ added below for php 4.0.1 and earlier
+		@$dbc->Open((string) $argHostname);
+		
+		$this->_connectionID = $dbc;
+		
+		$dbc->CursorLocation = $this->_cursor_location;
+		return  $dbc->State > 0;
+		} catch (exception $e) {
+		}
+		
+		return false;
+	}
+	
+	// returns true or false
+	function _pconnect($argHostname, $argUsername, $argPassword, $argProvider='MSDASQL')
+	{
+		return $this->_connect($argHostname,$argUsername,$argPassword,$argProvider);
+	}	
+	
+/*
+	adSchemaCatalogs	= 1,
+	adSchemaCharacterSets	= 2,
+	adSchemaCollations	= 3,
+	adSchemaColumns	= 4,
+	adSchemaCheckConstraints	= 5,
+	adSchemaConstraintColumnUsage	= 6,
+	adSchemaConstraintTableUsage	= 7,
+	adSchemaKeyColumnUsage	= 8,
+	adSchemaReferentialContraints	= 9,
+	adSchemaTableConstraints	= 10,
+	adSchemaColumnsDomainUsage	= 11,
+	adSchemaIndexes	= 12,
+	adSchemaColumnPrivileges	= 13,
+	adSchemaTablePrivileges	= 14,
+	adSchemaUsagePrivileges	= 15,
+	adSchemaProcedures	= 16,
+	adSchemaSchemata	= 17,
+	adSchemaSQLLanguages	= 18,
+	adSchemaStatistics	= 19,
+	adSchemaTables	= 20,
+	adSchemaTranslations	= 21,
+	adSchemaProviderTypes	= 22,
+	adSchemaViews	= 23,
+	adSchemaViewColumnUsage	= 24,
+	adSchemaViewTableUsage	= 25,
+	adSchemaProcedureParameters	= 26,
+	adSchemaForeignKeys	= 27,
+	adSchemaPrimaryKeys	= 28,
+	adSchemaProcedureColumns	= 29,
+	adSchemaDBInfoKeywords	= 30,
+	adSchemaDBInfoLiterals	= 31,
+	adSchemaCubes	= 32,
+	adSchemaDimensions	= 33,
+	adSchemaHierarchies	= 34,
+	adSchemaLevels	= 35,
+	adSchemaMeasures	= 36,
+	adSchemaProperties	= 37,
+	adSchemaMembers	= 38
+
+*/
+	
+	function &MetaTables()
+	{
+		$arr= array();
+		$dbc = $this->_connectionID;
+		
+		$adors=@$dbc->OpenSchema(20);//tables
+		if ($adors){
+			$f = $adors->Fields(2);//table/view name
+			$t = $adors->Fields(3);//table type
+			while (!$adors->EOF){
+				$tt=substr($t->value,0,6);
+				if ($tt!='SYSTEM' && $tt !='ACCESS')
+					$arr[]=$f->value;
+				//print $f->value . ' ' . $t->value.'<br>';
+				$adors->MoveNext();
+			}
+			$adors->Close();
+		}
+		
+		return $arr;
+	}
+	
+	function &MetaColumns($table)
+	{
+		$table = strtoupper($table);
+		$arr= array();
+		$dbc = $this->_connectionID;
+		
+		$adors=@$dbc->OpenSchema(4);//tables
+	
+		if ($adors){
+			$t = $adors->Fields(2);//table/view name
+			while (!$adors->EOF){
+				
+				
+				if (strtoupper($t->Value) == $table) {
+				
+					$fld = new ADOFieldObject();
+					$c = $adors->Fields(3);
+					$fld->name = $c->Value;
+					$fld->type = 'CHAR'; // cannot discover type in ADO!
+					$fld->max_length = -1;
+					$arr[strtoupper($fld->name)]=$fld;
+				}
+		
+				$adors->MoveNext();
+			}
+			$adors->Close();
+		}
+		
+		return $arr;
+	}
+	
+
+
+	
+	/* returns queryID or false */
+	function &_query($sql,$inputarr=false) 
+	{
+		try { // In PHP5, all COM errors are exceptions, so to maintain old behaviour...
+		
+		$dbc = $this->_connectionID;
+		
+	//	return rs	
+		if ($inputarr) {
+			
+			if (!empty($this->charPage))
+				$oCmd = new COM('ADODB.Command',null,$this->charPage);
+			else
+				$oCmd = new COM('ADODB.Command');
+			$oCmd->ActiveConnection = $dbc;
+			$oCmd->CommandText = $sql;
+			$oCmd->CommandType = 1;
+
+			foreach($inputarr as $val) {
+				// name, type, direction 1 = input, len,
+				$this->adoParameterType = 130;
+				$p = $oCmd->CreateParameter('name',$this->adoParameterType,1,strlen($val),$val);
+				//print $p->Type.' '.$p->value;
+				$oCmd->Parameters->Append($p);
+			}
+			$p = false;
+			$rs = $oCmd->Execute();
+			$e = $dbc->Errors;
+			if ($dbc->Errors->Count > 0) return false;
+			return $rs;
+		}
+		
+		$rs = @$dbc->Execute($sql,$this->_affectedRows, $this->_execute_option);
+			
+		if ($dbc->Errors->Count > 0) return false;
+		if (! $rs) return false;
+		
+		if ($rs->State == 0) return true; // 0 = adStateClosed means no records returned
+		return $rs;
+		
+		} catch (exception $e) {
+			
+		}
+		return false;
+	}
+
+	
+	function BeginTrans() 
+	{ 
+		if ($this->transOff) return true;
+		
+		if (isset($this->_thisTransactions))
+			if (!$this->_thisTransactions) return false;
+		else {
+			$o = $this->_connectionID->Properties("Transaction DDL");
+			$this->_thisTransactions = $o ? true : false;
+			if (!$o) return false;
+		}
+		@$this->_connectionID->BeginTrans();
+		$this->transCnt += 1;
+		return true;
+	}
+	function CommitTrans($ok=true) 
+	{ 
+		if (!$ok) return $this->RollbackTrans();
+		if ($this->transOff) return true;
+		
+		@$this->_connectionID->CommitTrans();
+		if ($this->transCnt) @$this->transCnt -= 1;
+		return true;
+	}
+	function RollbackTrans() {
+		if ($this->transOff) return true;
+		@$this->_connectionID->RollbackTrans();
+		if ($this->transCnt) @$this->transCnt -= 1;
+		return true;
+	}
+	
+	/*	Returns: the last error message from previous database operation	*/	
+
+	function ErrorMsg() 
+	{
+		$errc = $this->_connectionID->Errors;
+		if ($errc->Count == 0) return '';
+		$err = $errc->Item($errc->Count-1);
+		return $err->Description;
+	}
+	
+	function ErrorNo() 
+	{
+		$errc = $this->_connectionID->Errors;
+		if ($errc->Count == 0) return 0;
+		$err = $errc->Item($errc->Count-1);
+		return $err->NativeError;
+	}
+
+	// returns true or false
+	function _close()
+	{
+		if ($this->_connectionID) $this->_connectionID->Close();
+		$this->_connectionID = false;
+		return true;
+	}
+	
+	
+}
+	
+/*--------------------------------------------------------------------------------------
+	 Class Name: Recordset
+--------------------------------------------------------------------------------------*/
+
+class ADORecordSet_ado extends ADORecordSet {	
+	
+	var $bind = false;
+	var $databaseType = "ado";	
+	var $dataProvider = "ado";	
+	var $_tarr = false; // caches the types
+	var $_flds; // and field objects
+	var $canSeek = true;
+  	var $hideErrors = true;
+		  
+	function ADORecordSet_ado($id,$mode=false)
+	{
+		if ($mode === false) { 
+			global $ADODB_FETCH_MODE;
+			$mode = $ADODB_FETCH_MODE;
+		}
+		$this->fetchMode = $mode;
+		return $this->ADORecordSet($id,$mode);
+	}
+
+
+	// returns the field object
+	function FetchField($fieldOffset = -1) {
+		$off=$fieldOffset+1; // offsets begin at 1
+		
+		$o= new ADOFieldObject();
+		$rs = $this->_queryID;
+		$f = $rs->Fields($fieldOffset);
+		$o->name = $f->Name;
+		$t = $f->Type;
+		$o->type = $this->MetaType($t);
+		$o->max_length = $f->DefinedSize;
+		$o->ado_type = $t;
+		
+
+		//print "off=$off name=$o->name type=$o->type len=$o->max_length<br>";
+		return $o;
+	}
+	
+	/* Use associative array to get fields array */
+	function Fields($colname)
+	{
+		if ($this->fetchMode & ADODB_FETCH_ASSOC) return $this->fields[$colname];
+		if (!$this->bind) {
+			$this->bind = array();
+			for ($i=0; $i < $this->_numOfFields; $i++) {
+				$o = $this->FetchField($i);
+				$this->bind[strtoupper($o->name)] = $i;
+			}
+		}
+		
+		 return $this->fields[$this->bind[strtoupper($colname)]];
+	}
+
+		
+	function _initrs()
+	{
+		$rs = $this->_queryID;
+		$this->_numOfRows = $rs->RecordCount;
+		
+		$f = $rs->Fields;
+		$this->_numOfFields = $f->Count;
+	}
+	
+	
+	 // should only be used to move forward as we normally use forward-only cursors
+	function _seek($row)
+	{
+	   $rs = $this->_queryID; 
+		// absoluteposition doesn't work -- my maths is wrong ?
+		//	$rs->AbsolutePosition->$row-2;
+		//	return true;
+		if ($this->_currentRow > $row) return false;
+		@$rs->Move((integer)$row - $this->_currentRow-1); //adBookmarkFirst
+		return true;
+	}
+	
+/*
+	OLEDB types
+	
+	 enum DBTYPEENUM
+	{	DBTYPE_EMPTY	= 0,
+	DBTYPE_NULL	= 1,
+	DBTYPE_I2	= 2,
+	DBTYPE_I4	= 3,
+	DBTYPE_R4	= 4,
+	DBTYPE_R8	= 5,
+	DBTYPE_CY	= 6,
+	DBTYPE_DATE	= 7,
+	DBTYPE_BSTR	= 8,
+	DBTYPE_IDISPATCH	= 9,
+	DBTYPE_ERROR	= 10,
+	DBTYPE_BOOL	= 11,
+	DBTYPE_VARIANT	= 12,
+	DBTYPE_IUNKNOWN	= 13,
+	DBTYPE_DECIMAL	= 14,
+	DBTYPE_UI1	= 17,
+	DBTYPE_ARRAY	= 0x2000,
+	DBTYPE_BYREF	= 0x4000,
+	DBTYPE_I1	= 16,
+	DBTYPE_UI2	= 18,
+	DBTYPE_UI4	= 19,
+	DBTYPE_I8	= 20,
+	DBTYPE_UI8	= 21,
+	DBTYPE_GUID	= 72,
+	DBTYPE_VECTOR	= 0x1000,
+	DBTYPE_RESERVED	= 0x8000,
+	DBTYPE_BYTES	= 128,
+	DBTYPE_STR	= 129,
+	DBTYPE_WSTR	= 130,
+	DBTYPE_NUMERIC	= 131,
+	DBTYPE_UDT	= 132,
+	DBTYPE_DBDATE	= 133,
+	DBTYPE_DBTIME	= 134,
+	DBTYPE_DBTIMESTAMP	= 135
+	
+	ADO Types
+	
+   	adEmpty	= 0,
+	adTinyInt	= 16,
+	adSmallInt	= 2,
+	adInteger	= 3,
+	adBigInt	= 20,
+	adUnsignedTinyInt	= 17,
+	adUnsignedSmallInt	= 18,
+	adUnsignedInt	= 19,
+	adUnsignedBigInt	= 21,
+	adSingle	= 4,
+	adDouble	= 5,
+	adCurrency	= 6,
+	adDecimal	= 14,
+	adNumeric	= 131,
+	adBoolean	= 11,
+	adError	= 10,
+	adUserDefined	= 132,
+	adVariant	= 12,
+	adIDispatch	= 9,
+	adIUnknown	= 13,	
+	adGUID	= 72,
+	adDate	= 7,
+	adDBDate	= 133,
+	adDBTime	= 134,
+	adDBTimeStamp	= 135,
+	adBSTR	= 8,
+	adChar	= 129,
+	adVarChar	= 200,
+	adLongVarChar	= 201,
+	adWChar	= 130,
+	adVarWChar	= 202,
+	adLongVarWChar	= 203,
+	adBinary	= 128,
+	adVarBinary	= 204,
+	adLongVarBinary	= 205,
+	adChapter	= 136,
+	adFileTime	= 64,
+	adDBFileTime	= 137,
+	adPropVariant	= 138,
+	adVarNumeric	= 139
+*/
+	function MetaType($t,$len=-1,$fieldobj=false)
+	{
+		if (is_object($t)) {
+			$fieldobj = $t;
+			$t = $fieldobj->type;
+			$len = $fieldobj->max_length;
+		}
+		
+		if (!is_numeric($t)) return $t;
+		
+		switch ($t) {
+		case 0:
+		case 12: // variant
+		case 8: // bstr
+		case 129: //char
+		case 130: //wc
+		case 200: // varc
+		case 202:// varWC
+		case 128: // bin
+		case 204: // varBin
+		case 72: // guid
+			if ($len <= $this->blobSize) return 'C';
+		
+		case 201:
+		case 203:
+			return 'X';
+		case 128:
+		case 204:
+		case 205:
+			 return 'B';
+		case 7:
+		case 133: return 'D';
+		
+		case 134:
+		case 135: return 'T';
+		
+		case 11: return 'L';
+		
+		case 16://	adTinyInt	= 16,
+		case 2://adSmallInt	= 2,
+		case 3://adInteger	= 3,
+		case 4://adBigInt	= 20,
+		case 17://adUnsignedTinyInt	= 17,
+		case 18://adUnsignedSmallInt	= 18,
+		case 19://adUnsignedInt	= 19,
+		case 20://adUnsignedBigInt	= 21,
+			return 'I';
+		default: return 'N';
+		}
+	}
+	
+	// time stamp not supported yet
+	function _fetch()
+	{	
+		$rs = $this->_queryID;
+		if (!$rs or $rs->EOF) {
+			$this->fields = false;
+			return false;
+		}
+		$this->fields = array();
+	
+		if (!$this->_tarr) {
+			$tarr = array();
+			$flds = array();
+			for ($i=0,$max = $this->_numOfFields; $i < $max; $i++) {
+				$f = $rs->Fields($i);
+				$flds[] = $f;
+				$tarr[] = $f->Type;
+			}
+			// bind types and flds only once
+			$this->_tarr = $tarr; 
+			$this->_flds = $flds;
+		}
+		$t = reset($this->_tarr);
+		$f = reset($this->_flds);
+		
+		if ($this->hideErrors)  $olde = error_reporting(E_ERROR|E_CORE_ERROR);// sometimes $f->value be null
+		for ($i=0,$max = $this->_numOfFields; $i < $max; $i++) {
+			//echo "<p>",$t,' ';var_dump($f->value); echo '</p>';
+			switch($t) {
+			case 135: // timestamp
+				if (!strlen((string)$f->value)) $this->fields[] = false;
+				else {
+					if (!is_numeric($f->value)) $val = variant_date_to_timestamp($f->value);
+					else $val = $f->value;
+					$this->fields[] = adodb_date('Y-m-d H:i:s',$val);
+				}
+				break;			
+			case 133:// A date value (yyyymmdd) 
+				if ($val = $f->value) {
+					$this->fields[] = substr($val,0,4).'-'.substr($val,4,2).'-'.substr($val,6,2);
+				} else
+					$this->fields[] = false;
+				break;
+			case 7: // adDate
+				if (!strlen((string)$f->value)) $this->fields[] = false;
+				else {
+					if (!is_numeric($f->value)) $val = variant_date_to_timestamp($f->value);
+					else $val = $f->value;
+					
+					if (($val % 86400) == 0) $this->fields[] = adodb_date('Y-m-d',$val);
+					else $this->fields[] = adodb_date('Y-m-d H:i:s',$val);
+				}
+				break;
+			case 1: // null
+				$this->fields[] = false;
+				break;
+			case 6: // currency is not supported properly;
+				ADOConnection::outp( '<b>'.$f->Name.': currency type not supported by PHP</b>');
+				$this->fields[] = (float) $f->value;
+				break;
+			default:
+				$this->fields[] = $f->value; 
+				break;
+			}
+			//print " $f->value $t, ";
+			$f = next($this->_flds);
+			$t = next($this->_tarr);
+		} // for
+		if ($this->hideErrors) error_reporting($olde);
+		@$rs->MoveNext(); // @ needed for some versions of PHP!
+		
+		if ($this->fetchMode & ADODB_FETCH_ASSOC) {
+			$this->fields = &$this->GetRowAssoc(ADODB_ASSOC_CASE);
+		}
+		return true;
+	}
+	
+		function NextRecordSet()
+		{
+			$rs = $this->_queryID;
+			$this->_queryID = $rs->NextRecordSet();
+			//$this->_queryID = $this->_QueryId->NextRecordSet();
+			if ($this->_queryID == null) return false;
+			
+			$this->_currentRow = -1;
+			$this->_currentPage = -1;
+			$this->bind = false;
+			$this->fields = false;
+			$this->_flds = false;
+			$this->_tarr = false;
+			
+			$this->_inited = false;
+			$this->Init();
+			return true;
+		}
+
+	function _close() {
+		$this->_flds = false;
+		@$this->_queryID->Close();// by Pete Dishman (peterd@telephonetics.co.uk)
+		$this->_queryID = false;	
+	}
+
+}
+
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ado_access.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-ado_access.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ado_access.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-ado_access.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
 Released under both BSD license and Lesser GPL library license. 
 Whenever there is any discrepancy between the two licenses, 
 the BSD license will take precedence. See License.txt. 
@@ -15,7 +15,8 @@
 if (!defined('ADODB_DIR')) die();
 
 if (!defined('_ADODB_ADO_LAYER')) {
-	include(ADODB_DIR."/drivers/adodb-ado.inc.php");
+	if (PHP_VERSION >= 5) include(ADODB_DIR."/drivers/adodb-ado5.inc.php");
+	else include(ADODB_DIR."/drivers/adodb-ado.inc.php");
 }
 
 class  ADODB_ado_access extends ADODB_ado {	
@@ -33,6 +34,10 @@
 	}
 	
 	function BeginTrans() { return false;}
+	
+	function CommitTrans() { return false;}
+	
+	function RollbackTrans() { return false;}
 
 }
 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ado_mssql.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-ado_mssql.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ado_mssql.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-ado_mssql.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -19,7 +19,8 @@
 if (!defined('ADODB_DIR')) die();
 
 if (!defined('_ADODB_ADO_LAYER')) {
-	include(ADODB_DIR."/drivers/adodb-ado.inc.php");
+	if (PHP_VERSION >= 5) include(ADODB_DIR."/drivers/adodb-ado5.inc.php");
+	else include(ADODB_DIR."/drivers/adodb-ado.inc.php");
 }
 
 
@@ -54,36 +55,37 @@
 	
 	function MetaColumns($table)
 	{
-	        $table = strtoupper($table);
-	        $arr= array();
-	        $dbc = $this->_connectionID;
-	        
-	        $osoptions = array();
-	        $osoptions[0] = null;
-	        $osoptions[1] = null;
-	        $osoptions[2] = $table;
-	        $osoptions[3] = null;
-	        
-	        $adors=@$dbc->OpenSchema(4, $osoptions);//tables
-	
-	        if ($adors){
-	                while (!$adors->EOF){
-	                        $fld = new ADOFieldObject();
-	                        $c = $adors->Fields(3);
-	                        $fld->name = $c->Value;
-	                        $fld->type = 'CHAR'; // cannot discover type in ADO!
-	                        $fld->max_length = -1;
-	                        $arr[strtoupper($fld->name)]=$fld;
-	        
-	                        $adors->MoveNext();
-	                }
-	                $adors->Close();
-	        }
-	        
-	        return $arr;
-	}
+        $table = strtoupper($table);
+        $arr= array();
+        $dbc = $this->_connectionID;
+        
+        $osoptions = array();
+        $osoptions[0] = null;
+        $osoptions[1] = null;
+        $osoptions[2] = $table;
+        $osoptions[3] = null;
+        
+        $adors=@$dbc->OpenSchema(4, $osoptions);//tables
+
+        if ($adors){
+                while (!$adors->EOF){
+                        $fld = new ADOFieldObject();
+                        $c = $adors->Fields(3);
+                        $fld->name = $c->Value;
+                        $fld->type = 'CHAR'; // cannot discover type in ADO!
+                        $fld->max_length = -1;
+                        $arr[strtoupper($fld->name)]=$fld;
+        
+                        $adors->MoveNext();
+                }
+                $adors->Close();
+        }
+        $false = false;
+		return empty($arr) ? $false : $arr;
 	}
 	
+	} // end class 
+	
 	class  ADORecordSet_ado_mssql extends ADORecordSet_ado {        
 	
 	var $databaseType = 'ado_mssql';
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-borland_ibase.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-borland_ibase.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-borland_ibase.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-borland_ibase.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-csv.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-csv.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-csv.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-csv.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-db2.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-db2.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-db2.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-db2.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -145,8 +145,10 @@
 		$rs = new ADORecordSet_odbc($qid);
 		
 		$ADODB_FETCH_MODE = $savem;
-		if (!$rs) return false;
-		
+		if (!$rs) {
+			$false = false;
+			return $false;
+		}
 		$rs->_has_stupid_odbc_fetch_api_change = $this->_has_stupid_odbc_fetch_api_change;
 		
 		$arr =& $rs->GetArray();
@@ -175,7 +177,45 @@
 		}
 		return $arr2;
 	}
-	
+
+	function &MetaIndexes ($table, $primary = FALSE, $owner=false)
+	{
+        // save old fetch mode
+        global $ADODB_FETCH_MODE;
+        $save = $ADODB_FETCH_MODE;
+        $ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+        if ($this->fetchMode !== FALSE) {
+               $savem = $this->SetFetchMode(FALSE);
+        }
+		$false = false;
+		// get index details
+		$table = strtoupper($table);
+		$SQL="SELECT NAME, UNIQUERULE, COLNAMES FROM SYSIBM.SYSINDEXES WHERE TBNAME='$table'";
+        if ($primary) 
+			$SQL.= " AND UNIQUERULE='P'";
+		$rs = $this->Execute($SQL);
+        if (!is_object($rs)) {
+			if (isset($savem)) 
+				$this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+            return $false;
+        }
+		$indexes = array ();
+        // parse index data into array
+        while ($row = $rs->FetchRow()) {
+			$indexes[$row[0]] = array(
+			   'unique' => ($row[1] == 'U' || $row[1] == 'P'),
+			   'columns' => array()
+			);
+			$cols = ltrim($row[2],'+');
+			$indexes[$row[0]]['columns'] = explode('+', $cols);
+        }
+		if (isset($savem)) { 
+            $this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+		}
+        return $indexes;
+	}
 	
 	// Format date column in sql string given an input format that understands Y M D
 	function SQLDate($fmt, $col=false)
@@ -274,12 +314,14 @@
 		case 'VARCHAR':
 		case 'CHAR':
 		case 'CHARACTER':
+		case 'C':
 			if ($len <= $this->blobSize) return 'C';
 		
 		case 'LONGCHAR':
 		case 'TEXT':
 		case 'CLOB':
 		case 'DBCLOB': // double-byte
+		case 'X':
 			return 'X';
 		
 		case 'BLOB':
@@ -288,10 +330,12 @@
 			return 'B';
 			
 		case 'DATE':
+		case 'D':
 			return 'D';
 		
 		case 'TIME':
 		case 'TIMESTAMP':
+		case 'T':
 			return 'T';
 		
 		//case 'BOOLEAN': 
@@ -305,6 +349,7 @@
 		case 'INTEGER':
 		case 'BIGINT':
 		case 'SMALLINT':
+		case 'I':
 			return 'I';
 			
 		default: return 'N';
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-fbsql.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-fbsql.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-fbsql.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-fbsql.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
- @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -170,9 +170,10 @@
 		}
 		switch ($mode) {
 		case ADODB_FETCH_NUM: $this->fetchMode = FBSQL_NUM; break;
-		default:
-		case ADODB_FETCH_BOTH: $this->fetchMode = FBSQL_BOTH; break;
 		case ADODB_FETCH_ASSOC: $this->fetchMode = FBSQL_ASSOC; break;
+		case ADODB_FETCH_BOTH: 
+		default:
+		$this->fetchMode = FBSQL_BOTH; break;
 		}
 		return $this->ADORecordSet($queryID);
 	}
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-firebird.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-firebird.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-firebird.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-firebird.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ibase.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-ibase.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ibase.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-ibase.inc.php	2005-05-04 14:39:17.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.  
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.  
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -52,6 +52,7 @@
 	var $hasAffectedRows = false;
 	var $poorAffectedRows = true;
 	var $blobEncodeType = 'C';
+	var $role = false;
 	
 	function ADODB_ibase() 
 	{
@@ -65,7 +66,11 @@
 		if (!function_exists('ibase_pconnect')) return null;
 		if ($argDatabasename) $argHostname .= ':'.$argDatabasename;
 		$fn = ($persist) ? 'ibase_pconnect':'ibase_connect';
-		$this->_connectionID = $fn($argHostname,$argUsername,$argPassword,
+		if ($this->role)
+			$this->_connectionID = $fn($argHostname,$argUsername,$argPassword,
+					$this->charSet,$this->buffers,$this->dialect,$this->role);
+		else	
+			$this->_connectionID = $fn($argHostname,$argUsername,$argPassword,
 					$this->charSet,$this->buffers,$this->dialect);
 		
 		if ($this->dialect != 1) { // http://www.ibphoenix.com/ibp_60_del_id_ds.html
@@ -475,61 +480,60 @@
 	{
 	global $ADODB_FETCH_MODE;
 		
-		if ($this->metaColumnsSQL) {
-		
-			$save = $ADODB_FETCH_MODE;
-			$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
-		
-			$rs = $this->Execute(sprintf($this->metaColumnsSQL,strtoupper($table)));
-		
-			$ADODB_FETCH_MODE = $save;
-			if ($rs === false) return false;
-
-			$retarr = array();
+		$save = $ADODB_FETCH_MODE;
+		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+	
+		$rs = $this->Execute(sprintf($this->metaColumnsSQL,strtoupper($table)));
+	
+		$ADODB_FETCH_MODE = $save;
+		if ($rs === false) {
+			$false = false;
+			return $false;
+		}
+		
+		$retarr = array();
+		//OPN STUFF start
+		$dialect3 = ($this->dialect==3 ? true : false);
+		//OPN STUFF end
+		while (!$rs->EOF) { //print_r($rs->fields);
+			$fld = new ADOFieldObject();
+			$fld->name = trim($rs->fields[0]);
 			//OPN STUFF start
-			$dialect3 = ($this->dialect==3 ? true : false);
-			//OPN STUFF end
-			while (!$rs->EOF) { //print_r($rs->fields);
-				$fld = new ADOFieldObject();
-				$fld->name = trim($rs->fields[0]);
-				//OPN STUFF start
-				$this->_ConvertFieldType($fld, $rs->fields[7], $rs->fields[3], $rs->fields[4], $rs->fields[5], $rs->fields[6], $dialect3);
-				if (isset($rs->fields[1]) && $rs->fields[1]) {
-					$fld->not_null = true;
-				}				
-				if (isset($rs->fields[2])) {
-					
-					$fld->has_default = true;
-					$d = substr($rs->fields[2],strlen('default '));
-					switch ($fld->type)
-					{
-					case 'smallint':
-					case 'integer': $fld->default_value = (int) $d; break;
-					case 'char': 
-					case 'blob':
-					case 'text':
-					case 'varchar': $fld->default_value = (string) substr($d,1,strlen($d)-2); break;
-					case 'double':
-					case 'float': $fld->default_value = (float) $d; break;
-					default: $fld->default_value = $d; break;
-					}
-			//	case 35:$tt = 'TIMESTAMP'; break;
-				}
-				if ((isset($rs->fields[5])) && ($fld->type == 'blob')) {
-					$fld->sub_type = $rs->fields[5];
-				} else {
-					$fld->sub_type = null;
-				}
-				//OPN STUFF end
-				if ($ADODB_FETCH_MODE == ADODB_FETCH_NUM) $retarr[] = $fld;	
-				else $retarr[strtoupper($fld->name)] = $fld;
+			$this->_ConvertFieldType($fld, $rs->fields[7], $rs->fields[3], $rs->fields[4], $rs->fields[5], $rs->fields[6], $dialect3);
+			if (isset($rs->fields[1]) && $rs->fields[1]) {
+				$fld->not_null = true;
+			}				
+			if (isset($rs->fields[2])) {
 				
-				$rs->MoveNext();
+				$fld->has_default = true;
+				$d = substr($rs->fields[2],strlen('default '));
+				switch ($fld->type)
+				{
+				case 'smallint':
+				case 'integer': $fld->default_value = (int) $d; break;
+				case 'char': 
+				case 'blob':
+				case 'text':
+				case 'varchar': $fld->default_value = (string) substr($d,1,strlen($d)-2); break;
+				case 'double':
+				case 'float': $fld->default_value = (float) $d; break;
+				default: $fld->default_value = $d; break;
+				}
+		//	case 35:$tt = 'TIMESTAMP'; break;
 			}
-			$rs->Close();
-			return $retarr;	
+			if ((isset($rs->fields[5])) && ($fld->type == 'blob')) {
+				$fld->sub_type = $rs->fields[5];
+			} else {
+				$fld->sub_type = null;
+			}
+			//OPN STUFF end
+			if ($ADODB_FETCH_MODE == ADODB_FETCH_NUM) $retarr[] = $fld;	
+			else $retarr[strtoupper($fld->name)] = $fld;
+			
+			$rs->MoveNext();
 		}
-		return false;
+		$rs->Close();
+		return empty($retarr) ? false : $retarr;	
 	}
 	
 	function BlobEncode( $blob ) 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-informix.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-informix.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-informix.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-informix.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /**
-* @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+* @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
 * Released under both BSD license and Lesser GPL library license.
 * Whenever there is any discrepancy between the two licenses,
 * the BSD license will take precedence.
@@ -26,6 +26,7 @@
 
 class ADORecordset_informix extends ADORecordset_informix72 {
 	var $databaseType = "informix";
+	
 	function ADORecordset_informix($id,$mode=false)
 	{
 		$this->ADORecordset_informix72($id,$mode);
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-informix72.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-informix72.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-informix72.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-informix72.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim. All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim. All rights reserved.
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
   the BSD license will take precedence.
@@ -28,7 +28,7 @@
 	var $hasInsertID = true;
 	var $hasAffectedRows = true;
     var $substr = 'substr';
-	var $metaTablesSQL="select tabname from systables where tabtype!=' ' and owner!='informix'"; //Don't get informix tables and pseudo-tables
+	var $metaTablesSQL="select tabname,tabtype from systables where tabtype in ('T','V') and owner!='informix'"; //Don't get informix tables and pseudo-tables
 
 
 	var $metaColumnsSQL = 
@@ -74,7 +74,7 @@
 	    if (isset($this->version)) return $this->version;
 	
 	    $arr['description'] = $this->GetOne("select DBINFO('version','full') from systables where tabid = 1");
-	    $arr['version'] = $this->GetOne("select DBINFO('version','major')||"."||DBINFO('version','minor') from systables where tabid = 1");
+	    $arr['version'] = $this->GetOne("select DBINFO('version','major') || DBINFO('version','minor') from systables where tabid = 1");
 	    $this->version = $arr;
 	    return $arr;
 	}
@@ -141,7 +141,7 @@
 
 	function ErrorNo()
 	{
-		preg_match("/.*SQLCODE=([^\]]*)/",ifx_error(),$parse); //!EOS
+		preg_match("/.*SQLCODE=([^\]]*)/",ifx_error(),$parse);
 		if (is_array($parse) && isset($parse[1])) return (int)$parse[1]; 
 		return 0;
 	}
@@ -165,9 +165,20 @@
 			while (!$rs->EOF) { //print_r($rs->fields);
 				$fld = new ADOFieldObject();
 				$fld->name = $rs->fields[0];
+/*  //!eos.
+						$rs->fields[1] is not the correct adodb type
+						$rs->fields[2] is not correct max_length, because can include not-null bit
+
 				$fld->type = $rs->fields[1];
 				$fld->primary_key=$rspkey->fields && array_search($rs->fields[4],$rspkey->fields); //Added to set primary key flag
-				$fld->max_length = $rs->fields[2];
+				$fld->max_length = $rs->fields[2];*/
+				$pr=ifx_props($rs->fields[1],$rs->fields[2]); //!eos
+				$fld->type = $pr[0] ;//!eos
+				$fld->primary_key=$rspkey->fields && array_search($rs->fields[4],$rspkey->fields);
+				$fld->max_length = $pr[1]; //!eos
+				$fld->precision = $pr[2] ;//!eos
+				$fld->not_null = $pr[3]=="N"; //!eos
+
 				if (trim($rs->fields[3]) != "AAAAAA 0") {
 	                    		$fld->has_default = 1;
 	                    		$fld->default_value = $rs->fields[3];
@@ -180,6 +191,7 @@
 			}
 
 			$rs->Close();
+			$rspKey->Close(); //!eos
 			return $retarr;	
 		}
 
@@ -191,6 +203,38 @@
 		return ADOConnection::MetaColumns($table,false);
    }
 
+	 function MetaForeignKeys($table, $owner=false, $upper=false) //!Eos
+	{
+		$sql = "
+			select tr.tabname,updrule,delrule,
+			i.part1 o1,i2.part1 d1,i.part2 o2,i2.part2 d2,i.part3 o3,i2.part3 d3,i.part4 o4,i2.part4 d4,
+			i.part5 o5,i2.part5 d5,i.part6 o6,i2.part6 d6,i.part7 o7,i2.part7 d7,i.part8 o8,i2.part8 d8
+			from systables t,sysconstraints s,sysindexes i,
+			sysreferences r,systables tr,sysconstraints s2,sysindexes i2
+			where t.tabname='$table'
+			and s.tabid=t.tabid and s.constrtype='R' and r.constrid=s.constrid
+			and i.idxname=s.idxname and tr.tabid=r.ptabid
+			and s2.constrid=r.primary and i2.idxname=s2.idxname";
+
+		$rs = $this->Execute($sql);
+		if (!$rs || $rs->EOF)  return false;
+		$arr =& $rs->GetArray();
+		$a = array();
+		foreach($arr as $v) {
+			$coldest=$this->metaColumnNames($v["tabname"]);
+			$colorig=$this->metaColumnNames($table);
+			$colnames=array();
+			for($i=1;$i<=8 && $v["o$i"] ;$i++) {
+				$colnames[]=$coldest[$v["d$i"]-1]."=".$colorig[$v["o$i"]-1];
+			}
+			if($upper)
+				$a[strtoupper($v["tabname"])] =  $colnames;
+			else
+				$a[$v["tabname"]] =  $colnames;
+		}
+		return $a;
+	 }
+
    function UpdateBlob($table, $column, $val, $where, $blobtype = 'BLOB')
    {
    		$type = ($blobtype == 'TEXT') ? 1 : 0;
@@ -342,7 +386,7 @@
 
 	function _seek($row)
 	{
-		return @ifx_fetch_row($this->_queryID, $row);
+		return @ifx_fetch_row($this->_queryID, (int) $row);
 	}
 
    function MoveLast()
@@ -401,4 +445,29 @@
 	}
 
 }
+/** !Eos
+* Auxiliar function to Parse coltype,collength. Used by Metacolumns
+* return: array ($mtype,$length,$precision,$nullable) (similar to ifx_fieldpropierties)
+*/
+function ifx_props($coltype,$collength){
+	$itype=fmod($coltype+1,256);
+	$nullable=floor(($coltype+1) /256) ?"N":"Y";
+	$mtype=substr(" CIIFFNNDN TBXCC     ",$itype,1);
+	switch ($itype){
+		case 2:
+			$length=4;
+		case 6:
+		case 9:
+		case 14:
+			$length=floor($collength/256);
+			$precision=fmod($collength,256);
+			break;
+		default:
+			$precision=0;
+			$length=$collength;
+	}
+	return array($mtype,$length,$precision,$nullable);
+}
+
+
 ?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ldap.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-ldap.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-ldap.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-ldap.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,11 +1,15 @@
 <?php
 /*
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim#natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim#natsoft.com.my). All rights reserved.
    Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
   Set tabs to 8.
   
+  Revision 1: (02/25/2005) Updated codebase to include the _inject_bind_options function. This allows
+  users to access the options in the ldap_set_option function appropriately. Most importantly
+  LDAP Version 3 is now supported. See the examples for more information. Also fixed some minor
+  bugs that surfaced when PHP error levels were set high.
   
   Joshua Eldridge (joshuae74#hotmail.com)
 */ 
@@ -13,6 +17,12 @@
 // security - hide paths
 if (!defined('ADODB_DIR')) die();
 
+if (!defined('LDAP_ASSOC')) {
+	 define('LDAP_ASSOC',ADODB_FETCH_ASSOC);
+	 define('LDAP_NUM',ADODB_FETCH_NUM);
+	 define('LDAP_BOTH',ADODB_FETCH_BOTH);
+}
+
 class ADODB_ldap extends ADOConnection {
     var $databaseType = 'ldap';
 	var $dataProvider = 'ldap';
@@ -24,7 +34,10 @@
     # Used during searches
     var $filter;
     var $dn;
+	var $version;
 
+	# Options configuration information
+	var $LDAP_CONNECT_OPTIONS;
 
 	function ADODB_ldap() 
 	{		
@@ -36,6 +49,8 @@
 	function _connect( $host, $username, $password, $ldapbase )
 	{
 
+	global $LDAP_CONNECT_OPTIONS;
+
 	   if ( !function_exists( 'ldap_connect' ) ) return null;
 	   
 	   $conn_info = array( $host );
@@ -46,6 +61,11 @@
 
 	   $this->_connectionID = ldap_connect( $conn_info[0], $conn_info[1] ) 
 	       or die( 'Could not connect to ' . $this->_connectionID );
+
+	   if( count( $LDAP_CONNECT_OPTIONS ) > 0 ) {
+			$this->_inject_bind_options( $LDAP_CONNECT_OPTIONS );
+		}
+
 	   if ($username && $password) {
 	       $bind = ldap_bind( $this->_connectionID, $username, $password ) 
 	           or die( 'Could not bind to ' . $this->_connectionID . ' with $username & $password');
@@ -53,9 +73,68 @@
 	       $bind = ldap_bind( $this->_connectionID ) 
 	           or die( 'Could not bind anonymously to ' . $this->_connectionID );
 	   }
+	   $this->database = $ldapbase;
 	   return $this->_connectionID;
     }
     
+/*
+	Valid Domain Values for LDAP Options:
+
+	LDAP_OPT_DEREF (integer)
+	LDAP_OPT_SIZELIMIT (integer)
+	LDAP_OPT_TIMELIMIT (integer)
+	LDAP_OPT_PROTOCOL_VERSION (integer)
+	LDAP_OPT_ERROR_NUMBER (integer)
+	LDAP_OPT_REFERRALS (boolean)
+	LDAP_OPT_RESTART (boolean)
+	LDAP_OPT_HOST_NAME (string)
+	LDAP_OPT_ERROR_STRING (string)
+	LDAP_OPT_MATCHED_DN (string)
+	LDAP_OPT_SERVER_CONTROLS (array)
+	LDAP_OPT_CLIENT_CONTROLS (array)
+
+	Make sure to set this BEFORE calling Connect()
+
+	Example:
+
+	$LDAP_CONNECT_OPTIONS = Array(
+		Array (
+			"OPTION_NAME"=>LDAP_OPT_DEREF,
+			"OPTION_VALUE"=>2
+		),
+		Array (
+			"OPTION_NAME"=>LDAP_OPT_SIZELIMIT,
+			"OPTION_VALUE"=>100
+		),
+		Array (
+			"OPTION_NAME"=>LDAP_OPT_TIMELIMIT,
+			"OPTION_VALUE"=>30
+		),
+		Array (
+			"OPTION_NAME"=>LDAP_OPT_PROTOCOL_VERSION,
+			"OPTION_VALUE"=>3
+		),
+		Array (
+			"OPTION_NAME"=>LDAP_OPT_ERROR_NUMBER,
+			"OPTION_VALUE"=>13
+		),
+		Array (
+			"OPTION_NAME"=>LDAP_OPT_REFERRALS,
+			"OPTION_VALUE"=>FALSE
+		),
+		Array (
+			"OPTION_NAME"=>LDAP_OPT_RESTART,
+			"OPTION_VALUE"=>FALSE
+		)
+	);
+*/
+
+	function _inject_bind_options( $options ) {
+		foreach( $options as $option ) {
+			ldap_set_option( $this->_connectionID, $option["OPTION_NAME"], $option["OPTION_VALUE"] )
+				or die( "Unable to set server option: " . $option["OPTION_NAME"] );
+		}
+	}
 	
 	/* returns _queryID or false */
 	function _query($sql,$inputarr)
@@ -72,9 +151,14 @@
 		$this->_connectionID = false;
 	}
     
+	function SelectDB($db) {
+		$this->database = $db;
+		return true;
+	} // SelectDB
+
     function ServerInfo()
     {
-        if( is_array( $this->version ) ) return $this->version;
+        if( !empty( $this->version ) ) return $this->version;
         $version = array();
         /*
         Determines how aliases are handled during search. 
@@ -160,8 +244,8 @@
         }
         /* The host name (or list of hosts) for the primary LDAP server. */
         ldap_get_option( $this->_connectionID, LDAP_OPT_HOST_NAME, $version['LDAP_OPT_HOST_NAME'] ); 
-        ldap_get_option( $this->_connectionID, OPT_ERROR_NUMBER, $version['OPT_ERROR_NUMBER'] ); 
-        ldap_get_option( $this->_connectionID, OPT_ERROR_STRING, $version['OPT_ERROR_STRING'] ); 
+        ldap_get_option( $this->_connectionID, LDAP_OPT_ERROR_NUMBER, $version['LDAP_OPT_ERROR_NUMBER'] ); 
+        ldap_get_option( $this->_connectionID, LDAP_OPT_ERROR_STRING, $version['LDAP_OPT_ERROR_STRING'] ); 
         ldap_get_option( $this->_connectionID, LDAP_OPT_MATCHED_DN, $version['LDAP_OPT_MATCHED_DN'] ); 
         
         return $this->version = $version;
@@ -193,9 +277,9 @@
 		case ADODB_FETCH_ASSOC: 
 		  $this->fetchMode = LDAP_ASSOC; 
 		break;
-		default:
 		case ADODB_FETCH_DEFAULT:
 		case ADODB_FETCH_BOTH: 
+		default:
 		  $this->fetchMode = LDAP_BOTH; 
 		break;
 		}
@@ -292,11 +376,12 @@
             break;
             
             case LDAP_NUM:
-            $this->fields = $this->GetRowNums();
+			$this->fields = array_merge($this->GetRowNums(),$this->GetRowAssoc());
             break;
             
             case LDAP_BOTH:
             default:
+			$this->fields = $this->GetRowNums();
             break;
         }
         return ( is_array( $this->fields ) );        
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mssql.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-mssql.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mssql.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-mssql.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -312,6 +312,47 @@
 		return $this->GetOne("select top 1 null as ignore from $tables with (ROWLOCK,HOLDLOCK) where $where");
 	}
 	
+	
+	function &MetaIndexes($table,$primary=false)
+	{
+		$table = $this->qstr($table);
+
+		$sql = "SELECT i.name AS ind_name, C.name AS col_name, USER_NAME(O.uid) AS Owner, c.colid, k.Keyno, 
+			CASE WHEN I.indid BETWEEN 1 AND 254 AND (I.status & 2048 = 2048 OR I.Status = 16402 AND O.XType = 'V') THEN 1 ELSE 0 END AS IsPK,
+			CASE WHEN I.status & 2 = 2 THEN 1 ELSE 0 END AS IsUnique
+			FROM dbo.sysobjects o INNER JOIN dbo.sysindexes I ON o.id = i.id 
+			INNER JOIN dbo.sysindexkeys K ON I.id = K.id AND I.Indid = K.Indid 
+			INNER JOIN dbo.syscolumns c ON K.id = C.id AND K.colid = C.Colid
+			WHERE LEFT(i.name, 8) <> '_WA_Sys_' AND o.status >= 0 AND O.Name LIKE $table
+			ORDER BY O.name, I.Name, K.keyno";
+
+		global $ADODB_FETCH_MODE;
+		$save = $ADODB_FETCH_MODE;
+        $ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+        if ($this->fetchMode !== FALSE) {
+        	$savem = $this->SetFetchMode(FALSE);
+        }
+        
+        $rs = $this->Execute($sql);
+        if (isset($savem)) {
+        	$this->SetFetchMode($savem);
+        }
+        $ADODB_FETCH_MODE = $save;
+
+        if (!is_object($rs)) {
+        	return FALSE;
+        }
+
+		$indexes = array();
+		while ($row = $rs->FetchRow()) {
+			if (!$primary && $row[5]) continue;
+			
+            $indexes[$row[0]]['unique'] = $row[6];
+            $indexes[$row[0]]['columns'][] = $row[1];
+    	}
+        return $indexes;
+	}
+	
 	function MetaForeignKeys($table, $owner=false, $upper=false)
 	{
 	global $ADODB_FETCH_MODE;
@@ -494,6 +535,30 @@
 		return array($sql,$stmt);
 	}
 	
+	// returns concatenated string
+    // MSSQL requires integers to be cast as strings
+    // automatically cast every datatype to VARCHAR(255)
+    // @author David Rogers (introspectshun)
+    function Concat()
+    {
+            $s = "";
+            $arr = func_get_args();
+
+            // Split single record on commas, if possible
+            if (sizeof($arr) == 1) {
+                foreach ($arr as $arg) {
+                    $args = explode(',', $arg);
+                }
+                $arr = $args;
+            }
+
+            array_walk($arr, create_function('&$v', '$v = "CAST(" . $v . " AS VARCHAR(255))";'));
+            $s = implode('+',$arr);
+            if (sizeof($arr) > 0) return "$s";
+            
+			return '';
+    }
+	
 	/* 
 	Usage:
 		$stmt = $db->PrepareSP('SP_RUNSOMETHING'); -- takes 2 params, @myid and @group
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mssqlpo.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-mssqlpo.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mssqlpo.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-mssqlpo.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /**
-* @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+* @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
 * Released under both BSD license and Lesser GPL library license.
 * Whenever there is any discrepancy between the two licenses,
 * the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mysql.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-mysql.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mysql.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-mysql.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -79,6 +79,7 @@
         // save old fetch mode
         global $ADODB_FETCH_MODE;
         
+		$false = false;
         $save = $ADODB_FETCH_MODE;
         $ADODB_FETCH_MODE = ADODB_FETCH_NUM;
         if ($this->fetchMode !== FALSE) {
@@ -95,7 +96,7 @@
         $ADODB_FETCH_MODE = $save;
         
         if (!is_object($rs)) {
-                return FALSE;
+                return $false;
         }
         
         $indexes = array ();
@@ -148,7 +149,8 @@
 	
 	function _insertid()
 	{
-		return mysql_insert_id($this->_connectionID);
+		return ADOConnection::GetOne('SELECT LAST_INSERT_ID()');
+		//return mysql_insert_id($this->_connectionID);
 	}
 	
 	function GetOne($sql,$inputarr=false)
@@ -302,7 +304,13 @@
 				$s .= '%p';
 				break;
 				
-
+			case 'w':
+				$s .= '%w';
+				break;
+				
+			case 'l':
+				$s .= '%W';
+				break;
 			}
 		}
 		$s.="')";
@@ -368,72 +376,67 @@
 	
  	function &MetaColumns($table) 
 	{
-	
-		if ($this->metaColumnsSQL) {
 		global $ADODB_FETCH_MODE;
-		
-			$save = $ADODB_FETCH_MODE;
-			$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
-			if ($this->fetchMode !== false) $savem = $this->SetFetchMode(false);
-			
-			$rs = $this->Execute(sprintf($this->metaColumnsSQL,$table));
-			
-			if (isset($savem)) $this->SetFetchMode($savem);
-			$ADODB_FETCH_MODE = $save;
-			
-			if ($rs === false) return false;
-			
-			$retarr = array();
-			while (!$rs->EOF){
-				$fld = new ADOFieldObject();
-				$fld->name = $rs->fields[0];
-				$type = $rs->fields[1];
-				
-				
-				// split type into type(length):
-				$fld->scale = null;
-				if (strpos($type,',') && preg_match("/^(.+)\((\d+),(\d+)/", $type, $query_array)) {
-					$fld->type = $query_array[1];
-					$fld->max_length = is_numeric($query_array[2]) ? $query_array[2] : -1;
-					$fld->scale = is_numeric($query_array[3]) ? $query_array[3] : -1;
-				} elseif (preg_match("/^(.+)\((\d+)/", $type, $query_array)) {
-					$fld->type = $query_array[1];
-					$fld->max_length = is_numeric($query_array[2]) ? $query_array[2] : -1;
-				} else {
-					$fld->max_length = -1;
-					$fld->type = $type;
-				}
-				/*
-				// split type into type(length):
-				if (preg_match("/^(.+)\((\d+)/", $type, $query_array)) {
-					$fld->type = $query_array[1];
-					$fld->max_length = is_numeric($query_array[2]) ? $query_array[2] : -1;
+		$save = $ADODB_FETCH_MODE;
+		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+		if ($this->fetchMode !== false) $savem = $this->SetFetchMode(false);
+		$rs = $this->Execute(sprintf($this->metaColumnsSQL,$table));
+		if (isset($savem)) $this->SetFetchMode($savem);
+		$ADODB_FETCH_MODE = $save;
+		if (!is_object($rs)) {
+			$false = false;
+			return $false;
+		}
+			
+		$retarr = array();
+		while (!$rs->EOF){
+			$fld = new ADOFieldObject();
+			$fld->name = $rs->fields[0];
+			$type = $rs->fields[1];
+			
+			// split type into type(length):
+			$fld->scale = null;
+			if (preg_match("/^(.+)\((\d+),(\d+)/", $type, $query_array)) {
+				$fld->type = $query_array[1];
+				$fld->max_length = is_numeric($query_array[2]) ? $query_array[2] : -1;
+				$fld->scale = is_numeric($query_array[3]) ? $query_array[3] : -1;
+			} elseif (preg_match("/^(.+)\((\d+)/", $type, $query_array)) {
+				$fld->type = $query_array[1];
+				$fld->max_length = is_numeric($query_array[2]) ? $query_array[2] : -1;
+			} elseif (preg_match("/^(enum)\((.*)\)$/i", $type, $query_array)) {
+				$fld->type = $query_array[1];
+				$fld->max_length = max(array_map("strlen",explode(",",$query_array[2]))) - 2; // PHP >= 4.0.6
+				$fld->max_length = ($fld->max_length == 0 ? 1 : $fld->max_length);
+			} else {
+				$fld->type = $type;
+				$fld->max_length = -1;
+			}
+			$fld->not_null = ($rs->fields[2] != 'YES');
+			$fld->primary_key = ($rs->fields[3] == 'PRI');
+			$fld->auto_increment = (strpos($rs->fields[5], 'auto_increment') !== false);
+			$fld->binary = (strpos($type,'blob') !== false);
+			$fld->unsigned = (strpos($type,'unsigned') !== false);
+				
+			if (!$fld->binary) {
+				$d = $rs->fields[4];
+				if ($d != '' && $d != 'NULL') {
+					$fld->has_default = true;
+					$fld->default_value = $d;
 				} else {
-					$fld->max_length = -1;
-					$fld->type = $type;
-				}*/
-				$fld->not_null = ($rs->fields[2] != 'YES');
-				$fld->primary_key = ($rs->fields[3] == 'PRI');
-				$fld->auto_increment = (strpos($rs->fields[5], 'auto_increment') !== false);
-				$fld->binary = (strpos($fld->type,'blob') !== false);
-				
-				if (!$fld->binary) {
-					$d = $rs->fields[4];
-					if ($d != "" && $d != "NULL") {
-						$fld->has_default = true;
-						$fld->default_value = $d;
-					} else {
-						$fld->has_default = false;
-					}
+					$fld->has_default = false;
 				}
-				if ($save == ADODB_FETCH_NUM) $retarr[] = $fld;	
-				else $retarr[strtoupper($fld->name)] = $fld;
+			}
+			
+			if ($save == ADODB_FETCH_NUM) {
+				$retarr[] = $fld;
+			} else {
+				$retarr[strtoupper($fld->name)] = $fld;
+			}
 				$rs->MoveNext();
 			}
+		
 			$rs->Close();
 			return $retarr;	
-		}
-		return false;
 	}
 		
 	// returns true or false
@@ -533,11 +536,12 @@
 		{
 		case ADODB_FETCH_NUM: $this->fetchMode = MYSQL_NUM; break;
 		case ADODB_FETCH_ASSOC:$this->fetchMode = MYSQL_ASSOC; break;
-		default:
 		case ADODB_FETCH_DEFAULT:
-		case ADODB_FETCH_BOTH:$this->fetchMode = MYSQL_BOTH; break;
+		case ADODB_FETCH_BOTH:
+		default:
+			$this->fetchMode = MYSQL_BOTH; break;
 		}
-	
+		$this->adodbFetchMode = $mode;
 		$this->ADORecordSet($queryID);	
 	}
 	
@@ -688,17 +692,18 @@
 		{
 		case ADODB_FETCH_NUM: $this->fetchMode = MYSQL_NUM; break;
 		case ADODB_FETCH_ASSOC:$this->fetchMode = MYSQL_ASSOC; break;
-		default:
 		case ADODB_FETCH_DEFAULT:
-		case ADODB_FETCH_BOTH:$this->fetchMode = MYSQL_BOTH; break;
+		case ADODB_FETCH_BOTH:
+		default:
+		$this->fetchMode = MYSQL_BOTH; break;
 		}
-	
-		$this->ADORecordSet($queryID);	
+		$this->adodbFetchMode = $mode;
+		$this->ADORecordSet($queryID);
 	}
 	
 	function MoveNext()
 	{
-		return adodb_movenext($this);
+		return @adodb_movenext($this);
 	}
 }
 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mysqli.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-mysqli.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mysqli.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-mysqli.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -19,6 +19,11 @@
 if (! defined("_ADODB_MYSQLI_LAYER")) {
  define("_ADODB_MYSQLI_LAYER", 1 );
  
+ if (!defined('MYSQLI_READ_DEFAULT_GROUP')) define('MYSQLI_READ_DEFAULT_GROUP',1);
+
+ // disable adodb extension - currently incompatible.
+ global $ADODB_EXTENSION; $ADODB_EXTENSION = false;
+
 class ADODB_mysqli extends ADOConnection {
 	var $databaseType = 'mysqli';
 	var $dataProvider = 'native';
@@ -33,7 +38,7 @@
 	var $isoDates = true; // accepts dates in ISO format
 	var $sysDate = 'CURDATE()';
 	var $sysTimeStamp = 'NOW()';
-	var $hasTransactions = false;
+	var $hasTransactions = true;
 	var $forceNewConnect = false;
 	var $poorAffectedRows = true;
 	var $clientFlags = 0;
@@ -42,11 +47,12 @@
 	var $socket = false;
 	var $_bindInputArray = false;
 	var $nameQuote = '`';		/// string to use to quote identifiers and names
+	var $optionFlags = array(array(MYSQLI_READ_DEFAULT_GROUP,0));
 	
 	function ADODB_mysqli() 
 	{			
-	  if(!extension_loaded("mysqli"))
-	      trigger_error("You must have the MySQLi extension.", E_USER_ERROR);
+	 // if(!extension_loaded("mysqli"))
+	      ;//trigger_error("You must have the mysqli extension installed.", E_USER_ERROR);
 	    
 	}
 	
@@ -59,6 +65,9 @@
 			  $argPassword = NULL, 
 			  $argDatabasename = NULL, $persist=false)
 	  {
+	  	 if(!extension_loaded("mysqli")) {
+			return null;
+		 }
 	    $this->_connectionID = @mysqli_init();
 	    
 	    if (is_null($this->_connectionID)) {
@@ -67,9 +76,15 @@
 				ADOConnection::outp("mysqli_init() failed : "  . $this->ErrorMsg());
 	      return false;
 	    }
-	    // Set connection options
-	    // Not implemented now
-	    // mysqli_options($this->_connection,,);
+		/*
+		I suggest a simple fix which would enable adodb and mysqli driver to
+		read connection options from the standard mysql configuration file
+		/etc/my.cnf - "Bastien Duclaux" <bduclaux#yahoo.com>
+		*/
+		foreach($this->optionFlags as $arr) {	
+			mysqli_options($this->_connectionID,$arr[0],$arr[1]);
+		}
+		
  	    if (mysqli_real_connect($this->_connectionID,
  				    $argHostname,
  				    $argUsername,
@@ -104,7 +119,7 @@
 	function _nconnect($argHostname, $argUsername, $argPassword, $argDatabasename)
 	  {
 	    $this->forceNewConnect = true;
-	    $this->_connect($argHostname, $argUsername, $argPassword, $argDatabasename);
+	    return $this->_connect($argHostname, $argUsername, $argPassword, $argDatabasename);
 	  }
 	
 	function IfNull( $field, $ifNull ) 
@@ -176,7 +191,6 @@
 	
 	function _insertid()
 	{
-//	  $this->_connectionID = $this->mysqli_resolve_link($this->_connectionID);
 	  $result = @mysqli_insert_id($this->_connectionID);
 	  if ($result == -1){
 	      if ($this->debug) ADOConnection::outp("mysqli_insert_id() failed : "  . $this->ErrorMsg());
@@ -187,7 +201,6 @@
 	// Only works for INSERT, UPDATE and DELETE query's
 	function _affectedrows()
 	{
-	//  $this->_connectionID = $this->mysqli_resolve_link($this->_connectionID);
 	  $result =  @mysqli_affected_rows($this->_connectionID);
 	  if ($result == -1) {
 	      if ($this->debug) ADOConnection::outp("mysqli_affected_rows() failed : "  . $this->ErrorMsg());
@@ -235,62 +248,62 @@
 	}
 	
   	function &MetaDatabases()
-	  {
-	    $query = "SHOW DATABASES";
-	    $ret =& $this->Execute($query);
+	{
+		$query = "SHOW DATABASES";
+		$ret =& $this->Execute($query);
 		return $ret;
-	  }
+	}
 
 	  
 	function &MetaIndexes ($table, $primary = FALSE)
 	{
-	        // save old fetch mode
-	        global $ADODB_FETCH_MODE;
-	        
-	        $save = $ADODB_FETCH_MODE;
-	        $ADODB_FETCH_MODE = ADODB_FETCH_NUM;
-	        if ($this->fetchMode !== FALSE) {
-	               $savem = $this->SetFetchMode(FALSE);
-	        }
-	        
-	        // get index details
-	        $rs = $this->Execute(sprintf('SHOW INDEXES FROM %s',$table));
-	        
-	        // restore fetchmode
-	        if (isset($savem)) {
-	                $this->SetFetchMode($savem);
-	        }
-	        $ADODB_FETCH_MODE = $save;
-	        
-	        if (!is_object($rs)) {
-	                return FALSE;
-	        }
-	        
-	        $indexes = array ();
-	        
-	        // parse index data into array
-	        while ($row = $rs->FetchRow()) {
-	                if ($primary == FALSE AND $row[2] == 'PRIMARY') {
-	                        continue;
-	                }
-	                
-	                if (!isset($indexes[$row[2]])) {
-	                        $indexes[$row[2]] = array(
-	                                'unique' => ($row[1] == 0),
-	                                'columns' => array()
-	                        );
-	                }
-	                
-	                $indexes[$row[2]]['columns'][$row[3] - 1] = $row[4];
-	        }
-	        
-	        // sort columns by order in the index
-	        foreach ( array_keys ($indexes) as $index )
-	        {
-	                ksort ($indexes[$index]['columns']);
-	        }
-	        
-	        return $indexes;
+		// save old fetch mode
+		global $ADODB_FETCH_MODE;
+		
+		$save = $ADODB_FETCH_MODE;
+		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+		if ($this->fetchMode !== FALSE) {
+		       $savem = $this->SetFetchMode(FALSE);
+		}
+		
+		// get index details
+		$rs = $this->Execute(sprintf('SHOW INDEXES FROM %s',$table));
+		
+		// restore fetchmode
+		if (isset($savem)) {
+		        $this->SetFetchMode($savem);
+		}
+		$ADODB_FETCH_MODE = $save;
+		
+		if (!is_object($rs)) {
+		        return FALSE;
+		}
+		
+		$indexes = array ();
+		
+		// parse index data into array
+		while ($row = $rs->FetchRow()) {
+		        if ($primary == FALSE AND $row[2] == 'PRIMARY') {
+		                continue;
+		        }
+		        
+		        if (!isset($indexes[$row[2]])) {
+		                $indexes[$row[2]] = array(
+		                        'unique' => ($row[1] == 0),
+		                        'columns' => array()
+		                );
+		        }
+		        
+		        $indexes[$row[2]]['columns'][$row[3] - 1] = $row[4];
+		}
+		
+		// sort columns by order in the index
+		foreach ( array_keys ($indexes) as $index )
+		{
+		        ksort ($indexes[$index]['columns']);
+		}
+		
+		return $indexes;
 	}
 
 	
@@ -385,112 +398,88 @@
 		return "from_unixtime(unix_timestamp($date)+($dayFraction)*24*3600)";
 	}
 	
+	function &MetaTables($ttype=false,$showSchema=false,$mask=false) 
+	{	
+		$save = $this->metaTablesSQL;
+		if ($showSchema && is_string($showSchema)) {
+			$this->metaTablesSQL .= " from $showSchema";
+		}
+		
+		if ($mask) {
+			$mask = $this->qstr($mask);
+			$this->metaTablesSQL .= " like $mask";
+		}
+		$ret =& ADOConnection::MetaTables($ttype,$showSchema);
+		
+		$this->metaTablesSQL = $save;
+		return $ret;
+	}
 	
  	function &MetaColumns($table) 
 	{
-	  if ($this->metaColumnsSQL) {
-	    global $ADODB_FETCH_MODE;
-	    $save = $ADODB_FETCH_MODE;
-	    $rs = false;
-	    switch($ADODB_FETCH_MODE)
-	      {
-	      case ADODB_FETCH_NUM:
-		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
-		$rs = $this->Execute(sprintf($this->metaColumnsSQL,
-					     $table));
+		if (!$this->metaColumnsSQL)
+			return false;
 		
+		global $ADODB_FETCH_MODE;
+		$save = $ADODB_FETCH_MODE;
+		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+		if ($this->fetchMode !== false)
+			$savem = $this->SetFetchMode(false);
+		$rs = $this->Execute(sprintf($this->metaColumnsSQL,$table));
+		if (isset($savem)) $this->SetFetchMode($savem);
 		$ADODB_FETCH_MODE = $save;
-		if ($rs === false) break;
+		if (!is_object($rs))
+			return false;
+		
 		$retarr = array();
-		while (!$rs->EOF){
-		  $fld = new ADOFieldObject();
-		  $fld->name = $rs->fields[0];
-		  $fld->type = $rs->fields[1];
-		  // split type into type(length):
-		  if (preg_match("/^(.+)\((\d+)\)$/", $fld->type, $query_array))
-		    {
-		      $fld->type = $query_array[1];
-		      $fld->max_length = $query_array[2];
-		    }
-		  else
-		    {
-		      $fld->max_length = -1;
-		    }
-		  $fld->not_null = ($rs->fields[2] != 'YES');
-		  $fld->primary_key = ($rs->fields[3] == 'PRI');
-		  $fld->auto_increment = (strpos($rs->fields[5], 'auto_increment') !== false);
-		  $fld->binary = (strpos($fld->type,'blob') !== false);
-		  if (!$fld->binary) 
-		    {
-		      $d = $rs->fields[4];
-		      $d = $rs->fields['Default'];
-		      if ($d != "" && $d != "NULL")
-			{
-			  $fld->has_default = true;
-			  $fld->default_value = $d;
-			} 
-		      else 
-			{
-			  $fld->has_default = false;
+		while (!$rs->EOF) {
+			$fld = new ADOFieldObject();
+			$fld->name = $rs->fields[0];
+			$type = $rs->fields[1];
+			
+			// split type into type(length):
+			$fld->scale = null;
+			if (preg_match("/^(.+)\((\d+),(\d+)/", $type, $query_array)) {
+				$fld->type = $query_array[1];
+				$fld->max_length = is_numeric($query_array[2]) ? $query_array[2] : -1;
+				$fld->scale = is_numeric($query_array[3]) ? $query_array[3] : -1;
+			} elseif (preg_match("/^(.+)\((\d+)/", $type, $query_array)) {
+				$fld->type = $query_array[1];
+				$fld->max_length = is_numeric($query_array[2]) ? $query_array[2] : -1;
+			} elseif (preg_match("/^(enum)\((.*)\)$/i", $type, $query_array)) {
+				$fld->type = $query_array[1];
+				$fld->max_length = max(array_map("strlen",explode(",",$query_array[2]))) - 2; // PHP >= 4.0.6
+				$fld->max_length = ($fld->max_length == 0 ? 1 : $fld->max_length);
+			} else {
+				$fld->type = $type;
+				$fld->max_length = -1;
 			}
-		    }
-		  $retarr[strtoupper($fld->name)] = $fld;	
-		  $rs->MoveNext();
-		}
-		break;
-	      case ADODB_FETCH_ASSOC:
-	      case ADODB_FETCH_DEFAULT:
-	      case ADODB_FETCH_BOTH:
-		$ADODB_FETCH_MODE = ADODB_FETCH_ASSOC;
-		$rs = $this->Execute(sprintf($this->metaColumnsSQL,
-					     $table));
-		$ADODB_FETCH_MODE = $save;
-		if ($rs === false) break;
-		$retarr = array();
-		while (!$rs->EOF){
-		  $fld = new ADOFieldObject();
-		  $fld->name = $rs->fields['Field'];
-		  $fld->type = $rs->fields['Type'];
-				
-		  // split type into type(length):
-		  if (preg_match("/^(.+)\((\d+)\)$/", $fld->type, $query_array))
-		    {
-		      $fld->type = $query_array[1];
-		      $fld->max_length = $query_array[2];
-		    }
-		  else
-		    {
-		      $fld->max_length = -1;
-		    }
-		  $fld->not_null = ($rs->fields['Null'] != 'YES');
-		  $fld->primary_key = ($rs->fields['Key'] == 'PRI');
-		  $fld->auto_increment = (strpos($rs->fields['Extra'], 'auto_increment') !== false);
-		  $fld->binary = (strpos($fld->type,'blob') !== false);
-		  if (!$fld->binary) 
-		    {
-		      $d = $rs->fields['Default'];
-		      if ($d != "" && $d != "NULL")
-			{
-			  $fld->has_default = true;
-			  $fld->default_value = $d;
-			} 
-		      else 
-			{
-			  $fld->has_default = false;
+			$fld->not_null = ($rs->fields[2] != 'YES');
+			$fld->primary_key = ($rs->fields[3] == 'PRI');
+			$fld->auto_increment = (strpos($rs->fields[5], 'auto_increment') !== false);
+			$fld->binary = (strpos($type,'blob') !== false);
+			$fld->unsigned = (strpos($type,'unsigned') !== false);
+
+			if (!$fld->binary) {
+				$d = $rs->fields[4];
+				if ($d != '' && $d != 'NULL') {
+					$fld->has_default = true;
+					$fld->default_value = $d;
+				} else {
+					$fld->has_default = false;
+				}
+			}
+			
+			if ($save == ADODB_FETCH_NUM) {
+				$retarr[] = $fld;
+			} else {
+				$retarr[strtoupper($fld->name)] = $fld;
 			}
-		    }
-		  $retarr[strtoupper($fld->name)] = $fld;	
-		  $rs->MoveNext();
+			$rs->MoveNext();
 		}
-		break;
-	      default:
-	      }
-	    
-	    if ($rs === false) return false;
-	    $rs->Close();
-	    return $retarr;	
-	  }
-	  return false;
+		
+		$rs->Close();
+		return $retarr;
 	}
 		
 	// returns true or false
@@ -572,7 +561,7 @@
 	function ErrorMsg() 
 	  {
 	    if (empty($this->_connectionID)) 
-	      $this->_errorMsg = @mysqli_error();
+	      $this->_errorMsg = @mysqli_connect_error();
 	    else 
 	      $this->_errorMsg = @mysqli_error($this->_connectionID);
 	    return $this->_errorMsg;
@@ -582,7 +571,7 @@
 	function ErrorNo() 
 	  {
 	    if (empty($this->_connectionID))  
-	      return @mysqli_errno();
+	      return @mysqli_connect_errno();
 	    else 
 	      return @mysqli_errno($this->_connectionID);
 	  }
@@ -644,7 +633,7 @@
 	      $this->fetchMode = MYSQLI_BOTH; 
 	      break;
 	    }
-	  
+	  $this->adodbFetchMode = $mode;
 	  $this->ADORecordSet($queryID);	
 	}
 	
@@ -710,7 +699,7 @@
 	{
 		if ($this->EOF) return false;
 		$this->_currentRow++;
-		$this->fields = mysqli_fetch_array($this->_queryID,$this->fetchMode);
+		$this->fields = @mysqli_fetch_array($this->_queryID,$this->fetchMode);
 		
 		if (is_array($this->fields)) return true;
 		$this->EOF = true;
@@ -729,70 +718,132 @@
 	  	$this->_queryID = false;	
 	}
 	
+/*
+
+0 = MYSQLI_TYPE_DECIMAL
+1 = MYSQLI_TYPE_CHAR
+1 = MYSQLI_TYPE_TINY
+2 = MYSQLI_TYPE_SHORT
+3 = MYSQLI_TYPE_LONG
+4 = MYSQLI_TYPE_FLOAT
+5 = MYSQLI_TYPE_DOUBLE
+6 = MYSQLI_TYPE_NULL
+7 = MYSQLI_TYPE_TIMESTAMP
+8 = MYSQLI_TYPE_LONGLONG
+9 = MYSQLI_TYPE_INT24
+10 = MYSQLI_TYPE_DATE
+11 = MYSQLI_TYPE_TIME
+12 = MYSQLI_TYPE_DATETIME
+13 = MYSQLI_TYPE_YEAR
+14 = MYSQLI_TYPE_NEWDATE
+247 = MYSQLI_TYPE_ENUM
+248 = MYSQLI_TYPE_SET
+249 = MYSQLI_TYPE_TINY_BLOB
+250 = MYSQLI_TYPE_MEDIUM_BLOB
+251 = MYSQLI_TYPE_LONG_BLOB
+252 = MYSQLI_TYPE_BLOB
+253 = MYSQLI_TYPE_VAR_STRING
+254 = MYSQLI_TYPE_STRING
+255 = MYSQLI_TYPE_GEOMETRY
+*/
+
 	function MetaType($t, $len = -1, $fieldobj = false)
 	{
-	  if (is_object($t)) 
-	    {
-	      $fieldobj = $t;
-	      $t = $fieldobj->type;
-	      $len = $fieldobj->max_length;
-	    }
+		if (is_object($t)) {
+		    $fieldobj = $t;
+		    $t = $fieldobj->type;
+		    $len = $fieldobj->max_length;
+		}
 		
-	  $len = -1; // mysql max_length is not accurate
-	  switch (strtoupper($t)) {
-	  case 'STRING': 
-	  case 'CHAR':
-	  case 'VARCHAR': 
-	  case 'TINYBLOB': 
-	  case 'TINYTEXT': 
-	  case 'ENUM': 
-	  case 'SET': 
-	    if ($len <= $this->blobSize) return 'C';
-	    
-	  case 'TEXT':
-	  case 'LONGTEXT': 
-	  case 'MEDIUMTEXT':
-	    return 'X';
-			
-	    // php_mysql extension always returns 'blob' even if 'text'
-	    // so we have to check whether binary...
-	  case 'IMAGE':
-	  case 'LONGBLOB': 
-	  case 'BLOB':
-	  case 'MEDIUMBLOB':
-	    return !empty($fieldobj->binary) ? 'B' : 'X';
-	  case 'YEAR':
-	  case 'DATE': 
-	    return 'D';
-		
-	  case 'TIME':
-	  case 'DATETIME':
-	  case 'TIMESTAMP': return 'T';
-		
-	  case 'INT': 
-	  case 'INTEGER':
-	  case 'BIGINT':
-	  case 'TINYINT':
-	  case 'MEDIUMINT':
-	  case 'SMALLINT': 
-			
-	    if (!empty($fieldobj->primary_key)) return 'R';
-	    else return 'I';
-	    // Added floating-point types
-	    // Maybe not necessery.
-	  case 'FLOAT':
-	  case 'DOUBLE':
-	    //		case 'DOUBLE PRECISION':
-	  case 'DECIMAL':
-	  case 'DEC':
-	  case 'FIXED':
-	  default: 
-	    return 'N';
-	  }
-	}
+		
+		 $len = -1; // mysql max_length is not accurate
+		 switch (strtoupper($t)) {
+		 case 'STRING': 
+		 case 'CHAR':
+		 case 'VARCHAR': 
+		 case 'TINYBLOB': 
+		 case 'TINYTEXT': 
+		 case 'ENUM': 
+		 case 'SET': 
+		
+		case MYSQLI_TYPE_TINY_BLOB :
+		case MYSQLI_TYPE_CHAR :
+		case MYSQLI_TYPE_STRING :
+		case MYSQLI_TYPE_ENUM :
+		case MYSQLI_TYPE_SET :
+		case 253 :
+		   if ($len <= $this->blobSize) return 'C';
+		   
+		case 'TEXT':
+		case 'LONGTEXT': 
+		case 'MEDIUMTEXT':
+		   return 'X';
+		
+		
+		   // php_mysql extension always returns 'blob' even if 'text'
+		   // so we have to check whether binary...
+		case 'IMAGE':
+		case 'LONGBLOB': 
+		case 'BLOB':
+		case 'MEDIUMBLOB':
+		
+		case MYSQLI_TYPE_BLOB :
+		case MYSQLI_TYPE_LONG_BLOB :
+		case MYSQLI_TYPE_MEDIUM_BLOB :
+		
+		   return !empty($fieldobj->binary) ? 'B' : 'X';
+		case 'YEAR':
+		case 'DATE': 
+		case MYSQLI_TYPE_DATE :
+		case MYSQLI_TYPE_YEAR :
+		
+		   return 'D';
+		
+		case 'TIME':
+		case 'DATETIME':
+		case 'TIMESTAMP':
+		
+		case MYSQLI_TYPE_DATETIME :
+		case MYSQLI_TYPE_NEWDATE :
+		case MYSQLI_TYPE_TIME :
+		case MYSQLI_TYPE_TIMESTAMP :
+		
+			return 'T';
+		
+		case 'INT': 
+		case 'INTEGER':
+		case 'BIGINT':
+		case 'TINYINT':
+		case 'MEDIUMINT':
+		case 'SMALLINT': 
+		
+		case MYSQLI_TYPE_INT24 :
+		case MYSQLI_TYPE_LONG :
+		case MYSQLI_TYPE_LONGLONG :
+		case MYSQLI_TYPE_SHORT :
+		case MYSQLI_TYPE_TINY :
+		
+		   if (!empty($fieldobj->primary_key)) return 'R';
+		   
+		   return 'I';
+		
+		
+		   // Added floating-point types
+		   // Maybe not necessery.
+		 case 'FLOAT':
+		 case 'DOUBLE':
+		   //		case 'DOUBLE PRECISION':
+		 case 'DECIMAL':
+		 case 'DEC':
+		 case 'FIXED':
+		 default:
+		 	//if (!is_numeric($t)) echo "<p>--- Error in type matching $t -----</p>"; 
+		 	return 'N';
+		}
+	} // function
 	
 
-}
+} // rs class
  
 }
 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mysqlt.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-mysqlt.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-mysqlt.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-mysqlt.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -74,11 +74,13 @@
 		{
 		case ADODB_FETCH_NUM: $this->fetchMode = MYSQL_NUM; break;
 		case ADODB_FETCH_ASSOC:$this->fetchMode = MYSQL_ASSOC; break;
-		default:
+		
 		case ADODB_FETCH_DEFAULT:
-		case ADODB_FETCH_BOTH:$this->fetchMode = MYSQL_BOTH; break;
+		case ADODB_FETCH_BOTH:
+		default: $this->fetchMode = MYSQL_BOTH; break;
 		}
 	
+		$this->adodbFetchMode = $mode;
 		$this->ADORecordSet($queryID);	
 	}
 	
@@ -108,9 +110,11 @@
 		{
 		case ADODB_FETCH_NUM: $this->fetchMode = MYSQL_NUM; break;
 		case ADODB_FETCH_ASSOC:$this->fetchMode = MYSQL_ASSOC; break;
-		default:
+		
 		case ADODB_FETCH_DEFAULT:
-		case ADODB_FETCH_BOTH:$this->fetchMode = MYSQL_BOTH; break;
+		case ADODB_FETCH_BOTH:
+		default: 
+			$this->fetchMode = MYSQL_BOTH; break;
 		}
 	
 		$this->ADORecordSet($queryID);	
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-netezza.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-netezza.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-netezza.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-netezza.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim#natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim#natsoft.com.my). All rights reserved.
  
   First cut at the Netezza Driver by Josh Eldridge joshuae74#hotmail.com
  Based on the previous postgres drivers.
@@ -149,10 +149,12 @@
 		{
 		case ADODB_FETCH_NUM: $this->fetchMode = PGSQL_NUM; break;
 		case ADODB_FETCH_ASSOC:$this->fetchMode = PGSQL_ASSOC; break;
-		default:
+		
 		case ADODB_FETCH_DEFAULT:
-		case ADODB_FETCH_BOTH:$this->fetchMode = PGSQL_BOTH; break;
+		case ADODB_FETCH_BOTH:
+		default: $this->fetchMode = PGSQL_BOTH; break;
 		}
+		$this->adodbFetchMode = $mode;
 		$this->ADORecordSet($queryID);
 	}
 	
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-oci8.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-oci8.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-oci8.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-oci8.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 /*
 
-  version V4.50 6 July 2004 (c) 2000-2004 John Lim. All rights reserved.
+  version V4.62 2 Apr 2005 (c) 2000-2005 John Lim. All rights reserved.
 
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
@@ -99,6 +99,7 @@
 	{
 	global $ADODB_FETCH_MODE;
 	
+		$false = false;
 		$save = $ADODB_FETCH_MODE;
 		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
 		if ($this->fetchMode !== false) $savem = $this->SetFetchMode(false);
@@ -107,7 +108,9 @@
 		
 		if (isset($savem)) $this->SetFetchMode($savem);
 		$ADODB_FETCH_MODE = $save;
-		if (!$rs) return false;
+		if (!$rs) {
+			return $false;
+		}
 		$retarr = array();
 		while (!$rs->EOF) { //print_r($rs->fields);
 			$fld = new ADOFieldObject();
@@ -128,7 +131,7 @@
 			$rs->MoveNext();
 		}
 		$rs->Close();
-		return $retarr;
+		return (empty($retarr)) ? $false : $retarr;
 	}
 	
 	function Time()
@@ -203,12 +206,23 @@
 				
  		//if ($argHostname) print "<p>Connect: 1st argument should be left blank for $this->databaseType</p>";
 		if ($mode==1) {
-			$this->_connectionID = OCIPLogon($argUsername,$argPassword, $argDatabasename);
+			$this->_connectionID = ($this->charSet) ? 
+				OCIPLogon($argUsername,$argPassword, $argDatabasename)
+				:
+				OCIPLogon($argUsername,$argPassword, $argDatabasename, $this->charSet)
+				;
 			if ($this->_connectionID && $this->autoRollback)  OCIrollback($this->_connectionID);
 		} else if ($mode==2) {
-			$this->_connectionID = OCINLogon($argUsername,$argPassword, $argDatabasename);
+			$this->_connectionID = ($this->charSet) ? 
+				OCINLogon($argUsername,$argPassword, $argDatabasename)
+				:
+				OCINLogon($argUsername,$argPassword, $argDatabasename, $this->charSet);
+				
 		} else {
-			$this->_connectionID = OCILogon($argUsername,$argPassword, $argDatabasename);
+			$this->_connectionID = ($this->charSet) ? 
+				OCILogon($argUsername,$argPassword, $argDatabasename)
+				:
+				OCILogon($argUsername,$argPassword, $argDatabasename,$this->charSet);
 		}
 		if ($this->_connectionID === false) return false;
 		if ($this->_initdate) {
@@ -291,6 +305,73 @@
 		return $ret;
 	}
 	
+	// Mark Newnham 
+	function &MetaIndexes ($table, $primary = FALSE, $owner=false)
+	{
+        // save old fetch mode
+        global $ADODB_FETCH_MODE;
+
+        $save = $ADODB_FETCH_MODE;
+        $ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+
+        if ($this->fetchMode !== FALSE) {
+               $savem = $this->SetFetchMode(FALSE);
+        }
+
+		// get index details
+		$table = strtoupper($table);
+
+		// get Primary index
+		$primary_key = '';
+
+		$false = false;
+		$rs = $this->Execute(sprintf("SELECT * FROM ALL_CONSTRAINTS WHERE UPPER(TABLE_NAME)='%s' AND CONSTRAINT_TYPE='P'",$table));
+		if ($row = $rs->FetchRow())
+		   $primary_key = $row[1]; //constraint_name
+
+		if ($primary==TRUE && $primary_key=='') {
+			 if (isset($savem)) 
+                $this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+			return $false; //There is no primary key
+		}
+
+        $rs = $this->Execute(sprintf("SELECT ALL_INDEXES.INDEX_NAME, ALL_INDEXES.UNIQUENESS, ALL_IND_COLUMNS.COLUMN_POSITION, ALL_IND_COLUMNS.COLUMN_NAME FROM ALL_INDEXES,ALL_IND_COLUMNS WHERE UPPER(ALL_INDEXES.TABLE_NAME)='%s' AND ALL_IND_COLUMNS.INDEX_NAME=ALL_INDEXES.INDEX_NAME",$table));
+
+		
+        if (!is_object($rs)) {
+			if (isset($savem)) 
+				$this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+            return $false;
+        }
+
+		$indexes = array ();
+        // parse index data into array
+
+        while ($row = $rs->FetchRow()) {
+			if ($primary && $row[0] != $primary_key) continue;
+            if (!isset($indexes[$row[0]])) {
+				$indexes[$row[0]] = array(
+				   'unique' => ($row[1] == 'UNIQUE'),
+				   'columns' => array()
+				);
+            }
+            $indexes[$row[0]]['columns'][$row[2] - 1] = $row[3];
+        }
+
+        // sort columns by order in the index
+        foreach ( array_keys ($indexes) as $index ) {
+            ksort ($indexes[$index]['columns']);
+        }
+
+		if (isset($savem)) { 
+            $this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+		}
+        return $indexes;
+	}
+	
 	function BeginTrans()
 	{	
 		if ($this->transOff) return true;
@@ -412,6 +493,14 @@
 				$s .= 'AM';
 				break;
 				
+			case 'w':
+				$s .= 'D';
+				break;
+				
+			case 'l':
+				$s .= 'DAY';
+				break;
+				
 			default:
 			// handle escape characters...
 				if ($ch == '\\') {
@@ -457,9 +546,9 @@
 				if ($offset > 0) $nrows += $offset;
 				//$inputarr['adodb_rownum'] = $nrows;
 				if ($this->databaseType == 'oci8po') {
-					$sql = "select * from ($sql) where rownum <= ?";
+					$sql = "select * from (".$sql.") where rownum <= ?";
 				} else {
-					$sql = "select * from ($sql) where rownum <= :adodb_offset";
+					$sql = "select * from (".$sql.") where rownum <= :adodb_offset";
 				} 
 				$inputarr['adodb_offset'] = $nrows;
 				$nrows = -1;
@@ -473,10 +562,13 @@
 			 // Algorithm by Tomas V V Cox, from PEAR DB oci8.php
 			
 			 // Let Oracle return the name of the columns
-			 $q_fields = "SELECT * FROM ($sql) WHERE NULL = NULL";
-			 if (!$stmt = OCIParse($this->_connectionID, $q_fields)) {
-				 return false;
-			 }
+			$q_fields = "SELECT * FROM (".$sql.") WHERE NULL = NULL";
+			 
+			$false = false;
+			if (! $stmt_arr = $this->Prepare($q_fields)) {
+				return $false;
+			}
+			$stmt = $stmt_arr[1];
 			 
 			 if (is_array($inputarr)) {
 			 	foreach($inputarr as $k => $v) {
@@ -499,7 +591,7 @@
 			
 			 if (!OCIExecute($stmt, OCI_DEFAULT)) {
 				 OCIFreeStatement($stmt); 
-				 return false;
+				 return $false;
 			 }
 			 
 			 $ncols = OCINumCols($stmt);
@@ -633,14 +725,12 @@
 		$sttype = @OCIStatementType($stmt);
 		if ($sttype == 'BEGIN' || $sttype == 'DECLARE') {
 			return array($sql,$stmt,0,$BINDNUM, ($cursor) ? OCINewCursor($this->_connectionID) : false);
-		} 
-		
+		}
 		return array($sql,$stmt,0,$BINDNUM);
 	}
 	
 	/*
-		Call an oracle stored procedure and return a cursor variable. 
-		Convert the cursor variable into a recordset. 
+		Call an oracle stored procedure and returns a cursor variable as a recordset. 
 		Concept by Robert Tuttle robert@ud.com
 		
 		Example:
@@ -655,17 +745,24 @@
 	*/
 	function &ExecuteCursor($sql,$cursorName='rs',$params=false)
 	{
-		$stmt = ADODB_oci8::Prepare($sql,true); # true to allocate OCINewCursor
-			
+		if (is_array($sql)) $stmt = $sql;
+		else $stmt = ADODB_oci8::Prepare($sql,true); # true to allocate OCINewCursor
+	
 		if (is_array($stmt) && sizeof($stmt) >= 5) {
+			$hasref = true;
 			$this->Parameter($stmt, $ignoreCur, $cursorName, false, -1, OCI_B_CURSOR);
 			if ($params) {
 				foreach($params as $k => $v) {
 					$this->Parameter($stmt,$params[$k], $k);
 				}
 			}
-		}
-		return $this->Execute($stmt);
+		} else
+			$hasref = false;
+			
+		$rs =& $this->Execute($stmt);
+		if ($rs->databaseType == 'array') OCIFreeCursor($stmt[4]);
+		else if ($hasref) $rs->_refcursor = $stmt[4];
+		return $rs;
 	}
 	
 	/*
@@ -716,25 +813,26 @@
 				ADOConnection::outp("<b>Bind</b>: name = $name");
 			}
             //we have to create a new Descriptor here
-			$numlob = count($this -> _refLOBs);
-        	$this -> _refLOBs[$numlob]['LOB'] = OCINewDescriptor($this->_connectionID, oci_lob_desc($type));
-			$this -> _refLOBs[$numlob]['TYPE'] = $isOutput;
+			$numlob = count($this->_refLOBs);
+        	$this->_refLOBs[$numlob]['LOB'] = OCINewDescriptor($this->_connectionID, oci_lob_desc($type));
+			$this->_refLOBs[$numlob]['TYPE'] = $isOutput;
 			
-			$tmp = &$this -> _refLOBs[$numlob]['LOB'];
+			$tmp = &$this->_refLOBs[$numlob]['LOB'];
 	        $rez = OCIBindByName($stmt[1], ":".$name, $tmp, -1, $type);
 			if ($this->debug) {
-				ADOConnection::outp("<b>Bind</b>: descriptor has been allocated, var binded");
+				ADOConnection::outp("<b>Bind</b>: descriptor has been allocated, var (".$name.") binded");
 			}
 			
 			// if type is input then write data to lob now
 			if ($isOutput == false) {
-				$var = $this -> BlobEncode($var);
-				$tmp -> WriteTemporary($var);
+				$var = $this->BlobEncode($var);
+				$tmp->WriteTemporary($var);
+				$this->_refLOBs[$numlob]['VAR'] = &$var;
 				if ($this->debug) {
 					ADOConnection::outp("<b>Bind</b>: LOB has been written to temp");
 				}
 			} else {
-				$this -> _refLOBs[$numlob]['VAR'] = &$var;
+				$this->_refLOBs[$numlob]['VAR'] = &$var;
 			}
 			$rez = $tmp;
 		} else {
@@ -791,7 +889,7 @@
 	   3. $db->execute('insert into table (a,b,c) values (:a,:b,:c)',array('a'=>1,'b'=>2,'c'=>3));
 	   
 	   4. $db->prepare('insert into table (a,b,c) values (:0,:1,:2)');
-		  $db->$bind($stmt,1); $db->bind($stmt,2); $db->bind($stmt,3); 
+		  $db->bind($stmt,1); $db->bind($stmt,2); $db->bind($stmt,3); 
 		  $db->execute($stmt);
 	*/ 
 	function _query($sql,$inputarr)
@@ -812,7 +910,7 @@
 					$bindarr = array();
 					foreach($inputarr as $k => $v) {
 						$bindarr[$k] = $v;
-						OCIBindByName($stmt,":$k",$bindarr[$k],4000);
+						OCIBindByName($stmt,":$k",$bindarr[$k],is_string($v) && strlen($v)>4000 ? -1 : 4000);
 					}
 					$this->_bind[$bindpos] = &$bindarr;
 				}
@@ -861,9 +959,14 @@
 						}
 						//$_GLOBALS[$this -> _refLOBs[$key]['VAR']] = $tmp;
 						$this -> _refLOBs[$key]['VAR'] = $tmp;
-					}
-					$this -> _refLOBs[$key]['LOB'] -> free();
-					unset($this -> _refLOBs[$key]);
+					} else {
+                        $this->_refLOBs[$key]['LOB']->save($this->_refLOBs[$key]['VAR']);
+						$this -> _refLOBs[$key]['LOB']->free();
+						unset($this -> _refLOBs[$key]);
+                        if ($this->debug) {
+							ADOConnection::outp("<b>IN LOB</b>: LOB has been saved. <br>");
+						}
+                    }					
 				}
 			}
 		
@@ -902,10 +1005,10 @@
 		if (!$this->_connectionID) return;
 		
 		if (!$this->autoCommit) OCIRollback($this->_connectionID);
-		if (count($this -> _refLOBs) > 0) {
-			foreach ($this -> _refLOBs as $key => $value) {
-				$this -> _refLOBs[$key] -> free();
-				unset($this -> _refLOBs[$key]);
+		if (count($this->_refLOBs) > 0) {
+			foreach ($this ->_refLOBs as $key => $value) {
+				$this->_refLOBs[$key]['LOB']->free();
+				unset($this->_refLOBs[$key]);
 			}
 		}
 		OCILogoff($this->_connectionID);
@@ -1040,6 +1143,7 @@
 	var $databaseType = 'oci8';
 	var $bind=false;
 	var $_fieldobjs;
+	
 	//var $_arr = false;
 		
 	function ADORecordset_oci8($queryID,$mode=false)
@@ -1050,13 +1154,15 @@
 		}
 		switch ($mode)
 		{
-		default:
-		case ADODB_FETCH_NUM: $this->fetchMode = OCI_NUM+OCI_RETURN_NULLS+OCI_RETURN_LOBS; break;
 		case ADODB_FETCH_ASSOC:$this->fetchMode = OCI_ASSOC+OCI_RETURN_NULLS+OCI_RETURN_LOBS; break;
 		case ADODB_FETCH_DEFAULT:
 		case ADODB_FETCH_BOTH:$this->fetchMode = OCI_NUM+OCI_ASSOC+OCI_RETURN_NULLS+OCI_RETURN_LOBS; break;
+		case ADODB_FETCH_NUM: 
+		default:
+		$this->fetchMode = OCI_NUM+OCI_RETURN_NULLS+OCI_RETURN_LOBS; break;
 		}
-
+		
+		$this->adodbFetchMode = $mode;
 		$this->_queryID = $queryID;
 	}
 
@@ -1215,7 +1321,11 @@
 	function _close() 
 	{
 		if ($this->connection->_stmt === $this->_queryID) $this->connection->_stmt = false;
-		OCIFreeStatement($this->_queryID);
+		if (!empty($this->_refcursor)) {
+			OCIFreeCursor($this->_refcursor);
+			$this->_refcursor = false;
+		}
+		@OCIFreeStatement($this->_queryID);
  		$this->_queryID = false;
 		
 	}
@@ -1274,13 +1384,13 @@
 		}
 		switch ($mode)
 		{
-		default:
-		case ADODB_FETCH_NUM: $this->fetchMode = OCI_NUM+OCI_RETURN_NULLS+OCI_RETURN_LOBS; break;
 		case ADODB_FETCH_ASSOC:$this->fetchMode = OCI_ASSOC+OCI_RETURN_NULLS+OCI_RETURN_LOBS; break;
 		case ADODB_FETCH_DEFAULT:
 		case ADODB_FETCH_BOTH:$this->fetchMode = OCI_NUM+OCI_ASSOC+OCI_RETURN_NULLS+OCI_RETURN_LOBS; break;
+		case ADODB_FETCH_NUM: 
+		default: $this->fetchMode = OCI_NUM+OCI_RETURN_NULLS+OCI_RETURN_LOBS; break;
 		}
-
+		$this->adodbFetchMode = $mode;
 		$this->_queryID = $queryID;
 	}
 	
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-oci805.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-oci805.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-oci805.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-oci805.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /** 
- * @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license. 
  * Whenever there is any discrepancy between the two licenses, 
  * the BSD license will take precedence. 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-oci8po.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-oci8po.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-oci8po.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-oci8po.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim. All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim. All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbc.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbc.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbc.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbc.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim#natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim#natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -45,6 +45,49 @@
 		$this->_has_stupid_odbc_fetch_api_change = ADODB_PHPVER >= 0x4200;
 	}
 	
+		// returns true or false
+	function _connect($argDSN, $argUsername, $argPassword, $argDatabasename)
+	{
+	global $php_errormsg;
+		
+		if (!function_exists('odbc_connect')) return null;
+		
+		if ($this->debug && $argDatabasename && $this->databaseType != 'vfp') {
+			ADOConnection::outp("For odbc Connect(), $argDatabasename is not used. Place dsn in 1st parameter.");
+		}
+		if (isset($php_errormsg)) $php_errormsg = '';
+		if ($this->curmode === false) $this->_connectionID = odbc_connect($argDSN,$argUsername,$argPassword);
+		else $this->_connectionID = odbc_connect($argDSN,$argUsername,$argPassword,$this->curmode);
+		$this->_errorMsg = isset($php_errormsg) ? $php_errormsg : '';
+		if (isset($this->connectStmt)) $this->Execute($this->connectStmt);
+		
+		return $this->_connectionID != false;
+	}
+	
+	// returns true or false
+	function _pconnect($argDSN, $argUsername, $argPassword, $argDatabasename)
+	{
+	global $php_errormsg;
+	
+		if (!function_exists('odbc_connect')) return null;
+		
+		if (isset($php_errormsg)) $php_errormsg = '';
+		$this->_errorMsg = isset($php_errormsg) ? $php_errormsg : '';
+		if ($this->debug && $argDatabasename) {
+			ADOConnection::outp("For odbc PConnect(), $argDatabasename is not used. Place dsn in 1st parameter.");
+		}
+	//	print "dsn=$argDSN u=$argUsername p=$argPassword<br>"; flush();
+		if ($this->curmode === false) $this->_connectionID = odbc_connect($argDSN,$argUsername,$argPassword);
+		else $this->_connectionID = odbc_pconnect($argDSN,$argUsername,$argPassword,$this->curmode);
+		
+		$this->_errorMsg = isset($php_errormsg) ? $php_errormsg : '';
+		if ($this->_connectionID && $this->autoRollback) @odbc_rollback($this->_connectionID);
+		if (isset($this->connectStmt)) $this->Execute($this->connectStmt);
+		
+		return $this->_connectionID != false;
+	}
+
+	
 	function ServerInfo()
 	{
 	
@@ -156,48 +199,6 @@
 	}
 	
 	
-	// returns true or false
-	function _connect($argDSN, $argUsername, $argPassword, $argDatabasename)
-	{
-	global $php_errormsg;
-		
-		if (!function_exists('odbc_connect')) return null;
-		
-		if ($this->debug && $argDatabasename && $this->databaseType != 'vfp') {
-			ADOConnection::outp("For odbc Connect(), $argDatabasename is not used. Place dsn in 1st parameter.");
-		}
-		if (isset($php_errormsg)) $php_errormsg = '';
-		if ($this->curmode === false) $this->_connectionID = odbc_connect($argDSN,$argUsername,$argPassword);
-		else $this->_connectionID = odbc_connect($argDSN,$argUsername,$argPassword,$this->curmode);
-		$this->_errorMsg = isset($php_errormsg) ? $php_errormsg : '';
-		if (isset($this->connectStmt)) $this->Execute($this->connectStmt);
-		
-		//if ($this->_connectionID) odbc_autocommit($this->_connectionID,true);
-		return $this->_connectionID != false;
-	}
-	
-	// returns true or false
-	function _pconnect($argDSN, $argUsername, $argPassword, $argDatabasename)
-	{
-	global $php_errormsg;
-	
-		if (!function_exists('odbc_connect')) return null;
-		
-		if (isset($php_errormsg)) $php_errormsg = '';
-		$this->_errorMsg = isset($php_errormsg) ? $php_errormsg : '';
-		if ($this->debug && $argDatabasename) {
-			ADOConnection::outp("For odbc PConnect(), $argDatabasename is not used. Place dsn in 1st parameter.");
-		}
-	//	print "dsn=$argDSN u=$argUsername p=$argPassword<br>"; flush();
-		if ($this->curmode === false) $this->_connectionID = odbc_connect($argDSN,$argUsername,$argPassword);
-		else $this->_connectionID = odbc_pconnect($argDSN,$argUsername,$argPassword,$this->curmode);
-		
-		$this->_errorMsg = isset($php_errormsg) ? $php_errormsg : '';
-		if ($this->_connectionID && $this->autoRollback) @odbc_rollback($this->_connectionID);
-		if (isset($this->connectStmt)) $this->Execute($this->connectStmt);
-		
-		return $this->_connectionID != false;
-	}
 
 	function BeginTrans()
 	{	
@@ -274,8 +275,10 @@
 		$rs = new ADORecordSet_odbc($qid);
 		
 		$ADODB_FETCH_MODE = $savem;
-		if (!$rs) return false;
-		
+		if (!$rs) {
+			$false = false;
+			return $false;
+		}
 		$rs->_has_stupid_odbc_fetch_api_change = $this->_has_stupid_odbc_fetch_api_change;
 		
 		$arr =& $rs->GetArray();
@@ -300,6 +303,7 @@
 	}
 	
 /*
+See http://msdn.microsoft.com/library/default.asp?url=/library/en-us/odbc/htm/odbcdatetime_data_type_changes.asp
 / SQL data type codes /
 #define	SQL_UNKNOWN_TYPE	0
 #define SQL_CHAR			1
@@ -315,6 +319,7 @@
 #endif
 #define SQL_VARCHAR		12
 
+
 / One-parameter shortcuts for date/time data types /
 #if (ODBCVER >= 0x0300)
 #define SQL_TYPE_DATE	  91
@@ -340,13 +345,16 @@
 		case -4: //image
 			return 'B';
 				
+		case 9:	
 		case 91:
-		case 11:
 			return 'D';
-			
+		
+		case 10:
+		case 11:
 		case 92:
 		case 93:
-		case 9:	return 'T';
+			return 'T';
+			
 		case 4:
 		case 5:
 		case -6:
@@ -366,6 +374,7 @@
 	{
 	global $ADODB_FETCH_MODE;
 	
+		$false = false;
 		if ($this->uCaseTables) $table = strtoupper($table);
 		$schema = '';
 		$this->_findschema($table,$schema);
@@ -411,15 +420,15 @@
 			if (empty($qid)) $qid = odbc_columns($this->_connectionID);
 			break;
 		}
-		if (empty($qid)) return false;
+		if (empty($qid)) return $false;
 		
-		$rs = new ADORecordSet_odbc($qid);
+		$rs =& new ADORecordSet_odbc($qid);
 		$ADODB_FETCH_MODE = $savem;
 		
-		if (!$rs) return false;
-		
+		if (!$rs) return $false;
 		$rs->_has_stupid_odbc_fetch_api_change = $this->_has_stupid_odbc_fetch_api_change;
 		$rs->_fetch();
+		
 		$retarr = array();
 		
 		/*
@@ -438,8 +447,8 @@
 		11 REMARKS
 		*/
 		while (!$rs->EOF) {
-			//adodb_pr($rs->fields);
-			if (strtoupper($rs->fields[2]) == $table && (!$schema || strtoupper($rs->fields[1]) == $schema)) {
+		//	adodb_pr($rs->fields);
+			if (strtoupper(trim($rs->fields[2])) == $table && (!$schema || strtoupper($rs->fields[1]) == $schema)) {
 				$fld = new ADOFieldObject();
 				$fld->name = $rs->fields[3];
 				$fld->type = $this->ODBCTypes($rs->fields[4]);
@@ -464,7 +473,7 @@
 		}
 		$rs->Close(); //-- crashes 4.03pl1 -- why?
 		
-		return $retarr;
+		return empty($retarr) ? $false : $retarr;
 	}
 	
 	function Prepare($sql)
@@ -681,11 +690,13 @@
 	{
 		if ($this->_numOfRows != 0 && !$this->EOF) {		
 			$this->_currentRow++;
-			$row = 0;
+			
 			if ($this->_has_stupid_odbc_fetch_api_change)
 				$rez = @odbc_fetch_into($this->_queryID,$this->fields);
-			else 
+			else {
+				$row = 0;
 				$rez = @odbc_fetch_into($this->_queryID,$row,$this->fields);
+			}
 			if ($rez) {
 				if ($this->fetchMode & ADODB_FETCH_ASSOC) {
 					$this->fields =& $this->GetRowAssoc(ADODB_ASSOC_CASE);
@@ -700,12 +711,13 @@
 	
 	function _fetch()
 	{
-		$row = 0;
+		
 		if ($this->_has_stupid_odbc_fetch_api_change)
 			$rez = @odbc_fetch_into($this->_queryID,$this->fields,$row);
-		else 
+		else {
+			$row = 0;
 			$rez = @odbc_fetch_into($this->_queryID,$row,$this->fields);
-		
+		}
 		if ($rez) {
 			if ($this->fetchMode & ADODB_FETCH_ASSOC) {
 				$this->fields =& $this->GetRowAssoc(ADODB_ASSOC_CASE);
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbc_mssql.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbc_mssql.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbc_mssql.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbc_mssql.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -43,7 +43,7 @@
 	function ADODB_odbc_mssql()
 	{
 		$this->ADODB_odbc();
-		$this->curmode = SQL_CUR_USE_ODBC;	
+		//$this->curmode = SQL_CUR_USE_ODBC;	
 	}
 
 	// crashes php...
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbc_oracle.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbc_oracle.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbc_oracle.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbc_oracle.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -38,44 +38,41 @@
 		
 	function &MetaTables() 
 	{
-		if ($this->metaTablesSQL) {
-			$rs = $this->Execute($this->metaTablesSQL);
-			if ($rs === false) return false;
-			$arr = $rs->GetArray();
-			$arr2 = array();
-			for ($i=0; $i < sizeof($arr); $i++) {
-				$arr2[] = $arr[$i][0];
-			}
-			$rs->Close();
-			return $arr2;
+		$false = false;
+		$rs = $this->Execute($this->metaTablesSQL);
+		if ($rs === false) return $false;
+		$arr = $rs->GetArray();
+		$arr2 = array();
+		for ($i=0; $i < sizeof($arr); $i++) {
+			$arr2[] = $arr[$i][0];
 		}
-		return false;
+		$rs->Close();
+		return $arr2;
 	}
 	
 	function &MetaColumns($table) 
 	{
-		if (!empty($this->metaColumnsSQL)) {
 		
-			$rs = $this->Execute(sprintf($this->metaColumnsSQL,strtoupper($table)));
-			if ($rs === false) return false;
-
-			$retarr = array();
-			while (!$rs->EOF) { //print_r($rs->fields);
-				$fld = new ADOFieldObject();
-				$fld->name = $rs->fields[0];
-				$fld->type = $rs->fields[1];
-				$fld->max_length = $rs->fields[2];
-				
-				
-				if ($ADODB_FETCH_MODE == ADODB_FETCH_NUM) $retarr[] = $fld;	
-				else $retarr[strtoupper($fld->name)] = $fld;
-				
-				$rs->MoveNext();
-			}
-			$rs->Close();
-			return $retarr;	
+		$rs = $this->Execute(sprintf($this->metaColumnsSQL,strtoupper($table)));
+		if ($rs === false) {	
+			$false = false;
+			return $false;
+		}
+		$retarr = array();
+		while (!$rs->EOF) { //print_r($rs->fields);
+			$fld = new ADOFieldObject();
+			$fld->name = $rs->fields[0];
+			$fld->type = $rs->fields[1];
+			$fld->max_length = $rs->fields[2];
+			
+			
+			if ($ADODB_FETCH_MODE == ADODB_FETCH_NUM) $retarr[] = $fld;	
+			else $retarr[strtoupper($fld->name)] = $fld;
+			
+			$rs->MoveNext();
 		}
-		return false;
+		$rs->Close();
+		return $retarr;	
 	}
 
 	// returns true or false
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbtp.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbtp.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbtp.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbtp.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
   the BSD license will take precedence. See License.txt.
@@ -28,10 +28,10 @@
 
 	var $_genSeqSQL = "create table %s (seq_name char(30) not null unique , seq_value integer not null)";
 	var $_dropSeqSQL = "delete from adodb_seq where seq_name = '%s'";
-	var $_autocommit = true;
 	var $_bindInputArray = false;
 	var $_useUnicodeSQL = false;
 	var $_canPrepareSP = false;
+	var $_dontPoolDBC = true;
 
 	function ADODB_odbtp()
 	{
@@ -106,7 +106,7 @@
 	function GenID($seq='adodbseq',$start=1)
 	{
 		$seqtab='adodb_seq';
-		if( $this->odbc_driver == ODB_DRIVER_FOXPRO ) {
+		if( $this->odbc_driver == ODB_DRIVER_FOXPRO) {
 			$path = @odbtp_get_attr( ODB_ATTR_DATABASENAME, $this->_connectionID );
 			//if using vfp dbc file
 			if( !strcasecmp(strrchr($path, '.'), '.dbc') )
@@ -150,16 +150,31 @@
     function _connect($HostOrInterface, $UserOrDSN='', $argPassword='', $argDatabase='')
 	{
 		$this->_connectionID = @odbtp_connect($HostOrInterface,$UserOrDSN,$argPassword,$argDatabase);
-		if ($this->_connectionID === false)
-		{
+		if ($this->_connectionID === false) {
 			$this->_errorMsg = $this->ErrorMsg() ;
 			return false;
 		}
+		if ($this->_dontPoolDBC) {
+			if (function_exists('odbtp_dont_pool_dbc'))
+				@odbtp_dont_pool_dbc($this->_connectionID);
+		}
+		else {
+			$this->_dontPoolDBC = true;
+		}
 		$this->odbc_driver = @odbtp_get_attr(ODB_ATTR_DRIVER, $this->_connectionID);
-
-		// Set driver specific attributes
-		switch( $this->odbc_driver ) {
-			case ODB_DRIVER_MSSQL:
+		$dbms = strtolower(@odbtp_get_attr(ODB_ATTR_DBMSNAME, $this->_connectionID));
+		$this->odbc_name = $dbms;
+		
+		// Account for inconsistent DBMS names
+		if( $this->odbc_driver == ODB_DRIVER_ORACLE )
+			$dbms = 'oracle';
+		else if( $this->odbc_driver == ODB_DRIVER_SYBASE )
+			$dbms = 'sybase';
+
+		// Set DBMS specific attributes
+		switch( $dbms ) {
+			case 'microsoft sql server':
+				$this->databaseType = 'odbtp_mssql';
 				$this->fmtDate = "'Y-m-d'";
 				$this->fmtTimeStamp = "'Y-m-d h:i:sA'";
 				$this->sysDate = 'convert(datetime,convert(char,GetDate(),102),102)';
@@ -176,8 +191,10 @@
 				$this->length = 'len';
 				$this->identitySQL = 'select @@IDENTITY';
 				$this->metaDatabasesSQL = "select name from master..sysdatabases where name <> 'master'";
+				$this->_canPrepareSP = true;
 				break;
-			case ODB_DRIVER_JET:
+			case 'access':
+				$this->databaseType = 'odbtp_access';
 				$this->fmtDate = "#Y-m-d#";
 				$this->fmtTimeStamp = "#Y-m-d h:i:sA#";
 				$this->sysDate = "FORMAT(NOW,'yyyy-mm-dd')";
@@ -185,24 +202,22 @@
                 $this->hasTop = 'top';
 				$this->hasTransactions = false;
 				$this->_canPrepareSP = true;  // For MS Access only.
-
-				// Can't rebind ODB_CHAR to ODB_WCHAR if row cache enabled.
-				if ($this->_useUnicodeSQL)
-					odbtp_use_row_cache($this->_connectionID, FALSE, 0);
 				break;
-			case ODB_DRIVER_FOXPRO:
+			case 'visual foxpro':
+				$this->databaseType = 'odbtp_vfp';
 				$this->fmtDate = "{^Y-m-d}";
 				$this->fmtTimeStamp = "{^Y-m-d, h:i:sA}";
 				$this->sysDate = 'date()';
 				$this->sysTimeStamp = 'datetime()';
 				$this->ansiOuter = true;
                 $this->hasTop = 'top';
-			$this->hasTransactions = false;
+				$this->hasTransactions = false;
 				$this->replaceQuote = "'+chr(39)+'";
 				$this->true = '.T.';
 				$this->false = '.F.';
 				break;
-			case ODB_DRIVER_ORACLE:
+			case 'oracle':
+				$this->databaseType = 'odbtp_oci8';
 				$this->fmtDate = "'Y-m-d 00:00:00'";
 				$this->fmtTimeStamp = "'Y-m-d h:i:sA'";
 				$this->sysDate = 'TRUNC(SYSDATE)';
@@ -211,7 +226,8 @@
 				$this->_bindInputArray = true;
 				$this->concat_operator = '||';
 				break;
-			case ODB_DRIVER_SYBASE:
+			case 'sybase':
+				$this->databaseType = 'odbtp_sybase';
 				$this->fmtDate = "'Y-m-d'";
 				$this->fmtTimeStamp = "'Y-m-d H:i:s'";
 				$this->sysDate = 'GetDate()';
@@ -223,22 +239,26 @@
 				$this->identitySQL = 'select @@IDENTITY';
 				break;
 			default:
+				$this->databaseType = 'odbtp';
 				if( @odbtp_get_attr(ODB_ATTR_TXNCAPABLE, $this->_connectionID) )
-			$this->hasTransactions = true;
+					$this->hasTransactions = true;
 				else
 					$this->hasTransactions = false;
 		}
         @odbtp_set_attr(ODB_ATTR_FULLCOLINFO, TRUE, $this->_connectionID );
+
 		if ($this->_useUnicodeSQL )
 			@odbtp_set_attr(ODB_ATTR_UNICODESQL, TRUE, $this->_connectionID);
+
         return true;
 	}
-	
+
 	function _pconnect($HostOrInterface, $UserOrDSN='', $argPassword='', $argDatabase='')
 	{
+		$this->_dontPoolDBC = false;
   		return $this->_connect($HostOrInterface, $UserOrDSN, $argPassword, $argDatabase);
 	}
-	
+
 	function SelectDB($dbName)
 	{
 		if (!@odbtp_select_db($dbName, $this->_connectionID)) {
@@ -254,7 +274,11 @@
 
 		$savem = $ADODB_FETCH_MODE;
 		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+		if ($this->fetchMode !== false) $savefm = $this->SetFetchMode(false);
+		
 		$arr =& $this->GetArray("||SQLTables||||$ttype");
+		
+		if (isset($savefm)) $this->SetFetchMode($savefm);
 		$ADODB_FETCH_MODE = $savem;
 
 		$arr2 = array();
@@ -276,11 +300,17 @@
 
 		$savem = $ADODB_FETCH_MODE;
 		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+		if ($this->fetchMode !== false) $savefm = $this->SetFetchMode(false);
+		
 		$rs = $this->Execute( "||SQLColumns||$schema|$table" );
+		
+		if (isset($savefm)) $this->SetFetchMode($savefm);
 		$ADODB_FETCH_MODE = $savem;
 
-		if (!$rs) return false;
-		
+		if (!$rs || $rs->EOF) {
+			$false = false;
+			return $false;
+		}
 		while (!$rs->EOF) {
 			//print_r($rs->fields);
 			if (strtoupper($rs->fields[2]) == $table) {
@@ -299,7 +329,7 @@
 				break;
 			$rs->MoveNext();
 		}
-		$rs->Close(); 
+		$rs->Close();
 
 		return $retarr;
 	}
@@ -335,8 +365,11 @@
 			//print_r($constr);
 			$arr[$constr[11]][$constr[2]][] = $constr[7].'='.$constr[3];
 		}
-		if (!$arr) return false;
-
+		if (!$arr) {
+			$false = false;
+			return $false;
+		}
+		
 		$arr2 = array();
 
 		foreach($arr as $k => $v) {
@@ -353,10 +386,14 @@
 		if (!$this->hasTransactions) return false;
 		if ($this->transOff) return true;
 		$this->transCnt += 1;
-		$this->_autocommit = false;
-		$rs = @odbtp_set_attr(ODB_ATTR_TRANSACTIONS,ODB_TXN_READUNCOMMITTED,$this->_connectionID);
+		$this->autoCommit = false;
+		if (defined('ODB_TXN_DEFAULT'))
+			$txn = ODB_TXN_DEFAULT;
+		else
+			$txn = ODB_TXN_READUNCOMMITTED;
+		$rs = @odbtp_set_attr(ODB_ATTR_TRANSACTIONS,$txn,$this->_connectionID);
 		if(!$rs) return false;
-		else return true;
+		return true;
 	}
 
 	function CommitTrans($ok=true)
@@ -364,8 +401,8 @@
 		if ($this->transOff) return true;
 		if (!$ok) return $this->RollbackTrans();
 		if ($this->transCnt) $this->transCnt -= 1;
-		$this->_autocommit = true;
-		if( ($ret = odbtp_commit($this->_connectionID)) )
+		$this->autoCommit = true;
+		if( ($ret = @odbtp_commit($this->_connectionID)) )
 			$ret = @odbtp_set_attr(ODB_ATTR_TRANSACTIONS, ODB_TXN_NONE, $this->_connectionID);//set transaction off
 		return $ret;
 	}
@@ -374,8 +411,8 @@
 	{
 		if ($this->transOff) return true;
 		if ($this->transCnt) $this->transCnt -= 1;
-		$this->_autocommit = true;
-		if( ($ret = odbtp_rollback($this->_connectionID)) )
+		$this->autoCommit = true;
+		if( ($ret = @odbtp_rollback($this->_connectionID)) )
 			$ret = @odbtp_set_attr(ODB_ATTR_TRANSACTIONS, ODB_TXN_NONE, $this->_connectionID);//set transaction off
 		return $ret;
 	}
@@ -392,7 +429,7 @@
 	function Prepare($sql)
 	{
 		if (! $this->_bindInputArray) return $sql; // no binding
-		$stmt = odbtp_prepare($sql,$this->_connectionID);
+		$stmt = @odbtp_prepare($sql,$this->_connectionID);
 		if (!$stmt) {
 		//	print "Prepare Error for ($sql) ".$this->ErrorMsg()."<br>";
 			return $sql;
@@ -404,7 +441,7 @@
 	{
 		if (!$this->_canPrepareSP) return $sql; // Can't prepare procedures
 
-		$stmt = odbtp_prepare_proc($sql,$this->_connectionID);
+		$stmt = @odbtp_prepare_proc($sql,$this->_connectionID);
 		if (!$stmt) return false;
 		return array($sql,$stmt);
 	}
@@ -441,7 +478,7 @@
 		else {
 			$name = '@'.$name;
 		}
-		return odbtp_attach_param($stmt[1], $name, $var, $type, $maxLen);
+		return @odbtp_attach_param($stmt[1], $name, $var, $type, $maxLen);
 	}
 
 	/*
@@ -457,13 +494,13 @@
 	function UpdateBlob($table,$column,$val,$where,$blobtype='image')
 	{
 		$sql = "UPDATE $table SET $column = ? WHERE $where";
-		if( !($stmt = odbtp_prepare($sql, $this->_connectionID)) )
+		if( !($stmt = @odbtp_prepare($sql, $this->_connectionID)) )
 			return false;
-		if( !odbtp_input( $stmt, 1, ODB_BINARY, 1000000, $blobtype ) )
+		if( !@odbtp_input( $stmt, 1, ODB_BINARY, 1000000, $blobtype ) )
 			return false;
-		if( !odbtp_set( $stmt, 1, $val ) )
+		if( !@odbtp_set( $stmt, 1, $val ) )
 			return false;
-		return odbtp_execute( $stmt ) != false;
+		return @odbtp_execute( $stmt ) != false;
 	}
 
 	function IfNull( $field, $ifNull )
@@ -483,23 +520,23 @@
 			if (is_array($sql)) {
 				$stmtid = $sql[1];
 			} else {
-				$stmtid = odbtp_prepare($sql,$this->_connectionID);
+				$stmtid = @odbtp_prepare($sql,$this->_connectionID);
 				if ($stmtid == false) {
 					$this->_errorMsg = $php_errormsg;
 					return false;
 				}
 			}
-			$num_params = odbtp_num_params( $stmtid );
+			$num_params = @odbtp_num_params( $stmtid );
 			for( $param = 1; $param <= $num_params; $param++ ) {
 				@odbtp_input( $stmtid, $param );
 				@odbtp_set( $stmtid, $param, $inputarr[$param-1] );
 			}
-			if (! odbtp_execute($stmtid) ) {
+			if (!@odbtp_execute($stmtid) ) {
 				return false;
 			}
 		} else if (is_array($sql)) {
 			$stmtid = $sql[1];
-			if (!odbtp_execute($stmtid)) {
+			if (!@odbtp_execute($stmtid)) {
 				return false;
 			}
 		} else {
@@ -540,6 +577,19 @@
 		$this->_numOfFields = @odbtp_num_fields($this->_queryID);
 		if (!($this->_numOfRows = @odbtp_num_rows($this->_queryID)))
 			$this->_numOfRows = -1;
+
+		if (!$this->connection->_useUnicodeSQL) return;
+
+		if ($this->connection->odbc_driver == ODB_DRIVER_JET) {
+			if (!@odbtp_get_attr(ODB_ATTR_MAPCHARTOWCHAR,
+			                     $this->connection->_connectionID))
+			{
+				for ($f = 0; $f < $this->_numOfFields; $f++) {
+					if (@odbtp_field_bindtype($this->_queryID, $f) == ODB_CHAR)
+						@odbtp_bind_field($this->_queryID, $f, ODB_WCHAR);
+				}
+			}
+		}
 	}
 
 	function &FetchField($fieldOffset = 0)
@@ -570,7 +620,7 @@
 				$this->bind[strtoupper($name)] = $i;
 			}
 		}
-		 return $this->fields[$this->bind[strtoupper($colname)]];
+		return $this->fields[$this->bind[strtoupper($colname)]];
 	}
 
 	function _fetch_odbtp($type=0)
@@ -597,18 +647,18 @@
 	{
 		if (!$this->_fetch_odbtp(ODB_FETCH_FIRST)) return false;
 		$this->EOF = false;
-	  $this->_currentRow = 0;
-	  return true;
+		$this->_currentRow = 0;
+		return true;
     }
 
-    function MoveLast()
-   {
+	function MoveLast()
+	{
 		if (!$this->_fetch_odbtp(ODB_FETCH_LAST)) return false;
 		$this->EOF = false;
 		$this->_currentRow = $this->_numOfRows - 1;
-	  return true;
-    }
-    
+		return true;
+	}
+
 	function NextRecordSet()
 	{
 		if (!@odbtp_next_result($this->_queryID)) return false;
@@ -625,4 +675,53 @@
 	}
 }
 
-?>
\ No newline at end of file
+class ADORecordSet_odbtp_mssql extends ADORecordSet_odbtp {
+
+	var $databaseType = 'odbtp_mssql';
+
+	function ADORecordSet_odbtp_mssql($id,$mode=false)
+	{
+		return $this->ADORecordSet_odbtp($id,$mode);
+	}
+}
+
+class ADORecordSet_odbtp_access extends ADORecordSet_odbtp {
+
+	var $databaseType = 'odbtp_access';
+
+	function ADORecordSet_odbtp_access($id,$mode=false)
+	{
+		return $this->ADORecordSet_odbtp($id,$mode);
+	}
+}
+
+class ADORecordSet_odbtp_vfp extends ADORecordSet_odbtp {
+
+	var $databaseType = 'odbtp_vfp';
+
+	function ADORecordSet_odbtp_vfp($id,$mode=false)
+	{
+		return $this->ADORecordSet_odbtp($id,$mode);
+	}
+}
+
+class ADORecordSet_odbtp_oci8 extends ADORecordSet_odbtp {
+
+	var $databaseType = 'odbtp_oci8';
+
+	function ADORecordSet_odbtp_oci8($id,$mode=false)
+	{
+		return $this->ADORecordSet_odbtp($id,$mode);
+	}
+}
+
+class ADORecordSet_odbtp_sybase extends ADORecordSet_odbtp {
+
+	var $databaseType = 'odbtp_sybase';
+
+	function ADORecordSet_odbtp_sybase($id,$mode=false)
+	{
+		return $this->ADORecordSet_odbtp($id,$mode);
+	}
+}
+?>
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbtp_unicode.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbtp_unicode.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-odbtp_unicode.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-odbtp_unicode.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+	V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
   the BSD license will take precedence. See License.txt.
@@ -28,7 +28,7 @@
 }
 
 class ADODB_odbtp_unicode extends ADODB_odbtp {
-	var $databaseType = "odbtp_unicode";
+	var $databaseType = 'odbtp';
 	var $_useUnicodeSQL = true;
 
 	function ADODB_odbtp_unicode()
@@ -36,27 +36,4 @@
 		$this->ADODB_odbtp();
 	}
 }
-
-class ADORecordSet_odbtp_unicode extends ADORecordSet_odbtp {
-	var $databaseType = 'odbtp_unicode';
-
-	function ADORecordSet_odbtp_unicode($queryID,$mode=false)
-	{
-		$this->ADORecordSet_odbtp($queryID, $mode);
-	}
-
-	function _initrs()
-	{
-		$this->_numOfFields = @odbtp_num_fields($this->_queryID);
-		if (!($this->_numOfRows = @odbtp_num_rows($this->_queryID)))
-			$this->_numOfRows = -1;
-
-		if ($this->connection->odbc_driver == ODB_DRIVER_JET) {
-			for ($f = 0; $f < $this->_numOfFields; $f++) {
-				if (odbtp_field_bindtype($this->_queryID, $f) == ODB_CHAR)
-					odbtp_bind_field($this->_queryID, $f, ODB_WCHAR);
-			}
-		}
-	}
-}
-?>
\ No newline at end of file
+?>
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-oracle.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-oracle.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-oracle.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-oracle.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-pdo.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-pdo.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-pdo.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-pdo.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim#natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim#natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -9,14 +9,290 @@
   Latest version is available at http://adodb.sourceforge.net
   
   Requires ODBC. Works on Windows and Unix.
+
+	Problems: 
+		Where is float/decimal type in pdo_param_type
+		LOB handling for CLOB/BLOB differs significantly
 */
 // security - hide paths
 if (!defined('ADODB_DIR')) die();
+
+
+/*
+enum pdo_param_type {
+PDO_PARAM_NULL, 0
+
+/* int as in long (the php native int type).
+ * If you mark a column as an int, PDO expects get_col to return
+ * a pointer to a long 
+PDO_PARAM_INT, 1
+
+/* get_col ptr should point to start of the string buffer 
+PDO_PARAM_STR, 2
+
+/* get_col: when len is 0 ptr should point to a php_stream *,
+ * otherwise it should behave like a string. Indicate a NULL field
+ * value by setting the ptr to NULL 
+PDO_PARAM_LOB, 3
+
+/* get_col: will expect the ptr to point to a new PDOStatement object handle,
+ * but this isn't wired up yet 
+PDO_PARAM_STMT, 4 /* hierarchical result set 
+
+/* get_col ptr should point to a zend_bool 
+PDO_PARAM_BOOL, 5
+
+
+/* magic flag to denote a parameter as being input/output 
+PDO_PARAM_INPUT_OUTPUT = 0x80000000
+};
+*/
+	
+function adodb_pdo_type($t)
+{
+	switch($t) {
+	case 2: return 'VARCHAR';
+	case 3: return 'BLOB';
+	default: return 'NUMERIC';
+	}
+}
 	 
 /*--------------------------------------------------------------------------------------
 --------------------------------------------------------------------------------------*/
 
 
+class ADODB_pdo_pgsql extends ADODB_pdo {
+var $metaDatabasesSQL = "select datname from pg_database where datname not in ('template0','template1') order by 1";
+    var $metaTablesSQL = "select tablename,'T' from pg_tables where tablename not like 'pg\_%'
+	and tablename not in ('sql_features', 'sql_implementation_info', 'sql_languages',
+	 'sql_packages', 'sql_sizing', 'sql_sizing_profiles') 
+	union 
+        select viewname,'V' from pg_views where viewname not like 'pg\_%'";
+	//"select tablename from pg_tables where tablename not like 'pg_%' order by 1";
+	var $isoDates = true; // accepts dates in ISO format
+	var $sysDate = "CURRENT_DATE";
+	var $sysTimeStamp = "CURRENT_TIMESTAMP";
+	var $blobEncodeType = 'C';
+	var $metaColumnsSQL = "SELECT a.attname,t.typname,a.attlen,a.atttypmod,a.attnotnull,a.atthasdef,a.attnum 
+		FROM pg_class c, pg_attribute a,pg_type t 
+		WHERE relkind in ('r','v') AND (c.relname='%s' or c.relname = lower('%s')) and a.attname not like '....%%'
+AND a.attnum > 0 AND a.atttypid = t.oid AND a.attrelid = c.oid ORDER BY a.attnum";
+
+	// used when schema defined
+	var $metaColumnsSQL1 = "SELECT a.attname, t.typname, a.attlen, a.atttypmod, a.attnotnull, a.atthasdef, a.attnum 
+FROM pg_class c, pg_attribute a, pg_type t, pg_namespace n 
+WHERE relkind in ('r','v') AND (c.relname='%s' or c.relname = lower('%s'))
+ and c.relnamespace=n.oid and n.nspname='%s' 
+	and a.attname not like '....%%' AND a.attnum > 0 
+	AND a.atttypid = t.oid AND a.attrelid = c.oid ORDER BY a.attnum";
+	
+	// get primary key etc -- from Freek Dijkstra
+	var $metaKeySQL = "SELECT ic.relname AS index_name, a.attname AS column_name,i.indisunique AS unique_key, i.indisprimary AS primary_key 
+	FROM pg_class bc, pg_class ic, pg_index i, pg_attribute a WHERE bc.oid = i.indrelid AND ic.oid = i.indexrelid AND (i.indkey[0] = a.attnum OR i.indkey[1] = a.attnum OR i.indkey[2] = a.attnum OR i.indkey[3] = a.attnum OR i.indkey[4] = a.attnum OR i.indkey[5] = a.attnum OR i.indkey[6] = a.attnum OR i.indkey[7] = a.attnum) AND a.attrelid = bc.oid AND bc.relname = '%s'";
+	
+	var $hasAffectedRows = true;
+	var $hasLimit = false;	// set to true for pgsql 7 only. support pgsql/mysql SELECT * FROM TABLE LIMIT 10
+	// below suggested by Freek Dijkstra 
+	var $true = 't';		// string that represents TRUE for a database
+	var $false = 'f';		// string that represents FALSE for a database
+	var $fmtDate = "'Y-m-d'";	// used by DBDate() as the default date format used by the database
+	var $fmtTimeStamp = "'Y-m-d G:i:s'"; // used by DBTimeStamp as the default timestamp fmt.
+	var $hasMoveFirst = true;
+	var $hasGenID = true;
+	var $_genIDSQL = "SELECT NEXTVAL('%s')";
+	var $_genSeqSQL = "CREATE SEQUENCE %s START %s";
+	var $_dropSeqSQL = "DROP SEQUENCE %s";
+	var $metaDefaultsSQL = "SELECT d.adnum as num, d.adsrc as def from pg_attrdef d, pg_class c where d.adrelid=c.oid and c.relname='%s' order by d.adnum";
+	var $random = 'random()';		/// random function
+	var $concat_operator='||';
+	 
+	function ServerInfo()
+	{
+		$arr['description'] = ADOConnection::GetOne("select version()");
+		$arr['version'] = ADOConnection::_findvers($arr['description']);
+		return $arr;
+	}
+	
+	function &SelectLimit($sql,$nrows=-1,$offset=-1,$inputarr=false,$secs2cache=0) 
+	{
+		 $offsetStr = ($offset >= 0) ? " OFFSET $offset" : '';
+		 $limitStr  = ($nrows >= 0)  ? " LIMIT $nrows" : '';
+		 if ($secs2cache)
+		  	$rs =& $this->CacheExecute($secs2cache,$sql."$limitStr$offsetStr",$inputarr);
+		 else
+		  	$rs =& $this->Execute($sql."$limitStr$offsetStr",$inputarr);
+		
+		return $rs;
+	}
+	
+	function &MetaTables($ttype=false,$showSchema=false,$mask=false) 
+	{
+		$info = $this->ServerInfo();
+		if ($info['version'] >= 7.3) {
+	    	$this->metaTablesSQL = "select tablename,'T' from pg_tables where tablename not like 'pg\_%'
+			  and schemaname  not in ( 'pg_catalog','information_schema')
+	union 
+        select viewname,'V' from pg_views where viewname not like 'pg\_%'  and schemaname  not in ( 'pg_catalog','information_schema') ";
+		}
+		if ($mask) {
+			$save = $this->metaTablesSQL;
+			$mask = $this->qstr(strtolower($mask));
+			if ($info['version']>=7.3)
+				$this->metaTablesSQL = "
+select tablename,'T' from pg_tables where tablename like $mask and schemaname not in ( 'pg_catalog','information_schema')  
+ union 
+select viewname,'V' from pg_views where viewname like $mask and schemaname  not in ( 'pg_catalog','information_schema')  ";
+			else
+				$this->metaTablesSQL = "
+select tablename,'T' from pg_tables where tablename like $mask 
+ union 
+select viewname,'V' from pg_views where viewname like $mask";
+		}
+		$ret =& ADOConnection::MetaTables($ttype,$showSchema);
+		
+		if ($mask) {
+			$this->metaTablesSQL = $save;
+		}
+		return $ret;
+	}
+	
+function &MetaColumns($table,$normalize=true) 
+	{
+	global $ADODB_FETCH_MODE;
+	
+		$schema = false;
+		$this->_findschema($table,$schema);
+		
+		if ($normalize) $table = strtolower($table);
+
+		$save = $ADODB_FETCH_MODE;
+		$ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+		if ($this->fetchMode !== false) $savem = $this->SetFetchMode(false);
+		
+		if ($schema) $rs =& $this->Execute(sprintf($this->metaColumnsSQL1,$table,$table,$schema));
+		else $rs =& $this->Execute(sprintf($this->metaColumnsSQL,$table,$table));
+		if (isset($savem)) $this->SetFetchMode($savem);
+		$ADODB_FETCH_MODE = $save;
+		
+		if ($rs === false) {
+			$false = false;
+			return $false;
+		}
+		if (!empty($this->metaKeySQL)) {
+			// If we want the primary keys, we have to issue a separate query
+			// Of course, a modified version of the metaColumnsSQL query using a 
+			// LEFT JOIN would have been much more elegant, but postgres does 
+			// not support OUTER JOINS. So here is the clumsy way.
+			
+			$ADODB_FETCH_MODE = ADODB_FETCH_ASSOC;
+			
+			$rskey = $this->Execute(sprintf($this->metaKeySQL,($table)));
+			// fetch all result in once for performance.
+			$keys =& $rskey->GetArray();
+			if (isset($savem)) $this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+			
+			$rskey->Close();
+			unset($rskey);
+		}
+
+		$rsdefa = array();
+		if (!empty($this->metaDefaultsSQL)) {
+			$ADODB_FETCH_MODE = ADODB_FETCH_ASSOC;
+			$sql = sprintf($this->metaDefaultsSQL, ($table));
+			$rsdef = $this->Execute($sql);
+			if (isset($savem)) $this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+			
+			if ($rsdef) {
+				while (!$rsdef->EOF) {
+					$num = $rsdef->fields['num'];
+					$s = $rsdef->fields['def'];
+					if (strpos($s,'::')===false && substr($s, 0, 1) == "'") { /* quoted strings hack... for now... fixme */
+						$s = substr($s, 1);
+						$s = substr($s, 0, strlen($s) - 1);
+					}
+
+					$rsdefa[$num] = $s;
+					$rsdef->MoveNext();
+				}
+			} else {
+				ADOConnection::outp( "==> SQL => " . $sql);
+			}
+			unset($rsdef);
+		}
+	
+		$retarr = array();
+		while (!$rs->EOF) { 	
+			$fld = new ADOFieldObject();
+			$fld->name = $rs->fields[0];
+			$fld->type = $rs->fields[1];
+			$fld->max_length = $rs->fields[2];
+			if ($fld->max_length <= 0) $fld->max_length = $rs->fields[3]-4;
+			if ($fld->max_length <= 0) $fld->max_length = -1;
+			if ($fld->type == 'numeric') {
+				$fld->scale = $fld->max_length & 0xFFFF;
+				$fld->max_length >>= 16;
+			}
+			// dannym
+			// 5 hasdefault; 6 num-of-column
+			$fld->has_default = ($rs->fields[5] == 't');
+			if ($fld->has_default) {
+				$fld->default_value = $rsdefa[$rs->fields[6]];
+			}
+
+			//Freek
+			if ($rs->fields[4] == $this->true) {
+				$fld->not_null = true;
+			}
+			
+			// Freek
+			if (is_array($keys)) {
+				foreach($keys as $key) {
+					if ($fld->name == $key['column_name'] AND $key['primary_key'] == $this->true) 
+						$fld->primary_key = true;
+					if ($fld->name == $key['column_name'] AND $key['unique_key'] == $this->true) 
+						$fld->unique = true; // What name is more compatible?
+				}
+			}
+			
+			if ($ADODB_FETCH_MODE == ADODB_FETCH_NUM) $retarr[] = $fld;	
+			else $retarr[($normalize) ? strtoupper($fld->name) : $fld->name] = $fld;
+			
+			$rs->MoveNext();
+		}
+		$rs->Close();
+		return empty($retarr) ? false : $retarr;	
+		
+	}
+
+}
+
+class ADODB_pdo_base extends ADODB_pdo {
+
+	function ServerInfo()
+	{
+		return ADOConnection::ServerInfo();
+	}
+	
+	function &SelectLimit($sql,$nrows=-1,$offset=-1,$inputarr=false,$secs2cache=0)
+	{
+		$ret = ADOConnection::SelectLimit($sql,$nrows,$offset,$inputarr,$secs2cache);
+		return $ret;
+	}
+	
+	function MetaTables()
+	{
+		return false;
+	}
+	
+	function MetaColumns()
+	{
+		return false;
+	}
+}
+
+
 class ADODB_pdo extends ADOConnection {
 	var $databaseType = "pdo";	
 	var $dataProvider = "pdo";
@@ -30,16 +306,36 @@
 	var $_haserrorfunctions = true;
 	var $_lastAffectedRows = 0;
 	
+	var $dsnType = '';
 	var $stmt = false;
 	
-	function ADODB_pdo() 
+	function ADODB_pdo()
 	{
 	}
 	
-
+	function _UpdatePDO()
+	{
+		$d = &$this->_driver;
+		$this->fmtDate = $d->fmtDate;
+		$this->fmtTimeStamp = $d->fmtTimeStamp;
+		$this->replaceQuote = $d->replaceQuote;
+		$this->sysDate = $d->sysDate;
+		$this->sysTimeStamp = $d->sysTimeStamp;
+		$this->random = $d->random;
+		$this->concat_operator = $d->concat_operator;
+	}
+	
+	function Time()
+	{
+		return false;
+	}
+	
 	// returns true or false
 	function _connect($argDSN, $argUsername, $argPassword, $argDatabasename, $persist=false)
 	{
+		$at = strpos($argDSN,':');
+		$this->dsnType = substr($argDSN,0,$at);
+
 		$this->_connectionID = new PDO($argDSN, $argUsername, $argPassword);
 		if ($this->_connectionID) {
 			switch(ADODB_ASSOC_CASE){
@@ -52,10 +348,18 @@
 			//$this->_connectionID->setAttribute(PDO_ATTR_ERRMODE,PDO_ERRMODE_SILENT );
 			$this->_connectionID->setAttribute(PDO_ATTR_CASE,$m);
 			
+			$class = 'ADODB_pdo_'.$this->dsnType;
 			//$this->_connectionID->setAttribute(PDO_ATTR_AUTOCOMMIT,true);
+			if (class_exists($class))
+				$this->_driver = new $class();
+			else
+				$this->_driver = new ADODB_pdo_base();
 			
+			$this->_driver->_connectionID = $this->_connectionID;
+			$this->_UpdatePDO();
 			return true;
 		}
+		$this->_driver = new ADODB_pdo_base();
 		return false;
 	}
 	
@@ -65,13 +369,41 @@
 		return $this->_connect($argDSN, $argUsername, $argPassword, $argDatabasename, true);
 	}
 	
+	/*------------------------------------------------------------------------------*/
+	
+	
+	function &SelectLimit($sql,$nrows=-1,$offset=-1,$inputarr=false,$secs2cache=0) 
+	{	
+		$save = $this->_driver->fetchMode;
+		$this->_driver->fetchMode = $this->fetchMode;
+		$ret = $this->_driver->SelectLimit($sql,$nrows,$offset,$inputarr,$secs2cache);
+		$this->_driver->fetchMode = $save;
+		return $ret;
+	}
+	
+	
+	function ServerInfo()
+	{
+		return $this->_driver->ServerInfo();
+	}
+	
+	function MetaTables($ttype=false,$showSchema=false,$mask=false)
+	{
+		return $this->_driver->MetaTables($ttype,$showSchema,$mask);
+	}
+	
+	function MetaColumns($table,$normalize=true)
+	{
+		return $this->_driver->MetaColumns($table,$normalize);
+	}
+	
 	function ErrorMsg()
 	{
 		if ($this->_stmt) $arr = $this->_stmt->errorInfo();
 		else $arr = $this->_connectionID->errorInfo();
 		
 		if ($arr) {
-			if ($arr[0]) return $arr[2];
+			if ((integer)$arr[0]) return $arr[2];
 			else return '';
 		} else return '-1';
 	}
@@ -85,9 +417,14 @@
 	
 	function ErrorNo()
 	{
-		
-		if ($this->_stmt) return $this->_stmt->errorCode();
-		else return $this->_connectionID->errorInfo();
+		if ($this->_stmt) $err = $this->_stmt->errorCode();
+		else {
+			$arr = $this->_connectionID->errorInfo();
+			if (isset($arr[0])) $err = $arr[0];
+			else $err = -1;
+		}
+		if ($err == '00000') return 0; // allows empty check
+		return $err;
 	}
 
 	function BeginTrans()
@@ -102,6 +439,7 @@
 	
 	function CommitTrans($ok=true) 
 	{ 
+		if (!$this->hasTransactions) return false;
 		if ($this->transOff) return true; 
 		if (!$ok) return $this->RollbackTrans();
 		if ($this->transCnt) $this->transCnt -= 1;
@@ -114,6 +452,7 @@
 	
 	function RollbackTrans()
 	{
+		if (!$this->hasTransactions) return false;
 		if ($this->transOff) return true; 
 		if ($this->transCnt) $this->transCnt -= 1;
 		$this->_autocommit = true;
@@ -145,14 +484,17 @@
 		if (is_array($sql)) {
 			$stmt = $sql[1];
 		} else {
-			$stmt = $this->_connectionID->prepare($sql);		
+			$stmt = $this->_connectionID->prepare($sql);
 		}
 		if ($stmt) {
-			if ($inputarr) $stmt->execute($inputarr);
-			else $stmt->execute();
+			if ($inputarr) $ok = $stmt->execute($inputarr);
+			else $ok = $stmt->execute();
 		}
-		$this->_stmt = $stmt;
-		return $stmt;
+		if ($ok) {
+			$this->_stmt = $stmt;
+			return $stmt;
+		} 
+		return false;
 	}
 
 	// returns true or false
@@ -211,12 +553,17 @@
 		if ($this->_stmt) $arr = $this->_stmt->errorInfo();
 		else $arr = $this->_connectionID->errorInfo();
 		print_r($arr);
-		if ($arr) {
-			if ($arr[0]) return $arr[2];
+		if (is_array($arr)) {
+			if ((integer) $arr[0] && isset($arr[2])) return $arr[2];
 			else return '';
 		} else return '-1';
 	}
 	
+	function NumCols()
+	{
+		return ($this->_stmt) ? $this->_stmt->columnCount() : 0;
+	}
+	
 	function ErrorNo()
 	{
 		if ($this->_stmt) return $this->_stmt->errorCode();
@@ -240,11 +587,13 @@
 			global $ADODB_FETCH_MODE;
 			$mode = $ADODB_FETCH_MODE;
 		}
+		$this->adodbFetchMode = $mode;
 		switch($mode) {
-		default:
-		case ADODB_FETCH_BOTH: $mode = PDO_FETCH_BOTH; break;
 		case ADODB_FETCH_NUM: $mode = PDO_FETCH_NUM; break;
 		case ADODB_FETCH_ASSOC:  $mode = PDO_FETCH_ASSOC; break;
+		
+		case ADODB_FETCH_BOTH: 
+		default: $mode = PDO_FETCH_BOTH; break;
 		}
 		$this->fetchMode = $mode;
 		
@@ -252,21 +601,6 @@
 		$this->ADORecordSet($id);
 	}
 
-
-	// returns the field object
-	function &FetchField($fieldOffset = -1) 
-	{
-		
-		$off=$fieldOffset+1; // offsets begin at 1
-		
-		$o= new ADOFieldObject();
-		$o->name = @odbc_field_name($this->_queryID,$off);
-		$o->type = @odbc_field_type($this->_queryID,$off);
-		$o->max_length = @odbc_field_len($this->_queryID,$off);
-		if (ADODB_ASSOC_CASE == 0) $o->name = strtolower($o->name);
-		else if (ADODB_ASSOC_CASE == 1) $o->name = strtoupper($o->name);
-		return $o;
-	}
 	
 	function Init()
 	{
@@ -282,21 +616,40 @@
 			if ($this->EOF = ($this->_fetch() === false)) {
 				$this->_numOfRows = 0; // _numOfRows could be -1
 			}
-			$this->_numOfFields = sizeof($this->fields);
 		} else {
 			$this->EOF = true;
 		}
 	}
 	
-		
 	function _initrs()
 	{
 	global $ADODB_COUNTRECS;
 	
 		$this->_numOfRows = ($ADODB_COUNTRECS) ? @$this->_queryID->rowCount() : -1;
 		if (!$this->_numOfRows) $this->_numOfRows = -1;
-		$this->_numOfFields =0;
-	}	
+		$this->_numOfFields = $this->_queryID->columnCount();
+	}
+
+	// returns the field object
+	function &FetchField($fieldOffset = -1) 
+	{
+		$off=$fieldOffset+1; // offsets begin at 1
+		
+		$o= new ADOFieldObject();
+		$arr = $this->_queryID->getColumnMeta($fieldOffset);
+		if (!$arr) return false;
+
+		//adodb_pr($arr);
+		$o->name = $arr['name'];
+		if (isset($arr['native_type'])) $o->type = $arr['native_type'];
+		else $o->type = adodb_pdo_type($arr['pdo_type']);
+		$o->max_length = $arr['len'];
+		$o->precision = $arr['precision'];
+		
+		if (ADODB_ASSOC_CASE == 0) $o->name = strtolower($o->name);
+		else if (ADODB_ASSOC_CASE == 1) $o->name = strtoupper($o->name);
+		return $o;
+	}
 	
 	function _seek($row)
 	{
@@ -305,6 +658,8 @@
 	
 	function _fetch()
 	{
+		if (!$this->_queryID) return false;
+		
 		$this->fields = $this->_queryID->fetch($this->fetchMode);
 		return !empty($this->fields);
 	}
@@ -313,6 +668,20 @@
 	{
 		$this->_queryID = false;
 	}
+	
+	function Fields($colname)
+	{
+		if ($this->adodbFetchMode != ADODB_FETCH_NUM) return @$this->fields[$colname];
+		
+		if (!$this->bind) {
+			$this->bind = array();
+			for ($i=0; $i < $this->_numOfFields; $i++) {
+				$o = $this->FetchField($i);
+				$this->bind[strtoupper($o->name)] = $i;
+			}
+		}
+		 return $this->fields[$this->bind[strtoupper($colname)]];
+	}
 
 }
 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-postgres.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-postgres.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-postgres.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-postgres.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
- V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-postgres64.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-postgres64.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-postgres64.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-postgres64.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
- V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -73,12 +73,13 @@
 	var $blobEncodeType = 'C';
 	var $metaColumnsSQL = "SELECT a.attname,t.typname,a.attlen,a.atttypmod,a.attnotnull,a.atthasdef,a.attnum 
 		FROM pg_class c, pg_attribute a,pg_type t 
-		WHERE relkind = 'r' AND (c.relname='%s' or c.relname = lower('%s')) and a.attname not like '....%%'
+		WHERE relkind in ('r','v') AND (c.relname='%s' or c.relname = lower('%s')) and a.attname not like '....%%'
 AND a.attnum > 0 AND a.atttypid = t.oid AND a.attrelid = c.oid ORDER BY a.attnum";
 
+	// used when schema defined
 	var $metaColumnsSQL1 = "SELECT a.attname, t.typname, a.attlen, a.atttypmod, a.attnotnull, a.atthasdef, a.attnum 
 FROM pg_class c, pg_attribute a, pg_type t, pg_namespace n 
-WHERE relkind = 'r' AND (c.relname='%s' or c.relname = lower('%s'))
+WHERE relkind in ('r','v') AND (c.relname='%s' or c.relname = lower('%s'))
  and c.relnamespace=n.oid and n.nspname='%s' 
 	and a.attname not like '....%%' AND a.attnum > 0 
 	AND a.atttypid = t.oid AND a.attrelid = c.oid ORDER BY a.attnum";
@@ -101,10 +102,11 @@
 	var $_dropSeqSQL = "DROP SEQUENCE %s";
 	var $metaDefaultsSQL = "SELECT d.adnum as num, d.adsrc as def from pg_attrdef d, pg_class c where d.adrelid=c.oid and c.relname='%s' order by d.adnum";
 	var $random = 'random()';		/// random function
-	var $autoRollback = true; // apparently pgsql does not autorollback properly before 4.3.4
+	var $autoRollback = true; // apparently pgsql does not autorollback properly before php 4.3.4
 							// http://bugs.php.net/bug.php?id=25404
 							
 	var $_bindInputArray = false; // requires postgresql 7.3+ and ability to modify database
+	var $disableBlobs = false; // set to true to disable blob checking, resulting in 2-5% improvement in performance.
 	
 	// The last (fmtTimeStamp is not entirely correct: 
 	// PostgreSQL also has support for time zones, 
@@ -128,12 +130,12 @@
 		$this->version = $arr;
 		return $arr;
 	}
-/*
+
 	function IfNull( $field, $ifNull ) 
 	{
-		return " NULLIF($field, $ifNull) "; // if PGSQL
+		return " coalesce($field, $ifNull) "; 
 	}
-*/
+
 	// get the last id - never tested
 	function pg_insert_id($tablename,$fieldname)
 	{
@@ -150,10 +152,12 @@
 Using a OID as a unique identifier is not generally wise. 
 Unless you are very careful, you might end up with a tuple having 
 a different OID if a database must be reloaded. */
-	function _insertid()
+	function _insertid($table,$column)
 	{
 		if (!is_resource($this->_resultid) || get_resource_type($this->_resultid) !== 'pgsql result') return false;
-	   	return pg_getlastoid($this->_resultid);
+		$oid = pg_getlastoid($this->_resultid);
+		// to really return the id, we need the table and column-name, else we can only return the oid != id
+		return empty($table) || empty($column) ? $oid : $this->GetOne("SELECT $column FROM $table WHERE oid=".(int)$oid);
 	}
 
 // I get this error with PHP before 4.0.6 - jlim
@@ -198,12 +202,26 @@
 	}
 	
 	function &MetaTables($ttype=false,$showSchema=false,$mask=false) 
-	{	
+	{
+		$info = $this->ServerInfo();
+		if ($info['version'] >= 7.3) {
+	    	$this->metaTablesSQL = "select tablename,'T' from pg_tables where tablename not like 'pg\_%'
+			  and schemaname  not in ( 'pg_catalog','information_schema')
+	union 
+        select viewname,'V' from pg_views where viewname not like 'pg\_%'  and schemaname  not in ( 'pg_catalog','information_schema') ";
+		}
 		if ($mask) {
 			$save = $this->metaTablesSQL;
 			$mask = $this->qstr(strtolower($mask));
-			$this->metaTablesSQL = "
-select tablename,'T' from pg_tables where tablename like $mask union 
+			if ($info['version']>=7.3)
+				$this->metaTablesSQL = "
+select tablename,'T' from pg_tables where tablename like $mask and schemaname not in ( 'pg_catalog','information_schema')  
+ union 
+select viewname,'V' from pg_views where viewname like $mask and schemaname  not in ( 'pg_catalog','information_schema')  ";
+			else
+				$this->metaTablesSQL = "
+select tablename,'T' from pg_tables where tablename like $mask 
+ union 
 select viewname,'V' from pg_views where viewname like $mask";
 		}
 		$ret =& ADOConnection::MetaTables($ttype,$showSchema);
@@ -287,6 +305,14 @@
 				$s .= 'AM';
 				break;
 				
+			case 'w':
+				$s .= 'D';
+				break;
+			
+			case 'l':
+				$s .= 'DAY';
+				break;
+				
 			default:
 			// handle escape characters...
 				if ($ch == '\\') {
@@ -331,6 +357,15 @@
 		return $rez; 
 	} 
 	
+	/*
+		Hueristic - not guaranteed to work.
+	*/
+	function GuessOID($oid)
+	{
+		if (strlen($oid)>16) return false;
+		return is_numeric($oid);
+	}
+	
 	/* 
 	* If an OID is detected, then we use pg_lo_* to open the oid file and read the
 	* real blob from the db using the oid supplied as a parameter. If you are storing
@@ -339,20 +374,24 @@
 	* contributed by Mattia Rossi mattia@technologist.com
 	*
 	* see http://www.postgresql.org/idocs/index.php?largeobjects.html
+	*
+	* Since adodb 4.54, this returns the blob, instead of sending it to stdout. Also
+	* added maxsize parameter, which defaults to $db->maxblobsize if not defined.
 	*/ 
-	function BlobDecode( $blob) 
-	{ 
-		if (strlen($blob) > 24) return $blob;
+	function BlobDecode($blob,$maxsize=false,$hastrans=true) 
+	{
+		if (!$this->GuessOID($blob)) return $blob;
 		
-		@pg_exec($this->_connectionID,"begin"); 
+		if ($hastrans) @pg_exec($this->_connectionID,"begin"); 
 		$fd = @pg_lo_open($this->_connectionID,$blob,"r");
 		if ($fd === false) {
-			@pg_exec($this->_connectionID,"commit");
+			if ($hastrans) @pg_exec($this->_connectionID,"commit");
 			return $blob;
 		}
-		$realblob = @pg_loreadall($fd); 
+		if (!$maxsize) $maxsize = $this->maxblobsize;
+		$realblob = @pg_loread($fd,$maxsize); 
 		@pg_loclose($fd); 
-		@pg_exec($this->_connectionID,"commit"); 
+		if ($hastrans) @pg_exec($this->_connectionID,"commit"); 
 		return $realblob;
 	} 
 	
@@ -375,8 +414,13 @@
 		// note that there is a pg_escape_bytea function only for php 4.2.0 or later
 	}
 	
+	// assumes bytea for blob, and varchar for clob
 	function UpdateBlob($table,$column,$val,$where,$blobtype='BLOB')
 	{
+	
+		if ($blobtype == 'CLOB') {
+    		return $this->Execute("UPDATE $table SET $column=" . $this->qstr($val) . " WHERE $where");
+		}
 		// do not use bind params which uses qstr(), as blobencode() already quotes data
 		return $this->Execute("UPDATE $table SET $column='".$this->BlobEncode($val)."'::bytea WHERE $where");
 	}
@@ -408,8 +452,10 @@
 		if (isset($savem)) $this->SetFetchMode($savem);
 		$ADODB_FETCH_MODE = $save;
 		
-		if ($rs === false) return false;
-		
+		if ($rs === false) {
+			$false = false;
+			return $false;
+		}
 		if (!empty($this->metaKeySQL)) {
 			// If we want the primary keys, we have to issue a separate query
 			// Of course, a modified version of the metaColumnsSQL query using a 
@@ -462,7 +508,10 @@
 			$fld->max_length = $rs->fields[2];
 			if ($fld->max_length <= 0) $fld->max_length = $rs->fields[3]-4;
 			if ($fld->max_length <= 0) $fld->max_length = -1;
-			
+			if ($fld->type == 'numeric') {
+				$fld->scale = $fld->max_length & 0xFFFF;
+				$fld->max_length >>= 16;
+			}
 			// dannym
 			// 5 hasdefault; 6 num-of-column
 			$fld->has_default = ($rs->fields[5] == 't');
@@ -491,7 +540,7 @@
 			$rs->MoveNext();
 		}
 		$rs->Close();
-		return $retarr;	
+		return empty($retarr) ? false : $retarr;	
 		
 	}
 
@@ -536,7 +585,8 @@
                 $ADODB_FETCH_MODE = $save;
 
                 if (!is_object($rs)) {
-                	return FALSE;
+                	$false = false;
+					return $false;
                 }
 				
                 $col_names = $this->MetaColumnNames($table,true);
@@ -779,10 +829,12 @@
 		{
 		case ADODB_FETCH_NUM: $this->fetchMode = PGSQL_NUM; break;
 		case ADODB_FETCH_ASSOC:$this->fetchMode = PGSQL_ASSOC; break;
-		default:
+		
 		case ADODB_FETCH_DEFAULT:
-		case ADODB_FETCH_BOTH:$this->fetchMode = PGSQL_BOTH; break;
+		case ADODB_FETCH_BOTH:
+		default: $this->fetchMode = PGSQL_BOTH; break;
 		}
+		$this->adodbFetchMode = $mode;
 		$this->ADORecordSet($queryID);
 	}
 	
@@ -801,6 +853,8 @@
 		$this->_numOfFields = @pg_numfields($qid);
 		
 		// cache types for blob decode check
+		// apparently pg_fieldtype actually performs an sql query on the database to get the type.
+		if (empty($this->connection->noBlobs))
 		for ($i=0, $max = $this->_numOfFields; $i < $max; $i++) {  
 			if (pg_fieldtype($qid,$i) == 'bytea') {
 				$this->_blobArr[$i] = pg_fieldname($qid,$i);
@@ -885,7 +939,7 @@
 
 		$this->fields = @pg_fetch_array($this->_queryID,$this->_currentRow,$this->fetchMode);
 		
-	if ($this->fields && isset($this->_blobArr)) $this->_fixblobs();
+		if ($this->fields && isset($this->_blobArr)) $this->_fixblobs();
 			
 		return (is_array($this->fields));
 	}
@@ -911,6 +965,7 @@
 				case 'NAME':
 		   		case 'BPCHAR':
 				case '_VARCHAR':
+				case 'INET':
 					if ($len <= $this->blobSize) return 'C';
 				
 				case 'TEXT':
@@ -955,4 +1010,4 @@
 	}
 
 }
-?>
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-postgres7.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-postgres7.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-postgres7.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-postgres7.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
- V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim#natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -90,41 +90,6 @@
 }
 
 
-
-    function xMetaForeignKeys($table, $owner=false, $upper=false)
-	{
-
-        $sql = '
-SELECT t.tgargs as args
-   FROM pg_trigger t,
-        pg_class c,
-        pg_class c2,
-        pg_proc f
-   WHERE t.tgenabled
-   AND t.tgrelid=c.oid
-   AND t.tgconstrrelid=c2.oid
-   AND t.tgfoid=f.oid
-   AND f.proname ~ \'^RI_FKey_check_ins\'
-   AND t.tgargs like \'$1\\\000'.strtolower($table).'%\'
-   ORDER BY t.tgrelid';
-
-        $rs = $this->Execute($sql);
-		if ($rs && !$rs->EOF) {
-			$arr =& $rs->GetArray();
-			$a = array();
-			foreach($arr as $v) {
-                $data = explode(chr(0), $v['args']);
-                if ($upper) {
-                    $a[] = array(strtoupper($data[2]) => strtoupper($data[4].'='.$data[5]));
-                } else {
-                    $a[] = array($data[2] => $data[4].'='.$data[5]);
-                }
-                
-			}
-			return $a;
-		}
-		else return false;
-    }
 	
  	 // this is a set of functions for managing client encoding - very important if the encodings
 	// of your database and your output target (i.e. HTML) don't match
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-postgres8.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-postgres8.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-postgres8.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-postgres8.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -0,0 +1,12 @@
+<?php
+/*
+ V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
+  Released under both BSD license and Lesser GPL library license. 
+  Whenever there is any discrepancy between the two licenses, 
+  the BSD license will take precedence.
+  Set tabs to 4.
+  
+  NOTE: The "postgres8" driver is remapped to "postgres7". 
+*/
+
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-proxy.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-proxy.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-proxy.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-proxy.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sapdb.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-sapdb.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sapdb.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-sapdb.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -26,8 +26,10 @@
 	var $concat_operator = '||';
 	var $sysDate = 'DATE';
 	var $sysTimeStamp = 'TIMESTAMP';
-	var $fmtDate = "\\D\\A\\T\\E('Y-m-d')";	/// used by DBDate() as the default date format used by the database
-	var $fmtTimeStamp = "\\T\\I\\M\\E\\S\\T\\A\\M\\P('Y-m-d','H:i:s')"; /// used by DBTimeStamp as the default timestamp fmt.
+	var $fmtDate = "'Y-m-d'";	/// used by DBDate() as the default date format used by the database
+	var $fmtTimeStamp = "'Y-m-d H:i:s'"; /// used by DBTimeStamp as the default timestamp fmt.
+	var $hasInsertId = true;
+	var $_bindInputArray = true;
 	
 	function ADODB_SAPDB()
 	{
@@ -35,6 +37,122 @@
 		$this->ADODB_odbc();
 	}
 	
+	function ServerInfo()
+	{
+		$info = ADODB_odbc::ServerInfo();
+		if (!$info['version'] && preg_match('/([0-9.]+)/',$info['description'],$matches)) {
+			$info['version'] = $matches[1];
+		}
+		return $info;
+	}
+
+	function MetaPrimaryKeys($table)
+	{
+		$table = $this->Quote(strtoupper($table));
+
+		return $this->GetCol("SELECT columnname FROM COLUMNS WHERE tablename=$table AND mode='KEY' ORDER BY pos");
+	}
+		
+ 	function &MetaIndexes ($table, $primary = FALSE)
+	{
+		$table = $this->Quote(strtoupper($table));
+
+		$sql = "SELECT INDEXNAME,TYPE,COLUMNNAME FROM INDEXCOLUMNS ".
+			" WHERE TABLENAME=$table".
+			" ORDER BY INDEXNAME,COLUMNNO";
+
+		global $ADODB_FETCH_MODE;
+		$save = $ADODB_FETCH_MODE;
+        $ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+        if ($this->fetchMode !== FALSE) {
+        	$savem = $this->SetFetchMode(FALSE);
+        }
+        
+        $rs = $this->Execute($sql);
+        if (isset($savem)) {
+        	$this->SetFetchMode($savem);
+        }
+        $ADODB_FETCH_MODE = $save;
+
+        if (!is_object($rs)) {
+        	return FALSE;
+        }
+
+		$indexes = array();
+		while ($row = $rs->FetchRow()) {
+            $indexes[$row[0]]['unique'] = $row[1] == 'UNIQUE';
+            $indexes[$row[0]]['columns'][] = $row[2];
+    	}
+		if ($primary) {
+			$indexes['SYSPRIMARYKEYINDEX'] = array(
+					'unique' => True,	// by definition
+					'columns' => $this->GetCol("SELECT columnname FROM COLUMNS WHERE tablename=$table AND mode='KEY' ORDER BY pos"),
+				);
+		}
+        return $indexes;
+	}
+	
+ 	function &MetaColumns ($table)
+	{
+		global $ADODB_FETCH_MODE;
+		$save = $ADODB_FETCH_MODE;
+        $ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+        if ($this->fetchMode !== FALSE) {
+        	$savem = $this->SetFetchMode(FALSE);
+        }
+		$table = $this->Quote(strtoupper($table));
+		
+		$retarr = array();
+		foreach($this->GetAll("SELECT COLUMNNAME,DATATYPE,LEN,DEC,NULLABLE,MODE,\"DEFAULT\",CASE WHEN \"DEFAULT\" IS NULL THEN 0 ELSE 1 END AS HAS_DEFAULT FROM COLUMNS WHERE tablename=$table ORDER BY pos") as $column)
+		{
+			$fld = new ADOFieldObject();
+			$fld->name = $column[0];
+			$fld->type = $column[1];
+			$fld->max_length = $fld->type == 'LONG' ? 2147483647 : $column[2];
+			$fld->scale = $column[3];
+			$fld->not_null = $column[4] == 'NO';
+			$fld->primary_key = $column[5] == 'KEY';
+			if ($fld->has_default = $column[7]) {
+				if ($fld->primary_key && $column[6] == 'DEFAULT SERIAL (1)') {
+					$fld->auto_increment = true;
+					$fld->has_default = false;
+				} else {
+					$fld->default_value = $column[6];
+					switch($fld->type) {
+						case 'VARCHAR':
+						case 'CHARACTER':
+						case 'LONG':
+							$fld->default_value = $column[6];
+							break;
+						default:
+							$fld->default_value = trim($column[6]);
+							break;
+					}
+				}
+			}
+			$retarr[$fld->name] = $fld;	
+		}
+        if (isset($savem)) {
+        	$this->SetFetchMode($savem);
+        }
+        $ADODB_FETCH_MODE = $save;
+
+		return $retarr;
+	}
+	
+	function MetaColumnNames($table)
+	{
+		$table = $this->Quote(strtoupper($table));
+
+		return $this->GetCol("SELECT columnname FROM COLUMNS WHERE tablename=$table ORDER BY pos");
+	}
+	
+	// unlike it seems, this depends on the db-session and works in a multiuser environment
+	function _insertid($table,$column)
+	{
+		return empty($table) ? False : $this->GetOne("SELECT $table.CURRVAL FROM DUAL");
+	}
+
 	/*
 		SelectLimit implementation problems:
 	
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sqlanywhere.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-sqlanywhere.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sqlanywhere.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-sqlanywhere.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-version V4.50 6 July 2004 (c) 2000-2004  John Lim (jlim@natsoft.com.my). All rights
+version V4.62 2 Apr 2005 (c) 2000-2005  John Lim (jlim@natsoft.com.my).  All rights
 reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sqlite.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-sqlite.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sqlite.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-sqlite.inc.php	2005-05-04 14:39:18.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
@@ -109,7 +109,10 @@
 	global $ADODB_FETCH_MODE;
 	
 		$rs = $this->Execute("select * from $tab limit 1");
-		if (!$rs) return false;
+		if (!$rs) {
+			$false = false;
+			return $false;
+		}
 		$arr = array();
 		for ($i=0,$max=$rs->_numOfFields; $i < $max; $i++) {
 			$fld =& $rs->FetchField($i);
@@ -187,7 +190,7 @@
 		$MAXLOOPS = 100;
 		//$this->debug=1;
 		while (--$MAXLOOPS>=0) {
-			$num = $this->GetOne("select id from $seq");
+			@($num = $this->GetOne("select id from $seq"));
 			if ($num === false) {
 				$this->Execute(sprintf($this->_genSeqSQL ,$seq));	
 				$start -= 1;
@@ -231,6 +234,51 @@
 		return @sqlite_close($this->_connectionID);
 	}
 
+	function &MetaIndexes ($table, $primary = FALSE, $owner=false)
+	{
+		$false = false;
+		// save old fetch mode
+        global $ADODB_FETCH_MODE;
+        $save = $ADODB_FETCH_MODE;
+        $ADODB_FETCH_MODE = ADODB_FETCH_NUM;
+        if ($this->fetchMode !== FALSE) {
+               $savem = $this->SetFetchMode(FALSE);
+        }
+		$SQL=sprintf("SELECT name,sql FROM sqlite_master WHERE type='index' AND tbl_name='%s'", strtolower($table));
+        $rs = $this->Execute($SQL);
+        if (!is_object($rs)) {
+			if (isset($savem)) 
+				$this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+            return $false;
+        }
+
+		$indexes = array ();
+		while ($row = $rs->FetchRow()) {
+			if ($primary && preg_match("/primary/i",$row[1]) == 0) continue;
+            if (!isset($indexes[$row[0]])) {
+
+			$indexes[$row[0]] = array(
+				   'unique' => preg_match("/unique/i",$row[1]),
+				   'columns' => array());
+			}
+			/**
+			  * There must be a more elegant way of doing this,
+			  * the index elements appear in the SQL statement
+			  * in cols[1] between parentheses
+			  * e.g CREATE UNIQUE INDEX ware_0 ON warehouse (org,warehouse)
+			  */
+			$cols = explode("(",$row[1]);
+			$cols = explode(")",$cols[1]);
+			array_pop($cols);
+			$indexes[$row[0]]['columns'] = $cols;
+		}
+		if (isset($savem)) { 
+            $this->SetFetchMode($savem);
+			$ADODB_FETCH_MODE = $save;
+		}
+        return $indexes;
+	}
 
 }
 
@@ -255,6 +303,7 @@
 		case ADODB_FETCH_ASSOC: $this->fetchMode = SQLITE_ASSOC; break;
 		default: $this->fetchMode = SQLITE_BOTH; break;
 		}
+		$this->adodbFetchMode = $mode;
 		
 		$this->_queryID = $queryID;
 	
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sqlite.inc.php.bak zentrack_2-5-5-1/includes/adodb/drivers/adodb-sqlite.inc.php.bak
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sqlite.inc.php.bak	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-sqlite.inc.php.bak	2005-05-04 14:39:18.000000000 -0700
@@ -0,0 +1,326 @@
+<?php
+/*
+V4.53 14 Sept 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  Released under both BSD license and Lesser GPL library license. 
+  Whenever there is any discrepancy between the two licenses, 
+  the BSD license will take precedence.
+
+  Latest version is available at http://adodb.sourceforge.net
+  
+  SQLite info: http://www.hwaci.com/sw/sqlite/
+    
+  Install Instructions:
+  ====================
+  1. Place this in adodb/drivers
+  2. Rename the file, remove the .txt prefix.
+*/
+
+// security - hide paths
+if (!defined('ADODB_DIR')) die();
+
+class ADODB_sqlite extends ADOConnection {
+	var $databaseType = "sqlite";
+	var $replaceQuote = "''"; // string to use to replace quotes
+	var $concat_operator='||';
+	var $_errorNo = 0;
+	var $hasLimit = true;	
+	var $hasInsertID = true; 		/// supports autoincrement ID?
+	var $hasAffectedRows = true; 	/// supports affected rows for update/delete?
+	var $metaTablesSQL = "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name";
+	var $sysDate = "adodb_date('Y-m-d')";
+	var $sysTimeStamp = "adodb_date('Y-m-d H:i:s')";
+	var $fmtTimeStamp = "'Y-m-d H:i:s'";
+	
+	function ADODB_sqlite() 
+	{
+	}
+	
+/*
+  function __get($name) 
+  {
+  	switch($name) {
+	case 'sysDate': return "'".date($this->fmtDate)."'";
+	case 'sysTimeStamp' : return "'".date($this->sysTimeStamp)."'";
+	}
+  }*/
+	
+	function ServerInfo()
+	{
+		$arr['version'] = sqlite_libversion();
+		$arr['description'] = 'SQLite ';
+		$arr['encoding'] = sqlite_libencoding();
+		return $arr;
+	}
+	
+	function BeginTrans()
+	{	  
+		 if ($this->transOff) return true; 
+		 $ret = $this->Execute("BEGIN TRANSACTION");
+		 $this->transCnt += 1;
+		 return true;
+	}
+	
+	function CommitTrans($ok=true) 
+	{ 
+		if ($this->transOff) return true; 
+		if (!$ok) return $this->RollbackTrans();
+		$ret = $this->Execute("COMMIT");
+		if ($this->transCnt>0)$this->transCnt -= 1;
+		return !empty($ret);
+	}
+	
+	function RollbackTrans()
+	{
+		if ($this->transOff) return true; 
+		$ret = $this->Execute("ROLLBACK");
+		if ($this->transCnt>0)$this->transCnt -= 1;
+		return !empty($ret);
+	}
+
+	function _insertid()
+	{
+		return sqlite_last_insert_rowid($this->_connectionID);
+	}
+	
+	function _affectedrows()
+	{
+        return sqlite_changes($this->_connectionID);
+    }
+	
+	function ErrorMsg() 
+ 	{
+		if ($this->_logsql) return $this->_errorMsg;
+		return ($this->_errorNo) ? sqlite_error_string($this->_errorNo) : '';
+	}
+ 
+	function ErrorNo() 
+	{
+		return $this->_errorNo;
+	}
+	
+	function SQLDate($fmt, $col=false)
+	{
+		$fmt = $this->qstr($fmt);
+		return ($col) ? "adodb_date2($fmt,$col)" : "adodb_date($fmt)";
+	}
+	
+	function &MetaColumns($tab)
+	{
+	global $ADODB_FETCH_MODE;
+	
+		$rs = $this->Execute("select * from $tab limit 1");
+		if (!$rs) return false;
+		$arr = array();
+		for ($i=0,$max=$rs->_numOfFields; $i < $max; $i++) {
+			$fld =& $rs->FetchField($i);
+			if ($ADODB_FETCH_MODE == ADODB_FETCH_NUM) $retarr[] =& $fld;	
+			else $arr[strtoupper($fld->name)] =& $fld;
+		}
+		$rs->Close();
+		return $arr;
+	}
+	
+	function _createFunctions()
+	{
+		@sqlite_create_function($this->_connectionID, 'adodb_date', 'adodb_date', 1);
+		@sqlite_create_function($this->_connectionID, 'adodb_date2', 'adodb_date2', 2);
+	}
+	
+
+	// returns true or false
+	function _connect($argHostname, $argUsername, $argPassword, $argDatabasename)
+	{
+		if (!function_exists('sqlite_open')) return null;
+		
+		$this->_connectionID = sqlite_open($argHostname);
+		if ($this->_connectionID === false) return false;
+		$this->_createFunctions();
+		return true;
+	}
+	
+	// returns true or false
+	function _pconnect($argHostname, $argUsername, $argPassword, $argDatabasename)
+	{
+		if (!function_exists('sqlite_open')) return null;
+		
+		$this->_connectionID = sqlite_popen($argHostname);
+		if ($this->_connectionID === false) return false;
+		$this->_createFunctions();
+		return true;
+	}
+
+	// returns query ID if successful, otherwise false
+	function _query($sql,$inputarr=false)
+	{
+		$rez = sqlite_query($sql,$this->_connectionID);
+		if (!$rez) {
+			$this->_errorNo = sqlite_last_error($this->_connectionID);
+		}
+		
+		return $rez;
+	}
+	
+	function &SelectLimit($sql,$nrows=-1,$offset=-1,$inputarr=false,$secs2cache=0) 
+	{
+		$offsetStr = ($offset >= 0) ? " OFFSET $offset" : '';
+		$limitStr  = ($nrows >= 0)  ? " LIMIT $nrows" : ($offset >= 0 ? ' LIMIT 999999999' : '');
+	  	if ($secs2cache)
+	   		$rs =& $this->CacheExecute($secs2cache,$sql."$limitStr$offsetStr",$inputarr);
+	  	else
+	   		$rs =& $this->Execute($sql."$limitStr$offsetStr",$inputarr);
+			
+		return $rs;
+	}
+	
+	/*
+		This algorithm is not very efficient, but works even if table locking
+		is not available.
+		
+		Will return false if unable to generate an ID after $MAXLOOPS attempts.
+	*/
+	var $_genSeqSQL = "create table %s (id integer)";
+	
+	function GenID($seq='adodbseq',$start=1)
+	{	
+		// if you have to modify the parameter below, your database is overloaded,
+		// or you need to implement generation of id's yourself!
+		$MAXLOOPS = 100;
+		//$this->debug=1;
+		while (--$MAXLOOPS>=0) {
+<<<<<<< adodb-sqlite.inc.php
+			$num = @$this->GetOne("select id from $seq");
+=======
+			@($num = $this->GetOne("select id from $seq"));
+>>>>>>> 1.42
+			if ($num === false) {
+				$this->Execute(sprintf($this->_genSeqSQL ,$seq));	
+				$start -= 1;
+				$num = '0';
+				$ok = $this->Execute("insert into $seq values($start)");
+				if (!$ok) return false;
+			} 
+			$this->Execute("update $seq set id=id+1 where id=$num");
+			
+			if ($this->affected_rows() > 0) {
+				$num += 1;
+				$this->genID = $num;
+				return $num;
+			}
+		}
+		if ($fn = $this->raiseErrorFn) {
+			$fn($this->databaseType,'GENID',-32000,"Unable to generate unique id after $MAXLOOPS attempts",$seq,$num);
+		}
+		return false;
+	}
+
+	function CreateSequence($seqname='adodbseq',$start=1)
+	{
+		if (empty($this->_genSeqSQL)) return false;
+		$ok = $this->Execute(sprintf($this->_genSeqSQL,$seqname));
+		if (!$ok) return false;
+		$start -= 1;
+		return $this->Execute("insert into $seqname values($start)");
+	}
+	
+	var $_dropSeqSQL = 'drop table %s';
+	function DropSequence($seqname)
+	{
+		if (empty($this->_dropSeqSQL)) return false;
+		return $this->Execute(sprintf($this->_dropSeqSQL,$seqname));
+	}
+	
+	// returns true or false
+	function _close()
+	{
+		return @sqlite_close($this->_connectionID);
+	}
+
+
+}
+
+/*--------------------------------------------------------------------------------------
+		 Class Name: Recordset
+--------------------------------------------------------------------------------------*/
+
+class ADORecordset_sqlite extends ADORecordSet {
+
+	var $databaseType = "sqlite";
+	var $bind = false;
+
+	function ADORecordset_sqlite($queryID,$mode=false)
+	{
+		
+		if ($mode === false) { 
+			global $ADODB_FETCH_MODE;
+			$mode = $ADODB_FETCH_MODE;
+		}
+		switch($mode) {
+		case ADODB_FETCH_NUM: $this->fetchMode = SQLITE_NUM; break;
+		case ADODB_FETCH_ASSOC: $this->fetchMode = SQLITE_ASSOC; break;
+		default: $this->fetchMode = SQLITE_BOTH; break;
+		}
+		
+		$this->_queryID = $queryID;
+	
+		$this->_inited = true;
+		$this->fields = array();
+		if ($queryID) {
+			$this->_currentRow = 0;
+			$this->EOF = !$this->_fetch();
+			@$this->_initrs();
+		} else {
+			$this->_numOfRows = 0;
+			$this->_numOfFields = 0;
+			$this->EOF = true;
+		}
+		
+		return $this->_queryID;
+	}
+
+
+	function &FetchField($fieldOffset = -1)
+	{
+		$fld = new ADOFieldObject;
+		$fld->name = sqlite_field_name($this->_queryID, $fieldOffset);
+		$fld->type = 'VARCHAR';
+		$fld->max_length = -1;
+		return $fld;
+	}
+	
+   function _initrs()
+   {
+		$this->_numOfRows = @sqlite_num_rows($this->_queryID);
+		$this->_numOfFields = @sqlite_num_fields($this->_queryID);
+   }
+
+	function Fields($colname)
+	{
+		if ($this->fetchMode != SQLITE_NUM) return $this->fields[$colname];
+		if (!$this->bind) {
+			$this->bind = array();
+			for ($i=0; $i < $this->_numOfFields; $i++) {
+				$o = $this->FetchField($i);
+				$this->bind[strtoupper($o->name)] = $i;
+			}
+		}
+		
+		 return $this->fields[$this->bind[strtoupper($colname)]];
+	}
+	
+   function _seek($row)
+   {
+   		return sqlite_seek($this->_queryID, $row);
+   }
+
+	function _fetch($ignore_fields=false) 
+	{
+		$this->fields = @sqlite_fetch_array($this->_queryID,$this->fetchMode);
+		return !empty($this->fields);
+	}
+	
+	function _close() 
+	{
+	}
+
+}
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sqlitepo.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-sqlitepo.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sqlitepo.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-sqlitepo.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /*
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sybase.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-sybase.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sybase.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-sybase.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim. All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim. All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -20,7 +20,7 @@
 
 class ADODB_sybase extends ADOConnection {
 	var $databaseType = "sybase";	
-	//var $dataProvider = 'sybase';
+	var $dataProvider = 'sybase';
 	var $replaceQuote = "''"; // string to use to replace quotes
 	var $fmtDate = "'Y-m-d'";
 	var $fmtTimeStamp = "'Y-m-d H:i:s'";
@@ -94,7 +94,8 @@
 		
 	}	
 		
-	function SelectDB($dbName) {
+	function SelectDB($dbName) 
+	{
 		$this->databaseName = $dbName;
 		if ($this->_connectionID) {
 			return @sybase_select_db($dbName);		
@@ -105,10 +106,14 @@
 	/*	Returns: the last error message from previous database operation
 		Note: This function is NOT available for Microsoft SQL Server.	*/	
 
-	function ErrorMsg() 
+	
+	function ErrorMsg()
 	{
 		if ($this->_logsql) return $this->_errorMsg;
-		$this->_errorMsg = sybase_get_last_message();
+		if (function_exists('sybase_get_last_message'))
+			$this->_errorMsg = sybase_get_last_message();
+		else
+			$this->_errorMsg = isset($php_errormsg) ? $php_errormsg : 'SYBASE error messages not supported on this platform';
 		return $this->_errorMsg;
 	}
 
@@ -151,12 +156,12 @@
 			$rs =& ADOConnection::SelectLimit($sql,$nrows,$offset,$inputarr,$secs2cache);
 			return $rs;
 		}
-		$cnt = ($nrows > 0) ? $nrows : 0;
+		$cnt = ($nrows >= 0) ? $nrows : 999999999;
 		if ($offset > 0 && $cnt) $cnt += $offset;
 		
 		$this->Execute("set rowcount $cnt"); 
 		$rs =& ADOConnection::SelectLimit($sql,$nrows,$offset,$inputarr,0);
-		$this->Execute("set rowcount 0"); 
+		$this->Execute("set rowcount 0");
 		
 		return $rs;
 	}
@@ -283,7 +288,7 @@
 		}
 		if (!$mode) $this->fetchMode = ADODB_FETCH_ASSOC;
 		else $this->fetchMode = $mode;
-		return $this->ADORecordSet($id,$mode);
+		$this->ADORecordSet($id,$mode);
 	}
 	
 	/*	Returns: an object containing field information. 
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sybase_ase.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-sybase_ase.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-sybase_ase.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-sybase_ase.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -0,0 +1,114 @@
+<?php
+/*
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
+  Released under both BSD license and Lesser GPL library license. 
+  Whenever there is any discrepancy between the two licenses, 
+  the BSD license will take precedence.
+  
+  Set tabs to 4.
+  
+  Contributed by Interakt Online. Thx Cristian MARIN cristic#interaktonline.com
+*/
+class ADODB_sybase_ase extends ADODB_sybase {
+ 	var $databaseType = "sybase_ase";
+	
+	 var $metaTablesSQL="SELECT sysobjects.name FROM sysobjects, sysusers WHERE sysobjects.type='U' AND sysobjects.uid = sysusers.uid";
+	 var $metaColumnsSQL = "SELECT syscolumns.name AS field_name, systypes.name AS type, systypes.length AS width FROM sysobjects, syscolumns, systypes WHERE sysobjects.name='%s' AND syscolumns.id = sysobjects.id AND systypes.type=syscolumns.type";
+	 var $metaDatabasesSQL ="SELECT a.name FROM master.dbo.sysdatabases a, master.dbo.syslogins b WHERE a.suid = b.suid and a.name like '%' and a.name != 'tempdb' and a.status3 != 256  order by 1";
+
+	function ADODB_sybase_ase()
+	{
+	}
+	
+	// split the Views, Tables and procedures.
+	function &MetaTables($ttype=false,$showSchema=false,$mask=false)
+	{
+		if ($this->metaTablesSQL) {
+			// complicated state saving by the need for backward compat
+			
+			if ($ttype == 'VIEWS'){
+						$sql = str_replace('U', 'V', $this->metaTablesSQL);
+			}elseif (false === $ttype){
+						$sql = str_replace('U',"U' OR type='V", $this->metaTablesSQL);
+			}else{ // TABLES OR ANY OTHER 
+						$sql = $this->metaTablesSQL;
+			}
+			$rs = $this->Execute($sql);
+			
+			if ($rs === false || !method_exists($rs, 'GetArray')){
+					return false;
+			}
+			$arr =& $rs->GetArray();
+
+			$arr2 = array();
+			foreach($arr as $key=>$value){
+					$arr2[] = trim($value['name']);
+			}
+			return $arr2;
+		}
+		return false;
+	}
+
+	function MetaDatabases()
+	{
+			$arr = array();
+			if ($this->metaDatabasesSQL!='') {
+				$rs = $this->Execute($this->metaDatabasesSQL);
+				if ($rs && !$rs->EOF){
+					while (!$rs->EOF){
+						$arr[] = $rs->Fields('name');
+						$rs->MoveNext();
+					}
+					return $arr;
+				}
+			}
+			return false;
+	}
+
+	// fix a bug which prevent the metaColumns query to be executed for Sybase ASE
+	function &MetaColumns($table,$upper=false) 
+	{
+		$false = false;
+		if (!empty($this->metaColumnsSQL)) {
+		
+			$rs = $this->Execute(sprintf($this->metaColumnsSQL,$table));
+			if ($rs === false) return $false;
+
+			$retarr = array();
+			while (!$rs->EOF) {
+				$fld =& new ADOFieldObject();
+				$fld->name = $rs->Fields('field_name');
+				$fld->type = $rs->Fields('type');
+				$fld->max_length = $rs->Fields('width');
+				$retarr[strtoupper($fld->name)] = $fld;
+				$rs->MoveNext();
+			}
+			$rs->Close();
+			return $retarr;	
+		}
+		return $false;
+	}
+	
+	function getProcedureList($schema)
+	{
+			return false;
+	}
+
+	function ErrorMsg()
+	{
+		if (!function_exists('sybase_connect')){
+				return 'Your PHP doesn\'t contain the Sybase connection module!';
+		}
+		return parent::ErrorMsg();	
+	}
+}
+
+class adorecordset_sybase_ase extends ADORecordset_sybase {
+var $databaseType = "sybase_ase";
+function ADORecordset_sybase_ase($id,$mode=false)
+	{
+		$this->ADORecordSet_sybase($id,$mode);
+	}
+	
+}
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-vfp.inc.php zentrack_2-5-5-1/includes/adodb/drivers/adodb-vfp.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/drivers/adodb-vfp.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/drivers/adodb-vfp.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /* 
-V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -32,7 +32,7 @@
 	var $sysDate = 'date()';
 	var $ansiOuter = true;
 	var $hasTransactions = false;
-	var $curmode = SQL_CUR_USE_ODBC ; // See sqlext.h, SQL_CUR_DEFAULT == SQL_CUR_USE_DRIVER == 2L
+	var $curmode = false ; // See sqlext.h, SQL_CUR_DEFAULT == SQL_CUR_USE_DRIVER == 2L
 	
 	function ADODB_vfp()
 	{
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-ar.inc.php zentrack_2-5-5-1/includes/adodb/lang/adodb-ar.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-ar.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/lang/adodb-ar.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -0,0 +1,34 @@
+<?php
+// by "El-Shamaa, Khaled" <k.el-shamaa#cgiar.org>
+$ADODB_LANG_ARRAY = array (
+			'LANG'			    => 'ar',
+	    DB_ERROR			=> '  ',
+	    DB_ERROR_ALREADY_EXISTS	=> ' ',
+	    DB_ERROR_CANNOT_CREATE	=> '  ',
+	    DB_ERROR_CANNOT_DELETE	=> '  ',
+	    DB_ERROR_CANNOT_DROP	=> '  ',
+	    DB_ERROR_CONSTRAINT 	=> '  ',
+	    DB_ERROR_DIVZERO		=> '   ',
+	    DB_ERROR_INVALID		=> ' ',
+	    DB_ERROR_INVALID_DATE	=> '     ',
+	    DB_ERROR_INVALID_NUMBER	=> '   ',
+	    DB_ERROR_MISMATCH		=> ' ',
+	    DB_ERROR_NODBSELECTED	=> '     ',
+	    DB_ERROR_NOSUCHFIELD	=> '    ',
+	    DB_ERROR_NOSUCHTABLE	=> '    ',
+	    DB_ERROR_NOT_CAPABLE	=> '     ',
+	    DB_ERROR_NOT_FOUND		=> '  ',
+	    DB_ERROR_NOT_LOCKED 	=> ' ',
+	    DB_ERROR_SYNTAX		=> '  ',
+	    DB_ERROR_UNSUPPORTED	=> ' ',
+	    DB_ERROR_VALUE_COUNT_ON_ROW => '   ',
+	    DB_ERROR_INVALID_DSN	=> 'DNS  ',
+	    DB_ERROR_CONNECT_FAILED	=> '  ',
+	    0			       => '  ', // DB_OK
+	    DB_ERROR_NEED_MORE_DATA	=> '   ',
+	    DB_ERROR_EXTENSION_NOT_FOUND=> '    ',
+	    DB_ERROR_NOSUCHDB		=> '     ',
+	    DB_ERROR_ACCESS_VIOLATION	=> '  '
+);
+?>
+		
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-da.inc.php zentrack_2-5-5-1/includes/adodb/lang/adodb-da.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-da.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/lang/adodb-da.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -0,0 +1,33 @@
+<?php
+// Arne Eckmann bananstat#users.sourceforge.net
+$ADODB_LANG_ARRAY = array (
+  	    'LANG'                      => 'da',
+            DB_ERROR                    => 'ukendt fejl',
+            DB_ERROR_ALREADY_EXISTS     => 'eksisterer allerede',
+            DB_ERROR_CANNOT_CREATE      => 'kan ikke oprette',
+            DB_ERROR_CANNOT_DELETE      => 'kan ikke slette',
+            DB_ERROR_CANNOT_DROP        => 'kan ikke droppe',
+            DB_ERROR_CONSTRAINT         => 'begr&aelig;nsning kr&aelig;nket',
+            DB_ERROR_DIVZERO            => 'division med nul',
+            DB_ERROR_INVALID            => 'ugyldig',
+            DB_ERROR_INVALID_DATE       => 'ugyldig dato eller klokkeslet',
+            DB_ERROR_INVALID_NUMBER     => 'ugyldigt tal',
+            DB_ERROR_MISMATCH           => 'mismatch',
+            DB_ERROR_NODBSELECTED       => 'ingen database valgt',
+            DB_ERROR_NOSUCHFIELD        => 'felt findes ikke',
+            DB_ERROR_NOSUCHTABLE        => 'tabel findes ikke',
+            DB_ERROR_NOT_CAPABLE        => 'DB backend opgav',
+            DB_ERROR_NOT_FOUND          => 'ikke fundet',
+            DB_ERROR_NOT_LOCKED         => 'ikke l&aring;st',
+            DB_ERROR_SYNTAX             => 'syntaksfejl',
+            DB_ERROR_UNSUPPORTED        => 'ikke underst&oslash;ttet',
+            DB_ERROR_VALUE_COUNT_ON_ROW => 'resulterende antal felter svarer ikke til foresp&oslash;rgslens antal felter',
+            DB_ERROR_INVALID_DSN        => 'ugyldig DSN',
+            DB_ERROR_CONNECT_FAILED     => 'tilslutning mislykkedes',
+            0	                        => 'ingen fejl', // DB_OK
+            DB_ERROR_NEED_MORE_DATA     => 'utilstr&aelig;kkelige data angivet',
+            DB_ERROR_EXTENSION_NOT_FOUND=> 'udvidelse ikke fundet',
+            DB_ERROR_NOSUCHDB           => 'database ikke fundet',
+            DB_ERROR_ACCESS_VIOLATION   => 'utilstr&aelig;kkelige rettigheder'
+);
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-es.inc.php zentrack_2-5-5-1/includes/adodb/lang/adodb-es.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-es.inc.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/lang/adodb-es.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -22,8 +22,7 @@
             DB_ERROR_SYNTAX             => 'error de sintaxis',
             DB_ERROR_UNSUPPORTED        => 'no soportado',
             DB_ERROR_VALUE_COUNT_ON_ROW => 'la cantidad de columnas no corresponden a la cantidad de valores',
-            DB_ERROR_INVALID_DSN
-        => 'DSN invalido',
+            DB_ERROR_INVALID_DSN        => 'DSN invalido',
             DB_ERROR_CONNECT_FAILED     => 'fallo la conexion',
             0	                       => 'sin error', // DB_OK
             DB_ERROR_NEED_MORE_DATA     => 'insuficientes datos',
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-esperanto.inc.php zentrack_2-5-5-1/includes/adodb/lang/adodb-esperanto.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-esperanto.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/lang/adodb-esperanto.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -0,0 +1,35 @@
+<?php
+// Vivu Esperanto cxiam! 
+// Traduko fare de Antono Vasiljev (anders[#]brainactive.org)
+
+$ADODB_LANG_ARRAY = array (
+             'LANG'                      => 'eo',
+            DB_ERROR                    => 'nekonata eraro',
+            DB_ERROR_ALREADY_EXISTS     => 'jam ekzistas',
+            DB_ERROR_CANNOT_CREATE      => 'maleblas krei',
+            DB_ERROR_CANNOT_DELETE      => 'maleblas elimini',
+            DB_ERROR_CANNOT_DROP        => 'maleblas elimini (drop)',
+            DB_ERROR_CONSTRAINT         => 'rompo de kondicxoj de provo',
+            DB_ERROR_DIVZERO            => 'divido per 0 (nul)',
+            DB_ERROR_INVALID            => 'malregule',
+            DB_ERROR_INVALID_DATE       => 'malregula dato kaj tempo',
+            DB_ERROR_INVALID_NUMBER     => 'malregula nombro',
+            DB_ERROR_MISMATCH           => 'eraro',
+            DB_ERROR_NODBSELECTED       => 'datumbazo ne elektita',
+            DB_ERROR_NOSUCHFIELD        => 'ne ekzistas kampo',
+            DB_ERROR_NOSUCHTABLE        => 'ne ekzistas tabelo',
+            DB_ERROR_NOT_CAPABLE        => 'DBMS ne povas',
+            DB_ERROR_NOT_FOUND          => 'ne trovita',
+            DB_ERROR_NOT_LOCKED         => 'ne blokita',
+            DB_ERROR_SYNTAX             => 'sintaksa eraro',
+            DB_ERROR_UNSUPPORTED        => 'ne apogata',
+            DB_ERROR_VALUE_COUNT_ON_ROW => 'nombrilo de valoroj en linio',
+            DB_ERROR_INVALID_DSN        => 'malregula DSN-o',
+            DB_ERROR_CONNECT_FAILED     => 'konekto malsukcesa',
+            0                               => 'cxio bone', // DB_OK
+            DB_ERROR_NEED_MORE_DATA     => 'ne suficxe da datumo',
+            DB_ERROR_EXTENSION_NOT_FOUND=> 'etendo ne trovita',
+            DB_ERROR_NOSUCHDB           => 'datumbazo ne ekzistas',
+            DB_ERROR_ACCESS_VIOLATION   => 'ne suficxe da rajto por atingo'
+);
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-hu.inc.php zentrack_2-5-5-1/includes/adodb/lang/adodb-hu.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-hu.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/lang/adodb-hu.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -0,0 +1,34 @@
+<?php
+# Hungarian language, encoding by ISO 8859-2 charset (Iso Latin-2)
+# Halszvri Gbor <g.halaszvari#portmax.hu>
+$ADODB_LANG_ARRAY = array (
+			'LANG'                      => 'hu',
+            DB_ERROR                    => 'ismeretlen hiba',
+            DB_ERROR_ALREADY_EXISTS     => 'mr ltezik',
+            DB_ERROR_CANNOT_CREATE      => 'nem sikerlt ltrehozni',
+            DB_ERROR_CANNOT_DELETE      => 'nem sikerlt trlni',
+            DB_ERROR_CANNOT_DROP        => 'nem sikerlt eldobni',
+            DB_ERROR_CONSTRAINT         => 'szablyok megszegse',
+            DB_ERROR_DIVZERO            => 'oszts nullval',
+            DB_ERROR_INVALID            => 'rvnytelen',
+            DB_ERROR_INVALID_DATE       => 'rvnytelen dtum vagy id',
+            DB_ERROR_INVALID_NUMBER     => 'rvnytelen szm',
+            DB_ERROR_MISMATCH           => 'nem megfelel',
+            DB_ERROR_NODBSELECTED       => 'nincs kivlasztott adatbzis',
+            DB_ERROR_NOSUCHFIELD        => 'nincs ilyen mez',
+            DB_ERROR_NOSUCHTABLE        => 'nincs ilyen tbla',
+            DB_ERROR_NOT_CAPABLE        => 'DB backend nem tmogatja',
+            DB_ERROR_NOT_FOUND          => 'nem tallhat',
+            DB_ERROR_NOT_LOCKED         => 'nincs lezrva',
+            DB_ERROR_SYNTAX             => 'szintaktikai hiba',
+            DB_ERROR_UNSUPPORTED        => 'nem tmogatott',
+            DB_ERROR_VALUE_COUNT_ON_ROW => 'soron vgzett rtk szmlls',
+            DB_ERROR_INVALID_DSN        => 'hibs DSN',
+            DB_ERROR_CONNECT_FAILED     => 'sikertelen csatlakozs',
+            0	                       => 'nincs hiba', // DB_OK
+            DB_ERROR_NEED_MORE_DATA     => 'tl kevs az adat',
+            DB_ERROR_EXTENSION_NOT_FOUND=> 'bvtmny nem tallhat',
+            DB_ERROR_NOSUCHDB           => 'nincs ilyen adatbzis',
+            DB_ERROR_ACCESS_VIOLATION   => 'nincs jogosultsg'
+);
+?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-uk1251.inc.php zentrack_2-5-5-1/includes/adodb/lang/adodb-uk1251.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/lang/adodb-uk1251.inc.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/adodb/lang/adodb-uk1251.inc.php	2005-05-04 14:39:36.000000000 -0700
@@ -0,0 +1,35 @@
+<?php
+
+// Ukrainian language file contributed by  Alex Rootoff rootoff{AT}pisem.net.
+
+$ADODB_LANG_ARRAY = array (
+             'LANG'                      => 'uk1251',
+            DB_ERROR                    => ' ',
+            DB_ERROR_ALREADY_EXISTS     => ' ',
+            DB_ERROR_CANNOT_CREATE      => ' ',
+            DB_ERROR_CANNOT_DELETE      => ' ',
+            DB_ERROR_CANNOT_DROP        => '  (drop)',
+            DB_ERROR_CONSTRAINT         => '  ',
+            DB_ERROR_DIVZERO            => '  0',
+            DB_ERROR_INVALID            => '',
+            DB_ERROR_INVALID_DATE       => '   ',
+            DB_ERROR_INVALID_NUMBER     => ' ',
+            DB_ERROR_MISMATCH           => '',
+            DB_ERROR_NODBSELECTED       => '  ',
+            DB_ERROR_NOSUCHFIELD        => '  ',
+            DB_ERROR_NOSUCHTABLE        => '  ',
+            DB_ERROR_NOT_CAPABLE        => '   ',
+            DB_ERROR_NOT_FOUND          => ' ',
+            DB_ERROR_NOT_LOCKED         => ' ',
+            DB_ERROR_SYNTAX             => ' ',
+            DB_ERROR_UNSUPPORTED        => ' ',
+            DB_ERROR_VALUE_COUNT_ON_ROW => '   ',
+            DB_ERROR_INVALID_DSN        => ' DSN',
+            DB_ERROR_CONNECT_FAILED     => '\' ',
+            0                               => ' ', // DB_OK
+            DB_ERROR_NEED_MORE_DATA     => '  ',
+            DB_ERROR_EXTENSION_NOT_FOUND=> '  ',
+            DB_ERROR_NOSUCHDB           => '  ',
+            DB_ERROR_ACCESS_VIOLATION   => '  '
+);
+?>
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/pivottable.inc.php zentrack_2-5-5-1/includes/adodb/pivottable.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/pivottable.inc.php	2004-09-08 01:22:40.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/pivottable.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /** 
- * @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.50 6 July 2004 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license. 
  * Whenever there is any discrepancy between the two licenses, 
  * the BSD license will take precedence. 
@@ -37,6 +37,8 @@
 	if ($aggfield) $hidecnt = true;
 	else $hidecnt = false;
 	
+	$iif = strpos($db->databaseType,'access') !== false; 
+		// note - vfp still doesn' work even with IIF enabled || $db->databaseType == 'vfp';
 	
 	//$hidecnt = false;
 	
@@ -47,20 +49,39 @@
 	$sel = "$rowfields, ";
 	if (is_array($colfield)) {
 		foreach ($colfield as $k => $v) {
-			if (!$hidecnt) $sel .= "\n\t$aggfn(CASE WHEN $v THEN 1 ELSE 0 END) AS \"$k\", ";
-			if ($aggfield)
-				$sel .= "\n\t$aggfn(CASE WHEN $v THEN $aggfield ELSE 0 END) AS \"$sumlabel$k\", ";
+			$k = trim($k);
+			if (!$hidecnt) {
+				$sel .= $iif ? 
+					"\n\t$aggfn(IIF($v,1,0)) AS \"$k\", "
+					:
+					"\n\t$aggfn(CASE WHEN $v THEN 1 ELSE 0 END) AS \"$k\", ";
+			}
+			if ($aggfield) {
+				$sel .= $iif ?
+					"\n\t$aggfn(IIF($v,$aggfield,0)) AS \"$sumlabel$k\", "
+					:
+					"\n\t$aggfn(CASE WHEN $v THEN $aggfield ELSE 0 END) AS \"$sumlabel$k\", ";
+			}
 		} 
 	} else {
 		foreach ($colarr as $v) {
 			if (!is_numeric($v)) $vq = $db->qstr($v);
 			else $vq = $v;
+			$v = trim($v);
 			if (strlen($v) == 0	) $v = 'null';
-			if (!$hidecnt) $sel .= "\n\t$aggfn(CASE WHEN $colfield=$vq THEN 1 ELSE 0 END) AS \"$v\", ";
+			if (!$hidecnt) {
+				$sel .= $iif ?
+					"\n\t$aggfn(IIF($colfield=$vq,1,0)) AS \"$v\", "
+					:
+					"\n\t$aggfn(CASE WHEN $colfield=$vq THEN 1 ELSE 0 END) AS \"$v\", ";
+			}
 			if ($aggfield) {
 				if ($hidecnt) $label = $v;
 				else $label = "{$v}_$aggfield";
-				$sel .= "\n\t$aggfn(CASE WHEN $colfield=$vq THEN $aggfield ELSE 0 END) AS \"$label\", ";
+				$sel .= $iif ?
+					"\n\t$aggfn(IIF($colfield=$vq,$aggfield,0)) AS \"$label\", "
+					:
+					"\n\t$aggfn(CASE WHEN $colfield=$vq THEN $aggfield ELSE 0 END) AS \"$label\", ";
 			}
 		}
 	}
@@ -123,7 +144,7 @@
 #
 # Query the main "product" table
 # Set the rows to CompanyName and QuantityPerUnit
-# and the columns to the UnitsInStock for different ranges
+# and the columns to the UnitsInStock for diiferent ranges
 # and define the joins to link to lookup tables 
 # "categories" and "suppliers"
 #
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/rsfilter.inc.php zentrack_2-5-5-1/includes/adodb/rsfilter.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/rsfilter.inc.php	2004-09-08 01:22:40.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/rsfilter.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php
 /** 
- * @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license. 
  * Whenever there is any discrepancy between the two licenses, 
  * the BSD license will take precedence. 
@@ -42,7 +42,14 @@
 	}
 	$rows = $rs->RecordCount();
 	for ($i=0; $i < $rows; $i++) {
-		$fn($rs->_array[$i],$rs);
+		if (is_array ($fn)) {
+        	$obj = $fn[0];
+        	$method = $fn[1];
+        	$obj->$method ($rs->_array[$i],$rs);
+      } else {
+			$fn($rs->_array[$i],$rs);
+      }
+	  
 	}
 	if (!$rs->EOF) {
 		$rs->_currentRow = 0;
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/server.php zentrack_2-5-5-1/includes/adodb/server.php
--- zentrack_2-5-5-PRE1/includes/adodb/server.php	2004-09-08 01:22:40.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/server.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /** 
- * @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence. 
@@ -65,9 +65,9 @@
 ///////////////////////////////////////// DEFINITIONS
 
 
-$remote = $HTTP_SERVER_VARS["REMOTE_ADDR"]; 
+$remote = $_SERVER["REMOTE_ADDR"]; 
  
-if (empty($HTTP_GET_VARS['sql'])) err('No SQL');
+if (empty($_GET['sql'])) err('No SQL');
 
 if (!empty($ACCEPTIP))
  if ($remote != '127.0.0.1' && $remote != $ACCEPTIP) 
@@ -77,14 +77,14 @@
 $conn = &ADONewConnection($driver);
 
 if (!$conn->Connect($host,$uid,$pwd,$database)) err($conn->ErrorNo(). $sep . $conn->ErrorMsg());
-$sql = undomq($HTTP_GET_VARS['sql']);
+$sql = undomq($_GET['sql']);
 
-if (isset($HTTP_GET_VARS['fetch']))
-	$ADODB_FETCH_MODE = $HTTP_GET_VARS['fetch'];
+if (isset($_GET['fetch']))
+	$ADODB_FETCH_MODE = $_GET['fetch'];
 	
-if (isset($HTTP_GET_VARS['nrows'])) {
-	$nrows = $HTTP_GET_VARS['nrows'];
-	$offset = isset($HTTP_GET_VARS['offset']) ? $HTTP_GET_VARS['offset'] : -1;
+if (isset($_GET['nrows'])) {
+	$nrows = $_GET['nrows'];
+	$offset = isset($_GET['offset']) ? $_GET['offset'] : -1;
 	$rs = $conn->SelectLimit($sql,$nrows,$offset);
 } else 
 	$rs = $conn->Execute($sql);
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/session/adodb-compress-bzip2.php zentrack_2-5-5-1/includes/adodb/session/adodb-compress-bzip2.php
--- zentrack_2-5-5-PRE1/includes/adodb/session/adodb-compress-bzip2.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/session/adodb-compress-bzip2.php	2005-05-04 14:39:36.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /*
-V4.01 23 Oct 2003  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
          Contributed by Ross Smith (adodb@netebb.com). 
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/session/adodb-compress-gzip.php zentrack_2-5-5-1/includes/adodb/session/adodb-compress-gzip.php
--- zentrack_2-5-5-PRE1/includes/adodb/session/adodb-compress-gzip.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/session/adodb-compress-gzip.php	2005-05-04 14:39:36.000000000 -0700
@@ -2,7 +2,7 @@
 
 
 /*
-V4.01 23 Oct 2003  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
          Contributed by Ross Smith (adodb@netebb.com). 
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/session/adodb-cryptsession.php zentrack_2-5-5-1/includes/adodb/session/adodb-cryptsession.php
--- zentrack_2-5-5-PRE1/includes/adodb/session/adodb-cryptsession.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/session/adodb-cryptsession.php	2005-05-04 14:39:36.000000000 -0700
@@ -2,7 +2,7 @@
 
 
 /*
-V4.01 23 Oct 2003  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
          Contributed by Ross Smith (adodb@netebb.com). 
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/session/adodb-encrypt-mcrypt.php zentrack_2-5-5-1/includes/adodb/session/adodb-encrypt-mcrypt.php
--- zentrack_2-5-5-PRE1/includes/adodb/session/adodb-encrypt-mcrypt.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/session/adodb-encrypt-mcrypt.php	2005-05-04 14:39:36.000000000 -0700
@@ -2,7 +2,7 @@
 
 
 /*
-V4.01 23 Oct 2003  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
          Contributed by Ross Smith (adodb@netebb.com). 
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/session/adodb-encrypt-md5.php zentrack_2-5-5-1/includes/adodb/session/adodb-encrypt-md5.php
--- zentrack_2-5-5-PRE1/includes/adodb/session/adodb-encrypt-md5.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/session/adodb-encrypt-md5.php	2005-05-04 14:39:36.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /*
-V4.01 23 Oct 2003  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
          Contributed by Ross Smith (adodb@netebb.com). 
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/session/adodb-encrypt-secret.php zentrack_2-5-5-1/includes/adodb/session/adodb-encrypt-secret.php
--- zentrack_2-5-5-PRE1/includes/adodb/session/adodb-encrypt-secret.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/session/adodb-encrypt-secret.php	2005-05-04 14:39:36.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /*
-V4.01 23 Oct 2003  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
          Contributed by Ross Smith (adodb@netebb.com). 
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/session/adodb-session-clob.php zentrack_2-5-5-1/includes/adodb/session/adodb-session-clob.php
--- zentrack_2-5-5-PRE1/includes/adodb/session/adodb-session-clob.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/session/adodb-session-clob.php	2005-05-04 14:39:36.000000000 -0700
@@ -2,7 +2,7 @@
 
 
 /*
-V4.01 23 Oct 2003  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
          Contributed by Ross Smith (adodb@netebb.com). 
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/session/adodb-session.php zentrack_2-5-5-1/includes/adodb/session/adodb-session.php
--- zentrack_2-5-5-PRE1/includes/adodb/session/adodb-session.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/session/adodb-session.php	2005-05-04 14:39:36.000000000 -0700
@@ -2,7 +2,7 @@
 
 
 /*
-V4.01 23 Oct 2003  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
          Contributed by Ross Smith (adodb@netebb.com). 
   Released under both BSD license and Lesser GPL library license.
   Whenever there is any discrepancy between the two licenses,
@@ -33,6 +33,58 @@
 
 define('ADODB_SESSION', dirname(__FILE__));
 
+
+/* 
+	Unserialize session data manually. See http://phplens.com/lens/lensforum/msgs.php?id=9821 
+	
+	From Kerr Schere, to unserialize session data stored via ADOdb. 
+	1. Pull the session data from the db and loop through it. 
+	2. Inside the loop, you will need to urldecode the data column. 
+	3. After urldecode, run the serialized string through this function:
+
+*/
+function adodb_unserialize( $serialized_string ) 
+{
+	$variables = array( );
+	$a = preg_split( "/(\w+)\|/", $serialized_string, -1, PREG_SPLIT_NO_EMPTY | PREG_SPLIT_DELIM_CAPTURE );
+	for( $i = 0; $i < count( $a ); $i = $i+2 ) {
+		$variables[$a[$i]] = unserialize( $a[$i+1] );
+	}
+	return( $variables );
+}
+
+/*
+	Thanks Joe Li. See http://phplens.com/lens/lensforum/msgs.php?id=11487&x=1
+	Since adodb 4.61.
+*/
+function adodb_session_regenerate_id() 
+{
+	$conn =& ADODB_Session::_conn();
+	if (!$conn) return false;
+
+	$old_id = session_id();
+	if (function_exists('session_regenerate_id')) {
+		session_regenerate_id();
+	} else {
+		session_id(md5(uniqid(rand(), true)));
+		$ck = session_get_cookie_params();
+		setcookie(session_name(), session_id(), false, $ck['path'], $ck['domain'], $ck['secure']);
+		//@session_start();
+	}
+	$new_id = session_id();
+	$ok =& $conn->Execute('UPDATE '. ADODB_Session::table(). ' SET sesskey='. $conn->qstr($new_id). ' WHERE sesskey='.$conn->qstr($old_id));
+	
+	/* it is possible that the update statement fails due to a collision */
+	if (!$ok) {
+		session_id($old_id);
+		if (empty($ck)) $ck = session_get_cookie_params();
+		setcookie(session_name(), session_id(), false, $ck['path'], $ck['domain'], $ck['secure']);
+		return false;
+	}
+	
+	return true;
+}
+
 /*!
 	\static
 */
@@ -138,7 +190,8 @@
 
 	/*!
 	*/
-	function persist($persist = null) {
+	function persist($persist = null) 
+	{
 		static $_persist = true;
 
 		if (!is_null($persist)) {
@@ -431,7 +484,6 @@
 		$user		= ADODB_Session::user();
 
 		if (!is_null($persist)) {
-			$persist = (bool) $persist;
 			ADODB_Session::persist($persist);
 		} else {
 			$persist = ADODB_Session::persist();
@@ -443,7 +495,7 @@
 #		assert('$host');
 
 		// cannot use =& below - do not know why...
-		$conn = ADONewConnection($driver);
+		$conn =& ADONewConnection($driver);
 
 		if ($debug) {
 			$conn->debug = true;
@@ -451,7 +503,12 @@
 		}
 
 		if ($persist) {
-			$ok = $conn->PConnect($host, $user, $password, $database);
+			switch($persist) {
+			default:
+			case 'P': $ok = $conn->PConnect($host, $user, $password, $database); break;
+			case 'C': $ok = $conn->Connect($host, $user, $password, $database); break;
+			case 'N': $ok = $conn->NConnect($host, $user, $password, $database); break;
+			}
 		} else {
 			$ok = $conn->Connect($host, $user, $password, $database);
 		}
@@ -468,12 +525,10 @@
 		Close the connection
 	*/
 	function close() {
+/*
 		$conn =& ADODB_Session::_conn();
-
-		if ($conn) {
-			$conn->Close();
-		}
-
+		if ($conn) $conn->Close();
+*/
 		return true;
 	}
 
@@ -537,16 +592,16 @@
 		$filter			= ADODB_Session::filter();
 		$lifetime		= ADODB_Session::lifetime();
 		$table			= ADODB_Session::table();
-
+	
 		if (!$conn) {
 			return false;
 		}
-
+		$qkey = $conn->qstr($key);
+	
 		assert('$table');
 
 		$expiry = time() + $lifetime;
 
-		$qkey = $conn->quote($key);
 		$binary = $conn->dataProvider === 'mysql' ? '/*! BINARY */' : '';
 
 		// crc32 optimization since adodb 2.1
@@ -555,8 +610,8 @@
 			if ($debug) {
 				echo '<p>Session: Only updating date - crc32 not changed</p>';
 			}
-			$sql = "UPDATE $table SET expiry = $expiry WHERE $binary sesskey = $qkey AND expiry >= " . time();
-			$rs =& $conn->Execute($sql);
+			$sql = "UPDATE $table SET expiry = ".$conn->Param('0')." WHERE $binary sesskey = ".$conn->Param('1')." AND expiry >= ".$conn->Param('2');
+			$rs =& $conn->Execute($sql,array($expiry,$key,time()));
 			ADODB_Session::_dumprs($rs);
 			if ($rs) {
 				$rs->Close();
@@ -599,7 +654,7 @@
 					$lob_value = 'null';
 					break;
 			}
-
+			
 			// do we insert or update? => as for sesskey
 			$rs =& $conn->Execute("SELECT COUNT(*) AS cnt FROM $table WHERE $binary sesskey = $qkey");
 			ADODB_Session::_dumprs($rs);
@@ -783,10 +838,9 @@
 				$t = time();
 
 				if (abs($dbt - $t) >= $sync_seconds) {
-					global $HTTP_SERVER_VARS;
 					$msg = __FILE__ .
-						": Server time for webserver {$HTTP_SERVER_VARS['HTTP_HOST']} not in synch with database: " .
-						" database=$dbt ($dbts), webserver=$t (diff=". (abs($dbt - $t) / 3600) . ' hours)';
+						": Server time for webserver {$_SERVER['HTTP_HOST']} not in synch with database: " .
+						" database=$dbt ($dbts), webserver=$t (diff=". (abs($dbt - $t) / 60) . ' minutes)';
 					error_log($msg);
 					if ($debug) {
 						ADOConnection::outp("<p>$msg</p>");
@@ -797,7 +851,6 @@
 
 		return true;
 	}
-
 }
 
 ADODB_Session::_init();
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/toexport.inc.php zentrack_2-5-5-1/includes/adodb/toexport.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/toexport.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/toexport.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,7 @@
 <?php
 
 /** 
- * @version V4.50 6 July 2004 (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+ * @version V4.62 2 Apr 2005 (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
  * Released under both BSD license and Lesser GPL library license. 
  * Whenever there is any discrepancy between the two licenses, 
  * the BSD license will take precedence. 
@@ -77,7 +77,7 @@
 			
 			$v = $o->name;
 			if ($escquote) $v = str_replace($quote,$escquotequote,$v);
-			$v = strip_tags(str_replace("\n",$replaceNewLine,str_replace($sep,$sepreplace,$v)));
+			$v = strip_tags(str_replace("\n", $replaceNewLine, str_replace("\r\n",$replaceNewLine,str_replace($sep,$sepreplace,$v))));
 			$elements[] = $v;
 			
 		}
@@ -94,9 +94,11 @@
 		
 		if ($hasNumIndex) {
 			for ($j=0; $j < $max; $j++) {
-				$v = trim($rs->fields[$j]);
+				$v = $rs->fields[$j];
+				if (!is_object($v)) $v = trim($v);
+				else $v = 'Object';
 				if ($escquote) $v = str_replace($quote,$escquotequote,$v);
-				$v = strip_tags(str_replace("\n",$replaceNewLine,str_replace($sep,$sepreplace,$v)));
+				$v = strip_tags(str_replace("\n", $replaceNewLine, str_replace("\r\n",$replaceNewLine,str_replace($sep,$sepreplace,$v))));
 				
 				if (strpos($v,$sep) !== false || strpos($v,$quote) !== false) $elements[] = "$quote$v$quote";
 				else $elements[] = $v;
@@ -104,7 +106,7 @@
 		} else { // ASSOCIATIVE ARRAY
 			foreach($rs->fields as $v) {
 				if ($escquote) $v = str_replace($quote,$escquotequote,trim($v));
-				$v = strip_tags(str_replace("\n",$replaceNewLine,str_replace($sep,$sepreplace,$v)));
+				$v = strip_tags(str_replace("\n", $replaceNewLine, str_replace("\r\n",$replaceNewLine,str_replace($sep,$sepreplace,$v))));
 				
 				if (strpos($v,$sep) !== false || strpos($v,$quote) !== false) $elements[] = "$quote$v$quote";
 				else $elements[] = $v;
diff -Naur zentrack_2-5-5-PRE1/includes/adodb/tohtml.inc.php zentrack_2-5-5-1/includes/adodb/tohtml.inc.php
--- zentrack_2-5-5-PRE1/includes/adodb/tohtml.inc.php	2004-09-08 01:22:41.000000000 -0700
+++ zentrack_2-5-5-1/includes/adodb/tohtml.inc.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,6 +1,6 @@
 <?php 
 /*
-  V4.52 10 Aug 2004  (c) 2000-2004 John Lim (jlim@natsoft.com.my). All rights reserved.
+  V4.62 2 Apr 2005  (c) 2000-2005 John Lim (jlim@natsoft.com.my). All rights reserved.
   Released under both BSD license and Lesser GPL library license. 
   Whenever there is any discrepancy between the two licenses, 
   the BSD license will take precedence.
diff -Naur zentrack_2-5-5-PRE1/includes/configVars.php zentrack_2-5-5-1/includes/configVars.php
--- zentrack_2-5-5-PRE1/includes/configVars.php	2005-05-08 13:11:23.202812800 -0700
+++ zentrack_2-5-5-1/includes/configVars.php	2005-05-08 13:58:09.548139200 -0700
@@ -1,5 +1,6 @@
 <?{
-
+  if( !ZT_DEFINED ) { die("Illegal Access"); }
+  
   /*
   **  ZENTRACK CONFIGURATION SETTINGS
   **
@@ -20,10 +21,10 @@
    global $Db_Instance;
    global $Db_Login;
    global $Db_Pass;
-   
 
    $this->demo_mode = $Demo_Mode; 
-   $this->debug = $Debug_Mode;  
+   $this->debug = $Debug_Mode;
+   //$this->sql_debug = true;  //uncommenting this will break everything and produce tons of garbage
    
    $this->database_type      = $Db_Type;
    $this->database_instance  = $Db_Instance;
diff -Naur zentrack_2-5-5-PRE1/includes/db.class zentrack_2-5-5-1/includes/db.class
--- zentrack_2-5-5-PRE1/includes/db.class	2005-02-19 22:55:59.000000000 -0800
+++ zentrack_2-5-5-1/includes/db.class	2005-05-08 07:41:02.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 include_once("$libDir/adodb/adodb.inc.php");
 
@@ -146,7 +148,7 @@
     // .. in mysql, there is no SELECT nextval()
     // so it is easieast to run the query, then return
     // the mysql function mysql_insert_id()
-    if( $this->database_type != 'mysql' ) {
+    if( !Zen::inString('mysql',$this->database_type) ) {
       if( !$sequence ) {
         $sequence = ereg_replace("zentrack_", "", strtolower($table));
         $sequence .= "_id_seq";
@@ -184,7 +186,7 @@
         $res = $this->db_link->Execute($query);
       }
     }
-    if( $res && $this->database_type == "mysql" ) {
+    if( $res && Zen::inString('mysql',$this->database_type) ) {
       $id = $this->db_insertID();
     }
     if( $res ) {
@@ -211,15 +213,16 @@
     $this->switchQueryMode(0);
     $recordSet = &$this->db_link->Execute($query);
     $this->addDebug('db_list','['.$recordSet.'] '.$query,3);
+    $vals = array();
     if( $recordSet ) {
       $vars = $recordSet->getArray();
       if( is_array($vars) && count($vars) > 0 ) {
         foreach($vars as $v) {
           $vals[] = $v[0];
         }
-        return($vals);
       }
     }
+    return($vals);
   }
   
   function db_listIndexed( $query ) {
@@ -252,7 +255,10 @@
     // insert id for the INSERT statement about to take place... don't
     // forget to manually add the id with the insert statement in 
     // this case!
-    if( $this->database_type == 'mysql' ) {
+    if( $this->database_type == 'mysqli' ) {
+      $id = mysqli_insert_id();
+    }
+    else if( Zen::inString('mysql',$this->database_type) ) {
       $id = mysql_insert_id();
     } else {
       $id = $this->db_link->genID($sequence);
@@ -290,7 +296,7 @@
       $vals = "";
       foreach($params as $k=>$v) {
         $cols .= ($cols)? ", $k" : "$k";
-        if( ereg("^(NULL|FALSE|TRUE|[0-9]+)$", $v) ) {
+        if( ereg("^(NULL|FALSE|TRUE)$", $v) ) {
           $vals .= strlen($vals)? ", $v" : "$v"; 
         } else {
           $vals .= strlen($vals)? ", ".$this->checkSlashes($v) : $this->checkSlashes($v);
@@ -301,7 +307,7 @@
       $cols = "";
       $vals = "";
       foreach($params as $k=>$v) {
-        if( ereg("^(NULL|FALSE|TRUE|[0-9]+)$", $v) ) {
+        if( ereg("^(NULL|FALSE|TRUE)$", $v) ) {
           $vals .= strlen($vals)? ", $k = $v" : "$k = $v"; 
         } else {
           $vals .= strlen($vals)? ", $k = ".$this->checkSlashes($v) : "$k = ".$this->checkSlashes($v);
@@ -476,8 +482,8 @@
         }
         $p[2] = $this->checkSlashes($p[2]);
         if( !$p[3] && ereg("[a-zA-Z]",$p[2]) ) {
-          if( !Zen::inString('mysql',$this->db_type) 
-            && !Zen::inString('mssql',$this->db_type) ) {
+          if( !Zen::inString('mysql',$this->database_type) 
+            && !Zen::inString('mssql',$this->database_type) ) {
             $p[0] = "lower($p[0])";
             $p[2] = strtolower($p[2]);
           }
@@ -507,6 +513,13 @@
     if( $database and $this->db_link ) {
       $this->dbName = $database;
     }
+    
+    if( $this->db_link ) {
+      $this->addDebug('db_connect', "Connected successfully to database", 3);
+    }
+    else {
+      $this->addDebug('db_connect', "Could not connect to $user@$host:$database", 1);
+    }
     return( $this->db_link );      
   }
   
diff -Naur zentrack_2-5-5-PRE1/includes/editAgreementSubmit.php zentrack_2-5-5-1/includes/editAgreementSubmit.php
--- zentrack_2-5-5-PRE1/includes/editAgreementSubmit.php	2004-09-03 08:41:48.000000000 -0700
+++ zentrack_2-5-5-1/includes/editAgreementSubmit.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 
   // initiate default values
diff -Naur zentrack_2-5-5-PRE1/includes/editContactSubmit.php zentrack_2-5-5-1/includes/editContactSubmit.php
--- zentrack_2-5-5-PRE1/includes/editContactSubmit.php	2004-09-08 01:22:37.000000000 -0700
+++ zentrack_2-5-5-1/includes/editContactSubmit.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 
   // initiate default values
diff -Naur zentrack_2-5-5-PRE1/includes/editContacteSubmit.php zentrack_2-5-5-1/includes/editContacteSubmit.php
--- zentrack_2-5-5-PRE1/includes/editContacteSubmit.php	2004-09-08 01:22:37.000000000 -0700
+++ zentrack_2-5-5-1/includes/editContacteSubmit.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 
   // initiate default values
diff -Naur zentrack_2-5-5-PRE1/includes/editCustomSubmit.php zentrack_2-5-5-1/includes/editCustomSubmit.php
--- zentrack_2-5-5-PRE1/includes/editCustomSubmit.php	2005-02-09 05:56:12.000000000 -0800
+++ zentrack_2-5-5-1/includes/editCustomSubmit.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,23 +1,20 @@
 <?
-//if( !$zen->checkAccess($login_id,$ticket["bin_id"],"edit_custom") ) {
-//  $errs[] = tr("You cannot edit a ticket's custom fields in this bin ");
-//} else if( !$zen->actionApplicable($id,"edit_custom",$login_id) ) {
-//  $errs[] = $zen->ptrans("Ticket #? cannot be edited in its current status",array($id));
-//}
+  if( !ZT_DEFINED ) { die("Illegal Access"); }
+  
   $page_title = tr("Ticket #?: Save Custom Fields", array($id));
   $fields = array();
   $required = array();
   // the TODO is saved, even if the save failed
   $TODO = 'SAVED';
                                 
-  if( !$errs ) {
-    $customFieldsArray = $zen->getCustomFields(0,$page_type, 'Custom Tab');
-    include("$libDir/parseVarfields.php");
-  }
+  include("$libDir/validateFields.php");
 
   if( !$errs ) {
-    // update the ticket info
-    $res = $zen->updateVarfieldVals($id,$varfield_params);
+    if( count($varfield_params) ) {
+      // update the ticket info
+      $res = $zen->updateVarfieldVals($id,$varfield_params);
+    }
+
     // check for errors
     if( !$res ) {
       $errs[] = tr("System Error").": ".tr("Ticket could not be edited.")." ".$zen->db_error;
diff -Naur zentrack_2-5-5-PRE1/includes/editTicketSubmit.php zentrack_2-5-5-1/includes/editTicketSubmit.php
--- zentrack_2-5-5-PRE1/includes/editTicketSubmit.php	2005-03-01 07:32:25.000000000 -0800
+++ zentrack_2-5-5-1/includes/editTicketSubmit.php	2005-05-08 07:41:02.000000000 -0700
@@ -1,5 +1,6 @@
 <?
-
+  if( !ZT_DEFINED ) { die("Illegal Access"); }
+  
   if( !$zen->checkAccess($login_id,$ticket["bin_id"],"edit") ) {
     $errs[] = tr("You cannot edit a ticket in this bin ");
   } else if( !$zen->actionApplicable($id,"edit",$login_id) ) {
@@ -20,53 +21,14 @@
      $tested = 0;
   if( !$approved )
      $approved = 0;
-  if( $type == "project" && !$type_id )
+  if( $type == "project" )
      $type_id = $zen->projectTypeID();
 
   $is_project = $type == 'project' || $zen->inProjectTypeIds($type_id);
+  $view = $is_project? 'project_edit' : 'ticket_edit';
 
-  $fields = array(
-        "title"       => "text",
-        "priority"    => "int",
-        "description" => "html",
-        "bin_id"       => "int",
-        "type_id"      => "int",
-        "user_id"      => "int",
-        "system_id"    => "int",
-        "tested"      => "int",
-        "approved"    => "int",
-        "relations"   => "text",
-        "project_id"   => "int",
-        "est_hours"   => "num",
-        "deadline"    => "int",
-        "start_date"  => "int"
-        );
- // $required = array(
-         // "title",
-         // "priority",
-         // "description",
-         // "bin_id",
-         // "type_id",
-         // "system_id"
-         // );
-
-  $customFieldsArray = false;
-  $customFieldsArray = $map->getFieldMap($type=='project'?'project_edit':'ticket_edit');
-
-  $required = array();
-  foreach($customFieldsArray as $f=>$field) {
-    if( $field['is_required'] ) {
-      $required[] = $f;
-    }
-  }
-         
-  $zen->cleanInput($fields);
-  // check for required fields
-  foreach($required as $r) {
-     if( !$$r ) {
-   $errs[] = ucfirst($r)." ".tr("is a required field");
-     }
-  }
+  include("$libDir/validateFields.php");
+  
   if( !$errs ) {
      $params = array();
      // create an array of existing fields
@@ -79,27 +41,10 @@
      if( !$res ) {
        $errs[] = tr("System Error").": ".tr("Ticket could not be edited.")." ".$zen->db_error;
      }
-     else {
-       // parse variable fields which appear in new ticket screen, 
-       // store them in $varfield_params
-       // insure that all requirements are met before proceeding
-       // with the ticket save process
-       if( !$errs ) {
-         foreach(array_keys($customFieldsArray) as $f) {
-           if (strncmp($f,"custom_",7)!=0) {
-             unset($customFieldsArray["$f"]);
-           }
-         }
-         if( $customFieldsArray && count($customFieldsArray) ) {
-           include("$libDir/parseVarfields.php");
-         }
-       }
-       
-       if( $customFieldsArray && count($varfield_params) ) {
-         $res = $zen->updateVarfieldVals($id, $varfield_params, $login_id, $bin_id);
-         if( !$res ) {
-           $errs[] = tr("? updated, but variable fields could not be saved", array(tr($x)));
-         }
+     else if( $varfields && count($varfield_params) ) {
+       $res = $zen->updateVarfieldVals($id, $varfield_params, $login_id, $bin_id);
+       if( !$res ) {
+         $errs[] = tr("? updated, but variable fields could not be saved", array(tr($x)));
        }
      }
   }
diff -Naur zentrack_2-5-5-PRE1/includes/egate_config.php zentrack_2-5-5-1/includes/egate_config.php
--- zentrack_2-5-5-PRE1/includes/egate_config.php	2005-05-08 13:11:23.242870400 -0700
+++ zentrack_2-5-5-1/includes/egate_config.php	2005-05-08 13:58:09.608225600 -0700
@@ -1,4 +1,5 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
 
   /*
   **  EGATE CONFIGURATION
diff -Naur zentrack_2-5-5-PRE1/includes/egate_utils.php zentrack_2-5-5-1/includes/egate_utils.php
--- zentrack_2-5-5-PRE1/includes/egate_utils.php	2005-01-31 08:04:56.000000000 -0800
+++ zentrack_2-5-5-1/includes/egate_utils.php	2005-05-04 09:01:07.000000000 -0700
@@ -1,5 +1,6 @@
 <?{
-
+  define("ZT_DEFINED",true);
+  
   /*
   **  EGATE UTILS
   **  
diff -Naur zentrack_2-5-5-PRE1/includes/footer.php zentrack_2-5-5-1/includes/footer.php
--- zentrack_2-5-5-PRE1/includes/footer.php	2005-02-28 12:02:28.000000000 -0800
+++ zentrack_2-5-5-1/includes/footer.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
    
 
@@ -48,22 +49,25 @@
   
      $debug_text .= "<tr><td class='mainContent'>\n";
      $debug_text .= "<p><b>SETTINGS / SYSTEM INFO</b></p>\n";
+     if( preg_match('@'.strtolower(Zen::cleanPath($_SERVER['DOCUMENT_ROOT'])).'@', strtolower(Zen::cleanPath($libDir))) ) {
+       $debug_text .= "<b><span class='error'>\$libDir should not be a www viewable directory!</span></b><br>\n";
+     }
      $debug_text .= "<span class='note'>\n";
      $debug_text .= "HTTP_USER_AGENT: $HTTP_USER_AGENT<br>\n";
      $debug_text .= "SCRIPT_NAME: $SCRIPT_NAME<br>\n";
-     $debug_text .= "HTTP_HOST: $HTTP_HOST<br>\n";
+     $debug_text .= "HTTP_HOST: (".(preg_match("/$HTTP_HOST/",$rootUrl)? 'matches rootUrl' : 
+        '<b><span class="error">DOES NOT MATCH $rootUrl!!!</span></b>').")<br>\n";
      $debug_text .= "HTTP_COOKIE: $HTTP_COOKIE<br>\n";
      $debug_text .= "SERVER_SOFTWARE: {$_SERVER['SERVER_SOFTWARE']}<br>\n";
-     $debug_text .= "SERVER_NAME: $SERVER_NAME<br>\n";
      $debug_text .= "PHP Version: ".phpversion()."<br>\n";
      $debug_text .= "zenTrack Version: ".$zen->settings["version_xx"]."<br>\n";
      $debug_text .= "rootUrl: $rootUrl<br>\n";
      $debug_text .= "database: ".$zen->database_type."/".$zen->database_host."<br>\n";
      $debug_text .= "settings count: ".count($zen->settings)."<br>\n";
-     $debug_text .= "bins: ".join(",",$zen->bins)."<br>\n";
-     $debug_text .= "types: ".join(",",$zen->types)."<br>\n";
-     $debug_text .= "priorities: ".join(",",$zen->priorities)."<br>\n";
-     $debug_text .= "systems: ".join(",",$zen->systems)."<br>\n";
+     $debug_text .= "bins: ".(count($zen->bins)? join(",",$zen->bins) : 'NO BINS FOUND, DID YOU RUN THE SEED_YOURDB.SQL SCRIPT?')."<br>\n";
+     $debug_text .= "types: ".(count($zen->types)? join(",",$zen->types) : 'NO TYPES FOUND, DID YOU RUN THE SEED_YOURDB.SQL SCRIPT?')."<br>\n";
+     $debug_text .= "priorities: ".(count($zen->priorities)? join(",",$zen->priorities) : 'NO PRIORITIES FOUND, DID YOU RUN THE SEED_YOURDB.SQL SCRIPT?')."<br>\n";
+     $debug_text .= "systems: ".(count($zen->systems)? join(",",$zen->systems) : 'NO SYSTEMS FOUND, DID YOU RUN THE SEED_YOURDB.SQL SCRIPT?')."<br>\n";
      $debug_text .= "login_language: $login_language<br>\n";
      if( $login_id ) {
        $debug_text .= "login_id: $login_id<br>\n";
@@ -90,21 +94,29 @@
 
      $user = $zen->getUser($login_id);
     ?>
-    <table cellspacing='2' cellpadding='4' width='500' align='center'><tr><td class='mainContent'>
+    <table cellspacing='2' cellpadding='4' width='500' align='center'>
+    <tr><td class='mainContent' align='center'><b>DEBUG LOG</b></td></tr>
+    <tr><td class='mainContent'>
+    <p class='error'>To disable this output, set $Debug_Mode in header.php to 0.  Never leave this on in a production environment!</p>
     <form action='<?=$rootUrl?>/help/bugs.php' method='post'>
-    <input type='submit' value='Report A Bug' name='reportButton' class='submit'>
+    Report bugs by clicking here: <input type='submit' value='Report A Bug' name='reportButton' class='submit'>
     <input type='hidden' name='name' value='<?=$zen->ffv($login_name)?>'>
     <input type='hidden' name='email' value='<?=$zen->ffv($user['email'])?>'>
     <input type='hidden' name='debug_output' value='<?=urlencode($debug_text)?>'>
     <input type='hidden' name='user_info' value='<?=$zen->ffv($_SERVER['HTTP_USER_AGENT'])?>'>
     </form>
     <p>Please send us <a href='http://www.zentrack.net/feedback/?name=<?=$zen->ffv($login_name)?>&email=<?=$user['email']?>&subject=Feedback'>Feedback</a>!</p>
-    <p><b>PHPINFO:</b> <a href='<?=$rootUrl?>/phpinfo.php'>click here to view phpinfo</a></p>
-    <p><b>CACHE:</b> <a href='<?=$SCRIPT_NAME?>?clear_session_cache=1'>click here to clear session cache</a></p>
-    <p><i>To disable this output, set $Debug_Mode in header.php to 0.</i><br>
+    <p><a href='<?=$rootUrl?>/phpinfo.php'>click here to view phpinfo</a></p>
+    <p><a href='<?=$SCRIPT_NAME?>?clear_session_cache=1'>click here to clear session cache</a></p>
     </td></tr>
     <?
-  
+    // for extra security, make sure we don't pass anything sensitive out to
+    // the public
+    $debug_text = preg_replace('/password=[^"\' ]+/', 'password=xxxx', $debug_text);
+    $debug_text = preg_replace('/Db_Pass=[^"\' ]+/', 'Db_Pass=xxxx', $debug_text);
+    $debug_text = preg_replace('/database_password=[^"\' ]+/', 'database_password=xxxx', $debug_text);
+    $debug_text = preg_replace('/[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+[.][a-zA-Z0-9_.-]+/', 'xxxx@xxxx.xxx',$debug_text);
+    $debug_text = preg_replace('@(https?://|www[.])[a-zA-Z0-9_-]+[.]([a-zA-Z]{2,4})@', '\\1xxxx.\\2', $debug_text);
     print $debug_text;
     
     // used by behavior_js.php
@@ -115,6 +127,9 @@
     <?
   }
   
+  //Zen::printArray($_SERVER,'_SERVER');
+  //Zen::printArray($_ENV,'_ENV');
+  
   //if( is_array($ticket) ) {
   //  Zen::printArray($ticket, "Ticket Contents");
   //}
diff -Naur zentrack_2-5-5-PRE1/includes/headerInc.php zentrack_2-5-5-1/includes/headerInc.php
--- zentrack_2-5-5-PRE1/includes/headerInc.php	2005-03-11 07:37:36.000000000 -0800
+++ zentrack_2-5-5-1/includes/headerInc.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?{
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /*
   ** headerInc.php
   **
diff -Naur zentrack_2-5-5-PRE1/includes/leftAdmin.php zentrack_2-5-5-1/includes/leftAdmin.php
--- zentrack_2-5-5-PRE1/includes/leftAdmin.php	2004-09-27 22:24:15.000000000 -0700
+++ zentrack_2-5-5-1/includes/leftAdmin.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <tr>
   <td <?=($expand_admin)? " class='titleCell'" : $nav_rollover_text?>>
diff -Naur zentrack_2-5-5-PRE1/includes/leftBins.php zentrack_2-5-5-1/includes/leftBins.php
--- zentrack_2-5-5-PRE1/includes/leftBins.php	2004-09-27 22:24:15.000000000 -0700
+++ zentrack_2-5-5-1/includes/leftBins.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <tr>
   <td class="altCell" align=center>
diff -Naur zentrack_2-5-5-PRE1/includes/leftContacts.php zentrack_2-5-5-1/includes/leftContacts.php
--- zentrack_2-5-5-PRE1/includes/leftContacts.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/leftContacts.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <tr>
   <td<?=(isset($expand_contacts)&&$expand_contacts)? " class='titleCell'" : " ".$nav_rollover_text?>>
diff -Naur zentrack_2-5-5-PRE1/includes/leftHelp.php zentrack_2-5-5-1/includes/leftHelp.php
--- zentrack_2-5-5-PRE1/includes/leftHelp.php	2004-09-27 22:24:15.000000000 -0700
+++ zentrack_2-5-5-1/includes/leftHelp.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <tr>
   <td <?=((isset($expand_help)&&$expand_help))? " class='titleCell'" : $nav_rollover_text?>>
diff -Naur zentrack_2-5-5-PRE1/includes/leftMain.php zentrack_2-5-5-1/includes/leftMain.php
--- zentrack_2-5-5-PRE1/includes/leftMain.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/leftMain.php	2005-05-04 14:39:16.000000000 -0700
@@ -1,7 +1,9 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <div class="small" align="center"><b><?=$zen->showLongDate()?></b></div>
 <div class="small" align='center'><?=tr("version")?> <?=$zen->settings["version_xx"]?></div>
-  
 <?
+  if( $zen->demo_mode == 'on' ) { print "<div class='small' align='center'>(demo mode)</div>"; }
+
   $num = 0;
   $num = $zen->getTicketCount('OPEN');
   print "<p align='center' class='small'>";
@@ -76,12 +78,13 @@
   </td>
   </tr>  
   <? 
-     if( $login_level >= $zen->settings["level_reports"] ) {
+//we check also if login_level is a number because in first login it will be 'first_login' what would give access to all.
+     if( $zen->checkNum($login_level) >= $zen->settings["level_reports"] ) {
    include("$libDir/leftReports.php");
       } 
   ?>
   <? 
-     if( $login_level >= $zen->settings["level_settings"] ) {
+     if( $zen->checkNum($login_level) >= $zen->settings["level_settings"] ) {
    include("$libDir/leftAdmin.php");
       } 
   ?>
diff -Naur zentrack_2-5-5-PRE1/includes/leftReports.php zentrack_2-5-5-1/includes/leftReports.php
--- zentrack_2-5-5-PRE1/includes/leftReports.php	2003-03-21 00:27:14.000000000 -0800
+++ zentrack_2-5-5-1/includes/leftReports.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <tr>
   <td <?=($expand_reports)? " class='titleCell'" : $nav_rollover_text?>>
diff -Naur zentrack_2-5-5-PRE1/includes/leftSearch.php zentrack_2-5-5-1/includes/leftSearch.php
--- zentrack_2-5-5-PRE1/includes/leftSearch.php	2003-03-21 00:27:14.000000000 -0800
+++ zentrack_2-5-5-1/includes/leftSearch.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <tr>
   <td<?=(isset($expand_search)&&$expand_search)? " class='titleCell'" : " ".$nav_rollover_text?>>
diff -Naur zentrack_2-5-5-PRE1/includes/leftTickets.php zentrack_2-5-5-1/includes/leftTickets.php
--- zentrack_2-5-5-PRE1/includes/leftTickets.php	2003-03-21 00:27:14.000000000 -0800
+++ zentrack_2-5-5-1/includes/leftTickets.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <tr>
   <td<?=(isset($expand_projects)&&$expand_projects)? " class='titleCell'" : " ".$nav_rollover_text?>>
diff -Naur zentrack_2-5-5-PRE1/includes/login.php zentrack_2-5-5-1/includes/login.php
--- zentrack_2-5-5-PRE1/includes/login.php	2004-09-09 17:04:57.000000000 -0700
+++ zentrack_2-5-5-1/includes/login.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   
   // log user out of zentrack if $logoff
   if( isset($logoff) && $logoff > 0 ) {
diff -Naur zentrack_2-5-5-PRE1/includes/nav.php zentrack_2-5-5-1/includes/nav.php
--- zentrack_2-5-5-PRE1/includes/nav.php	2004-09-08 01:22:37.000000000 -0700
+++ zentrack_2-5-5-1/includes/nav.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <html>
   <head>
   <title><?=$page_prefix.$page_title?></title>
diff -Naur zentrack_2-5-5-PRE1/includes/paging.php zentrack_2-5-5-1/includes/paging.php
--- zentrack_2-5-5-PRE1/includes/paging.php	2004-09-09 17:04:57.000000000 -0700
+++ zentrack_2-5-5-1/includes/paging.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <!--- BEGIN Paging --->
 
 <table width='100%'>
diff -Naur zentrack_2-5-5-PRE1/includes/parseVarfields.php zentrack_2-5-5-1/includes/parseVarfields.php
--- zentrack_2-5-5-PRE1/includes/parseVarfields.php	2004-09-08 01:22:37.000000000 -0700
+++ zentrack_2-5-5-1/includes/parseVarfields.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,14 +1,16 @@
 <?{
+  if( !ZT_DEFINED ) { die("Illegal Access"); }
+  
   /**
   * Parses form input and creates an array called $varfield_params which contains the values needed
   * to run $zen->updateVarfieldVals()
   *
   * Depends on the following variables to determine which custom fields are used:
-  *   $customFieldsArray - the results of $zen->getCustomFields() call
+  *   $varfields - the results of $zen->getCustomFields() call
   */
   
   $varfield_fields = array();
-  foreach($customFieldsArray as $f) {
+  foreach($varfields as $f) {
     $k = $f['field_name'];
     $v = $f['field_label'];
     $r = $f['is_required'];
diff -Naur zentrack_2-5-5-PRE1/includes/prepareSearchVarfields.php zentrack_2-5-5-1/includes/prepareSearchVarfields.php
--- zentrack_2-5-5-PRE1/includes/prepareSearchVarfields.php	2004-08-25 09:27:32.000000000 -0700
+++ zentrack_2-5-5-1/includes/prepareSearchVarfields.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
  $varfieldsAll = $zen->getCustomFields(0,"","Search Screen");
  $varfieldsText = array();
  $varfieldsDates = array();
diff -Naur zentrack_2-5-5-PRE1/includes/priorityColors.php zentrack_2-5-5-1/includes/priorityColors.php
--- zentrack_2-5-5-PRE1/includes/priorityColors.php	2003-05-06 23:04:08.000000000 -0700
+++ zentrack_2-5-5-1/includes/priorityColors.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 function color_scale($startcol, $endcol, $pct) {
    // This function returns an HTML colour scaled on a percentile
diff -Naur zentrack_2-5-5-PRE1/includes/reportConfig.php zentrack_2-5-5-1/includes/reportConfig.php
--- zentrack_2-5-5-PRE1/includes/reportConfig.php	2003-03-28 12:42:28.000000000 -0800
+++ zentrack_2-5-5-1/includes/reportConfig.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?{
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   /*
   **  ZENGRAPH CONFIGURATION SETTINGS
diff -Naur zentrack_2-5-5-PRE1/includes/reportDataParser.php zentrack_2-5-5-1/includes/reportDataParser.php
--- zentrack_2-5-5-PRE1/includes/reportDataParser.php	2004-11-22 01:24:22.000000000 -0800
+++ zentrack_2-5-5-1/includes/reportDataParser.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 $title_length = 25;
 
diff -Naur zentrack_2-5-5-PRE1/includes/session_save.php zentrack_2-5-5-1/includes/session_save.php
--- zentrack_2-5-5-PRE1/includes/session_save.php	2004-07-22 07:00:50.000000000 -0700
+++ zentrack_2-5-5-1/includes/session_save.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   /*
   ** Returns variables extracted to the $_SESSION array
diff -Naur zentrack_2-5-5-PRE1/includes/session_start.php zentrack_2-5-5-1/includes/session_start.php
--- zentrack_2-5-5-PRE1/includes/session_start.php	2005-01-30 23:05:45.000000000 -0800
+++ zentrack_2-5-5-1/includes/session_start.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   /*
   **  SESSION TRACKING AND MANAGEMENT
@@ -18,7 +20,7 @@
 }
 
 // ... except the following list
-$reservedList = array("libDir", "rootUrl", 
+$reservedList = array("libDir", "rootUrl", "rootWWW",
 		      "Db_Type", "Db_Instance", "Db_Login", "Db_Pass", "Db_Host", 
 		      "Debug_Mode", "Demo_Mode", "Debug_Overview", 
 		      "page_prefix", "page_title", "page_section", 
diff -Naur zentrack_2-5-5-PRE1/includes/smtp.class zentrack_2-5-5-1/includes/smtp.class
--- zentrack_2-5-5-PRE1/includes/smtp.class	2002-05-21 07:32:23.000000000 -0700
+++ zentrack_2-5-5-1/includes/smtp.class	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?php
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /**************************************************************************\
   * smtp mailer                                                              *
   * Written by Itzchak Rehberg <izzysoft@qumran.org>                         *
@@ -11,7 +13,7 @@
   * the function send() - unless you are really sure what you are doing!     *
   \**************************************************************************/
 
-  /* $Id: upgrade_2-5-5-PRE1_to_2-5-5-1.patch,v 1.2 2005/05/08 21:14:55 phpzen Exp $ */
+  /* $Id: upgrade_2-5-5-PRE1_to_2-5-5-1.patch,v 1.2 2005/05/08 21:14:55 phpzen Exp $ */
 
 # echo "<!-- *** " . basename(__FILE__) . " starts here. *** -->\n";
 
diff -Naur zentrack_2-5-5-PRE1/includes/sorting.php zentrack_2-5-5-1/includes/sorting.php
--- zentrack_2-5-5-PRE1/includes/sorting.php	2005-03-11 07:37:36.000000000 -0800
+++ zentrack_2-5-5-1/includes/sorting.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /**
    * Parses sorting data and stores in session
    * creates a single string which can be passed
@@ -8,7 +10,7 @@
   $sm =& $zen->getSessionManager();
   $orderby  = $sm->find('ztorderby');
   if( !$orderby ) {
-    $orderby = array('status DESC','priority DESC','otime DESC');
+    $orderby = array('priority DESC','otime DESC');
     $sm->store('ztorderby', $orderby);
   }
   
@@ -25,9 +27,8 @@
   if( $newsort ) {
     // if we have a valid sorting field, drop it into our stuff.
     $ordervals = array( preg_replace('/[^0-9a-zA-Z_ ]/', '', $newsort) );
-    $count = 0;
-    foreach($orderby as $v) {
-      if( ++$count > 3 ) { break; }
+    for($i=0; $i<count($orderby) && count($ordervals)<2; $i++) {
+      $v = $orderby[$i];
       $ok = true;
       if( $v == $newsort ) { $ok = false; }
       else if( strpos($v, " DESC") > 0 ) {
diff -Naur zentrack_2-5-5-PRE1/includes/templates/accessForm.php zentrack_2-5-5-1/includes/templates/accessForm.php
--- zentrack_2-5-5-PRE1/includes/templates/accessForm.php	2003-08-28 14:49:15.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/accessForm.php	2005-05-01 23:59:36.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   // fetch a list of bins for new bins
   $userBins = $zen->getBins();
 
@@ -59,7 +61,7 @@
   // option tags for the access levels
   function opt_lvls( $selected = '' ) {
     print "<option value=''>---</option>\n";
-    for( $i=0; $i<6; $i++ ) {
+    for( $i=0; $i<11; $i++ ) {
       $sel = (strlen($selected) && $i==$selected)? 
 	" selected" : "";
       print "<option$sel>$i</option>\n";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/assign.php zentrack_2-5-5-1/includes/templates/actions/assign.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/assign.php	2003-03-23 23:25:04.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/assign.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/close.php zentrack_2-5-5-1/includes/templates/actions/close.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/close.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/close.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   $view = 'ticket_close';
   $fields = $map->getFieldMap($view);
   $hidden_fields = array();
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/contacts.php zentrack_2-5-5-1/includes/templates/actions/contacts.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/contacts.php	2004-11-16 05:14:30.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/contacts.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /**
    * creates a form for adding entries to the contact list
    */
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/email.php zentrack_2-5-5-1/includes/templates/actions/email.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/email.php	2003-03-23 23:25:05.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/email.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 
 <script language="javascript">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/estimate.php zentrack_2-5-5-1/includes/templates/actions/estimate.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/estimate.php	2003-03-23 23:25:05.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/estimate.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/log.php zentrack_2-5-5-1/includes/templates/actions/log.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/log.php	2004-11-01 11:19:22.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/log.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/move.php zentrack_2-5-5-1/includes/templates/actions/move.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/move.php	2003-03-23 23:25:05.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/move.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/notify.php zentrack_2-5-5-1/includes/templates/actions/notify.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/notify.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/actions/notify.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?{
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /**
    * creates a form for adding entries to the
    * ticket notify list
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/reject.php zentrack_2-5-5-1/includes/templates/actions/reject.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/reject.php	2003-03-23 23:25:05.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/reject.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/relate.php zentrack_2-5-5-1/includes/templates/actions/relate.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/relate.php	2004-08-09 01:10:05.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/actions/relate.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>" name='relateTicketForm'>
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/reopen.php zentrack_2-5-5-1/includes/templates/actions/reopen.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/reopen.php	2003-03-23 23:25:05.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/reopen.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/test.php zentrack_2-5-5-1/includes/templates/actions/test.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/test.php	2003-03-23 23:25:05.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/test.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/upload.php zentrack_2-5-5-1/includes/templates/actions/upload.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/upload.php	2003-03-23 23:25:05.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/upload.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form enctype="multipart/form-data" action="<?=$SCRIPT_NAME?>" method="post">
   <input type="hidden" name="MAX_FILE_SIZE" value="<?=$zen->settings["attachment_max_size"]?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/varfield_edit.php zentrack_2-5-5-1/includes/templates/actions/varfield_edit.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/varfield_edit.php	2005-03-08 08:04:40.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/varfield_edit.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,5 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   include("$libDir/templates/ticket_systemBox.php");
 ?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/templates/actions/yank.php zentrack_2-5-5-1/includes/templates/actions/yank.php
--- zentrack_2-5-5-PRE1/includes/templates/actions/yank.php	2003-03-23 23:25:05.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/actions/yank.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 <input type="hidden" name="id" value="<?=$id?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/adminMenu.php zentrack_2-5-5-1/includes/templates/adminMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/adminMenu.php	2005-03-11 08:15:53.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/adminMenu.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <br>
 <ul>
   
diff -Naur zentrack_2-5-5-PRE1/includes/templates/agreementView.php zentrack_2-5-5-1/includes/templates/agreementView.php
--- zentrack_2-5-5-PRE1/includes/templates/agreementView.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/agreementView.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 	<?
 	$sort = "dtime asc";
 	$parms = array(1 => array(1 => "status", 2 => "=", 3 => "1")
diff -Naur zentrack_2-5-5-PRE1/includes/templates/agreement_box.php zentrack_2-5-5-1/includes/templates/agreement_box.php
--- zentrack_2-5-5-PRE1/includes/templates/agreement_box.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/agreement_box.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 /* 
 *Show the contacts that are connected to a company
diff -Naur zentrack_2-5-5-PRE1/includes/templates/agreement_list.php zentrack_2-5-5-1/includes/templates/agreement_list.php
--- zentrack_2-5-5-PRE1/includes/templates/agreement_list.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/agreement_list.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 /* 
 *Show the contacts that are connected to a company
 */
diff -Naur zentrack_2-5-5-PRE1/includes/templates/behaviorDetailForm.php zentrack_2-5-5-1/includes/templates/behaviorDetailForm.php
--- zentrack_2-5-5-PRE1/includes/templates/behaviorDetailForm.php	2004-11-10 13:21:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/behaviorDetailForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
    // some elements of page are presented slightly different, although
    // data structure remains the same, when we plan to deal with groups
    // created from files
diff -Naur zentrack_2-5-5-PRE1/includes/templates/behaviorForm.php zentrack_2-5-5-1/includes/templates/behaviorForm.php
--- zentrack_2-5-5-PRE1/includes/templates/behaviorForm.php	2004-10-11 16:35:28.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/behaviorForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   // generate some text to display based on whether this
   // is an edit page or an add page
   $td = ($TODO == 'EDIT');
diff -Naur zentrack_2-5-5-PRE1/includes/templates/behaviorMenu.php zentrack_2-5-5-1/includes/templates/behaviorMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/behaviorMenu.php	2005-01-30 23:05:48.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/behaviorMenu.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
          $elnk="$rootUrl/admin/editBehavior.php";
          $llnk="$rootUrl/admin/editBehaviorDetails.php";
          $dlnk="$rootUrl/admin/deleteBehavior.php";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/binForm.php zentrack_2-5-5-1/includes/templates/binForm.php
--- zentrack_2-5-5-PRE1/includes/templates/binForm.php	2004-09-09 02:33:22.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/binForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
       <br>
       <p class='error'><?
          $str = "<a href='$rootUrl/help/find.php?s=admin&p=varfields'>".tr('Documentation')."</a>";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/bugForm.php zentrack_2-5-5-1/includes/templates/bugForm.php
--- zentrack_2-5-5-PRE1/includes/templates/bugForm.php	2004-09-09 03:20:16.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/bugForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form name='bugForm' method='post'>
 <table>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/configForm.php zentrack_2-5-5-1/includes/templates/configForm.php
--- zentrack_2-5-5-PRE1/includes/templates/configForm.php	2004-10-11 16:35:28.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/configForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
       <br>
       <p class='error'><?
          $str = "<a href='$rootUrl/help/find.php?s=admin&p=data_types'>".tr('Documentation')."</a>";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/configSettingsForm.php zentrack_2-5-5-1/includes/templates/configSettingsForm.php
--- zentrack_2-5-5-PRE1/includes/templates/configSettingsForm.php	2004-11-01 11:19:22.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/configSettingsForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
       <br>
       <p><b><?=tr("Changing these settings can have a severe impact on the system.  Please consider this before making modifications.")?></b></p>
       <p class='error'><?
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contactView.php zentrack_2-5-5-1/includes/templates/contactView.php
--- zentrack_2-5-5-PRE1/includes/templates/contactView.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contactView.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /*
   **  CONTACT VIEW
   **
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_!19Box.php zentrack_2-5-5-1/includes/templates/contact_!19Box.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_!19Box.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_!19Box.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_abcBox.php zentrack_2-5-5-1/includes/templates/contact_abcBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_abcBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_abcBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_allBox.php zentrack_2-5-5-1/includes/templates/contact_allBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_allBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_allBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <table width="645" cellpadding="0" cellspacing="0" border="0">
 <tr> 
   <td class="ticketCell" height="300" valign="top">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_box.php zentrack_2-5-5-1/includes/templates/contact_box.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_box.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_box.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <table width="645" cellpadding="0" cellspacing="0" border="0">
 <tr> 
 <td valign="bottom">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_buttonBox.php zentrack_2-5-5-1/includes/templates/contact_buttonBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_buttonBox.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_buttonBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <table width="120" cellpadding="0" cellspacing="0" border="0">
 <tr>
 <?
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_defBox.php zentrack_2-5-5-1/includes/templates/contact_defBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_defBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_defBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_ghiBox.php zentrack_2-5-5-1/includes/templates/contact_ghiBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_ghiBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_ghiBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_jklBox.php zentrack_2-5-5-1/includes/templates/contact_jklBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_jklBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_jklBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_list.php zentrack_2-5-5-1/includes/templates/contact_list.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_list.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_list.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 /* 
 *Show the contacts that are connected to a company
 */
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_mnoBox.php zentrack_2-5-5-1/includes/templates/contact_mnoBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_mnoBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_mnoBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_personBox.php zentrack_2-5-5-1/includes/templates/contact_personBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_personBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_personBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 /* 
 *Show the contacts that are connected to a company
 */
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_pqrsBox.php zentrack_2-5-5-1/includes/templates/contact_pqrsBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_pqrsBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_pqrsBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_titleBox.php zentrack_2-5-5-1/includes/templates/contact_titleBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_titleBox.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_titleBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <table cellpadding="0" cellspacing="0">
   <tr>
    <td class="ticketCell"><table 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_tuvBox.php zentrack_2-5-5-1/includes/templates/contact_tuvBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_tuvBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_tuvBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/contact_wxyzBox.php zentrack_2-5-5-1/includes/templates/contact_wxyzBox.php
--- zentrack_2-5-5-PRE1/includes/templates/contact_wxyzBox.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/contact_wxyzBox.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/customGroupDetailsForm.php zentrack_2-5-5-1/includes/templates/customGroupDetailsForm.php
--- zentrack_2-5-5-PRE1/includes/templates/customGroupDetailsForm.php	2004-08-04 04:52:18.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/customGroupDetailsForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
       <br>
       <p class='error'><?=tr("Select the items that will appear in this group and their order.")?></p>
       <ul>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/editAgreementForm.php zentrack_2-5-5-1/includes/templates/editAgreementForm.php
--- zentrack_2-5-5-PRE1/includes/templates/editAgreementForm.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/editAgreementForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   $skip = 0;
   
   $agreement = $zen->get_contact($id,"ZENTRACK_AGREEMENT","agree_id");
diff -Naur zentrack_2-5-5-PRE1/includes/templates/editContactForm.php zentrack_2-5-5-1/includes/templates/editContactForm.php
--- zentrack_2-5-5-PRE1/includes/templates/editContactForm.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/editContactForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   $skip = 0;
   $id = NULL;
   
diff -Naur zentrack_2-5-5-PRE1/includes/templates/editCustomsForm.php zentrack_2-5-5-1/includes/templates/editCustomsForm.php
--- zentrack_2-5-5-PRE1/includes/templates/editCustomsForm.php	2004-09-27 22:24:16.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/editCustomsForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 
       <p class='bigBold'><?=tr('Edit Variable Fields')?></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/editTicketForm.php zentrack_2-5-5-1/includes/templates/editTicketForm.php
--- zentrack_2-5-5-PRE1/includes/templates/editTicketForm.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/editTicketForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   // if there is an ID, open it up
   // otherwise, ask for the ticket ID
   $skip = 0;
diff -Naur zentrack_2-5-5-PRE1/includes/templates/fieldMapForm.php zentrack_2-5-5-1/includes/templates/fieldMapForm.php
--- zentrack_2-5-5-PRE1/includes/templates/fieldMapForm.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/fieldMapForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /**
     PREREQUISITES:
       $map - (ZenFieldMap) map object which can be used to retrieve default values
@@ -97,11 +99,11 @@
     $fn = "document.fieldMapForm";
     // up arrow
     $txt .= "<a href='#' onClick='moveRowUp(this.parentNode);return false;'";
-    $txt .= " border='0' alt='Move Up' title='Move Up'><img src='/images/icon_arrow_up.gif'";
+    $txt .= " border='0' alt='Move Up' title='Move Up'><img src='$rootUrl/images/icon_arrow_up.gif'";
     $txt .= " width='16' height='16' alt='Move Up' title='Move Up' border='0'></a>";
     // down arrow
     $txt .= "<a href='#' onClick='moveRowDown(this.parentNode);return false;'";
-    $txt .= " border='0' alt='Move Down' title='Move Down'><img src='/images/icon_arrow_down.gif'";
+    $txt .= " border='0' alt='Move Down' title='Move Down'><img src='$rootUrl/images/icon_arrow_down.gif'";
     $txt .= " width='16' height='16' alt='Move Down' title='Move Down' border='0'></a>";
     // control sort ordering by tracking what order these hidden fields arrive
     $txt .= "<input type='hidden' name='orderset[$f]' value='$fcount'>";
@@ -109,13 +111,13 @@
     if( $field['field_type'] == 'section' && $field['field_name'] != 'elapsed' ) {
       // remove sections
       $txt .= "<a href='#' onClick='removeRow(this);return false;'";
-      $txt .= " border='0' alt='Remove Section' title='Remove Section'><img src='/images/icon_trash.gif'";
+      $txt .= " border='0' alt='Remove Section' title='Remove Section'><img src='$rootUrl/images/icon_trash.gif'";
       $txt .= " width='16' height='16' alt='Remove Section' title='Remove Section' border='0'></a>";
     }
     else {
       // add new sections
       $txt .= "<a href='#' onClick='addRow(this);return false;'";
-      $txt .= " border='0' alt='Add Section' title='Add Section'><img src='/images/icon_add.gif'";
+      $txt .= " border='0' alt='Add Section' title='Add Section'><img src='$rootUrl/images/icon_add.gif'";
       $txt .= " width='16' height='16' alt='Add Section' title='Add Section' border='0'></a>";
     }
   }
@@ -164,7 +166,7 @@
         $txt = "<select ".fmfName($f,'default_val').">";
         $txt .= "<option value=''>--</option>";
         foreach($choices as $k=>$v) {
-          $sel = $field['default_val'] === $k? " selected" : "";
+          $sel = $field['default_val'] == $k? " selected" : "";
           $txt .= "<option value='$k'{$sel}>$v</option>";
         }
         $txt .= "</select>";
@@ -183,10 +185,12 @@
     }
     else {
       $txt = "<select style='width:80px;' ".fmfName($f, 'field_type').">";
-      foreach($fprops['types'] as $t) {
-        if( $view == 'search_form' && $t == 'checkbox' ) { continue; }
-        $sel = ( $field['field_type'] == $t )? ' selected':'';
-        $txt .= "<option value='$t'$sel>$t</option>\n";
+      if (count($fprops['types'])>0) {
+        foreach($fprops['types'] as $t) {
+          if( $view == 'search_form' && $t == 'checkbox' ) { continue; }
+          $sel = ( $field['field_type'] == $t )? ' selected':'';
+          $txt .= "<option value='$t'$sel>$t</option>\n";
+        }
       }
       $txt .= "</select>";
       fmfRow($txt,$class);
diff -Naur zentrack_2-5-5-PRE1/includes/templates/fields/label.template zentrack_2-5-5-1/includes/templates/fields/label.template
--- zentrack_2-5-5-PRE1/includes/templates/fields/label.template	2005-02-02 06:45:34.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/fields/label.template	2005-03-31 12:11:54.000000000 -0800
@@ -1,2 +1,2 @@
 
-<input type='hidden' name='{field_name}' value='{field_value}'>{field_label}
+<input type='hidden' name='{field_name}' value='{field_value}'><div id='{field_name}LabelText'>{field_label}</div>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/groupAdd.php zentrack_2-5-5-1/includes/templates/groupAdd.php
--- zentrack_2-5-5-PRE1/includes/templates/groupAdd.php	2004-10-11 16:35:28.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/groupAdd.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   // generate some text to display based on whether this
   // is an edit page or an add page
   $td = ($TODO == 'EDIT');
diff -Naur zentrack_2-5-5-PRE1/includes/templates/groupDetailsForm.php zentrack_2-5-5-1/includes/templates/groupDetailsForm.php
--- zentrack_2-5-5-PRE1/includes/templates/groupDetailsForm.php	2004-09-27 22:24:16.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/groupDetailsForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
       <br>
       <p class='error'><?=tr("Select the items that will appear in this group and their order.")?></p>
       <ul>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/groupForm.php zentrack_2-5-5-1/includes/templates/groupForm.php
--- zentrack_2-5-5-PRE1/includes/templates/groupForm.php	2004-11-10 13:21:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/groupForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
          $elnk="$rootUrl/admin/editGroup.php";
          $llnk="$rootUrl/admin/editGroupDetails.php";
          $dlnk="$rootUrl/admin/deleteGroup.php";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/homebinForm.php zentrack_2-5-5-1/includes/templates/homebinForm.php
--- zentrack_2-5-5-PRE1/includes/templates/homebinForm.php	2003-05-22 00:11:24.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/homebinForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$SCRIPT_NAME?>">
 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/languageForm.php zentrack_2-5-5-1/includes/templates/languageForm.php
--- zentrack_2-5-5-PRE1/includes/templates/languageForm.php	2003-05-03 03:07:43.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/languageForm.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" action="<?=$rootUrl?>/misc/language.php">
 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/listContacts.php zentrack_2-5-5-1/includes/templates/listContacts.php
--- zentrack_2-5-5-PRE1/includes/templates/listContacts.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/listContacts.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 /*
 *Company bar to show some info
 */
diff -Naur zentrack_2-5-5-PRE1/includes/templates/listContacts2.php zentrack_2-5-5-1/includes/templates/listContacts2.php
--- zentrack_2-5-5-PRE1/includes/templates/listContacts2.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/listContacts2.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 /*
 *Person bar to show some info
 */
diff -Naur zentrack_2-5-5-PRE1/includes/templates/listTickets.php zentrack_2-5-5-1/includes/templates/listTickets.php
--- zentrack_2-5-5-PRE1/includes/templates/listTickets.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/listTickets.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,10 +1,11 @@
 <?
+  if( !ZT_DEFINED ) { die("Illegal access"); }
 
   /**
    PREREQUISITES:
      (ZenFieldMap)$map - contains properties for fields
      (string)$view - the current view (probably project_list or ticket_list)
-     (array)$fields - properties for fields to be rendered, obtained from ZenFieldMap::getFieldMap( view )
+     (array)$fields - [optional]properties for fields to be rendered, obtained from ZenFieldMap::getFieldMap( view )
      (string)$page_type - (optional) either 'ticket' or 'project'
      (array)$tickets - list of tickets to be displayed, as retrieved from zenTrack::get_tickets()
   **/
@@ -12,6 +13,9 @@
 if( !$page_type )
   $page_type = "ticket";
   
+$fields = $map->getFieldMap($view);
+include_once("$libDir/sorting.php");
+  
 if( is_array($tickets) && count($tickets) ) {
 ?>
 <script type='text/javascript'>
@@ -135,7 +139,7 @@
           print $zen->showTimeElapsed($t["otime"],$t["ctime"],1,1);
         }
         else {
-          $value = strpos($f, 'custom_')===0? $custom_fields[$f] : $t[$f];
+          $value = strpos($f, 'custom_')===0? $custom_fields[$t["id"]][$f] : $t[$f];
           print $map->getTextValue($view, $f, $value);
         }
         print "</a></td>\n";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/listTickets_workFormat.php zentrack_2-5-5-1/includes/templates/listTickets_workFormat.php
--- zentrack_2-5-5-PRE1/includes/templates/listTickets_workFormat.php	2003-05-22 00:11:25.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/listTickets_workFormat.php	2005-05-01 23:59:37.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   
 if( is_array($tickets) ) {
  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/newAgreementForm.php zentrack_2-5-5-1/includes/templates/newAgreementForm.php
--- zentrack_2-5-5-PRE1/includes/templates/newAgreementForm.php	2004-11-23 11:24:23.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/newAgreementForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <script language='javascript' type='text/javascript'>
   function checkMyBox(fieldName, event) {
     if( !event ) { event = window.event; }
diff -Naur zentrack_2-5-5-PRE1/includes/templates/newContactForm.php zentrack_2-5-5-1/includes/templates/newContactForm.php
--- zentrack_2-5-5-PRE1/includes/templates/newContactForm.php	2004-10-27 12:15:31.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/newContactForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" name="contactForm" action="<?=($skip)? "editContactSubmit.php" : "$rootUrl/addContactSubmit.php"?>">
 <input type="hidden" name="id" value="<?=strip_tags($id)?>">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/newContacteForm.php zentrack_2-5-5-1/includes/templates/newContacteForm.php
--- zentrack_2-5-5-PRE1/includes/templates/newContacteForm.php	2004-10-27 12:15:31.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/newContacteForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <form method="post" name="contactForm" action="<?=($skip)? "editContacteSubmit.php" : "$rootUrl/addContacteSubmit.php"?>">
 <?
diff -Naur zentrack_2-5-5-PRE1/includes/templates/newTicketForm.php zentrack_2-5-5-1/includes/templates/newTicketForm.php
--- zentrack_2-5-5-PRE1/includes/templates/newTicketForm.php	2005-03-10 19:16:28.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/newTicketForm.php	2005-05-08 13:44:39.000000000 -0700
@@ -1,4 +1,6 @@
 <?  
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /**
    PREREQUISITES:
      (ZenFieldMap)$map - contains properties for fields
@@ -51,7 +53,7 @@
   if( strlen($start_date) ) { $start_date = $zen->showDateTime($start_date); }
   if( strlen($ctime) ) { $ctime = $zen->showDateTime($ctime); }
   if( strlen($otime) && $td ) { $otime = $zen->showDateTime($otime); }
-  else { $otime = time(); }
+  if( !$td ) { $otime = time(); }
      
   //$view = $td? 'ticket_edit' : 'ticket_create';
   $fields = $map->listFieldsForView($view);
@@ -98,7 +100,13 @@
     print "<tr><td class='bars'>";
     print $map->getLabel($view, $f);
     print "</td><td class='bars'>";
-    print $map->renderTicketField($view, 'ticketForm', $f, $$f);
+    if( $td && $page_type == 'project' && $f == 'type_id' ) {
+      // do not allow type to be edited for projects
+      print $map->getTextValue($view, $f, $$f);
+    }
+    else {
+      print $map->renderTicketField($view, 'ticketForm', $f, $$f);
+    }
     print "</td></tr>\n";
   }
 }
diff -Naur zentrack_2-5-5-PRE1/includes/templates/optionsMenu.php zentrack_2-5-5-1/includes/templates/optionsMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/optionsMenu.php	2005-02-09 05:56:14.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/optionsMenu.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <br>
 <ul>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/projectView.php zentrack_2-5-5-1/includes/templates/projectView.php
--- zentrack_2-5-5-PRE1/includes/templates/projectView.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/projectView.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /*
   **  PROJECT VIEW
   **
diff -Naur zentrack_2-5-5-PRE1/includes/templates/pwcForm.php zentrack_2-5-5-1/includes/templates/pwcForm.php
--- zentrack_2-5-5-PRE1/includes/templates/pwcForm.php	2003-05-22 00:11:25.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/pwcForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   $user = $zen->getUser($login_id);
   if( $user["passphrase"] == $zen->encval($user["lname"]) ) {
     print "<p class='hot'>".tr("Your passphrase is currently set to the system default.  Please change it.")."</p>\n";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/referencedGroupForm.php zentrack_2-5-5-1/includes/templates/referencedGroupForm.php
--- zentrack_2-5-5-PRE1/includes/templates/referencedGroupForm.php	2004-10-19 11:44:11.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/referencedGroupForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
          $elnk="$rootUrl/admin/deleteGroup.php";
 ?>
       <br>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/reportMenu.php zentrack_2-5-5-1/includes/templates/reportMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/reportMenu.php	2004-02-27 03:37:46.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/reportMenu.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <table width='300'>
 <tr>
   <td class='titleCell' align='center'><?=tr("View Reports")?></td>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/reportsDataMenu.php zentrack_2-5-5-1/includes/templates/reportsDataMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/reportsDataMenu.php	2003-03-23 23:25:02.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/reportsDataMenu.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <!-- DATA MENU -->
 
 <?
diff -Naur zentrack_2-5-5-PRE1/includes/templates/reportsDateMenu.php zentrack_2-5-5-1/includes/templates/reportsDateMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/reportsDateMenu.php	2003-03-23 23:25:02.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/reportsDateMenu.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <!-- DATE MENU -->
 <?
   // validate data
diff -Naur zentrack_2-5-5-PRE1/includes/templates/reportsMenu.php zentrack_2-5-5-1/includes/templates/reportsMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/reportsMenu.php	2003-03-23 23:25:02.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/reportsMenu.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="640" align="left" cellpadding="2" cellspacing="2" bgcolor="<?=$zen->settings["color_background"]?>">
 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/reportsOptionsMenu.php zentrack_2-5-5-1/includes/templates/reportsOptionsMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/reportsOptionsMenu.php	2003-03-23 23:25:02.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/reportsOptionsMenu.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <!-- OPTIONS MENU -->
 <?
   // validation
diff -Naur zentrack_2-5-5-PRE1/includes/templates/reportsSubmit.php zentrack_2-5-5-1/includes/templates/reportsSubmit.php
--- zentrack_2-5-5-PRE1/includes/templates/reportsSubmit.php	2003-03-23 23:25:03.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/reportsSubmit.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <!-- SUBMIT MENU -->
 <tr>
   <td class='<?=($tf_options)? "titleCell" : "subTitle" ?>' colspan='3'>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/reportsTasks.php zentrack_2-5-5-1/includes/templates/reportsTasks.php
--- zentrack_2-5-5-PRE1/includes/templates/reportsTasks.php	2003-01-03 22:11:49.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/reportsTasks.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 Form for detailed input of report parameters:
 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/reportsTypeMenu.php zentrack_2-5-5-1/includes/templates/reportsTypeMenu.php
--- zentrack_2-5-5-PRE1/includes/templates/reportsTypeMenu.php	2003-03-23 23:25:03.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/reportsTypeMenu.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   // set a toggle
   if( $report_type )
      $report_type = $zen->checkAlphaNum($report_type,"_ ");
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchContact2List.php zentrack_2-5-5-1/includes/templates/searchContact2List.php
--- zentrack_2-5-5-PRE1/includes/templates/searchContact2List.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/searchContact2List.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?  
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 if( is_array($tickets) && count($tickets) ) {
  
    $link = $zen->settings["url_view_ticket"];   
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchContact3List.php zentrack_2-5-5-1/includes/templates/searchContact3List.php
--- zentrack_2-5-5-PRE1/includes/templates/searchContact3List.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/searchContact3List.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?  
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 if( is_array($tickets) && count($tickets) ) {
  
    $link = $zen->settings["url_view_ticket"];   
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchContact4List.php zentrack_2-5-5-1/includes/templates/searchContact4List.php
--- zentrack_2-5-5-PRE1/includes/templates/searchContact4List.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/searchContact4List.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?  
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 if( is_array($tickets) && count($tickets) ) {
  
    $link = $zen->settings["url_view_ticket"];   
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchContactForm.php zentrack_2-5-5-1/includes/templates/searchContactForm.php
--- zentrack_2-5-5-PRE1/includes/templates/searchContactForm.php	2004-11-01 11:19:22.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/searchContactForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 
 <form action="<?=($SCRIPT_NAME)?>" name="searchCompany">
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchContactList.php zentrack_2-5-5-1/includes/templates/searchContactList.php
--- zentrack_2-5-5-PRE1/includes/templates/searchContactList.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/searchContactList.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?  
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 if( is_array($tickets) && count($tickets) ) {
  
    $link = $zen->settings["url_view_ticket"];   
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchContactResults.php zentrack_2-5-5-1/includes/templates/searchContactResults.php
--- zentrack_2-5-5-PRE1/includes/templates/searchContactResults.php	2004-09-02 09:40:51.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/searchContactResults.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <?{
 	
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchForm.php zentrack_2-5-5-1/includes/templates/searchForm.php
--- zentrack_2-5-5-PRE1/includes/templates/searchForm.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/searchForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /**
    PREREQUISITES:
      (ZenFieldMap)$map - contains properties for fields
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchLogForm.php zentrack_2-5-5-1/includes/templates/searchLogForm.php
--- zentrack_2-5-5-PRE1/includes/templates/searchLogForm.php	2004-11-01 11:19:22.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/searchLogForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   // create a default date
   if( !$search_date )
     $search_date = 0;
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchLogList.php zentrack_2-5-5-1/includes/templates/searchLogList.php
--- zentrack_2-5-5-PRE1/includes/templates/searchLogList.php	2004-11-01 11:19:22.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/searchLogList.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 if( is_array($logs) && count($logs) ) {
   
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchLogResults.php zentrack_2-5-5-1/includes/templates/searchLogResults.php
--- zentrack_2-5-5-PRE1/includes/templates/searchLogResults.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/searchLogResults.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?{
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   // integrity
   $params = array();
diff -Naur zentrack_2-5-5-PRE1/includes/templates/searchResults.php zentrack_2-5-5-1/includes/templates/searchResults.php
--- zentrack_2-5-5-PRE1/includes/templates/searchResults.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/searchResults.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?{
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   
   include("$libDir/sorting.php");
   
@@ -85,7 +87,7 @@
               if( is_array($v) ) {
                 $v = array_reduce($v, "searchResultsMaxPri");
               }
-              $params[] = array($zen->table_tickets.".$k",'<=',$vh,1);
+              $params[] = array($zen->table_tickets.".$k",'<=',$v,1);
             }
             else {
               $params[] = array($zen->table_tickets.".$k",$op,$v,1);
@@ -159,4 +161,4 @@
     $tickets = $zen->search_tickets($params, "AND", "0", join(',',$orderby), $limit);//"status DESC, priority DESC"
   }
   
-}?>
\ No newline at end of file
+}?>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticketView.php zentrack_2-5-5-1/includes/templates/ticketView.php
--- zentrack_2-5-5-PRE1/includes/templates/ticketView.php	2003-03-06 00:29:54.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticketView.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /*
   **  TICKET VIEW
   **
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_actionBar.php zentrack_2-5-5-1/includes/templates/ticket_actionBar.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_actionBar.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/ticket_actionBar.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 
 <!-- BEGIN ACTION BAR -->
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_attachmentsBox.php zentrack_2-5-5-1/includes/templates/ticket_attachmentsBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_attachmentsBox.php	2004-11-25 12:03:44.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_attachmentsBox.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
    $rollover_text = " onclick=\"mClk(this);\" "
       ."onmouseout=\"mOut(this,'".$zen->settings["color_background"]."', '');\" "
       ."onmouseover=\"mOvr(this,'".$zen->settings["color_bars"]."', '');\"";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_box.php zentrack_2-5-5-1/includes/templates/ticket_box.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_box.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_box.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <table width="645" cellpadding="0" cellspacing="0" border="0">
 <tr> 
   <td valign="bottom"><?
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_contactsBox.php zentrack_2-5-5-1/includes/templates/ticket_contactsBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_contactsBox.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/ticket_contactsBox.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   // security measure
   if( $login_level < $zen->settings['level_contacts'] ) {
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_customBox.php zentrack_2-5-5-1/includes/templates/ticket_customBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_customBox.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_customBox.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <? 
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 if( $TODO == 'SAVED' ) {
   $zen->print_errors($errs); 
   if( $save_message ) {
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_detailsBox.php zentrack_2-5-5-1/includes/templates/ticket_detailsBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_detailsBox.php	2005-02-09 05:56:14.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_detailsBox.php	2005-05-08 13:44:39.000000000 -0700
@@ -1,3 +1,17 @@
+<? 
+  /**
+   * This displays the details tab within the ticket view.
+   *
+   * Requirements:
+   *   ZenTrack $zen - zenTrack class and utils
+   *   ZenFieldMap $map - an instance of $ZenFieldMap used to obtain list of fields
+   *   String $view - a view as defined in ZenFieldMap.class, used to obtain fields and properties
+   *   int $project_id - [optional] if defined, represents the project this ticket belongs to
+   *   mixed [various] - ticket fields from ZENTRACK_TICKETS are provided to this page as $column_name
+   */
+   
+   if( !ZT_DEFINED ) { die("Illegal Access"); } 
+?>
 
   <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
@@ -18,7 +32,7 @@
     <td colspan='3' <?=$rollover_text?>><a 
 	href='<?=$rootUrl?>/project.php?id=<?=$project_id?>' 
 	class='rowLink'><?=$project_id?> -  
-    	<?=stripslashes($project["title"])?></a></td>
+    	<?=$zen->ffv($project["title"])?></a></td>
     <? } ?>
     <td class='altCellInv'>&nbsp;</td>
     <td class='altCellInv'><?=($start_date)?$zen->showDateTime($start_date):"n/a"?></td>  
@@ -75,7 +89,7 @@
     <td class="smallTitleCell"><?=uptr("Hours Worked")?></td>  
   </tr>
    <tr>
-    <td><?=($ctime)?$zen->showDate($ctime):tr("n/a")?></td>    
+    <td><?=($ctime)?$zen->showDateTime($ctime):tr("n/a")?></td>    
     <td><? 
       switch($tested){
         case 1: 
@@ -118,13 +132,16 @@
     $varfield_type=ereg_replace("[^a-z_]", "", $k);
     switch($varfield_type) {
       case "custom_number":
-        $cfv = strlen($varfields["$k"])? $varfields["$k"] : 'n/a';
+        $cfv = strlen($varfields["$k"])? $varfields["$k"] : '&nbsp;';
         break;
       case "custom_date":
-        $cfv = $varfields["$k"]? $zen->showDateTime($varfields["$k"]) : "n/a";
+        $cfv = $varfields["$k"]? $zen->showDateTime($varfields["$k"]) : "&nbsp;";
+        break;
+      case "custom_text":
+        $cfv = strlen($varfields["$k"])? $zen->ffvText($varfields["$k"]) : "&nbsp;";
         break;
       default:
-        $cfv = $varfields["$k"]? $zen->ffv($varfields["$k"]) : 'n/a';
+        $cfv = $varfields["$k"]? $zen->ffv($varfields["$k"]) : '&nbsp;';
         break;
     }
 ?>
@@ -134,10 +151,7 @@
    </tr>
    <tr>
       <td colspan="3"<?= $varfield_type == 'custom_text'? " class='outlined'" : '' ?>>
-      <?= 
-	 $varfield_type == 'custom_text'?
-           (get_magic_quotes_runtime()? nl2br(stripslashes($cfv)) : nl2br($cfv)) : $zen->ffv($cfv);
-      ?>
+      <?= $cfv ?>
     </td>
     <td colspan='2'>&nbsp;</td>
    </tr>
@@ -153,7 +167,7 @@
    </tr>
    <tr>
     <td colspan="5" class="outlined">
-   <?=(get_magic_quotes_runtime())?nl2br(stripslashes($description)):nl2br($description); ?>
+   <?= $zen->ffvText($description) ?>
     </td>
    </tr>  
 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_logBox.php zentrack_2-5-5-1/includes/templates/ticket_logBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_logBox.php	2004-11-01 11:19:22.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_logBox.php	2005-05-08 07:41:03.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <table width="600" align="center" cellpadding="2" cellspacing="2">
       <?
@@ -28,10 +29,6 @@
       // the log and attachments
       if( $l["entry"] ) {
 	print "<br>\n";
-//	$l["entry"] = nl2br(htmlspecialchars(stripslashes($l["entry"])));
-	if ( get_magic_quotes_runtime() ) {
-	   $l["entry"] = stripslashes($l["entry"]);
-	}
 	$l["entry"] = nl2br($zen->ffv($l["entry"]));
 	$l["entry"] = preg_replace("#\&amp;#", "&", $l["entry"]);
 //	$l["entry"] = preg_replace("#(https?://[a-zA-Z0-9_/.-]+[a-zA-Z0-9\-_]+\.[a-z]{2,3}(/[a-zA-Z/\._\?=&0-9-]+))#", "<a href='\\1' target='_blank'>\\1</a>", $l["entry"]);
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_notifyBox.php zentrack_2-5-5-1/includes/templates/ticket_notifyBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_notifyBox.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/ticket_notifyBox.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <table width="600" align="center" cellpadding="2" cellspacing="2">
   <tr> 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_relatedBox.php zentrack_2-5-5-1/includes/templates/ticket_relatedBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_relatedBox.php	2004-09-08 01:22:42.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/ticket_relatedBox.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
@@ -10,14 +11,17 @@
 <?
   $tickets = false;
   if( $page_type == "ticket" ) {
+    $view='ticket_list';
     $ticket = $zen->get_ticket($id);
   } else {
+    $view='project_list';
     $ticket = $zen->get_project($id);
   }
   if( $ticket["relations"] ) {
      $tids = explode(",", $ticket["relations"]);
      $tickets = $zen->get_tickets( array("id"=>$tids) );
   }
+  $fields=$map->getFieldMap($view);
   if( is_array($tickets) && count($tickets) ) {
      include("$templateDir/listTickets.php");
   } else {
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_reportBox.php zentrack_2-5-5-1/includes/templates/ticket_reportBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_reportBox.php	2002-03-19 01:11:54.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_reportBox.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <table width="600" align="center" cellpadding="2" cellspacing="2">
    <tr>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_systemBox.php zentrack_2-5-5-1/includes/templates/ticket_systemBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_systemBox.php	2003-03-23 23:25:04.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_systemBox.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   
   if( $action ) {   
      
@@ -13,7 +15,7 @@
        include("$templateDir/actions/$action.php");
      }
      else {
-       print "<p class='error'>".tr("Invalid action declared")."</p>\n";
+       print "<p class='error'>".tr("Invalid action declared")." (".$zen->ffv($action).")</p>\n";
      }
   
      print "<p>&nbsp;</p>\n";
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_tasksBox.php zentrack_2-5-5-1/includes/templates/ticket_tasksBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_tasksBox.php	2003-03-23 23:25:04.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_tasksBox.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
   <table width="600" align="center" cellpadding="2" cellspacing="2">
   <tr> 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/ticket_titleBox.php zentrack_2-5-5-1/includes/templates/ticket_titleBox.php
--- zentrack_2-5-5-PRE1/includes/templates/ticket_titleBox.php	2005-02-28 12:02:31.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/ticket_titleBox.php	2005-05-08 07:41:03.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <table width="560" cellpadding="0" cellspacing="0">
   <tr>
    <td class="ticketCell"><table 
@@ -11,7 +12,7 @@
 	  </tr>
 	  <tr>
 	   <td class="small"><?=$id?></td>
-	   <td colspan="2"><?=stripslashes($title)?></td>
+	   <td colspan="2"><?=$zen->ffv($title)?></td>
 	  </tr>
 	  <tr>
 	   <td class="smallTitleCell" height="<?=$height_num?>"><?=uptr("Elapsed")?></td>  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/add_attachment.php zentrack_2-5-5-1/includes/templates/tutorial/english/add_attachment.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/add_attachment.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/add_attachment.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Attachments</p>
 
 <p><b>Purpose</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/bins.php zentrack_2-5-5-1/includes/templates/tutorial/english/bins.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/bins.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/bins.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Bins and the Move feature</p>
 
 <p><b>Purpose</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/close_ticket.php zentrack_2-5-5-1/includes/templates/tutorial/english/close_ticket.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/close_ticket.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/close_ticket.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <p align='center' class='bigbold'>Closing Tickets</p>
 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/closure.php zentrack_2-5-5-1/includes/templates/tutorial/english/closure.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/closure.php	2004-09-09 02:33:22.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/closure.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Thanks for Reading the Tutorial</p>
 
 <p>Hopefully this walkthrough has been somewhat useful to you and hasn't resulted
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/contacts.php zentrack_2-5-5-1/includes/templates/tutorial/english/contacts.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/contacts.php	2004-09-09 02:33:22.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/contacts.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Contacts</p>
 
 <b>Important Note:</b> If contacts are not useful to your organization, they
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/create_ticket.php zentrack_2-5-5-1/includes/templates/tutorial/english/create_ticket.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/create_ticket.php	2004-09-09 02:33:22.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/create_ticket.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Creating a New Ticket</p>
 
 <p><b>Purpose</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/introduction.php zentrack_2-5-5-1/includes/templates/tutorial/english/introduction.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/introduction.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/introduction.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Introduction</p>
 
 <p>This tutorial explains the basic flowpath and actions you will need to 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/log_ticket.php zentrack_2-5-5-1/includes/templates/tutorial/english/log_ticket.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/log_ticket.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/log_ticket.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>The Ticket Log</p>
 
 <p><b>Purpose</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/login.php zentrack_2-5-5-1/includes/templates/tutorial/english/login.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/login.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/login.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Logging In</p>
 
 <p><b>Getting Login and Password</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/notify_list.php zentrack_2-5-5-1/includes/templates/tutorial/english/notify_list.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/notify_list.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/notify_list.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Notify Lists</p>
 
 <p><b>Purpose</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/ownership.php zentrack_2-5-5-1/includes/templates/tutorial/english/ownership.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/ownership.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/ownership.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Ownership of Tickets</p>
 
 <p><b>You must own a ticket for most actions</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/relate_ticket.php zentrack_2-5-5-1/includes/templates/tutorial/english/relate_ticket.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/relate_ticket.php	2004-09-09 02:33:22.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/relate_ticket.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Related Tickets</p>
 
 <p><b>Purpose</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/use_project.php zentrack_2-5-5-1/includes/templates/tutorial/english/use_project.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/use_project.php	2004-09-09 02:33:22.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/use_project.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Projects</p>
 
 <p><b>Purpose</b></p>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/tutorial/english/view_tickets.php zentrack_2-5-5-1/includes/templates/tutorial/english/view_tickets.php
--- zentrack_2-5-5-PRE1/includes/templates/tutorial/english/view_tickets.php	2004-09-08 17:28:27.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/tutorial/english/view_tickets.php	2005-05-01 23:59:39.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 <p align='center' class='bigbold'>Viewing Tickets</p>
 
 <img src="<?=$tutImageUrl?>/nav_tickets.gif" 
diff -Naur zentrack_2-5-5-PRE1/includes/templates/userAdd.php zentrack_2-5-5-1/includes/templates/userAdd.php
--- zentrack_2-5-5-PRE1/includes/templates/userAdd.php	2004-07-01 21:56:37.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/userAdd.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   // generate some text to display based on whether this
   // is an edit page or an add page
   $td = ($TODO == 'EDIT');
diff -Naur zentrack_2-5-5-PRE1/includes/templates/userSearchForm.php zentrack_2-5-5-1/includes/templates/userSearchForm.php
--- zentrack_2-5-5-PRE1/includes/templates/userSearchForm.php	2005-03-11 07:37:38.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/userSearchForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,3 +1,4 @@
+<? if( !ZT_DEFINED ) { die("Illegal Access"); } ?>
 
 <table width="640" align="left" cellpadding="2" cellspacing="2" bgcolor="<?=$zen->settings["color_background"]?>">
 <tr>
diff -Naur zentrack_2-5-5-PRE1/includes/templates/userSearchList.php zentrack_2-5-5-1/includes/templates/userSearchList.php
--- zentrack_2-5-5-PRE1/includes/templates/userSearchList.php	2003-03-23 23:25:04.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/userSearchList.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   
 if( is_array($users) && count($users) ) {
  
diff -Naur zentrack_2-5-5-PRE1/includes/templates/userSearchResults.php zentrack_2-5-5-1/includes/templates/userSearchResults.php
--- zentrack_2-5-5-PRE1/includes/templates/userSearchResults.php	2002-04-30 03:11:12.000000000 -0700
+++ zentrack_2-5-5-1/includes/templates/userSearchResults.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?{
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   // integrity
   unset($params);
diff -Naur zentrack_2-5-5-PRE1/includes/templates/validateTicketForm.php zentrack_2-5-5-1/includes/templates/validateTicketForm.php
--- zentrack_2-5-5-PRE1/includes/templates/validateTicketForm.php	2005-03-10 20:27:53.000000000 -0800
+++ zentrack_2-5-5-1/includes/templates/validateTicketForm.php	2005-05-01 23:59:38.000000000 -0700
@@ -1,4 +1,6 @@
 <?  
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   /**
    PREREQUISITES:
      (ZenFieldMap)$map - contains properties for fields
@@ -38,7 +40,7 @@
    var errs = new Array();
 <?
 foreach($fields as $f) {
-  $field = $map->getFieldFromMap($view,$f);
+  $field = $map->getFieldFromMap($view,$f['field_name']);
   // we don't want to validate any hidden fields using javascript, this is
   // a potential problem.
   if( $field['is_required'] && $field['is_visible'] && $field['field_type'] != 'label' ) {
diff -Naur zentrack_2-5-5-PRE1/includes/translations/spanish.trans zentrack_2-5-5-1/includes/translations/spanish.trans
--- zentrack_2-5-5-PRE1/includes/translations/spanish.trans	2004-11-26 08:25:40.000000000 -0800
+++ zentrack_2-5-5-1/includes/translations/spanish.trans	2005-03-22 08:31:41.000000000 -0800
@@ -112,7 +112,7 @@
 #file "/home/ired/zentrack_2/includes/leftMain.php"
 #args "array($num,count($zen->bins))"
 msgid "? open tickets in ? bins"
-msgstr "? tickets abiertos en ? 'bins'"
+msgstr "? tickets abiertos en ? comunidades"
 
 
 #file "/home/ired/zentrack_2/www/admin/priorities.php"
@@ -874,7 +874,7 @@
 #file "/home/ired/zentrack_2/includes/templates/actions/yank.php"
 #args ""
 msgid "Click button to yank ticket"
-msgstr "Presione el bot&oacute;n para sustraer el ticket"
+msgstr "Presione el bot&oacute;n para capturar el ticket"
 
 
 #file "/home/ired/zentrack_2/includes/templates/newAgreementForm.php"
@@ -3334,7 +3334,7 @@
 #file "/home/ired/zentrack_2/includes/templates/actions/email.php"
 #args ""
 msgid "Send a summary of the ticket"
-msgstr "Env/iacute;e un resumen del ticket"
+msgstr "Env&iacute;e un resumen del ticket"
 
 
 #file "/home/ired/zentrack_2/includes/templates/actions/email.php"
@@ -4270,7 +4270,7 @@
 #file "/home/ired/zentrack_2/includes/zenTrack.class"
 #args ""
 msgid "Ticket Summary")
-msgstr "Res&uacute;men del Ticket"
+msgstr "Resumen del Ticket"
 
 
 #file "/home/ired/zentrack_2/includes/templates/editCustomsForm.php"
@@ -4720,13 +4720,13 @@
 #file "/home/ired/zentrack_2/includes/templates/actions/yank.php"
 #args ""
 msgid "Yank Ticket"
-msgstr "Sustraer Ticket"
+msgstr "Capturar Ticket"
 
 
 #file "/home/ired/zentrack_2/includes/templates/actions/yank.php"
 #args ""
 msgid "Yank"
-msgstr "Sustraer"
+msgstr "Capturar"
 
 
 #file "/home/ired/zentrack_2/includes/templates/reportsDateMenu.php"
@@ -5842,7 +5842,7 @@
 #file "/home/ired/zentrack_2/www/help/english/users/tickets.php"
 #args ""
 msgid 'Yank'
-msgstr "Sustraer"
+msgstr "Capturar"
 
 
 #file "/home/ired/zentrack_2/includes/templates/searchLogResults.php"
diff -Naur zentrack_2-5-5-PRE1/includes/translator.class zentrack_2-5-5-1/includes/translator.class
--- zentrack_2-5-5-PRE1/includes/translator.class	2005-03-11 07:37:36.000000000 -0800
+++ zentrack_2-5-5-1/includes/translator.class	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?php
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 /**
  * The translation function wrapper
  *
diff -Naur zentrack_2-5-5-PRE1/includes/validateFields.php zentrack_2-5-5-1/includes/validateFields.php
--- zentrack_2-5-5-PRE1/includes/validateFields.php	1969-12-31 16:00:00.000000000 -0800
+++ zentrack_2-5-5-1/includes/validateFields.php	2005-05-08 07:41:02.000000000 -0700
@@ -0,0 +1,55 @@
+<?{
+  
+  /*
+  ** Validates input fields for add/edit operations
+  **
+  ** Depends on the following variables:
+  **    (String)$view - the view which will be passed into the field map
+  **    (ZenFieldMap)$map - the field map to collect field info from
+  **
+  ** Creates the following variables:
+  **    (Array)$fields - key/value pairs of (String)field => (String)data_type
+  **    (Array)$required - array of (String)field names which are required for this view
+  **    (Array)$varfield_params - contains the values needed to run $zen->updateVarfieldVals() (if any)
+  */
+  if( !ZT_DEFINED ) { die("Illegal Access"); }
+  
+  $fields = array();
+  $varfields = array();
+  $required = array();
+  $customFieldsArray = false;
+  $customFieldsArray = $map->getFieldMap($view);
+  $fprops = getFmFieldProps($view);
+  foreach($customFieldsArray as $f=>$field) {
+    // don't include sections
+    if( $field['field_type'] == 'section' ) { continue; }
+    // parse dates
+    if( $fprops["$f"]['data_type'] == 'date' ) {
+      $$f = $zen->dateParse($$f);
+    }
+    //if( !$field['is_visible'] ) { continue; }
+    if( $field['is_required'] || $fprops["$f"]['always_required'] ) {
+      $required[] = $f;
+    }
+    if ( strpos($f,'custom_') === 0 ) { $varfields["$f"] = $field; }
+    else { $fields["$f"] = $fprops["$f"]['data_type']; }
+  }
+
+  $zen->cleanInput($fields);
+  
+  // check for required fields
+  foreach($required as $r) {
+    if( !strlen($$r) ) {
+      $errs[] = tr("Required field missing:") . " " . ucfirst($r);
+    }
+  }
+  
+  // parse variable fields which appear in new ticket screen, 
+  // store them in $varfield_params
+  // insure that all requirements are met before proceeding
+  // with the ticket save process
+  if( count($varfields) ) {
+    include("$libDir/parseVarfields.php");
+  }
+  
+}?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/includes/varfieldConfig.php zentrack_2-5-5-1/includes/varfieldConfig.php
--- zentrack_2-5-5-PRE1/includes/varfieldConfig.php	2004-08-24 01:47:58.000000000 -0700
+++ zentrack_2-5-5-1/includes/varfieldConfig.php	2005-05-01 23:59:35.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 /**
  *  This file contains configuration settings for variable ticket fields
diff -Naur zentrack_2-5-5-PRE1/includes/zen.class zentrack_2-5-5-1/includes/zen.class
--- zentrack_2-5-5-PRE1/includes/zen.class	2005-02-09 05:56:12.000000000 -0800
+++ zentrack_2-5-5-1/includes/zen.class	2005-05-08 07:41:02.000000000 -0700
@@ -1,4 +1,6 @@
 <? /* -*- Mode: C; c-basic-indent: 3; indent-tabs-mode: nil -*- ex: set tabstop=3 expandtab: */ 
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 include_once("$libDir/zenDate.class");  
   
@@ -77,13 +79,21 @@
      }
      return $this->_ucwords;
    }
+   
+   function ffvText( $val = '', $strlen = 0 ) {
+     if( $strlen && strlen($val) > $strlen ) { $val = substr($val,0,$strlen); }
+     $val = $this->ffv($val);
+     $val = nl2br($val);
+     return $val;
+   }
 
    function ffv( $val = '', $strlen = 0 ) {
      // converts special characters to ascii codes
      // to be used in <input> fields
      if( strlen($val) ) {
        if( $strlen && strlen($val) > $strlen ) { $val = substr($val,0,$strlen); }
-       $val = htmlspecialchars(stripslashes($val),ENT_QUOTES,$this->settings["character_set"]);
+       $val = htmlspecialchars($val,ENT_QUOTES,$this->settings["character_set"]);
+       $val = str_replace('\\', '&#92;', $val);
        $val = str_replace('&amp;', '&', $val);
      }
      return $val;
@@ -313,7 +323,7 @@
              $vals["$k"] = $this->checkAlphaNum($v,"_.-");
              break;
            case "text":
-             $vals["$k"] = $this->ffv("$v");
+             $vals["$k"] = $v; //$this->checkSlashes($v);
              break;
            default:
              $vals["$k"] = strip_tags("$v", $this->html_allowed);
@@ -358,7 +368,7 @@
            $$k = $this->checkAlphaNum($$k, "_.-");
            break;
          case "text":
-           $$k = $this->ffv($$k);
+           //$$k = $$k;
            break;
          default:
            $$k = strip_tags($$k, $this->html_allowed);
@@ -564,12 +574,9 @@
    /**
     * Prints the debug output collected by addDebug()
     */
-   function printDebugMessages() {  
+   function printDebugMessages() { 
      if( is_array($this->debugMessages) ) {
        $styles = array("","error","warning","note");
-       print "<p>--------<b>MESSAGES</b>--------<ul>\n";
-       print "<i>To disable this output, set \$Debug_Mode ";
-       print "in header.php to 0.</i><br>\n";
        if( is_array($this->debugMessages) ) {   
          foreach($this->debugMessages as $v) {
            $n = $v[2];
@@ -584,7 +591,6 @@
            print "\"";
          }
        }      
-       print "</ul>------<b>MESSAGES</b>------</p>\n";
      }
    }
    
@@ -645,7 +651,7 @@
    * @return boolean
    */
    function inString( $pattern, $text ) {
-     return !strlen(strpos($text, $pattern));
+     return strlen(strpos($text, $pattern));
    }
    
    /**
@@ -697,6 +703,29 @@
      }
    }
    
+  /**
+   * Merges two arrays into a single array.  Does not throw a warning if one
+   * of the arrays is null.  If the arrays are indexed, values from the second
+   * array will overwrite the first if the keys are equal.
+   *
+   * @param array $arr1
+   * @param array $arr2
+   * @return array an empty array if both values are null or empty
+   */
+   function mergeArrays($arr1, $arr2) {
+     if( is_array($arr1) && is_array($arr2) ) { return array_merge($arr1,$arr2); }
+     else if( is_array($arr1) ) { return $arr1; }
+     else if( is_array($arr2) ) { return $arr2; }
+     else { return array(); }
+   }
+   
+   /**
+    * Converts file names to an absolute path name using / characters.
+    */
+    function cleanPath( $path ) {
+      return str_replace('\\', '/', realpath($path) );
+    }
+   
    /*
    **  SYSTEM METHODS
    */
diff -Naur zentrack_2-5-5-PRE1/includes/zenDatabase.class zentrack_2-5-5-1/includes/zenDatabase.class
--- zentrack_2-5-5-PRE1/includes/zenDatabase.class	2002-05-06 13:49:02.000000000 -0700
+++ zentrack_2-5-5-1/includes/zenDatabase.class	2005-05-01 23:59:36.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
   
 class zenDatabase {
 
diff -Naur zentrack_2-5-5-PRE1/includes/zenDate.class zentrack_2-5-5-1/includes/zenDate.class
--- zentrack_2-5-5-PRE1/includes/zenDate.class	2004-11-27 22:33:59.000000000 -0800
+++ zentrack_2-5-5-1/includes/zenDate.class	2005-05-01 23:59:36.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   /*
   **
diff -Naur zentrack_2-5-5-PRE1/includes/zenGraph.class zentrack_2-5-5-1/includes/zenGraph.class
--- zentrack_2-5-5-PRE1/includes/zenGraph.class	2005-02-28 12:02:29.000000000 -0800
+++ zentrack_2-5-5-1/includes/zenGraph.class	2005-05-01 23:59:36.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   /*
   **  ZENGRAPH - REPORT GENERATING TOOL
diff -Naur zentrack_2-5-5-PRE1/includes/zenTemplate.class zentrack_2-5-5-1/includes/zenTemplate.class
--- zentrack_2-5-5-PRE1/includes/zenTemplate.class	2005-03-11 07:37:36.000000000 -0800
+++ zentrack_2-5-5-1/includes/zenTemplate.class	2005-05-01 23:59:36.000000000 -0700
@@ -1,4 +1,6 @@
 <?
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
   /**
    **  TEMPLATE PROCESSING ENGINE
@@ -142,7 +144,7 @@
 	    foreach($vars as $k=>$v) {
         $fv = $this->_getVar("field_value");
 	      $tmp=$str;
-	      if($fv===$k || is_array($fv) && in_array($k, $fv) || 
+	      if($fv==$k || is_array($fv) && in_array($k, $fv) || 
             (!is_array($fv) && !strlen($k) && !strlen($fv))) {
 	        $tmp = str_replace("{selected}", " selected", $tmp);
 	        $tmp = str_replace("{checked}", " checked", $tmp);
diff -Naur zentrack_2-5-5-PRE1/includes/zenTrack.class zentrack_2-5-5-1/includes/zenTrack.class
--- zentrack_2-5-5-PRE1/includes/zenTrack.class	2005-03-11 07:37:36.000000000 -0800
+++ zentrack_2-5-5-1/includes/zenTrack.class	2005-05-01 23:59:36.000000000 -0700
@@ -1,4 +1,6 @@
 <? /* -*- Mode: C; c-basic-indent: 3; indent-tabs-mode: nil -*- ex: set tabstop=3 expandtab: */ 
+if( !ZT_DEFINED ) { die("Illegal Access"); }
+
 
 /* 
 **  zenTrack Class
@@ -452,7 +454,7 @@
     $query2 .= "user_id IS NULL AND ticket_id = '".$ticket_id."' ";    
    
     // get the lists of recipients and merge them
-    $list = array_merge($this->db_list($query),$this->db_list($query2));
+    $list = $this->mergeArrays($this->db_list($query),$this->db_list($query2));
     // print a debug message
     $this->addDebug("get_notify_recipients","Found ".count($list)
                     ." recipients for ticket $ticket_id",3);
@@ -2068,22 +2070,22 @@
 	$this->add_log($id, $logParams);    
       }
       if( $this->settings["email_closed"] == "on" ) {
-	// send email
-	$recipients = $this->get_notify_recipients($id);
+	     // send email
+	     $recipients = $this->get_notify_recipients($id);
         // make sure the manager gets a notification
         $vals = $this->fetch_bin_role_emails($t['bin_id'],$this->getRoleId('manager'));
         $this->checkIncludedRecipients($recipients,$vals);
         // create email
-	if( is_array($recipients) && count($recipients) ) {
-	  $bin = $t["bin_id"];
-	  $subject = $this->ptrans("Ticket #?: closed",array($id));
-	  $emailParams["Close Time"] = $this->showDateTime($this->currTime);
-	  if( $comments )
-	    $emailParams["body"] = $comments;
-	  $emailParams["tid"] = $t;
-	  $message = $this->formatEmailMessage($emailParams);
-	  $this->sendEmail($recipients,$subject,$message,$user_id);       
-	}
+	     if( is_array($recipients) && count($recipients) ) {
+	       $bin = $t["bin_id"];
+	       $subject = $this->ptrans("Ticket #?: closed",array($id));
+	       $emailParams["Close Time"] = $this->showDateTime($this->currTime);
+	       if( $comments )
+	         $emailParams["body"] = $comments;
+	       $emailParams["tid"] = $t;
+	       $message = $this->formatEmailMessage($emailParams);
+	       $this->sendEmail($recipients,$subject,$message,$user_id);       
+	     }
       } 
     } else if( ($t["tested"] == 1 || $t["approved"] == 1) 
 	       && $t["status"] == "OPEN" ) {
@@ -2094,25 +2096,25 @@
 		      );
       $res = $this->update_ticket($id, $params);
       if( $this->settings["log_pending"] == "on" ) {
-	// make a log entry
-	$logParams = array(
+	     // make a log entry
+	     $logParams = array(
 			   "action"   =>  'PENDING',
 			   "ticket_id" =>  $id,
 			   "entry"    =>  $entry
 			   );
-	if( $user_id ) {
-	  $logParams["user_id"] = $user_id;
-	}
-	$logParams["bin_id"] = $t["bin_id"];      
-	if( $hours )
-	  $logParams["hours"] = $hours;
-	if( $comments )
-	  $logParams["entry"] = $comments;
-	$this->add_log($id, $logParams);    
+	     if( $user_id ) {
+	       $logParams["user_id"] = $user_id;
+	     }
+	     $logParams["bin_id"] = $t["bin_id"];      
+	     if( $hours )
+	       $logParams["hours"] = $hours;
+	     if( $comments )
+	       $logParams["entry"] = $comments;
+	     $this->add_log($id, $logParams);    
       }  
       if( $this->settings["email_pending"] == "on" ) {
-	// send an email
-	$recipients = $this->get_notify_recipients($id);
+  	     // send an email
+	     $recipients = $this->get_notify_recipients($id);
         // make sure the testers/managers gets a notification
         if( $t['tested'] == 1 ) {
           $vals = $this->fetch_bin_role_emails($t['bin_id'], $this->getRoleId('tester'));
@@ -2122,16 +2124,16 @@
         }        
         $this->checkIncludedRecipients($recipients, $vals);
         // create email
-	if( is_array($recipients) && count($recipients) ) {
-	  $bin = $t["bin_id"];
-	  $subject = $this->ptrans("Ticket #?: closed",array($id));
-	  $emailParams["Close Time"] = $this->showDateTime($this->currTime);
-	  if( $comments )
-	    $emailParams["body"] = $this->ffv($comments);
-	  $emailParams["tid"] = $id;
-	  $message = $this->formatEmailMessage($emailParams);
-	  $this->sendEmail($recipients,$subject,$message,$user_id);
-	} 
+	     if( is_array($recipients) && count($recipients) ) {
+	       $bin = $t["bin_id"];
+	       $subject = $this->ptrans("Ticket #?: closed",array($id));
+	       $emailParams["Close Time"] = $this->showDateTime($this->currTime);
+	       if( $comments )
+	         $emailParams["body"] = $this->ffv($comments);
+	       $emailParams["tid"] = $id;
+	       $message = $this->formatEmailMessage($emailParams);
+	       $this->sendEmail($recipients,$subject,$message,$user_id);
+	     } 
       } 
     }
     return($res);
@@ -2166,9 +2168,11 @@
     if( $this->check_status($t,"READY") ) {
       // if ticket is ready to close, then close it
       $params = array(
-            "status"  =>  'CLOSED',
-            "ctime"   =>  $this->currTime
+            "status"  =>  'CLOSED'
             );
+      if( ! $t["ctime"] ) {
+        $params["ctime"]=$this->currTime;
+      }
       if( $this->settings["retain_owner_closed"] != "on") {
         $params["user_id"] = NULL;
       }
@@ -2216,6 +2220,9 @@
       if( $this->settings["retain_owner_pending"] != "on") {
         $params["user_id"] = NULL;
       }
+      if( ! $t["ctime"]  && $this->settings["ctime_on_pending"] == "on" ) {
+        $params["ctime"]=$this->currTime;
+      }
       $res = $this->update_ticket($id, $params);
       if( $this->settings["log_pending"] == "on" ) {
         // make a log entry
@@ -2313,8 +2320,8 @@
       $params["user_id"] = NULL;
     } else {
       $currentOwner=$this->checkNum($t['user_id']);
-      $ownerAccess = $this->get_access($currentOwner,1);
-      if( strlen($ownerAccess["$newBin"]) < 1 ) {
+      $ownerAccess = $this->get_access($currentOwner,0);
+      if( ! (strlen($ownerAccess["$newBin"]) > 0) ) {
         $params["user_id"] = NULL;
       } else {
         if( $ownerAccess["$newBin"] < $this->settings["level_user"] ) {
@@ -2672,10 +2679,13 @@
       $this->set_notify_list($id,$notify_list);
 
       // create a log entry
+      $log_entry=$params["user_id"]?tr("Assigned to [?-?]",array($params["user_id"],$this->formatName($params["user_id"])))
+                                   :tr("Unassigned");
       $lParams = array(
                        "action"   =>   "CREATED",
                        "user_id"   =>   $params["creator_id"],
-                       "bin_id"    =>   $params["bin_id"]
+                       "bin_id"    =>   $params["bin_id"],
+                       "entry"     =>   $log_entry
                        );
       if( $log_notes ) {
         $lParams["entry"] = $log_notes;
@@ -2816,6 +2826,7 @@
                                break;
             case "otime":
             case "ctime":
+            case "deadline":
             case "start_date": $v1=$this->showDateTime($v1);
                                $v2=$this->showDateTime($v2);
             default:           $d1 = "";
@@ -4346,7 +4357,7 @@
       if( $ticket["user_id"] != $user_id ) {
         if( !$c["override"] 
             || ( strlen($access["$bin_id"]) 
-                 && $access["bin_id"] < $this->settings["level_super"] )
+                 && $access["$bin_id"] < $this->settings["level_super"] )
             || ( !strlen($access["$bin_id"]) 
                  && $user["access_level"] < $this->settings["level_super"])
                  ) {
@@ -4455,7 +4466,7 @@
                                 "owner"    => 1,
                                 "access"   => 1,
                                 "status"   => array('OPEN'),
-                                "override" => 0,
+                                "override" => 1,
                                 "egate"    => 1,
                                 "level"    => $this->settings["level_user"]
                                 );
@@ -4575,7 +4586,7 @@
                                "owner"    => 0,
                                "access"   => 1,
                                "status"   => array('PENDING'),
-                               "override" => 0,
+                               "override" => 1,
                                "egate"    => 1,
                                "level"    => $this->settings["level_test"]
                                );
@@ -5520,7 +5531,7 @@
     return $id;
   }
   
-  function get_open_tickets($id,$type) {
+/*   function get_open_tickets($id,$type,$orderby='otime DESC') {
     // get open tickets of a contact
     
     $ids2 = array(); //arry for person ids
@@ -5572,8 +5583,47 @@
     }
     
     return($tickets);
+  } */
+  
+  /**
+   * Returns a list of tickets associated with a given company
+   *
+   * @param int $company_id an id from the zentrack_company.company_id field
+   * @param string $order_by see includes/sorting.php
+   */
+  function getTicketsByCompany($company_id, $sort) {
+    // collect a list of tickets belonging to any contact within the current company
+    // (or simply belonging to the company itself)
+    $id = $this->checkNum($company_id);
+    $query = "SELECT ticket_id FROM ZENTRACK_RELATED_CONTACTS c, ZENTRACK_EMPLOYEE e"
+        ." WHERE (cp_id = '$id' AND c.type='1')"
+        ." OR (c.type='2' AND c.cp_id = e.person_id AND e.company_id = '$id')";
+    $ids = array_unique($this->db_list($query));
+    $this->addDebug("getTicketsByCompany","[".count($ids)."]".$query,3);
+    // skip query if there are no ids to retrieve
+    if( !count($ids) ) { return array(); }
+    // using our list of ids, call the get_tickets method normally 
+    return $this->get_tickets( array('id'=>$ids), $sort );
   }
    
+  /**
+   * Returns a list of tickets associated with a given contact
+   *
+   * @param int $company_id an id from the zentrack_employee.person_id field
+   * @param string $sort see includes/sorting.php
+   */
+  function getTicketsByPerson($person_id, $sort) {
+    // collect a list of tickets matching the current contact
+    $id = $this->checkNum($person_id);
+    $query = "SELECT ticket_id FROM ZENTRACK_RELATED_CONTACTS WHERE cp_id = '".$id."' AND type ='2'";
+    $ids = array_unique($this->db_list($query));
+    $this->addDebug("getTicketsByEmployee","[".count($ids)."]".$query,3);
+    // skip query if there are no ids to retrieve
+    if( !count($ids) ) { return array(); }
+    // using our list of ids, call the get_tickets method normally 
+    return $this->get_tickets( array('id'=>$ids), $sort );
+  }
+
   function get_contact_all() {
     // get all companys for the droplists
     $query = "SELECT company_id,title,office FROM ZENTRACK_COMPANY ORDER BY title asc";
diff -Naur zentrack_2-5-5-PRE1/www/actions/close.php zentrack_2-5-5-1/www/actions/close.php
--- zentrack_2-5-5-PRE1/www/actions/close.php	2005-03-10 19:16:29.000000000 -0800
+++ zentrack_2-5-5-1/www/actions/close.php	2005-05-01 23:59:39.000000000 -0700
@@ -21,40 +21,9 @@
     if (!isset($hours)) $hours=0;
     if (!isset($comments)) $comments="";
 
-    $customFieldsArray = false;
-    $customFieldsArray = $map->getFieldMap('ticket_close');
-
-    $fields = array();
-
-    $required = array();
-    foreach($customFieldsArray as $f=>$field) {
-      if( $field['is_required'] ) {
-        $required[] = $f;
-      }
-    }
-    // check for required fields
-    foreach($required as $r) {
-      if( !strlen($$r) ) {
-        $errs[] = tr("Required field missing:") . " " . ucfirst($r);
-      }
-    }
-    // parse variable fields which appear in close ticket screen,
-    // store them in $varfield_params
-    // insure that all requirements are met before proceeding
-    // with the ticket save process
-    if( !$errs ) {
-      foreach(array_keys($customFieldsArray) as $f) {
-        if (strncmp($f,"custom_",7)!=0) {
-          if ( strcmp($f,"hours")!=0 && strcmp($f,"comments")!=0 && strcmp($f,"id")!=0 )  {
-            $fields["$f"]=$customFieldsArray["$f"];
-          }
-          unset($customFieldsArray["$f"]);
-        }
-      }
-      if( $customFieldsArray && count($customFieldsArray) ) {
-        include("$libDir/parseVarfields.php");
-      }
-    }
+    $view = 'ticket_close';
+    include("$libDir/validateFields.php");
+    
     if( !$errs ) {
       if( $zen->inProjectTypeIDs($ticket["type_id"]) ) {
         $children = $zen->getProjectChildren($id,'id,type,status');
@@ -68,28 +37,25 @@
       }
     }
     if( !$errs ) {
-      // create an array of existing fields
-      // to be used for the ticket
-      foreach(array_keys($fields) as $f) {
-        if( strlen($$f) ) {
-          $params["$f"] = $$f;
-        }
-      }
+     $params = array();
+     // create an array of existing fields
+     foreach(array_keys($fields) as $f) {
+       $params["$f"] = $$f;
+     }
+
       $res = $zen->close_ticket($id, $login_id, $hours, $comments);
       if( !$res ) {
         $errs[] = tr("Could not close ticket."). " ".$zen->db_error;
-      } else {
-        if( $customFieldsArray && count($varfield_params) ) {
+      } else if( $varfields && count($varfield_params) ) {
         // update the variable field entries for this ticket
-          $res = $zen->updateVarfieldVals($id, $varfield_params);
-          if( !$res ) {
-            add_system_mesages(tr("? ? closed, but variable fields could not be saved", array(tr('Ticket'),$id)));
-          } else {
-            add_system_messages(tr("Ticket ? has been closed", array($id)));
-          }
+        $res = $zen->updateVarfieldVals($id, $varfield_params);
+        if( !$res ) {
+          add_system_mesages(tr("? ? closed, but variable fields could not be saved", array(tr('Ticket'),$id)));
+        } else {
+          add_system_messages(tr("Ticket ? has been closed", array($id)));
         }
-        $setmode="details";
       }
+      $setmode="details";
     }
     if( $errs ) {
       add_system_messages( $errs, 'Error' );
diff -Naur zentrack_2-5-5-PRE1/www/actions/email.php zentrack_2-5-5-1/www/actions/email.php
--- zentrack_2-5-5-PRE1/www/actions/email.php	2004-10-12 22:49:08.000000000 -0700
+++ zentrack_2-5-5-1/www/actions/email.php	2005-03-21 09:55:55.000000000 -0800
@@ -73,7 +73,13 @@
            // Generate log entry with list of email addresses
            $entry = "Ticket emailed to ";
            foreach ($recipients as $v) {
-             $entry .= $v . ", ";
+             if ($zen->checkNum($v) >0) {
+               $user_info=$zen->get_user($v);
+               $v1="[".$v." - ".$user_info["email"]."]";
+             } else {
+               $v1=$v;
+             }
+             $entry .= $v1 . ", ";
            }
            $entry = substr($entry, 0, -2);
            $logParams["entry"] = $entry;
diff -Naur zentrack_2-5-5-PRE1/www/addProjectSubmit.php zentrack_2-5-5-1/www/addProjectSubmit.php
--- zentrack_2-5-5-PRE1/www/addProjectSubmit.php	2005-02-28 12:02:31.000000000 -0800
+++ zentrack_2-5-5-1/www/addProjectSubmit.php	2005-05-01 23:59:39.000000000 -0700
@@ -18,6 +18,8 @@
   
   $page_title = tr("Commit New Project");
   $expand_projects = 1;
+  $page_type = "project";
+  $view = 'project_create';
   
   // initiate default values
   $otime = time();  // set time ticket opened
@@ -31,31 +33,8 @@
   $type_id = $zen->projectTypeID();
   $description = nl2br($zen->ffv($description));
   
-  $fields = array(
-  "title"       => "text",
-  "priority"    => "int",
-  "description" => "ignore",
-  "otime"       => "int",
-  "bin_id"       => "int",
-  "type_id"      => "int",
-  "user_id"      => "int",
-  "system_id"    => "int",
-  "tested"      => "int",
-  "approved"    => "int",
-  "relations"   => "text",
-  "project_id"   => "int",
-  "est_hours"   => "num",
-  "deadline"    => "int",
-  "start_date"  => "int"
-  );
-  
-  $fields = $map->getFieldMap('project_create');
-  $required = array();
-  foreach($fields as $f=>$field) {
-    if( $field['is_required'] ) {
-      $required[] = $f;
-    }
-  }
+  include("$libDir/validateFields.php");
+  
   $zen->cleanInput($fields);
   // check for required fields
   foreach($required as $r) {
@@ -78,19 +57,7 @@
       $errs[] = tr("Could not create project.") . " " .$zen->db_error;
     }
     else {
-      // parse variable fields which appear in new ticket screen, 
-      // store them in $varfield_params
-      // insure that all requirements are met before proceeding
-      // with the ticket save process
-      $customFieldsArray = false;
-      if( !$errs ) {
-        $customFieldsArray = $zen->getCustomFields(0, 'Project', 'New');
-        if( $customFieldsArray && count($customFieldsArray) ) {
-          include("$libDir/parseVarfields.php");
-        }
-      }
-      
-      if( $customFieldsArray && count($varfield_params) ) {
+      if( $varfields && count($varfield_params) ) {
         $res = $zen->updateVarfieldVals($id, $varfield_params, $login_id, $bin_id);
         if( !$res ) {
           $errs[] = tr("? created, but variable fields could not be saved", array(tr('Project')));
@@ -108,7 +75,7 @@
     include("$libDir/nav.php");
     $zen->print_errors($errs);
     $view = "project_create";
-    include("$templateDir/newProjectForm.php");
+    include("$templateDir/newTicketForm.php");
     include("$libDir/footer.php");
   }
 ?>
diff -Naur zentrack_2-5-5-PRE1/www/addSubmit.php zentrack_2-5-5-1/www/addSubmit.php
--- zentrack_2-5-5-PRE1/www/addSubmit.php	2005-03-01 07:32:25.000000000 -0800
+++ zentrack_2-5-5-1/www/addSubmit.php	2005-05-01 23:59:39.000000000 -0700
@@ -17,6 +17,9 @@
     exit;
   }
   
+  $page_type = 'ticket';
+  $view = 'ticket_create';
+  
   $page_title = tr("Commit New Ticket");
   $expand_tickets = 1;
   
@@ -30,66 +33,8 @@
   }
   
   $description = $zen->ffv($description);
-  
-  $fields = array(
-  "title"       => "text",
-  "priority"    => "int",
-  "description" => "ignore",
-  "otime"       => "int",
-  "bin_id"       => "int",
-  "type_id"      => "int",
-  "user_id"      => "int",
-  "system_id"    => "int",
-  "tested"      => "int",
-  "approved"    => "int",
-  "relations"   => "text",
-  "project_id"   => "int",
-  "est_hours"   => "num",
-  "deadline"    => "int",
-  "start_date"  => "int"
-  );
 
-  $customFieldsArray = false;
-  $customFieldsArray = $map->getFieldMap($type=='project'?'project_create':'ticket_create');
-
-  $required = array();
-  foreach($customFieldsArray as $f=>$field) {
-    if( $field['is_required'] ) {
-      $required[] = $f;
-    }
-  }
-
-  // $required = array(
-  // "title",
-  // "priority",
-  // "description",
-  // "bin_id",
-  // "type_id",
-  // "system_id"
-  // );
-  $zen->cleanInput($fields);
-  
-  // check for required fields
-  foreach($required as $r) {
-    if( !strlen($$r) ) {
-      $errs[] = tr("Required field missing:") . " " . ucfirst($r);
-    }
-  }
-  
-  // parse variable fields which appear in new ticket screen, 
-  // store them in $varfield_params
-  // insure that all requirements are met before proceeding
-  // with the ticket save process
-  if( !$errs ) {
-    foreach(array_keys($customFieldsArray) as $f) {
-      if (strncmp($f,"custom_",7)!=0) {
-        unset($customFieldsArray["$f"]);
-      }
-    }
-    if( $customFieldsArray && count($customFieldsArray) ) {
-      include("$libDir/parseVarfields.php");
-    }
-  }
+  include("$libDir/validateFields.php");
   
   if( !$errs ) {
     // create an array of existing fields
@@ -105,7 +50,7 @@
     $id = $zen->add_ticket($params);
     
     // update the variable field entries for this ticket
-    if( $id && $customFieldsArray && count($varfield_params) ) {
+    if( $id && $varfields && count($varfield_params) ) {
       $res = $zen->updateVarfieldVals($id, $varfield_params);
       if( !$res ) {
         $errs[] = tr("? created, but variable fields could not be saved", array(tr('Ticket')));
diff -Naur zentrack_2-5-5-PRE1/www/admin/admin_header.php zentrack_2-5-5-1/www/admin/admin_header.php
--- zentrack_2-5-5-PRE1/www/admin/admin_header.php	2005-02-09 05:56:15.000000000 -0800
+++ zentrack_2-5-5-1/www/admin/admin_header.php	2005-03-31 15:25:39.000000000 -0800
@@ -7,7 +7,7 @@
   $page_title = tr("Administration");
 
   $system_name = $zen->settings["system_name"];
-  if( $login_level < $zen->settings["level_settings"] ) {
+  if( $zen->checkNum($login_level) < $zen->settings["level_settings"] ) {
      $page_title = "Access Error";    
      $msg = "<p class='hot'>" . tr("You do not have access to administrate zenTrack.") . "</p>\n"; 
      include("$libDir/nav.php");     
diff -Naur zentrack_2-5-5-PRE1/www/admin/fieldMap.php zentrack_2-5-5-1/www/admin/fieldMap.php
--- zentrack_2-5-5-PRE1/www/admin/fieldMap.php	2005-03-11 07:37:39.000000000 -0800
+++ zentrack_2-5-5-1/www/admin/fieldMap.php	2005-05-04 14:39:36.000000000 -0700
@@ -46,7 +46,10 @@
     $view = 'ticket_create';
   }
   
-  if( $TODO == 'save' ) {
+  if( $TODO == 'save' && $zen->demo_mode == "on" ) {
+    $errs[] = "Your operation was completed, but you cannot edit the field map on a demo site.";
+  }
+  else if( $TODO == 'save' ) {
     $deletes = array();
     $inserts = array();
     $vprops = getFmViewProps($view);
diff -Naur zentrack_2-5-5-PRE1/www/assignedProjects.php zentrack_2-5-5-1/www/assignedProjects.php
--- zentrack_2-5-5-PRE1/www/assignedProjects.php	2005-02-09 05:56:15.000000000 -0800
+++ zentrack_2-5-5-1/www/assignedProjects.php	2005-05-01 23:59:39.000000000 -0700
@@ -9,6 +9,8 @@
   include("header.php");
 
   $page_type = "project";
+  $view = 'project_list';
+
   $params = array(
 		  "type_id"  => $zen->projectTypeIDs(),
 		  "status"  => array("OPEN","PENDING"),
@@ -22,6 +24,7 @@
   $expand_projects = 1;
   include("$libDir/nav.php");
 
+  
   if( $login_bin ) {
     $params["bin_id"] = $login_bin;
   } else {
@@ -29,6 +32,7 @@
   }
   if( is_array($params) )
     $tickets = $zen->get_tickets($params);
+    
   include("$templateDir/listTickets.php");
 
   include("$libDir/footer.php");
diff -Naur zentrack_2-5-5-PRE1/www/behavior_js.php zentrack_2-5-5-1/www/behavior_js.php
--- zentrack_2-5-5-PRE1/www/behavior_js.php	2005-03-09 09:49:08.000000000 -0800
+++ zentrack_2-5-5-1/www/behavior_js.php	2005-04-13 09:11:44.000000000 -0700
@@ -397,6 +397,7 @@
     var f = 'window.document.'+fieldObj.form.getAttribute('name');
     var fn = f+'.'+fieldObj.name
     var s = unescape(group.evalText);
+    s = s.replace( /\{form\}.\{field\}/ig, "{field}" );
     s = s.replace( /{form}/ig, f);
     var vals = evalJsString( s.replace(/{field}/ig, fn) );
 
@@ -427,6 +428,29 @@
   }
   behaviorDebug(3, "(setFormValsUsingGroup)updating "+fieldObj.name
 		+" using "+group.name+"["+fieldObj.type+"] with setid="+setid+" and values=["+v+"]");
+  // To be used for hidden, text, etc: set the oldPos value if the fieldObj.value is in the list
+  // (unless we do it, the first element of the list will always be assigned to the field, no matter if the fieldObj.value is in the list)
+  var oldPos = -1;
+  if ( fieldObj.value != null && typeof fieldObj.value != "undef" ) {
+    for(var i=0; i < fields.length && oldPos == -1; i++) {
+      if ( fields[i].value == fieldObj.value ) {
+        oldPos=i;
+      }
+    }
+  }
+  if ( oldPos == -1) {
+    for(var i=0; i < fields.length && oldPos == -1; i++) {
+      if (fields[i].label == fieldObj.value) {
+        oldPos=i;
+      }
+    }
+  }
+  if ( oldPos == -1) {
+    oldPos=0;
+    behaviorDebug(3, "(setFormValsUsingGroup)Did not recognize field value for "+fieldObj.name+" ("+fieldObj.value+")");
+  } else {
+    behaviorDebug(3, "(setFormValsUsingGroup)Recognized field value for "+fieldObj.name+" as ["+fields[oldPos].value+"]"+fields[oldPos].label);
+  }
   switch( fieldObj.type ) {
     case "checkbox":
       if( fields[0].value ) {
@@ -434,11 +458,15 @@
       }
       break;
     case "hidden":
+      var labelText = document.getElementById(fieldObj.name+"LabelText");
+      if( labelText ) {
+        labelText.innerHTML = fields[oldPos].label;
+      }
     case "button":
     case "submit":
     case "text":
     case "textarea":
-      fieldObj.value = fields[0].value;
+      fieldObj.value = fields[oldPos].value;
       break;
     case "select":
     case "select-one":
@@ -446,7 +474,9 @@
       if( fieldObj.selectedIndex && fieldObj.options && fieldObj.options.length > 0 ) {
         // store the currently selected value and try to reproduce in a minute
         var oldValue = fieldObj.options[ fieldObj.selectedIndex ].value;
+        behaviorDebug(3, "(setFormValsUsingGroup)storing oldValue="+oldValue);
       }
+      behaviorDebug(3, "(setFormValsUsingGroup)storing oldValue="+oldValue); 
       fieldObj.length = 0;
       for(var i=0; i < fields.length; i++) {
         var f = fields[i];
@@ -456,7 +486,8 @@
         fieldObj.options[i].value = f.value;
         // try to set to the same value if possible
         if( f.value == oldValue ) {
-          fieldObj.options[i].selected = true;
+//          fieldObj.options[i].selected = true;
+          fieldObj.selectedIndex=i;
         }
       }
       break;
diff -Naur zentrack_2-5-5-PRE1/www/contact.php zentrack_2-5-5-1/www/contact.php
--- zentrack_2-5-5-PRE1/www/contact.php	2004-09-02 10:24:19.000000000 -0700
+++ zentrack_2-5-5-1/www/contact.php	2005-04-25 05:44:12.000000000 -0700
@@ -61,12 +61,16 @@
       if($pid){
 	    	include("$templateDir/contact_personBox.php"); 
 	    	if($overview=="tickets") {
-		    	//show open tickets
-					$tickets = $zen->get_open_tickets($id,"2");
+          //collect field map info
+          $view = 'ticket_list';
+          $fields = $map->getFieldMap($view);
+		    	//sort tickets
+          include("$libDir/sorting.php");
+          // collect open tickets
+          $tickets = $zen->getTicketsByPerson($id, join(',',$orderby));
+					//$tickets = $zen->get_open_tickets($id,"2");
 					
-					if ($tickets) {
-						include("$templateDir/listTickets.php");
-					}
+          include("$templateDir/listTickets.php");
 	    	}
 	    	
       } else {
@@ -82,13 +86,16 @@
 	  				include("$templateDir/agreement_list.php");
   				}
 				} elseif ($overview=="tickets") {
+          //collect field map info
+          $view = 'ticket_list';
+          $fields = $map->getFieldMap($view);
+          // sort tickets
+          include("$libDir/sorting.php");
 					//show open tickets
-					$tickets = $zen->get_open_tickets($id,"1");
-					
+					//$tickets = $zen->get_open_tickets($id,"1");
+          $tickets = $zen->getTicketsByCompany($id,join(',',$orderby));
 					echo "<br>";
-					if ($tickets) {
-						include("$templateDir/listTickets.php");
-					}
+          include("$templateDir/listTickets.php");
 				} else {
 					//show the related contacts
 					$parms = array(1 => array(1 => "company_id", 2 => "=", 3 => $id),
diff -Naur zentrack_2-5-5-PRE1/www/header.php zentrack_2-5-5-1/www/header.php
--- zentrack_2-5-5-PRE1/www/header.php	2005-05-08 13:11:23.222841600 -0700
+++ zentrack_2-5-5-1/www/header.php	2005-05-08 13:58:09.578182400 -0700
@@ -7,22 +7,17 @@
   /* DO NOT PUT ANYTHING, INCLUDING SPACES, OUTSIDE OF THE <? ?> marks */
 
   /*
-  **  T H E S E   T W O   M U S T    B E   S E T ! ! !
+  **  THE INCLUDES DIRECTORY
   **
-  **  OR ZENTRACK WILL NOT RUN PROPERLY
-  **  Don't use trailing slashes
+  **  Use the complete system path from the root directory
+  **  Do not use a trailing slash
+  **  Use only a forward slash "/" since a backslash "\" has special meaning in php.
+  **
+  **  Valid samples:
+  **    $libDir = "c:/private_folder/includes";
+  **    $libDir = "/var/hidden/localhost/zentrack/includes";
   */
-
-  // the directory where zentrack includes are stored
-  // use the complete system path
-  $libDir = "/web/zentrack/includes";
-
-  // the base url used to reach zentrack
-  $rootUrl = "http://www.yourhost.com/zentrack";
-
-  // the directory where the www files are stored
-  $rootWWW = dirname(__FILE__);  //this will work for most installs
-  //$rootWWW = "/web/zentrack/www"; //uncomment if the previous line fails
+  $libDir = "/not_web_directory/zentrack/includes";
 
   /*
   **
@@ -31,7 +26,8 @@
   **  Valid SQL Types:
   **     mysql
   **     mssqlpo
-  **     oci8po (oracle >= 8i)
+  **     odbc_mssql (see below)
+  **     oci8po (see below)
   **     postgres (postgres >= 7)
   **     (see http://phplens.com/lens/adodb/docs-adodb.htm#drivers for more)
   */
@@ -41,30 +37,38 @@
   $Db_Pass      = "test";       //password
   $Db_Host      = "localhost";  //host of database (localhost doesn't work with sqlserver)
 
-   // ORACLE USERS! the order of items may be changed
-   // it may be that the entry will be:
-   //      $Db_Host: "serverip:port#"
-   //      $Db_Login: "scott"
-   //      $Db_Pass:  "tiger"
-   //      $Db_Instance: "servicename"
-   // or:
-   //      $Db_Host: ""
-   //      $Db_Login: "scott"
-   //      $Db_Pass:  "tiger"
-   //      $Db_Instance: "TNSName"
-   // hints for these entries:
-   // - for Oracle 8 and later, use "oci8po" as database_type
-   // - if using an Oracle Names Server, leave database_instance blank and put
-   //   the database alias into database_host
-   // - the same applies if you want to use a whole TNS connection string
-   // - to connect to a local instance, you may leave the database_host blank
-   // also... you may need to uncomment the following for oracle to work properly:
-   //   putenv("ORACLE_SID=ORACLE"); 
-   // the database instance
-   //   putenv("ORACLE_HOME=/opt/oracle/oracle/8.0.3"); 
-   // the oracle installation directory
-   //   putenv("TNS_ADMIN=/opt/oracle/product/8.1.5/network/admin"); 
-   // the directory of the tnsnames.ora file
+  // SQL SERVER >= 2000
+  // Here is a sample config
+  //$Db_Type = "odbc_mssql"; //sql type
+  //$Db_Instance = null; //db name
+  //$Db_Login = "test"; //username
+  //$Db_Pass = "test"; //password
+  //$Db_Host = "Driver={SQL Server};Server=123.321.123.321;Database=Zentrack;";
+
+  // ORACLE USERS! the order of items may be changed
+  // it may be that the entry will be:
+  //      $Db_Host: "serverip:port#"
+  //      $Db_Login: "scott"
+  //      $Db_Pass:  "tiger"
+  //      $Db_Instance: "servicename"
+  // or:
+  //      $Db_Host: ""
+  //      $Db_Login: "scott"
+  //      $Db_Pass:  "tiger"
+  //      $Db_Instance: "TNSName"
+  // hints for these entries:
+  // - for Oracle 8 and later, use "oci8po" as database_type
+  // - if using an Oracle Names Server, leave database_instance blank and put
+  //   the database alias into database_host
+  // - the same applies if you want to use a whole TNS connection string
+  // - to connect to a local instance, you may leave the database_host blank
+  // also... you may need to uncomment the following for oracle to work properly:
+  //   putenv("ORACLE_SID=ORACLE"); 
+  // the database instance
+  //   putenv("ORACLE_HOME=/opt/oracle/oracle/8.0.3"); 
+  // the oracle installation directory
+  //   putenv("TNS_ADMIN=/opt/oracle/product/8.1.5/network/admin"); 
+  // the directory of the tnsnames.ora file
 
   /*
   ** DEMO MODE AND DEBUG OUTPUT 
@@ -82,11 +86,10 @@
   ** setup and then be sure to turn it off.  It provides
   ** information about your system that is not for public
   ** consumption.
-  **
   */
 
   //set this from 0=off, 1=errors, 2=warnings, 3=notices(all)
-  $Debug_Mode = 1;  
+  $Debug_Mode = 0;  
 
   //set this to "on" prevents users from doing anything you don't
   //want them doing on a demo site
@@ -130,10 +133,20 @@
    // setlocale(LC_TIME, "de_DE");  // german
    // setlocale(LC_TIME, "es_ES");  // spanish
 
+  // the base url used to reach zentrack
+  // you should only need to edit this if the auto-config fails
+  $rootUrl = 'http://'.$_SERVER['HTTP_HOST'] . preg_replace( '@^'.str_replace("\\", "/", realpath(strtolower($_SERVER['DOCUMENT_ROOT']))).'@', '', str_replace("\\", "/", realpath(strtolower(dirname(__FILE__)))));
+  //$rootUrl = "http://www.yourhost.com/zentrack"; //uncomment and edit if the previous line fails
+
+  // the directory where the www files are stored
+  // you should only need to edit this if the auto-config fails
+  $rootWWW = dirname(__FILE__);
+  //$rootWWW = "/web/zentrack/www"; //uncomment and edit if the previous line fails
 
   /*
   **  LEAVE THIS PART ALONE
   */
+  define('ZT_DEFINED', true);
   include_once("$libDir/headerInc.php");
   
 }?>
\ No newline at end of file
diff -Naur zentrack_2-5-5-PRE1/www/javascript.js zentrack_2-5-5-1/www/javascript.js
--- zentrack_2-5-5-PRE1/www/javascript.js	2005-03-11 07:37:39.000000000 -0800
+++ zentrack_2-5-5-1/www/javascript.js	2005-04-13 08:08:16.000000000 -0700
@@ -46,7 +46,7 @@
 	src.style.cursor = 'hand'; 
 	src.style.backgroundColor = clrOver;
 	if( txtOver != null &&  txtOver != "" ){
-	  if( src.children ) {
+	  if( src.children && src.children.tags('A') && src.children.tags('A')[0] ) {
 	    src.children.tags('A')[0].style.color = txtOver;
 	  }
 	}
@@ -56,7 +56,7 @@
   src.style.cursor = 'default'; 
   src.style.backgroundColor = clrIn; 
   if( txtIn != null && txtIn != "" ){
-    if( src.children ) {
+    if( src.children && src.children.tags('A') && src.children.tags('A')[0] ) {
       src.children.tags('A')[0].style.color = txtIn;
     }
   }
diff -Naur zentrack_2-5-5-PRE1/www/projects.php zentrack_2-5-5-1/www/projects.php
--- zentrack_2-5-5-PRE1/www/projects.php	2005-03-11 07:37:39.000000000 -0800
+++ zentrack_2-5-5-1/www/projects.php	2005-05-04 09:01:07.000000000 -0700
@@ -29,12 +29,11 @@
   if( !is_array($userBins) || count($userBins) < 1 ) {
     print "<p class='hot'>" . tr("You do not have access to any existing bins") . "</p>\n";     
   } else {
-     if( $login_bin > 0 ) {
-	$params["bin_id"] = $login_bin;
-     } else {
-	$params["bin_id"] = $userBins;
-     }
-    if( is_array($params) ) 
+    if( $login_bin > 0 ) {
+      $params["bin_id"] = $login_bin;
+    } else {
+      $params["bin_id"] = $userBins;
+    }
     include("$libDir/sorting.php");
     $tickets = $zen->get_tickets($params, join(',',$orderby));
     include("$templateDir/listTickets.php");
